<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:exsl="http://exslt.org/common" xmlns:date="http://exslt.org/dates-and-times" xmlns:xdmp="http://marklogic.com/xdmp" xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#" xmlns:marc="http://www.loc.gov/MARC21/slim" xmlns:bf="http://id.loc.gov/ontologies/bibframe/" xmlns:bflc="http://id.loc.gov/ontologies/bflc/" xmlns:madsrdf="http://www.loc.gov/mads/rdf/v1#" xmlns:local="http://example.org/local" version="1.0" extension-element-prefixes="exsl date xdmp" exclude-result-prefixes="fn rdf rdfs bf bflc madsrdf local">
  <xsl:output encoding="UTF-8" method="xml" indent="yes"/>
  <xsl:strip-space elements="*"/>
  <xsl:param name="pRecordId" select="'default'"/>
  <xsl:param name="pCatScript" select="'Latn'"/>
  <xsl:param name="pGenerationDatestamp">
    <xsl:choose>
      <xsl:when test="function-available('date:date-time')">
        <xsl:value-of select="concat(translate(substring(date:date-time(),1,19),'-:T',''),'.0')"/>
      </xsl:when>
      <xsl:when test="function-available('fn:current-dateTime')">
        <xsl:value-of select="concat(translate(substring(fn:current-dateTime(),1,19),'-:T',''),'.0')"/>
      </xsl:when>
    </xsl:choose>
  </xsl:param>
  <xsl:param name="pSourceRecordId"/>
  <xsl:param name="pConversionAgency" select="'DLC'"/>
  <xsl:param name="pGenerationUri" select="'https://github.com/lcnetdev/bibframe2marc'"/>
  <xsl:param name="pSRULookup"/>
  <xsl:variable name="lower">abcdefghijklmnopqrstuvwxyz</xsl:variable>
  <xsl:variable name="upper">ABCDEFGHIJKLMNOPQRSTUVWXYZ</xsl:variable>
  <xsl:variable name="xslProcessor">
    <xsl:value-of select="system-property('xsl:vendor')"/>
  </xsl:variable>
  <xsl:variable name="vCurrentVersion">DLC bibframe2marc v2.10</xsl:variable>
  <xsl:variable name="df880script">
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>arab</lang>
      <code>(3/r</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>fa-arab</lang>
      <code>(4/r</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>ps-arab</lang>
      <code>(4/r</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>ur-arab</lang>
      <code>(4/r</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>cyrl</lang>
      <code>(N</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>uk-cyrl</lang>
      <code>(Q</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>grek</lang>
      <code>(S</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>kore</lang>
      <code>$1</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>hang</lang>
      <code>$1</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>hani</lang>
      <code>$1</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>hebr</lang>
      <code>(2/r</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>jpan</lang>
      <code>$1</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>latn</lang>
      <code>(B</code>
    </script>
    <script xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <lang>thai</lang>
      <code>Thai</code>
    </script>
  </xsl:variable>
  <xsl:variable name="df045BCEtimePeriods">
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>a0</code>
      <edtfDate>-XXXX/-3000</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b0</code>
      <edtfDate>-29XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b1</code>
      <edtfDate>-28XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b2</code>
      <edtfDate>-27XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b3</code>
      <edtfDate>-26XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b4</code>
      <edtfDate>-25XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b5</code>
      <edtfDate>-24XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b6</code>
      <edtfDate>-23XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b7</code>
      <edtfDate>-22XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b8</code>
      <edtfDate>-21XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>b9</code>
      <edtfDate>-20XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c0</code>
      <edtfDate>-19XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c1</code>
      <edtfDate>-18XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c2</code>
      <edtfDate>-17XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c3</code>
      <edtfDate>-16XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c4</code>
      <edtfDate>-15XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c5</code>
      <edtfDate>-14XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c6</code>
      <edtfDate>-13XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c7</code>
      <edtfDate>-12XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c8</code>
      <edtfDate>-11XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>c9</code>
      <edtfDate>-10XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d0</code>
      <edtfDate>-09XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d1</code>
      <edtfDate>-08XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d2</code>
      <edtfDate>-07XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d3</code>
      <edtfDate>-06XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d4</code>
      <edtfDate>-05XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d5</code>
      <edtfDate>-04XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d6</code>
      <edtfDate>-03XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d7</code>
      <edtfDate>-02XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d8</code>
      <edtfDate>-01XX</edtfDate>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>d9</code>
      <edtfDate>-00XX</edtfDate>
    </timePeriod>
  </xsl:variable>
  <xsl:variable name="df045CEtimePeriods">
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>e</code>
      <century>00</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>f</code>
      <century>01</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>g</code>
      <century>02</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>h</code>
      <century>03</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>i</code>
      <century>04</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>j</code>
      <century>05</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>k</code>
      <century>06</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>l</code>
      <century>07</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>m</code>
      <century>08</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>n</code>
      <century>09</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>o</code>
      <century>10</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>p</code>
      <century>11</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>q</code>
      <century>12</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>r</code>
      <century>13</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>s</code>
      <century>14</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>t</code>
      <century>15</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>u</code>
      <century>16</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>v</code>
      <century>17</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>w</code>
      <century>18</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>x</code>
      <century>19</century>
    </timePeriod>
    <timePeriod xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>y</code>
      <century>20</century>
    </timePeriod>
  </xsl:variable>
  <xsl:variable name="df048performers">
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ba</code>
      <type>brass</type>
      <label>horn</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>bb</code>
      <type>brass</type>
      <label>trumpet</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>bc</code>
      <type>brass</type>
      <label>coronet</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>bd</code>
      <type>brass</type>
      <label>trombone</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>be</code>
      <type>brass</type>
      <label>tuba</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>bf</code>
      <type>brass</type>
      <label>baritone</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>bn</code>
      <type>brass</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>by</code>
      <type>brass, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ca</code>
      <type>chorus</type>
      <label>mixed chorus</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>cb</code>
      <type>chorus</type>
      <label>female chorus</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>cc</code>
      <type>chorus</type>
      <label>male chorus</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>cd</code>
      <type>chorus</type>
      <label>children chorus</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>cn</code>
      <type>chorus</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>cy</code>
      <type>chorus, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ea</code>
      <type>electronic</type>
      <label>electronic synthesizer</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>eb</code>
      <type>electronic</type>
      <label>electronic tape</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ec</code>
      <type>electronic</type>
      <label>computer</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ed</code>
      <type>electronic</type>
      <label>ondes martinot</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>en</code>
      <type>electronic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ka</code>
      <type>keyboard</type>
      <label>piano</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>kb</code>
      <type>keyboard</type>
      <label>organ</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>kc</code>
      <type>keyboard</type>
      <label>harpsichord</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>kd</code>
      <type>keyboard</type>
      <label>clavichord</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ke</code>
      <type>keyboard</type>
      <label>continuo</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>kf</code>
      <type>keyboard</type>
      <label>celeste</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>kn</code>
      <type>keyboard</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ky</code>
      <type>keyboard, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>oa</code>
      <type>instrumental</type>
      <label>orchestra</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ob</code>
      <type>instrumental</type>
      <label>chamber orchestra</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>oc</code>
      <type>instrumental</type>
      <label>string orchestra</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>od</code>
      <type>instrumental</type>
      <label>band</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>oe</code>
      <type>instrumental</type>
      <label>dance orchestra</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>of</code>
      <type>instrumental</type>
      <label>brass band</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>on</code>
      <type>instrumental</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>oy</code>
      <type>instrumental, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>pa</code>
      <type>percussion</type>
      <label>timpani</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>pb</code>
      <type>percussion</type>
      <label>xylophone</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>pc</code>
      <type>percussion</type>
      <label>marimba</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>pd</code>
      <type>percussion</type>
      <label>drum</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>pn</code>
      <type>percussion</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>py</code>
      <type>percussion, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sa</code>
      <type>string, bowed</type>
      <label>violin</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sb</code>
      <type>string, bowed</type>
      <label>viola</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sc</code>
      <type>string, bowed</type>
      <label>violoncello</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sd</code>
      <type>string, bowed</type>
      <label>double bass</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>se</code>
      <type>string, bowed</type>
      <label>viol</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sf</code>
      <type>string, bowed</type>
      <label>viola d'amore</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sg</code>
      <type>string, bowed</type>
      <label>viola da gamba</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sn</code>
      <type>string, bowed</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>sy</code>
      <type>string, bowed, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ta</code>
      <type>string, plucked</type>
      <label>harp</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>tb</code>
      <type>string, plucked</type>
      <label>guitar</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>tc</code>
      <type>string, plucked</type>
      <label>lute</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>td</code>
      <type>string, plucked</type>
      <label>mandolin</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>tn</code>
      <type>string, plucked</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ty</code>
      <type>string, plucked, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>va</code>
      <type>voice</type>
      <label>soprano</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vb</code>
      <type>voice</type>
      <label>mezzo soprano</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vc</code>
      <type>voice</type>
      <label>alto</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vd</code>
      <type>voice</type>
      <label>tenor</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>ve</code>
      <type>voice</type>
      <label>baritone</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vf</code>
      <type>voice</type>
      <label>bass</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vg</code>
      <type>voice</type>
      <label>counter tenor</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vh</code>
      <type>voice</type>
      <label>high voice</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vi</code>
      <type>voice</type>
      <label>medium voice</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vj</code>
      <type>voice</type>
      <label>low voice</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vn</code>
      <type>voice</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>vy</code>
      <type>voice, ethnic</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wa</code>
      <type>woodwind</type>
      <label>flute</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wb</code>
      <type>woodwind</type>
      <label>oboe</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wc</code>
      <type>woodwind</type>
      <label>clarinet</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wd</code>
      <type>woodwind</type>
      <label/>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>we</code>
      <type>woodwind</type>
      <label>bassoon</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wf</code>
      <type>woodwind</type>
      <label>English horn</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wg</code>
      <type>woodwind</type>
      <label>bass clarinet</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wh</code>
      <type>woodwind</type>
      <label>recorder</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wi</code>
      <type>woodwind</type>
      <label>saxophone</label>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wn</code>
      <type>woodwind</type>
    </performer>
    <performer xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <code>wy</code>
      <type>woodwind, ethnic</type>
    </performer>
  </xsl:variable>
  <xsl:variable name="languages">
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>aa</xmllang>
      <iso6392>aar</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ab</xmllang>
      <iso6392>abk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ace</xmllang>
      <iso6392>ace</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ach</xmllang>
      <iso6392>ach</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ada</xmllang>
      <iso6392>ada</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ady</xmllang>
      <iso6392>ady</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>afa</xmllang>
      <iso6392>afa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>afh</xmllang>
      <iso6392>afh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>af</xmllang>
      <iso6392>afr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ain</xmllang>
      <iso6392>ain</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ak</xmllang>
      <iso6392>aka</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>akk</xmllang>
      <iso6392>akk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sq</xmllang>
      <iso6392>sqi</iso6392>
      <iso6392>alb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ale</xmllang>
      <iso6392>ale</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>alg</xmllang>
      <iso6392>alg</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>alt</xmllang>
      <iso6392>alt</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>am</xmllang>
      <iso6392>amh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ang</xmllang>
      <iso6392>ang</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>anp</xmllang>
      <iso6392>anp</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>apa</xmllang>
      <iso6392>apa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ar</xmllang>
      <iso6392>ara</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>arc</xmllang>
      <iso6392>arc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>an</xmllang>
      <iso6392>arg</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hy</xmllang>
      <iso6392>hye</iso6392>
      <iso6392>arm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>arn</xmllang>
      <iso6392>arn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>arp</xmllang>
      <iso6392>arp</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>art</xmllang>
      <iso6392>art</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>arw</xmllang>
      <iso6392>arw</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>as</xmllang>
      <iso6392>asm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ast</xmllang>
      <iso6392>ast</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ath</xmllang>
      <iso6392>ath</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>aus</xmllang>
      <iso6392>aus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>av</xmllang>
      <iso6392>ava</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ae</xmllang>
      <iso6392>ave</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>awa</xmllang>
      <iso6392>awa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ay</xmllang>
      <iso6392>aym</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>az</xmllang>
      <iso6392>aze</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bad</xmllang>
      <iso6392>bad</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bai</xmllang>
      <iso6392>bai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ba</xmllang>
      <iso6392>bak</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bal</xmllang>
      <iso6392>bal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bm</xmllang>
      <iso6392>bam</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ban</xmllang>
      <iso6392>ban</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>eu</xmllang>
      <iso6392>eus</iso6392>
      <iso6392>baq</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bas</xmllang>
      <iso6392>bas</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bat</xmllang>
      <iso6392>bat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bej</xmllang>
      <iso6392>bej</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>be</xmllang>
      <iso6392>bel</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bem</xmllang>
      <iso6392>bem</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bn</xmllang>
      <iso6392>ben</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ber</xmllang>
      <iso6392>ber</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bho</xmllang>
      <iso6392>bho</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bh</xmllang>
      <iso6392>bih</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bik</xmllang>
      <iso6392>bik</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bin</xmllang>
      <iso6392>bin</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bi</xmllang>
      <iso6392>bis</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bla</xmllang>
      <iso6392>bla</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bnt</xmllang>
      <iso6392>bnt</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bo</xmllang>
      <iso6392>bod</iso6392>
      <iso6392>tib</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bs</xmllang>
      <iso6392>bos</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bra</xmllang>
      <iso6392>bra</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>br</xmllang>
      <iso6392>bre</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>btk</xmllang>
      <iso6392>btk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bua</xmllang>
      <iso6392>bua</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bug</xmllang>
      <iso6392>bug</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>bg</xmllang>
      <iso6392>bul</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>my</xmllang>
      <iso6392>mya</iso6392>
      <iso6392>bur</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>byn</xmllang>
      <iso6392>byn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cad</xmllang>
      <iso6392>cad</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cai</xmllang>
      <iso6392>cai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>car</xmllang>
      <iso6392>car</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ca</xmllang>
      <iso6392>cat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cau</xmllang>
      <iso6392>cau</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ceb</xmllang>
      <iso6392>ceb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cel</xmllang>
      <iso6392>cel</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cs</xmllang>
      <iso6392>ces</iso6392>
      <iso6392>cze</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ch</xmllang>
      <iso6392>cha</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chb</xmllang>
      <iso6392>chb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ce</xmllang>
      <iso6392>che</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chg</xmllang>
      <iso6392>chg</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zh</xmllang>
      <iso6392>zho</iso6392>
      <iso6392>chi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chk</xmllang>
      <iso6392>chk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chm</xmllang>
      <iso6392>chm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chn</xmllang>
      <iso6392>chn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cho</xmllang>
      <iso6392>cho</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chp</xmllang>
      <iso6392>chp</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chr</xmllang>
      <iso6392>chr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cu</xmllang>
      <iso6392>chu</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cv</xmllang>
      <iso6392>chv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>chy</xmllang>
      <iso6392>chy</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cmc</xmllang>
      <iso6392>cmc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cop</xmllang>
      <iso6392>cop</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kw</xmllang>
      <iso6392>cor</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>co</xmllang>
      <iso6392>cos</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cpe</xmllang>
      <iso6392>cpe</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cpf</xmllang>
      <iso6392>cpf</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cpp</xmllang>
      <iso6392>cpp</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cr</xmllang>
      <iso6392>cre</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>crh</xmllang>
      <iso6392>crh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>crp</xmllang>
      <iso6392>crp</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>csb</xmllang>
      <iso6392>csb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cus</xmllang>
      <iso6392>cus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>cy</xmllang>
      <iso6392>cym</iso6392>
      <iso6392>wel</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dak</xmllang>
      <iso6392>dak</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>da</xmllang>
      <iso6392>dan</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dar</xmllang>
      <iso6392>dar</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>day</xmllang>
      <iso6392>day</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>del</xmllang>
      <iso6392>del</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>den</xmllang>
      <iso6392>den</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>de</xmllang>
      <iso6392>ger</iso6392>
      <iso6392>deu</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dgr</xmllang>
      <iso6392>dgr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>din</xmllang>
      <iso6392>din</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dv</xmllang>
      <iso6392>div</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>doi</xmllang>
      <iso6392>doi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dra</xmllang>
      <iso6392>dra</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dsb</xmllang>
      <iso6392>dsb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dua</xmllang>
      <iso6392>dua</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dum</xmllang>
      <iso6392>dum</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nl</xmllang>
      <iso6392>nld</iso6392>
      <iso6392>dut</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dyu</xmllang>
      <iso6392>dyu</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>dz</xmllang>
      <iso6392>dzo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>efi</xmllang>
      <iso6392>efi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>egy</xmllang>
      <iso6392>egy</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>eka</xmllang>
      <iso6392>eka</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>el</xmllang>
      <iso6392>ell</iso6392>
      <iso6392>gre</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>elx</xmllang>
      <iso6392>elx</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>en</xmllang>
      <iso6392>eng</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>enm</xmllang>
      <iso6392>enm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>eo</xmllang>
      <iso6392>epo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>et</xmllang>
      <iso6392>est</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ee</xmllang>
      <iso6392>ewe</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ewo</xmllang>
      <iso6392>ewo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fan</xmllang>
      <iso6392>fan</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fo</xmllang>
      <iso6392>fao</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fa</xmllang>
      <iso6392>fas</iso6392>
      <iso6392>per</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fat</xmllang>
      <iso6392>fat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fj</xmllang>
      <iso6392>fij</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fil</xmllang>
      <iso6392>fil</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fi</xmllang>
      <iso6392>fin</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fiu</xmllang>
      <iso6392>fiu</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fon</xmllang>
      <iso6392>fon</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fr</xmllang>
      <iso6392>fre</iso6392>
      <iso6392>fra</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>frm</xmllang>
      <iso6392>frm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fro</xmllang>
      <iso6392>fro</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>frr</xmllang>
      <iso6392>frr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>frs</xmllang>
      <iso6392>frs</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fy</xmllang>
      <iso6392>fry</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ff</xmllang>
      <iso6392>ful</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>fur</xmllang>
      <iso6392>fur</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gaa</xmllang>
      <iso6392>gaa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gay</xmllang>
      <iso6392>gay</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gba</xmllang>
      <iso6392>gba</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gem</xmllang>
      <iso6392>gem</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ka</xmllang>
      <iso6392>geo</iso6392>
      <iso6392>kat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gez</xmllang>
      <iso6392>gez</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gil</xmllang>
      <iso6392>gil</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gd</xmllang>
      <iso6392>gla</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ga</xmllang>
      <iso6392>gle</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gl</xmllang>
      <iso6392>glg</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gv</xmllang>
      <iso6392>glv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gmh</xmllang>
      <iso6392>gmh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>goh</xmllang>
      <iso6392>goh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gon</xmllang>
      <iso6392>gon</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gor</xmllang>
      <iso6392>gor</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>got</xmllang>
      <iso6392>got</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>grb</xmllang>
      <iso6392>grb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>grc</xmllang>
      <iso6392>grc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gn</xmllang>
      <iso6392>grn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gsw</xmllang>
      <iso6392>gsw</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gu</xmllang>
      <iso6392>guj</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>gwi</xmllang>
      <iso6392>gwi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hai</xmllang>
      <iso6392>hai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ht</xmllang>
      <iso6392>hat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ha</xmllang>
      <iso6392>hau</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>haw</xmllang>
      <iso6392>haw</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>he</xmllang>
      <iso6392>heb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hz</xmllang>
      <iso6392>her</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hil</xmllang>
      <iso6392>hil</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>him</xmllang>
      <iso6392>him</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hi</xmllang>
      <iso6392>hin</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hit</xmllang>
      <iso6392>hit</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hmn</xmllang>
      <iso6392>hmn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ho</xmllang>
      <iso6392>hmo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hr</xmllang>
      <iso6392>hrv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hsb</xmllang>
      <iso6392>hsb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hu</xmllang>
      <iso6392>hun</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>hup</xmllang>
      <iso6392>hup</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>iba</xmllang>
      <iso6392>iba</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ig</xmllang>
      <iso6392>ibo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>is</xmllang>
      <iso6392>isl</iso6392>
      <iso6392>ice</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>io</xmllang>
      <iso6392>ido</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ii</xmllang>
      <iso6392>iii</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ijo</xmllang>
      <iso6392>ijo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>iu</xmllang>
      <iso6392>iku</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ie</xmllang>
      <iso6392>ile</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ilo</xmllang>
      <iso6392>ilo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ia</xmllang>
      <iso6392>ina</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>inc</xmllang>
      <iso6392>inc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>id</xmllang>
      <iso6392>ind</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ine</xmllang>
      <iso6392>ine</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>inh</xmllang>
      <iso6392>inh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ik</xmllang>
      <iso6392>ipk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ira</xmllang>
      <iso6392>ira</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>iro</xmllang>
      <iso6392>iro</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>it</xmllang>
      <iso6392>ita</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>jv</xmllang>
      <iso6392>jav</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>jbo</xmllang>
      <iso6392>jbo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ja</xmllang>
      <iso6392>jpn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>jpr</xmllang>
      <iso6392>jpr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>jrb</xmllang>
      <iso6392>jrb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kaa</xmllang>
      <iso6392>kaa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kab</xmllang>
      <iso6392>kab</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kac</xmllang>
      <iso6392>kac</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kl</xmllang>
      <iso6392>kal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kam</xmllang>
      <iso6392>kam</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kn</xmllang>
      <iso6392>kan</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kar</xmllang>
      <iso6392>kar</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ks</xmllang>
      <iso6392>kas</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kr</xmllang>
      <iso6392>kau</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kaw</xmllang>
      <iso6392>kaw</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kk</xmllang>
      <iso6392>kaz</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kbd</xmllang>
      <iso6392>kbd</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kha</xmllang>
      <iso6392>kha</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>khi</xmllang>
      <iso6392>khi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>km</xmllang>
      <iso6392>khm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kho</xmllang>
      <iso6392>kho</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ki</xmllang>
      <iso6392>kik</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rw</xmllang>
      <iso6392>kin</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ky</xmllang>
      <iso6392>kir</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kmb</xmllang>
      <iso6392>kmb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kok</xmllang>
      <iso6392>kok</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kv</xmllang>
      <iso6392>kom</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kg</xmllang>
      <iso6392>kon</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ko</xmllang>
      <iso6392>kor</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kos</xmllang>
      <iso6392>kos</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kpe</xmllang>
      <iso6392>kpe</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>krc</xmllang>
      <iso6392>krc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>krl</xmllang>
      <iso6392>krl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kro</xmllang>
      <iso6392>kro</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kru</xmllang>
      <iso6392>kru</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kj</xmllang>
      <iso6392>kua</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kum</xmllang>
      <iso6392>kum</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ku</xmllang>
      <iso6392>kur</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>kut</xmllang>
      <iso6392>kut</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lad</xmllang>
      <iso6392>lad</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lah</xmllang>
      <iso6392>lah</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lam</xmllang>
      <iso6392>lam</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lo</xmllang>
      <iso6392>lao</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>la</xmllang>
      <iso6392>lat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lv</xmllang>
      <iso6392>lav</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lez</xmllang>
      <iso6392>lez</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>li</xmllang>
      <iso6392>lim</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ln</xmllang>
      <iso6392>lin</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lt</xmllang>
      <iso6392>lit</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lol</xmllang>
      <iso6392>lol</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>loz</xmllang>
      <iso6392>loz</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lb</xmllang>
      <iso6392>ltz</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lua</xmllang>
      <iso6392>lua</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lu</xmllang>
      <iso6392>lub</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lg</xmllang>
      <iso6392>lug</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lui</xmllang>
      <iso6392>lui</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lun</xmllang>
      <iso6392>lun</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>luo</xmllang>
      <iso6392>luo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>lus</xmllang>
      <iso6392>lus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mk</xmllang>
      <iso6392>mkd</iso6392>
      <iso6392>mac</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mad</xmllang>
      <iso6392>mad</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mag</xmllang>
      <iso6392>mag</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mh</xmllang>
      <iso6392>mah</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mai</xmllang>
      <iso6392>mai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mak</xmllang>
      <iso6392>mak</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ml</xmllang>
      <iso6392>mal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>man</xmllang>
      <iso6392>man</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mi</xmllang>
      <iso6392>mri</iso6392>
      <iso6392>mao</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>map</xmllang>
      <iso6392>map</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mr</xmllang>
      <iso6392>mar</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mas</xmllang>
      <iso6392>mas</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ms</xmllang>
      <iso6392>msa</iso6392>
      <iso6392>may</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mdf</xmllang>
      <iso6392>mdf</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mdr</xmllang>
      <iso6392>mdr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>men</xmllang>
      <iso6392>men</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mga</xmllang>
      <iso6392>mga</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mic</xmllang>
      <iso6392>mic</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>min</xmllang>
      <iso6392>min</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mis</xmllang>
      <iso6392>mis</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mkh</xmllang>
      <iso6392>mkh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mg</xmllang>
      <iso6392>mlg</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mt</xmllang>
      <iso6392>mlt</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mnc</xmllang>
      <iso6392>mnc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mni</xmllang>
      <iso6392>mni</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mno</xmllang>
      <iso6392>mno</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>moh</xmllang>
      <iso6392>moh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mn</xmllang>
      <iso6392>mon</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mos</xmllang>
      <iso6392>mos</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mul</xmllang>
      <iso6392>mul</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mun</xmllang>
      <iso6392>mun</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mus</xmllang>
      <iso6392>mus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mwl</xmllang>
      <iso6392>mwl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>mwr</xmllang>
      <iso6392>mwr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>myn</xmllang>
      <iso6392>myn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>myv</xmllang>
      <iso6392>myv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nah</xmllang>
      <iso6392>nah</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nai</xmllang>
      <iso6392>nai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nap</xmllang>
      <iso6392>nap</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>na</xmllang>
      <iso6392>nau</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nv</xmllang>
      <iso6392>nav</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nr</xmllang>
      <iso6392>nbl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nd</xmllang>
      <iso6392>nde</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ng</xmllang>
      <iso6392>ndo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nds</xmllang>
      <iso6392>nds</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ne</xmllang>
      <iso6392>nep</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>new</xmllang>
      <iso6392>new</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nia</xmllang>
      <iso6392>nia</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nic</xmllang>
      <iso6392>nic</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>niu</xmllang>
      <iso6392>niu</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nn</xmllang>
      <iso6392>nno</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nb</xmllang>
      <iso6392>nob</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nog</xmllang>
      <iso6392>nog</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>non</xmllang>
      <iso6392>non</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>no</xmllang>
      <iso6392>nor</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nqo</xmllang>
      <iso6392>nqo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nso</xmllang>
      <iso6392>nso</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nub</xmllang>
      <iso6392>nub</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nwc</xmllang>
      <iso6392>nwc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ny</xmllang>
      <iso6392>nya</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nym</xmllang>
      <iso6392>nym</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nyn</xmllang>
      <iso6392>nyn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nyo</xmllang>
      <iso6392>nyo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>nzi</xmllang>
      <iso6392>nzi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>oc</xmllang>
      <iso6392>oci</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>oj</xmllang>
      <iso6392>oji</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>or</xmllang>
      <iso6392>ori</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>om</xmllang>
      <iso6392>orm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>osa</xmllang>
      <iso6392>osa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>os</xmllang>
      <iso6392>oss</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ota</xmllang>
      <iso6392>ota</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>oto</xmllang>
      <iso6392>oto</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>paa</xmllang>
      <iso6392>paa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pag</xmllang>
      <iso6392>pag</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pal</xmllang>
      <iso6392>pal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pam</xmllang>
      <iso6392>pam</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pa</xmllang>
      <iso6392>pan</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pap</xmllang>
      <iso6392>pap</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pau</xmllang>
      <iso6392>pau</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>peo</xmllang>
      <iso6392>peo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>phi</xmllang>
      <iso6392>phi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>phn</xmllang>
      <iso6392>phn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pi</xmllang>
      <iso6392>pli</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pl</xmllang>
      <iso6392>pol</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pon</xmllang>
      <iso6392>pon</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pt</xmllang>
      <iso6392>por</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pra</xmllang>
      <iso6392>pra</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>pro</xmllang>
      <iso6392>pro</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ps</xmllang>
      <iso6392>pus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>qaa-qtz</xmllang>
      <iso6392>qaa-qtz</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>qu</xmllang>
      <iso6392>que</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>raj</xmllang>
      <iso6392>raj</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rap</xmllang>
      <iso6392>rap</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rar</xmllang>
      <iso6392>rar</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>roa</xmllang>
      <iso6392>roa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rm</xmllang>
      <iso6392>roh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rom</xmllang>
      <iso6392>rom</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ro</xmllang>
      <iso6392>ron</iso6392>
      <iso6392>rum</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rn</xmllang>
      <iso6392>run</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>rup</xmllang>
      <iso6392>rup</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ru</xmllang>
      <iso6392>rus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sad</xmllang>
      <iso6392>sad</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sg</xmllang>
      <iso6392>sag</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sah</xmllang>
      <iso6392>sah</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sai</xmllang>
      <iso6392>sai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sal</xmllang>
      <iso6392>sal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sam</xmllang>
      <iso6392>sam</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sa</xmllang>
      <iso6392>san</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sas</xmllang>
      <iso6392>sas</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sat</xmllang>
      <iso6392>sat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>scn</xmllang>
      <iso6392>scn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sco</xmllang>
      <iso6392>sco</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sel</xmllang>
      <iso6392>sel</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sem</xmllang>
      <iso6392>sem</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sga</xmllang>
      <iso6392>sga</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sgn</xmllang>
      <iso6392>sgn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>shn</xmllang>
      <iso6392>shn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sid</xmllang>
      <iso6392>sid</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>si</xmllang>
      <iso6392>sin</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sio</xmllang>
      <iso6392>sio</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sit</xmllang>
      <iso6392>sit</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sla</xmllang>
      <iso6392>sla</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sk</xmllang>
      <iso6392>slk</iso6392>
      <iso6392>slo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sl</xmllang>
      <iso6392>slv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sma</xmllang>
      <iso6392>sma</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>se</xmllang>
      <iso6392>sme</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>smi</xmllang>
      <iso6392>smi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>smj</xmllang>
      <iso6392>smj</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>smn</xmllang>
      <iso6392>smn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sm</xmllang>
      <iso6392>smo</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sms</xmllang>
      <iso6392>sms</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sn</xmllang>
      <iso6392>sna</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sd</xmllang>
      <iso6392>snd</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>snk</xmllang>
      <iso6392>snk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sog</xmllang>
      <iso6392>sog</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>so</xmllang>
      <iso6392>som</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>son</xmllang>
      <iso6392>son</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>st</xmllang>
      <iso6392>sot</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>es</xmllang>
      <iso6392>spa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sc</xmllang>
      <iso6392>srd</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>srn</xmllang>
      <iso6392>srn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sr</xmllang>
      <iso6392>srp</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>srr</xmllang>
      <iso6392>srr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ssa</xmllang>
      <iso6392>ssa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ss</xmllang>
      <iso6392>ssw</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>suk</xmllang>
      <iso6392>suk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>su</xmllang>
      <iso6392>sun</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sus</xmllang>
      <iso6392>sus</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sux</xmllang>
      <iso6392>sux</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sw</xmllang>
      <iso6392>swa</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>sv</xmllang>
      <iso6392>swe</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>syc</xmllang>
      <iso6392>syc</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>syr</xmllang>
      <iso6392>syr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ty</xmllang>
      <iso6392>tah</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tai</xmllang>
      <iso6392>tai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ta</xmllang>
      <iso6392>tam</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tt</xmllang>
      <iso6392>tat</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>te</xmllang>
      <iso6392>tel</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tem</xmllang>
      <iso6392>tem</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ter</xmllang>
      <iso6392>ter</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tet</xmllang>
      <iso6392>tet</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tg</xmllang>
      <iso6392>tgk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tl</xmllang>
      <iso6392>tgl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>th</xmllang>
      <iso6392>tha</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tig</xmllang>
      <iso6392>tig</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ti</xmllang>
      <iso6392>tir</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tiv</xmllang>
      <iso6392>tiv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tkl</xmllang>
      <iso6392>tkl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tlh</xmllang>
      <iso6392>tlh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tli</xmllang>
      <iso6392>tli</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tmh</xmllang>
      <iso6392>tmh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tog</xmllang>
      <iso6392>tog</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>to</xmllang>
      <iso6392>ton</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tpi</xmllang>
      <iso6392>tpi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tsi</xmllang>
      <iso6392>tsi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tn</xmllang>
      <iso6392>tsn</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ts</xmllang>
      <iso6392>tso</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tk</xmllang>
      <iso6392>tuk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tum</xmllang>
      <iso6392>tum</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tup</xmllang>
      <iso6392>tup</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tr</xmllang>
      <iso6392>tur</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tut</xmllang>
      <iso6392>tut</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tvl</xmllang>
      <iso6392>tvl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tw</xmllang>
      <iso6392>twi</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>tyv</xmllang>
      <iso6392>tyv</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>udm</xmllang>
      <iso6392>udm</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>uga</xmllang>
      <iso6392>uga</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ug</xmllang>
      <iso6392>uig</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>uk</xmllang>
      <iso6392>ukr</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>umb</xmllang>
      <iso6392>umb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>und</xmllang>
      <iso6392>und</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ur</xmllang>
      <iso6392>urd</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>uz</xmllang>
      <iso6392>uzb</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>vai</xmllang>
      <iso6392>vai</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ve</xmllang>
      <iso6392>ven</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>vi</xmllang>
      <iso6392>vie</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>vo</xmllang>
      <iso6392>vol</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>vot</xmllang>
      <iso6392>vot</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>wak</xmllang>
      <iso6392>wak</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>wal</xmllang>
      <iso6392>wal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>war</xmllang>
      <iso6392>war</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>was</xmllang>
      <iso6392>was</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>wen</xmllang>
      <iso6392>wen</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>wa</xmllang>
      <iso6392>wln</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>wo</xmllang>
      <iso6392>wol</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>xal</xmllang>
      <iso6392>xal</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>xh</xmllang>
      <iso6392>xho</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>yao</xmllang>
      <iso6392>yao</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>yap</xmllang>
      <iso6392>yap</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>yi</xmllang>
      <iso6392>yid</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>yo</xmllang>
      <iso6392>yor</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>ypk</xmllang>
      <iso6392>ypk</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zap</xmllang>
      <iso6392>zap</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zbl</xmllang>
      <iso6392>zbl</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zen</xmllang>
      <iso6392>zen</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zgh</xmllang>
      <iso6392>zgh</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>za</xmllang>
      <iso6392>zha</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>znd</xmllang>
      <iso6392>znd</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zu</xmllang>
      <iso6392>zul</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zun</xmllang>
      <iso6392>zun</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zxx</xmllang>
      <iso6392>zxx</iso6392>
    </language>
    <language xmlns:bf2marc="http://www.loc.gov/bf2marc">
      <xmllang>zza</xmllang>
      <iso6392>zza</iso6392>
    </language>
  </xsl:variable>
  <xsl:template match="/">
    <xsl:choose>
      <xsl:when test="rdf:RDF">
        <xsl:choose>
          <xsl:when test="count(rdf:RDF/bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]) = 1">
            <xsl:choose>
              <xsl:when test="count(rdf:RDF/bf:Work) = 0"/>
              <xsl:when test="count(rdf:RDF/bf:Work) = 1">
                <xsl:choose>
                  <xsl:when test="rdf:RDF/bf:Instance/bf:instanceOf/bf:*[@rdf:about=/rdf:RDF/bf:Work/@rdf:about]"/>
                  <xsl:when test="rdf:RDF/bf:Instance/bf:instanceOf[@rdf:resource=/rdf:RDF/bf:Work/@rdf:about]"/>
                  <xsl:when test="rdf:RDF/bf:Work/bf:hasInstance[@rdf:resource=/rdf:RDF/bf:Instance/@rdf:about]"/>
                  <xsl:otherwise>
                    <xsl:message terminate="yes">Invalid document: top-level Instance and Work are not linked</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message terminate="yes">Invalid document: document can only have 0 or 1 top-level Work element</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message terminate="yes">Invalid document: document must have exactly one top-level Instance element</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message terminate="yes">Invalid document: no RDF root element</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
    <xsl:apply-templates/>
  </xsl:template>
  <xsl:template match="rdf:RDF">
    <xsl:variable name="vPrincipalInstance" select="bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]"/>
    <xsl:variable name="vAdminMetadata" select="$vPrincipalInstance/bf:adminMetadata/bf:AdminMetadata | bf:Work/bf:adminMetadata/bf:AdminMetadata[not(/rdf:RDF/bf:Instance/bf:adminMetadata/bf:AdminMetadata)]"/>
    <xsl:variable name="vRecordId">
      <xsl:choose>
        <xsl:when test="$pRecordId = 'default'">
          <xsl:choose>
            <xsl:when test="$vAdminMetadata/bf:identifiedBy/bf:Local[not(bf:source) or bf:source/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc' or bf:source/bf:Source/@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc' or bf:source/bf:Source/rdfs:label='DLC']/rdf:value">
              <xsl:value-of select="$vAdminMetadata/bf:identifiedBy/bf:Local[not(bf:source) or bf:source/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc' or bf:source/bf:Source/@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc' or bf:source/bf:Source/rdfs:label='DLC']/rdf:value"/>
            </xsl:when>
            <xsl:when test="$vAdminMetadata/bf:identifiedBy/bf:Local[not(bf:source) or bf:source/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlcmrc' or bf:source/bf:Source/@rdf:about='http://id.loc.gov/vocabulary/organizations/dlcmrc' or bf:source/bf:Source/rdfs:label='DLC']/rdf:value">
              <xsl:value-of select="$vAdminMetadata/bf:identifiedBy/bf:Local[not(bf:source) or bf:source/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlcmrc' or bf:source/bf:Source/@rdf:about='http://id.loc.gov/vocabulary/organizations/dlcmrc' or bf:source/bf:Source/rdfs:label='DLC']/rdf:value"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="generate-id()"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$pRecordId"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <marc:record>
      <marc:leader>
        <xsl:attribute name="xml:space">preserve</xsl:attribute>
        <xsl:text>     </xsl:text>
        <xsl:variable name="vPosition-2">
          <xsl:choose>
            <xsl:when test="$vAdminMetadata/bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/d'] or                       $vAdminMetadata/bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/d']">
              <xsl:value-of select="'d'"/>
            </xsl:when>
            <xsl:when test="$vAdminMetadata/bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/c'] or                       $vAdminMetadata/bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/c']">
              <xsl:value-of select="'c'"/>
            </xsl:when>
            <xsl:when test="$vAdminMetadata/bf:status[@rdf:resource] or                       $vAdminMetadata/bf:status/bf:Status[@rdf:about]">
              <xsl:for-each select="$vAdminMetadata/bf:status/@rdf:resource |                            $vAdminMetadata/bf:status/bf:Status/@rdf:about">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:variable name="vStatusCode">
                      <xsl:call-template name="tUriCode">
                        <xsl:with-param name="pUri" select="."/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:value-of select="substring($vStatusCode, 1,1)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element LDR.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="string-length($vAdminMetadata/bf:status/bf:Status/bf:code) = 1">
              <xsl:for-each select="$vAdminMetadata/bf:status/bf:Status/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element LDR.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vPosition-2 != ''">
            <xsl:value-of select="$vPosition-2"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>n</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
        <xsl:variable name="vPosition-3">
          <xsl:choose>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/NotatedMusic'] and bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manuscript']">
              <xsl:text>d</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/NotatedMusic']">
              <xsl:text>c</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Cartography'] and bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manuscript']">
              <xsl:text>f</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Cartography']">
              <xsl:text>e</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MovingImage']">
              <xsl:text>g</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/NonMusicAudio']">
              <xsl:text>i</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicAudio']">
              <xsl:text>j</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/StillImage']">
              <xsl:text>k</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Multimedia']">
              <xsl:text>m</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MixedMaterial']">
              <xsl:text>p</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Object']">
              <xsl:text>r</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Text'] and bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manuscript']">
              <xsl:text>t</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vPosition-3 != ''">
            <xsl:value-of select="$vPosition-3"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>a</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
        <xsl:variable name="vPosition-4">
          <xsl:choose>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Collection']">
              <xsl:text>c</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Integrating']">
              <xsl:text>i</xsl:text>
            </xsl:when>
            <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Serial']">
              <xsl:text>s</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vPosition-4 != ''">
            <xsl:value-of select="$vPosition-4"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>m</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
        <xsl:text> a22     </xsl:text>
        <xsl:variable name="vPosition-6">
          <xsl:choose>
            <xsl:when test="$vAdminMetadata/bflc:encodingLevel[@rdf:resource] or                       $vAdminMetadata/bflc:encodingLevel/bflc:EncodingLevel[@rdf:about] or                        $vAdminMetadata/bflc:encodingLevel/bflc:EncodingLevel[not(@rdf:about) and bf:code]">
              <xsl:for-each select="$vAdminMetadata/bflc:encodingLevel/@rdf:resource |                            $vAdminMetadata/bflc:encodingLevel/bflc:EncodingLevel/@rdf:about |                             $vAdminMetadata/bflc:encodingLevel/bflc:EncodingLevel[not(@rdf:about)]/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:variable name="vLdr17" select="substring(.,string-length(.))"/>
                    <xsl:choose>
                      <xsl:when test="$vLdr17='f'">
                        <xsl:value-of select="' '"/>
                      </xsl:when>
                      <xsl:when test="$vLdr17!=''">
                        <xsl:value-of select="$vLdr17"/>
                      </xsl:when>
                      <xsl:when test="$vLdr17=''">
                        <xsl:value-of select="' '"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element LDR.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vPosition-6 != ''">
            <xsl:value-of select="$vPosition-6"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
        <xsl:text>i 4500</xsl:text>
      </marc:leader>
      <marc:controlfield>
        <xsl:attribute name="xml:space">preserve</xsl:attribute>
        <xsl:attribute name="tag">001</xsl:attribute>
        <xsl:value-of select="$vRecordId"/>
      </marc:controlfield>
      <marc:controlfield>
        <xsl:attribute name="xml:space">preserve</xsl:attribute>
        <xsl:attribute name="tag">003</xsl:attribute>
        <xsl:choose>
          <xsl:when test="$pConversionAgency != 'DLC' and $pRecordId != ''">
            <xsl:value-of select="$pConversionAgency"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:choose>
              <xsl:when test="$vAdminMetadata/bf:identifiedBy/*[local-name()='Local' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local']/bf:assigner/*/*[local-name()='code']">
                <xsl:value-of select="$vAdminMetadata/bf:identifiedBy/*[local-name()='Local' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local']/bf:assigner/*/*[local-name()='code']"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="$pConversionAgency"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:otherwise>
        </xsl:choose>
      </marc:controlfield>
      <xsl:choose>
        <xsl:when test="$pGenerationDatestamp != ''">
          <marc:controlfield>
            <xsl:attribute name="xml:space">preserve</xsl:attribute>
            <xsl:attribute name="tag">005</xsl:attribute>
            <xsl:value-of select="$pGenerationDatestamp"/>
          </marc:controlfield>
        </xsl:when>
        <xsl:when test="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/c']]">
          <xsl:choose>
            <xsl:when test="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/c']][fn:last()]/bf:date[@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime']">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:variable name="vDT">
                  <xsl:value-of select="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/c']][fn:last()]/bf:date[@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime']"/>
                </xsl:variable>
                <xsl:value-of select="concat(translate(substring($vDT, 1, 19), '-T:', ''),'.0')"/>
              </marc:controlfield>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="$vAdminMetadata[bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/c']]">
          <xsl:choose>
            <xsl:when test="$vAdminMetadata[bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/c']][fn:last()]/bf:date[@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime']">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:variable name="vDT">
                  <xsl:value-of select="$vAdminMetadata[bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/c']][fn:last()]/bf:date[@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime']"/>
                </xsl:variable>
                <xsl:value-of select="concat(translate(substring($vDT, 1, 19), '-T:', ''),'.0')"/>
              </marc:controlfield>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="$vAdminMetadata/bf:changeDate">
          <xsl:choose>
            <xsl:when test="$vAdminMetadata/bf:changeDate/@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime'">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),substring($vAdminMetadata/bf:changeDate,12,2),substring($vAdminMetadata/bf:changeDate,15,2),substring($vAdminMetadata/bf:changeDate,18,2),'.0')"/>
              </marc:controlfield>
            </xsl:when>
            <xsl:when test="$vAdminMetadata/bf:changeDate/@rdf:datatype='http://www.w3.org/2001/XMLSchema#date'">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),'000000.0')"/>
              </marc:controlfield>
            </xsl:when>
            <xsl:when test="string-length($vAdminMetadata/bf:changeDate) &gt;= 19 and                     substring($vAdminMetadata/bf:changeDate,5,1) = '-' and                     substring($vAdminMetadata/bf:changeDate,8,1) = '-' and                     substring($vAdminMetadata/bf:changeDate,11,1) = 'T' and                     substring($vAdminMetadata/bf:changeDate,14,1) = ':' and                     substring($vAdminMetadata/bf:changeDate,17,1) = ':'">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),substring($vAdminMetadata/bf:changeDate,12,2),substring($vAdminMetadata/bf:changeDate,15,2),substring($vAdminMetadata/bf:changeDate,18,2),'.0')"/>
              </marc:controlfield>
            </xsl:when>
            <xsl:when test="string-length($vAdminMetadata/bf:changeDate) &gt;= 10 and                     substring($vAdminMetadata/bf:changeDate,5,1) = '-' and                     substring($vAdminMetadata/bf:changeDate,8,1) = '-'">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),'000000.0')"/>
              </marc:controlfield>
            </xsl:when>
            <xsl:when test="string-length($vAdminMetadata/bf:changeDate) &gt;= 14 and                     translate($vAdminMetadata/bf:changeDate,'-:.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ','') = $vAdminMetadata/bf:changeDate">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,14),'.0')"/>
              </marc:controlfield>
            </xsl:when>
            <xsl:when test="string-length($vAdminMetadata/bf:changeDate) &gt;= 8 and                     translate($vAdminMetadata/bf:changeDate,'-:.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ','') = $vAdminMetadata/bf:changeDate">
              <marc:controlfield>
                <xsl:attribute name="xml:space">preserve</xsl:attribute>
                <xsl:attribute name="tag">005</xsl:attribute>
                <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,8),'000000.0')"/>
              </marc:controlfield>
            </xsl:when>
            <xsl:otherwise>
              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:changeDate. Invalid datatype for 005.</xsl:message>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:when>
      </xsl:choose>
      <xsl:apply-templates select="/rdf:RDF/bf:Instance" mode="generate-007">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="/rdf:RDF" mode="generate-008">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[         (local-name()='Lccn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']) and         not(           bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or           bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/cancinv' or           bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/cancinv'         )]" mode="generate-010">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='Nbn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Nbn']]" mode="generate-015">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/bf:Local[bf:source]|bf:Instance/bf:adminMetadata/bf:AdminMetadata/bf:identifiedBy/bf:Local[bf:source//@rdf:*[.='http://id.loc.gov/authorities/names/no2004037399']]" mode="generate-016">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='CopyrightNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/CopyrightNumber']]" mode="generate-017">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[(local-name()='Isbn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']) and rdf:value/text()]" mode="generate-020">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:identifiedBy/*[(local-name()='Issn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']) and rdf:value/text()] |        bf:Instance/bf:identifiedBy/*[(local-name()='Issn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']) and rdf:value/text()]" mode="generate-022">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:identifiedBy/*[(local-name()='IssnL' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/IssnL']) and rdf:value/text()] |        bf:Instance/bf:identifiedBy/*[(local-name()='IssnL' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/IssnL']) and rdf:value/text()]" mode="generate-023">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='Isrc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isrc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Upc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Upc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Ismn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ismn']] |       bf:Instance/bf:identifiedBy/*[local-name()='Ean' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ean']] |       bf:Instance/bf:identifiedBy/*[local-name()='Sici' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Sici']] |       bf:Instance/bf:identifiedBy/*[local-name()='Ansi' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ansi']] |       bf:Instance/bf:identifiedBy/*[local-name()='Doi' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Doi']] |       bf:Work/bf:identifiedBy/*[local-name()='Eidr' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/Eidr'] or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Eidr']] |       bf:Instance/bf:identifiedBy/*[local-name()='Gtin14Number' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Gtin14Number']] |       bf:Instance/bf:identifiedBy/*[local-name()='Hdl' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hdl']] |       bf:Instance/bf:identifiedBy/*[local-name()='Isan' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isan']] |       bf:Instance/bf:identifiedBy/*[local-name()='Isni' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isni']] |       bf:Instance/bf:identifiedBy/*[local-name()='Iso' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Iso']] |       bf:Instance/bf:identifiedBy/*[local-name()='Istc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Istc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Iswc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Iswc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Urn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Urn']] |       bf:Instance/bf:identifiedBy/bf:Identifier[not(rdf:type or bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dgpo' or bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dgpo')]" mode="generate-024">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='LcOverseasAcq' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/LcOverseasAcq']] |                     //bf:Item/bf:identifiedBy/*[local-name()='LcOverseasAcq' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/LcOverseasAcq']]" mode="generate-025">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='Fingerprint' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Fingerprint']]|                     //bf:Item/bf:identifiedBy/*[local-name()='Fingerprint' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Fingerprint']]" mode="generate-026">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='Strn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Strn']]" mode="generate-027">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[(local-name()='AudioIssueNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AudioIssueNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MatrixNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MatrixNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MusicPlate' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicPlate']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MusicPublisherNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicPublisherNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='VideoRecordingNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VideoRecordingNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='PublisherNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/PublisherNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MusicDistributorNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicDistributorNumber']) and rdf:value/text()]" mode="generate-028">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='Coden' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Coden']]" mode="generate-030">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='PostalRegistration' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/PostalRegistration']]" mode="generate-032">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:capture/bf:Capture[bf:date[@rdf:datatype='http://id.loc.gov/datatypes/edtf'] or bf:place/@rdf:resource]" mode="generate-033">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:scale/bf:Scale[starts-with(rdfs:label,'linear') or starts-with(rdfs:label,'angular')]" mode="generate-034">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[(local-name()='Local' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local']) and bf:assigner]" mode="generate-035">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[(local-name()='OclcNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/OclcNumber']) and rdf:value]" mode="generate-035">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='StudyNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/StudyNumber']]" mode="generate-036">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:acquisitionSource/bf:AcquisitionSource |                     //bf:Item/bf:acquisitionSource/bf:AcquisitionSource" mode="generate-037">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:choose>
        <xsl:when test="$vAdminMetadata/bflc:metadataLicensor">
          <marc:datafield>
            <xsl:attribute name="tag">038</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:variable name="v038-a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="$vAdminMetadata/bflc:metadataLicensor/bflc:MetadataLicensor/rdfs:label|$vAdminMetadata/bflc:metadataLicensor/*[local-name()='Authority' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]/madsrdf:code[@rdf:datatype='http://id.loc.gov/datatypes/orgs/code']"/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:if test="$v038-a != ''">
              <marc:subfield code="a">
                <xsl:value-of select="$v038-a"/>
              </marc:subfield>
            </xsl:if>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$vAdminMetadata[bf:descriptionLevel or bf:descriptionConventions or bflc:encodingLevel]">
          <marc:datafield>
            <xsl:attribute name="tag">040</xsl:attribute>
            <xsl:variable name="vLanguageUri">
              <xsl:choose>
                <xsl:when test="$vAdminMetadata[bf:descriptionLevel or bf:descriptionConventions or bflc:encodingLevel]/bf:descriptionLanguage/@rdf:resource">
                  <xsl:value-of select="$vAdminMetadata/bf:descriptionLanguage/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="$vAdminMetadata[bf:descriptionLevel or bf:descriptionConventions or bflc:encodingLevel]/bf:descriptionLanguage/*/@rdf:about">
                  <xsl:value-of select="$vAdminMetadata/bf:descriptionLanguage/*/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="df040sfsPreNS">
              <xsl:choose>
                <xsl:when test="$vAdminMetadata/bflc:marcKey[starts-with(., '040')]">
                  <xsl:call-template name="tParseMarcKey">
                    <xsl:with-param name="pString" select="substring($vAdminMetadata/bflc:marcKey[starts-with(., '040')], 6)"/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:when test="$vAdminMetadata/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/internal']/rdfs:label[starts-with(., '040')]">
                  <xsl:call-template name="tParseMarcKey">
                    <xsl:with-param name="pString" select="substring($vAdminMetadata/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/internal']/rdfs:label[starts-with(., '040')], 6)"/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="df040sfs" select="exsl:node-set($df040sfsPreNS)"/>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:variable name="vAuri">
              <xsl:choose>
                <xsl:when test="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]/bf:agent//@rdf:*">
                  <xsl:value-of select="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]/bf:agent//@rdf:*[1]"/>
                </xsl:when>
                <xsl:when test="$vAdminMetadata/bf:assigner/@rdf:resource">
                  <xsl:value-of select="$vAdminMetadata/bf:assigner/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="$vAdminMetadata/bf:assigner/*/@rdf:about">
                  <xsl:value-of select="$vAdminMetadata/bf:assigner/*/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vAcode">
              <xsl:choose>
                <xsl:when test="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]/bf:agent//bf:code">
                  <xsl:value-of select="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]/bf:agent//bf:code"/>
                </xsl:when>
                <xsl:when test="$vAdminMetadata/bf:assigner/*/*[local-name()='code']">
                  <xsl:value-of select="$vAdminMetadata/bf:assigner/*/*[local-name()='code']"/>
                </xsl:when>
                <xsl:when test="$vAuri != '' and contains($vAuri,'id.loc.gov')">
                  <xsl:call-template name="tUriCode">
                    <xsl:with-param name="pUri" select="$vAuri"/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vAcode = 'dlc'">
                <xsl:variable name="v040-a">
                  <xsl:value-of select="translate($vAcode,$lower,$upper)"/>
                </xsl:variable>
                <xsl:if test="$v040-a != ''">
                  <marc:subfield code="a">
                    <xsl:value-of select="$v040-a"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
              <xsl:when test="$vAcode != ''">
                <xsl:variable name="v040-a">
                  <xsl:value-of select="$vAcode"/>
                </xsl:variable>
                <xsl:if test="$v040-a != ''">
                  <marc:subfield code="a">
                    <xsl:value-of select="$v040-a"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
            </xsl:choose>
            <xsl:choose>
              <xsl:when test="$vLanguageUri != '' and contains($vLanguageUri,'id.loc.gov')">
                <xsl:variable name="v040-b">
                  <xsl:call-template name="tUriCode">
                    <xsl:with-param name="pUri" select="$vLanguageUri"/>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:if test="$v040-b != ''">
                  <marc:subfield code="b">
                    <xsl:value-of select="$v040-b"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
              <xsl:when test="$vAdminMetadata[bf:descriptionConventions or bflc:encodingLevel]/bf:descriptionLanguage/*/*[local-name()='code']">
                <xsl:variable name="v040-b">
                  <xsl:value-of select="$vAdminMetadata[bf:descriptionConventions or bflc:encodingLevel]/bf:descriptionLanguage/*/*[local-name()='code']"/>
                </xsl:variable>
                <xsl:if test="$v040-b != ''">
                  <marc:subfield code="b">
                    <xsl:value-of select="$v040-b"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
            </xsl:choose>
            <xsl:for-each select="$vAdminMetadata[bf:descriptionConventions or bflc:encodingLevel]/bf:descriptionConventions[not(contains(@rdf:resource,'isbd')) and                           not(contains(*/@rdf:about,'isbd')) and                           not(*/rdf:value='isbd') and                           not(*/*[local-name()='code']='isbd') and                           not(*/rdfs:label='isbd') and                           not(contains(@rdf:resource,'aacr')) and                           not(contains(*/@rdf:about,'aacr')) and                           not(*/rdf:value='aacr') and                           not(*/*[local-name()='code']='aacr') and                           not(*/rdfs:label='aacr')]">
              <marc:subfield code="e">
                <xsl:variable name="vConvUri">
                  <xsl:choose>
                    <xsl:when test="@rdf:resource">
                      <xsl:value-of select="@rdf:resource"/>
                    </xsl:when>
                    <xsl:when test="*/@rdf:about">
                      <xsl:value-of select="*/@rdf:about"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vConvUri != '' and contains($vConvUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vConvUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:when test="*/rdf:value">
                    <xsl:value-of select="*/rdf:value"/>
                  </xsl:when>
                  <xsl:when test="*/*[local-name()='code']">
                    <xsl:value-of select="*/*[local-name()='code']"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="*/rdfs:label"/>
                  </xsl:otherwise>
                </xsl:choose>
              </marc:subfield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$df040sfs//marc:subfield[@code='c']">
                <xsl:variable name="v040-c">
                  <xsl:value-of select="$df040sfs//marc:subfield[@code='c'][1]"/>
                </xsl:variable>
                <xsl:if test="$v040-c != ''">
                  <marc:subfield code="c">
                    <xsl:value-of select="$v040-c"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
              <xsl:when test="$vAcode = 'dlc'">
                <xsl:variable name="v040-c">
                  <xsl:value-of select="translate($vAcode,$lower,$upper)"/>
                </xsl:variable>
                <xsl:if test="$v040-c != ''">
                  <marc:subfield code="c">
                    <xsl:value-of select="$v040-c"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
              <xsl:when test="$vAcode != ''">
                <xsl:variable name="v040-c">
                  <xsl:value-of select="$vAcode"/>
                </xsl:variable>
                <xsl:if test="$v040-c != ''">
                  <marc:subfield code="c">
                    <xsl:value-of select="$v040-c"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
            </xsl:choose>
            <xsl:choose>
              <xsl:when test="count($vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/c']]) &gt; 0">
                <xsl:variable name="modifierCodePreNS">
                  <marc:codes>
                    <xsl:for-each select="$df040sfs//marc:subfield[@code='d' and .!='']">
                      <marc:modifierCode>
                        <xsl:value-of select="."/>
                      </marc:modifierCode>
                    </xsl:for-each>
                    <xsl:for-each select="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/c']]">
                      <xsl:sort select="bf:date" data-type="text" order="ascending"/>
                      <xsl:variable name="mCode">
                        <xsl:choose>
                          <xsl:when test="bf:descriptionModifier//bf:code">
                            <xsl:value-of select="bf:descriptionModifier//bf:code"/>
                          </xsl:when>
                          <xsl:when test="bf:agent//bf:code">
                            <xsl:value-of select="bf:agent//bf:code"/>
                          </xsl:when>
                          <xsl:when test="bf:descriptionModifier//@rdf:*[1]">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="bf:descriptionModifier//@rdf:*[1]"/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:when test="bf:agent//@rdf:*[1]">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="bf:agent//@rdf:*[1]"/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:when test="preceding::bf:AdminMetadata//bf:descriptionModifier//bf:code">
                            <xsl:value-of select="preceding::bf:AdminMetadata//bf:descriptionModifier//bf:code"/>
                          </xsl:when>
                          <xsl:when test="preceding::bf:AdminMetadata//bf:agent//bf:code">
                            <xsl:value-of select="preceding::bf:AdminMetadata//bf:agent//bf:code"/>
                          </xsl:when>
                          <xsl:when test="preceding::bf:AdminMetadata//bf:descriptionModifier//@rdf:*[1]">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="preceding::bf:AdminMetadata//bf:descriptionModifier//@rdf:*[1]"/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:when test="preceding::bf:AdminMetadata//bf:agent//@rdf:*[1]">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="preceding::bf:AdminMetadata//bf:agent//@rdf:*[1]"/>
                            </xsl:call-template>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$mCode != ''">
                        <marc:modifierCode>
                          <xsl:choose>
                            <xsl:when test="$mCode = 'dlc'">DLC</xsl:when>
                            <xsl:when test="$mCode = 'dlcmrc'">DLC-MRC</xsl:when>
                            <xsl:otherwise>
                              <xsl:value-of select="$mCode"/>
                            </xsl:otherwise>
                          </xsl:choose>
                        </marc:modifierCode>
                      </xsl:if>
                    </xsl:for-each>
                  </marc:codes>
                </xsl:variable>
                <xsl:variable name="modifierCodes" select="exsl:node-set($modifierCodePreNS)"/>
                <xsl:for-each select="$modifierCodes//marc:modifierCode[not(.=preceding::*[1])]">
                  <marc:subfield code="d">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="count($vAdminMetadata/bf:descriptionModifier) &gt; 0">
                <xsl:variable name="vLastAgentUri">
                  <xsl:choose>
                    <xsl:when test="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/@rdf:resource">
                      <xsl:value-of select="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/@rdf:resource"/>
                    </xsl:when>
                    <xsl:when test="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/*/@rdf:about">
                      <xsl:value-of select="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/*/@rdf:about"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vModifierCode">
                  <xsl:choose>
                    <xsl:when test="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/*/*[local-name()='code']">
                      <xsl:value-of select="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/*/*[local-name()='code']"/>
                    </xsl:when>
                    <xsl:when test="$vLastAgentUri != '' and contains($vLastAgentUri,'id.loc.gov')">
                      <xsl:call-template name="tUriCode">
                        <xsl:with-param name="pUri" select="$vLastAgentUri"/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="$vAdminMetadata/bf:descriptionModifier[count($vAdminMetadata/bf:descriptionModifier)]/*/*[local-name()='code']"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vModifierCode = 'dlc'">
                    <xsl:variable name="v040-d">
                      <xsl:value-of select="translate($vModifierCode,$lower,$upper)"/>
                    </xsl:variable>
                    <xsl:if test="$v040-d != ''">
                      <marc:subfield code="d">
                        <xsl:value-of select="$v040-d"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="$vModifierCode != ''">
                    <xsl:variable name="v040-d">
                      <xsl:value-of select="$vModifierCode"/>
                    </xsl:variable>
                    <xsl:if test="$v040-d != ''">
                      <marc:subfield code="d">
                        <xsl:value-of select="$v040-d"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages') and not(contains(., '/zxx'))] or                  bf:Work/bf:language/*/*[not(bf:source)]">
          <xsl:variable name="vAllLangElements" select="         bf:Work/bf:language/@rdf:resource[contains(., 'id.loc.gov/vocabulary/languages')] |         bf:Work/bf:language/bf:Language[not(bf:source) and not(bf:part)]//@rdf:about[contains(., 'id.loc.gov/vocabulary/languages')] |          bf:Work/bf:language/bf:Language[not(bf:source) and not(bf:part) and not(@rdf:about)] |          bf:Work/bf:language/bf:Language[not(bf:source) and bf:part] |         bf:Work/bf:accompaniedBy/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages')][1] |         bf:Work/bf:note/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages')][1]         "/>
          <xsl:choose>
            <xsl:when test="count($vAllLangElements) &gt; 1">
              <marc:datafield>
                <xsl:attribute name="tag">041</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="bf:Work/bf:note/bf:Note/rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/resourceComponents/otx'">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                      <xsl:when test="bf:Work/bf:note/bf:Note/rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/resourceComponents/sub'">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                      <xsl:when test="bf:Work/bf:note/bf:Note/rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/resourceComponents/itr'">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                      <xsl:when test="bf:Work/bf:note/bf:Note[rdfs:label='Includes translation or is translation']">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                      <xsl:when test="bf:Work/bf:note/bf:Note[rdfs:label='Includes translation']">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text>0</xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:variable name="vLangElements" select="bf:Work/bf:language/@rdf:resource[contains(., 'id.loc.gov/vocabulary/languages')] |                                                      bf:Work/bf:language/bf:Language[not(bf:source) and not(bf:part)]//@rdf:about[contains(., 'id.loc.gov/vocabulary/languages')] |                                                       bf:Work/bf:language/bf:Language[not(bf:source) and not(bf:part) and not(@rdf:about)] |                                                       bf:Work/bf:language/bf:Language[not(bf:source) and bf:part]"/>
                <xsl:variable name="vFirstLangCode">
                  <xsl:choose>
                    <xsl:when test="starts-with($vLangElements[1],'http://id.loc.gov/vocabulary/languages/')">
                      <xsl:value-of select="substring-after($vLangElements[1],'http://id.loc.gov/vocabulary/languages/')"/>
                    </xsl:when>
                    <xsl:when test="$vLangElements[1]/madsrdf:code">
                      <xsl:value-of select="$vLangElements[1]/madsrdf:code"/>
                    </xsl:when>
                    <xsl:when test="starts-with($vLangElements[1]/rdf:value,'http://id.loc.gov/vocabulary/languages/')">
                      <xsl:value-of select="substring-after($vLangElements[1]/rdf:value,'http://id.loc.gov/vocabulary/languages/')"/>
                    </xsl:when>
                    <xsl:when test="starts-with($vLangElements[1]/rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                      <xsl:value-of select="substring-after($vLangElements[1]/rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')"/>
                    </xsl:when>
                    <xsl:when test="$vLangElements[1]/rdf:value">
                      <xsl:value-of select="$vLangElements[1]/rdf:value"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="$vLangElements[1]/rdfs:label"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:for-each select="$vAllLangElements">
                  <xsl:choose>
                    <xsl:when test="position() = 1 and $vFirstLangCode!='zxx'">
                      <marc:subfield code="a">
                        <xsl:value-of select="$vFirstLangCode"/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:when test="position() = 1 and $vFirstLangCode='zxx'"/>
                    <xsl:otherwise>
                      <xsl:variable name="vLangCode">
                        <xsl:choose>
                          <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/languages/')">
                            <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/languages/')"/>
                          </xsl:when>
                          <xsl:when test="madsrdf:code">
                            <xsl:value-of select="madsrdf:code"/>
                          </xsl:when>
                          <xsl:when test="starts-with(rdf:value,'http://id.loc.gov/vocabulary/languages/')">
                            <xsl:value-of select="substring-after(rdf:value,'http://id.loc.gov/vocabulary/languages/')"/>
                          </xsl:when>
                          <xsl:when test="starts-with(rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                            <xsl:value-of select="substring-after(rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')"/>
                          </xsl:when>
                          <xsl:when test="rdf:value">
                            <xsl:value-of select="rdf:value"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="rdfs:label"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$vLangCode != ''">
                        <xsl:variable name="vtype" select="ancestor::bf:accompaniedBy/bf:*/rdf:type/@rdf:resource[contains(., 'id.loc.gov/vocabulary/resourceComponents')]|ancestor::bf:note/bf:*/rdf:type/@rdf:resource[contains(., 'id.loc.gov/vocabulary/resourceComponents')]"/>
                        <xsl:variable name="vSFcode">
                          <xsl:choose>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/res'">a</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/str'">a</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/sum'">b</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/stx'">d</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/lib'">e</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/toc'">f</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/amt'">g</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/otx'">h</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/int'">i</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/sub'">j</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/itr'">k</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/olb'">n</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/amt'">m</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/cap'">p</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/aud'">q</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/vis'">r</xsl:when>
                            <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/tav'">t</xsl:when>
                            <xsl:when test="bf:part='summary'">b</xsl:when>
                            <xsl:when test="bf:part='sung or spoken text'">d</xsl:when>
                            <xsl:when test="bf:part='libretto'">e</xsl:when>
                            <xsl:when test="bf:part='table of contents'">f</xsl:when>
                            <xsl:when test="bf:part='accompanying material'">g</xsl:when>
                            <xsl:when test="bf:part='original'">h</xsl:when>
                            <xsl:when test="bf:part='intertitles'">i</xsl:when>
                            <xsl:when test="bf:part='subtitles or captions'">j</xsl:when>
                            <xsl:when test="bf:part='intermediate translations'">k</xsl:when>
                            <xsl:when test="bf:part='original accompanying materials'">m</xsl:when>
                            <xsl:when test="bf:part='original libretto'">n</xsl:when>
                            <xsl:when test="bf:part='captions'">p</xsl:when>
                            <xsl:when test="bf:part='accessible audio'">q</xsl:when>
                            <xsl:when test="bf:part='accessible visual material'">r</xsl:when>
                            <xsl:when test="bf:part='accompanying transcripts'">t</xsl:when>
                            <xsl:otherwise>a</xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <marc:subfield>
                          <xsl:attribute name="code">
                            <xsl:value-of select="$vSFcode"/>
                          </xsl:attribute>
                          <xsl:value-of select="$vLangCode"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="(                   bf:Work/bf:accompaniedBy/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages')] or                    bf:Work/bf:note/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages')]                 ) and                  not(bf:Work/bf:language)">
          <marc:datafield>
            <xsl:attribute name="tag">041</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:variable name="vInd">
                <xsl:choose>
                  <xsl:when test="bf:Work/bf:note/bf:Note/rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/resourceComponents/otx'">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:note/bf:Note/rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/resourceComponents/sub'">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:note/bf:Note/rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/resourceComponents/itr'">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:note/bf:Note[rdfs:label='Includes translation or is translation']">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:note/bf:Note[rdfs:label='Includes translation']">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vInd != ''">
                  <xsl:value-of select="$vInd"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>0</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:for-each select="                   bf:Work/bf:accompaniedBy/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages')] |                    bf:Work/bf:note/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/languages')]">
              <xsl:variable name="vLangCode">
                <xsl:choose>
                  <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/languages/')">
                    <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/languages/')"/>
                  </xsl:when>
                  <xsl:when test="madsrdf:code">
                    <xsl:value-of select="madsrdf:code"/>
                  </xsl:when>
                  <xsl:when test="starts-with(rdf:value,'http://id.loc.gov/vocabulary/languages/')">
                    <xsl:value-of select="substring-after(rdf:value,'http://id.loc.gov/vocabulary/languages/')"/>
                  </xsl:when>
                  <xsl:when test="starts-with(rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                    <xsl:value-of select="substring-after(rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')"/>
                  </xsl:when>
                  <xsl:when test="rdf:value">
                    <xsl:value-of select="rdf:value"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="rdfs:label"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$vLangCode != ''">
                <xsl:variable name="vtype" select="ancestor::bf:accompaniedBy/bf:*/rdf:type/@rdf:resource[contains(., 'id.loc.gov/vocabulary/resourceComponents')]|ancestor::bf:note/bf:*/rdf:type/@rdf:resource[contains(., 'id.loc.gov/vocabulary/resourceComponents')]"/>
                <xsl:variable name="vSFcode">
                  <xsl:choose>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/res'">a</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/str'">a</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/sum'">b</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/stx'">d</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/lib'">e</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/toc'">f</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/amt'">g</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/otx'">h</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/int'">i</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/sub'">j</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/itr'">k</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/olb'">n</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/amt'">m</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/cap'">p</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/aud'">q</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/vis'">r</xsl:when>
                    <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/tav'">t</xsl:when>
                    <xsl:when test="bf:part='summary'">b</xsl:when>
                    <xsl:when test="bf:part='sung or spoken text'">d</xsl:when>
                    <xsl:when test="bf:part='libretto'">e</xsl:when>
                    <xsl:when test="bf:part='table of contents'">f</xsl:when>
                    <xsl:when test="bf:part='accompanying material'">g</xsl:when>
                    <xsl:when test="bf:part='original'">h</xsl:when>
                    <xsl:when test="bf:part='intertitles'">i</xsl:when>
                    <xsl:when test="bf:part='subtitles or captions'">j</xsl:when>
                    <xsl:when test="bf:part='intermediate translations'">k</xsl:when>
                    <xsl:when test="bf:part='original accompanying materials'">m</xsl:when>
                    <xsl:when test="bf:part='original libretto'">n</xsl:when>
                    <xsl:when test="bf:part='captions'">p</xsl:when>
                    <xsl:when test="bf:part='accessible audio'">q</xsl:when>
                    <xsl:when test="bf:part='accessible visual material'">r</xsl:when>
                    <xsl:when test="bf:part='accompanying transcripts'">t</xsl:when>
                    <xsl:otherwise>a</xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="$vSFcode"/>
                  </xsl:attribute>
                  <xsl:value-of select="$vLangCode"/>
                </marc:subfield>
              </xsl:if>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="         bf:Work/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')] or          bf:Work/bf:language/*/bf:source or          bf:Work/bf:accompaniedBy/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')] or         bf:Work/bf:note/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')]         ">
          <marc:datafield>
            <xsl:attribute name="tag">041</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:variable name="vInd">
                <xsl:choose>
                  <xsl:when test="bf:Work/bf:note/bf:Note[rdfs:label='Includes translation or is translation']">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:note/bf:Note[rdfs:label='Includes translation']">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vInd != ''">
                  <xsl:value-of select="$vInd"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>0</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text>7</xsl:text>
            </xsl:attribute>
            <xsl:variable name="vLangElements" select="             bf:Work/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')] |             bf:Work/bf:language/bf:Language[bf:source and not(bf:part)]//@rdf:about[not(contains(., 'id.loc.gov/vocabulary/'))] |              bf:Work/bf:language/bf:Language[bf:source] |              bf:Work/bf:language/bf:Language[bf:source and bf:part]"/>
            <xsl:variable name="vFirstLangCode">
              <xsl:choose>
                <xsl:when test="starts-with($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-1/')">
                  <xsl:value-of select="substring-after($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-1/')"/>
                </xsl:when>
                <xsl:when test="starts-with($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-2/')">
                  <xsl:value-of select="substring-after($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-2/')"/>
                </xsl:when>
                <xsl:when test="starts-with($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-3/')">
                  <xsl:value-of select="substring-after($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-3/')"/>
                </xsl:when>
                <xsl:when test="starts-with($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-5/')">
                  <xsl:value-of select="substring-after($vLangElements[1],'http://id.loc.gov/vocabulary/iso639-5/')"/>
                </xsl:when>
                <xsl:when test="$vLangElements[1]/madsrdf:code">
                  <xsl:value-of select="$vLangElements[1]/madsrdf:code"/>
                </xsl:when>
                <xsl:when test="starts-with($vLangElements[1]/rdf:value,'http://id.loc.gov/vocabulary/languages/')">
                  <xsl:value-of select="substring-after($vLangElements[1]/rdf:value,'http://id.loc.gov/vocabulary/languages/')"/>
                </xsl:when>
                <xsl:when test="starts-with($vLangElements[1]/rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                  <xsl:value-of select="substring-after($vLangElements[1]/rdf:value/@rdf:resource,'http://id.loc.gov/vocabulary/languages/')"/>
                </xsl:when>
                <xsl:when test="$vLangElements[1]/rdf:value">
                  <xsl:value-of select="$vLangElements[1]/rdf:value"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="$vLangElements[1]/rdfs:label"/>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:for-each select="$vLangElements|             bf:Work/bf:accompaniedBy/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')][1] |             bf:Work/bf:note/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')][1]">
              <xsl:choose>
                <xsl:when test="position() = 1 and $vFirstLangCode!=''">
                  <marc:subfield code="a">
                    <xsl:value-of select="$vFirstLangCode"/>
                  </marc:subfield>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:variable name="vLangCode">
                    <xsl:choose>
                      <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/iso639-1/')">
                        <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/iso639-1/')"/>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/iso639-2/')">
                        <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/iso639-2/')"/>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/iso639-3/')">
                        <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/iso639-3/')"/>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/iso639-5/')">
                        <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/iso639-5/')"/>
                      </xsl:when>
                      <xsl:when test="madsrdf:code">
                        <xsl:value-of select="madsrdf:code"/>
                      </xsl:when>
                      <xsl:when test="rdf:value">
                        <xsl:value-of select="rdf:value"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="rdfs:label"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$vLangCode != ''">
                    <xsl:variable name="vtype" select="ancestor::bf:accompaniedBy/bf:*/rdf:type/@rdf:resource[contains(., 'id.loc.gov/vocabulary/resourceComponents')]|ancestor::bf:note/bf:*/rdf:type/@rdf:resource[contains(., 'id.loc.gov/vocabulary/resourceComponents')]"/>
                    <xsl:variable name="vSFcode">
                      <xsl:choose>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/res'">a</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/str'">a</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/sum'">b</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/stx'">d</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/lib'">e</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/toc'">f</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/amt'">g</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/otx'">h</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/int'">i</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/sub'">j</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/itr'">k</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/olb'">n</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/amt'">m</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/olb'">p</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/aud'">q</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/vis'">r</xsl:when>
                        <xsl:when test="$vtype='http://id.loc.gov/vocabulary/resourceComponents/tav'">t</xsl:when>
                        <xsl:when test="bf:part='summary'">b</xsl:when>
                        <xsl:when test="bf:part='sung or spoken text'">d</xsl:when>
                        <xsl:when test="bf:part='libretto'">e</xsl:when>
                        <xsl:when test="bf:part='table of contents'">f</xsl:when>
                        <xsl:when test="bf:part='accompanying material'">g</xsl:when>
                        <xsl:when test="bf:part='original'">h</xsl:when>
                        <xsl:when test="bf:part='intertitles'">i</xsl:when>
                        <xsl:when test="bf:part='subtitles or captions'">j</xsl:when>
                        <xsl:when test="bf:part='intermediate translations'">k</xsl:when>
                        <xsl:when test="bf:part='original accompanying materials'">m</xsl:when>
                        <xsl:when test="bf:part='original libretto'">n</xsl:when>
                        <xsl:when test="bf:part='captions'">p</xsl:when>
                        <xsl:when test="bf:part='accessible audio'">q</xsl:when>
                        <xsl:when test="bf:part='accessible visual material'">r</xsl:when>
                        <xsl:when test="bf:part='accompanying transcripts'">t</xsl:when>
                        <xsl:otherwise>a</xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="$vSFcode"/>
                      </xsl:attribute>
                      <xsl:value-of select="$vLangCode"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
            <xsl:variable name="vSourceLang" select="bf:Work/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')]|                                        bf:Work/bf:accompaniedBy/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')] |                                        bf:Work/bf:note/bf:*[contains(rdf:type/@rdf:resource, 'id.loc.gov/vocabulary/resourceComponents')]/bf:language//@rdf:*[contains(., 'id.loc.gov/vocabulary/iso639-')] |                                        bf:Work/bf:language/bf:Language[bf:source//@rdf:*[not(contains(., 'id.loc.gov/vocabulary/'))]]|                                        bf:Work/bf:language/bf:Language[bf:source]"/>
            <xsl:variable name="vSourceUri">
              <xsl:choose>
                <xsl:when test="contains($vSourceLang[1], 'id.loc.gov/vocabulary/iso639-')">
                  <xsl:value-of select="$vSourceLang[1]"/>
                </xsl:when>
                <xsl:when test="$vSourceLang[1]/bf:source/@rdf:resource">
                  <xsl:value-of select="$vSourceLang[1]/bf:source/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="$vSourceLang[1]/bf:source/bf:Source/@rdf:about">
                  <xsl:value-of select="$vSourceLang[1]/bf:source/bf:Source/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <marc:subfield code="2">
              <xsl:choose>
                <xsl:when test="$vSourceUri != ''">
                  <xsl:choose>
                    <xsl:when test="contains($vSourceUri,'id.loc.gov/vocabulary/iso639-1')">iso639-1</xsl:when>
                    <xsl:when test="contains($vSourceUri,'id.loc.gov/vocabulary/iso639-2')">iso639-2</xsl:when>
                    <xsl:when test="contains($vSourceUri,'id.loc.gov/vocabulary/iso639-3')">iso639-3</xsl:when>
                  </xsl:choose>
                </xsl:when>
                <xsl:when test="$vSourceLang[1]/bf:source/bf:Source/*[local-name()='code']">
                  <xsl:value-of select="$vSourceLang[1]/bf:source/bf:Source/*[local-name()='code']"/>
                </xsl:when>
                <xsl:when test="$vSourceLang[1]/bf:source/madsrdf:Authority/*[local-name()='code']">
                  <xsl:value-of select="$vSourceLang[1]/bf:source/madsrdf:Authority/*[local-name()='code']"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="$vSourceLang[1]/bf:source/bf:Source/rdfs:label"/>
                  </xsl:call-template>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$vAdminMetadata/bf:descriptionAuthentication">
          <marc:datafield>
            <xsl:attribute name="tag">042</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:for-each select="$vAdminMetadata/bf:descriptionAuthentication">
              <marc:subfield code="a">
                <xsl:choose>
                  <xsl:when test="*/rdf:value">
                    <xsl:value-of select="*/rdf:value"/>
                  </xsl:when>
                  <xsl:when test="*/*[local-name()='code']">
                    <xsl:value-of select="*/*[local-name()='code']"/>
                  </xsl:when>
                  <xsl:when test="starts-with(*/@rdf:about,'http://id.loc.gov/vocabulary/marcauthen/')">
                    <xsl:value-of select="substring-after(*/@rdf:about,'http://id.loc.gov/vocabulary/marcauthen/')"/>
                  </xsl:when>
                  <xsl:when test="starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/marcauthen/')">
                    <xsl:value-of select="substring-after(@rdf:resource,'http://id.loc.gov/vocabulary/marcauthen/')"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: missing value from bf:descriptionAuthentication property</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </marc:subfield>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:apply-templates select="bf:Work/bf:geographicCoverage[                       contains(@rdf:resource,'id.loc.gov/vocabulary/geographicAreas') or                       contains(bf:GeographicCoverage/@rdf:about,'id.loc.gov/vocabulary/geographicAreas') or                        bf:GeographicCoverage/madsrdf:code or                       bf:GeographicCoverage/bf:code or                       madsrdf:Geographic/madsrdf:code or                        bf:GeographicCoverage/rdf:value]" mode="generate-043">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:temporalCoverage">
          <marc:datafield>
            <xsl:attribute name="tag">045</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:variable name="vInd">
                <xsl:choose>
                  <xsl:when test="count(bf:Work/bf:temporalCoverage[(@rdf:datatype='http://id.loc.gov/datatypes/edtf' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime') and not(contains(.,'X')) and not (contains(.,'/'))]) = 1">
                    <xsl:text>0</xsl:text>
                  </xsl:when>
                  <xsl:when test="count(bf:Work/bf:temporalCoverage[(@rdf:datatype='http://id.loc.gov/datatypes/edtf' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime') and not(contains(.,'X')) and not (contains(.,'/'))]) &gt; 1">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:when test="count(bf:Work/bf:temporalCoverage[(@rdf:datatype='http://id.loc.gov/datatypes/edtf' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime') and not(contains(.,'X')) and contains(.,'/')]) = 1">
                    <xsl:text>2</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vInd != ''">
                  <xsl:value-of select="$vInd"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text> </xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:for-each select="bf:Work/bf:temporalCoverage[@rdf:datatype='http://id.loc.gov/datatypes/edtf' and contains(.,'X')]">
              <marc:subfield code="a">
                <xsl:choose>
                  <xsl:when test="contains(.,'/')">
                    <xsl:variable name="v045Date1">
                      <xsl:variable name="vDate1">
                        <xsl:call-template name="EDTF-Date1">
                          <xsl:with-param name="pEDTFDate" select="."/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="starts-with($vDate1,'-')">
                          <xsl:value-of select="exsl:node-set($df045BCEtimePeriods)/*[edtfDate=$vDate1]/code"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:variable name="vCentury" select="exsl:node-set($df045CEtimePeriods)/*[century=substring($vDate1,1,2)]/code"/>
                          <xsl:variable name="vDecade">
                            <xsl:choose>
                              <xsl:when test="substring($vDate1,3,1)='X'">-</xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="substring($vDate1,3,1)"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:variable>
                          <xsl:value-of select="concat($vCentury,$vDecade)"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="v045Date2">
                      <xsl:variable name="vDate2">
                        <xsl:call-template name="EDTF-Date2">
                          <xsl:with-param name="pEDTFDate" select="."/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="starts-with($vDate2,'-')">
                          <xsl:value-of select="exsl:node-set($df045BCEtimePeriods)/*[edtfDate=$vDate2]/code"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:variable name="vCentury" select="exsl:node-set($df045CEtimePeriods)/*[century=substring($vDate2,1,2)]/code"/>
                          <xsl:variable name="vDecade">
                            <xsl:choose>
                              <xsl:when test="substring($vDate2,3,1)='X'">-</xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="substring($vDate2,3,1)"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:variable>
                          <xsl:value-of select="concat($vCentury,$vDecade)"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:value-of select="concat($v045Date1,$v045Date2)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:choose>
                      <xsl:when test="starts-with(.,'-')">
                        <xsl:variable name="vEdtfDate" select="."/>
                        <xsl:value-of select="concat(exsl:node-set($df045BCEtimePeriods)/*[edtfDate=$vEdtfDate]/code,exsl:node-set($df045BCEtimePeriods)/*[edtfDate=$vEdtfDate]/code)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="vEdtfDate" select="."/>
                        <xsl:variable name="vCentury" select="exsl:node-set($df045CEtimePeriods)/*[century=substring($vEdtfDate,1,2)]/code"/>
                        <xsl:choose>
                          <xsl:when test="substring($vEdtfDate,3,1)='X'">
                            <xsl:value-of select="concat($vCentury,'-',$vCentury,'-')"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="concat($vCentury,substring($vEdtfDate,3,1),$vCentury,substring($vEdtfDate,3,1))"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:otherwise>
                </xsl:choose>
              </marc:subfield>
            </xsl:for-each>
            <xsl:for-each select="bf:Work/bf:temporalCoverage[not(contains(.,'X'))]">
              <xsl:choose>
                <xsl:when test="@rdf:datatype='http://id.loc.gov/datatypes/edtf' and contains(.,'/')">
                  <xsl:variable name="vDate1">
                    <xsl:call-template name="EDTF-Date1">
                      <xsl:with-param name="pEDTFDate" select="."/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:variable name="vDate2">
                    <xsl:call-template name="EDTF-Date2">
                      <xsl:with-param name="pEDTFDate" select="."/>
                    </xsl:call-template>
                  </xsl:variable>
                  <marc:subfield code="b">
                    <xsl:choose>
                      <xsl:when test="substring($vDate1,1,1) = '-'">
                        <xsl:value-of select="concat('c',translate($vDate1,' -:T',''))"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="concat('d',translate($vDate1,' -:T',''))"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </marc:subfield>
                  <marc:subfield code="b">
                    <xsl:choose>
                      <xsl:when test="substring($vDate2,1,1) = '-'">
                        <xsl:value-of select="concat('c',translate($vDate2,' -:T',''))"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="concat('d',translate($vDate2,' -:T',''))"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </marc:subfield>
                </xsl:when>
                <xsl:when test="(@rdf:datatype='http://id.loc.gov/datatypes/edtf' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime') and not (contains(.,'/'))">
                  <marc:subfield code="b">
                    <xsl:choose>
                      <xsl:when test="substring(.,1,1) = '-'">
                        <xsl:value-of select="concat('c',translate(.,' -:T',''))"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="concat('d',translate(.,' -:T',''))"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </marc:subfield>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: no datatype for bf:temporalCoverage predicate, putting unformatted string into 045 $b</xsl:message>
                  <marc:subfield code="b">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bf:Work/bf:originDate[@rdf:datatype='http://id.loc.gov/datatypes/edtf']">
        <xsl:variable name="vCF008PreNS">
          <xsl:apply-templates select="ancestor::rdf:RDF" mode="generate-008">
            <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
          </xsl:apply-templates>
        </xsl:variable>
        <xsl:variable name="vCF008" select="exsl:node-set($vCF008PreNS)"/>
        <xsl:variable name="vDateType">
          <xsl:value-of select="substring($vCF008, 7, 1)"/>
        </xsl:variable>
        <xsl:variable name="v046DateTime1">
          <xsl:call-template name="EDTF-Date1">
            <xsl:with-param name="pEDTFDate" select="."/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="v046DateTime2">
          <xsl:call-template name="EDTF-Date2">
            <xsl:with-param name="pEDTFDate" select="."/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="v046Date1">
          <xsl:call-template name="EDTF-DatePart">
            <xsl:with-param name="pEDTFDate" select="$v046DateTime1"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="v046Time1">
          <xsl:call-template name="EDTF-TimePart">
            <xsl:with-param name="pEDTFDate" select="$v046DateTime1"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vDateType != 'r'">
            <marc:datafield>
              <xsl:attribute name="tag">046</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v046-k">
                <xsl:value-of select="concat(translate($v046Date1,'-',''),translate($v046Time1,':',''))"/>
              </xsl:variable>
              <xsl:if test="$v046-k != ''">
                <marc:subfield code="k">
                  <xsl:value-of select="$v046-k"/>
                </marc:subfield>
              </xsl:if>
              <xsl:choose>
                <xsl:when test="$v046DateTime2">
                  <xsl:variable name="v046-l">
                    <xsl:variable name="v046Date2">
                      <xsl:call-template name="EDTF-DatePart">
                        <xsl:with-param name="pEDTFDate" select="$v046DateTime2"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:variable name="v046Time2">
                      <xsl:call-template name="EDTF-TimePart">
                        <xsl:with-param name="pEDTFDate" select="$v046DateTime2"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:value-of select="concat(translate($v046Date2,'-',''),translate($v046Time2,':',''))"/>
                  </xsl:variable>
                  <xsl:if test="$v046-l != ''">
                    <marc:subfield code="l">
                      <xsl:value-of select="$v046-l"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:variable name="v046-2">
                <xsl:value-of select="'edtf'"/>
              </xsl:variable>
              <xsl:if test="$v046-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v046-2"/>
                </marc:subfield>
              </xsl:if>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:instrument/bf:MusicInstrument or       bf:Work/bf:ensemble/bf:MusicEnsemble or       bf:Work/bf:voice/bf:MusicVoice">
          <marc:datafield>
            <xsl:attribute name="tag">048</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:for-each select="bf:Work/bf:instrument/bf:MusicInstrument|bf:Work/bf:ensemble/bf:MusicEnsemble|bf:Work/bf:voice/bf:MusicVoice">
              <xsl:variable name="v048-a">
                <xsl:variable name="vType">
                  <xsl:choose>
                    <xsl:when test="local-name() = 'MusicInstrument'">
                      <xsl:value-of select="bf:instrumentalType"/>
                    </xsl:when>
                    <xsl:when test="local-name() = 'MusicEnsemble'">
                      <xsl:value-of select="bf:ensembleType"/>
                    </xsl:when>
                    <xsl:when test="local-name() = 'MusicVoice'">
                      <xsl:value-of select="bf:voiceType"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vLabel">
                  <xsl:value-of select="rdfs:label"/>
                </xsl:variable>
                <xsl:variable name="vCode">
                  <xsl:choose>
                    <xsl:when test="rdfs:label and $vType != ''">
                      <xsl:choose>
                        <xsl:when test="exsl:node-set($df048performers)/performer[type=$vType and label=$vLabel]">
                          <xsl:value-of select="exsl:node-set($df048performers)/performer[type=$vType and label=$vLabel]/code"/>
                        </xsl:when>
                        <xsl:when test="exsl:node-set($df048performers)/performer[type=$vType and not(label)]">
                          <xsl:value-of select="exsl:node-set($df048performers)/performer[type=$vType and not(label)]/code"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$vType != ''">
                      <xsl:value-of select="exsl:node-set($df048performers)/performer[type=$vType and not(label)]/code"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vCount">
                  <xsl:if test="bf:count">
                    <xsl:value-of select="format-number(bf:count,'00')"/>
                  </xsl:if>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vCode != ''">
                    <xsl:value-of select="concat($vCode,$vCount)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: no 048 performer match for <xsl:value-of select="name()"/>[<xsl:value-of select="position()"/>]</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v048-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$v048-a"/>
                </marc:subfield>
              </xsl:if>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:apply-templates select="bf:Work/bf:classification/*[bf:classificationPortion/text() and (local-name()='ClassificationLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationLcc') and not(bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399' or */rdf:about='http://id.loc.gov/authorities/names/no2004037399' or */rdfs:label='Library and Archives Canada'])]" mode="generate-050">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="//bf:Item[(bf:heldBy/*[@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc' or *[local-name()='label']='United States, Library of Congress' or *[local-name()='code']='DLC'] or bf:heldBy[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc']) and bf:shelfMark/*[local-name()='ShelfMarkLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ShelfMarkLcc']]">
        <marc:datafield>
          <xsl:attribute name="tag">051</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:for-each select="bf:shelfMark/*[local-name()='ShelfMarkLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ShelfMarkLcc']/rdfs:label[. != '']">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 051 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:shelfMark/*[local-name()='ShelfMarkLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ShelfMarkLcc']/bf:note/bf:Note/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="c">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 051 $c.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
      </xsl:for-each>
      <xsl:apply-templates select="//bf:Item/bf:classification/*[bf:classificationPortion/text() and (local-name()='ClassificationLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationLcc') and not(bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399' or */rdf:about='http://id.loc.gov/authorities/names/no2004037399' or */rdfs:label='Library and Archives Canada'])]" mode="generate-051">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:geographicCoverage[contains(@rdf:resource,'id.loc.gov/authorities/classification/G') or                contains(bf:GeographicCoverage/@rdf:about,'id.loc.gov/authorities/classification/G')]" mode="generate-052">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:classification/*[(local-name()='ClassificationLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationLcc') and bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399' or */@rdf:about='http://id.loc.gov/authorities/names/no2004037399' or */rdfs:label='Library and Archives Canada']]" mode="generate-055">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:classification/*[local-name()='ClassificationNlm' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationNlm']" mode="generate-060">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:choose>
        <xsl:when test="/descendant::node()[bf:Title|bf:ProvisionActivity|bf:editionStatement|bf:Series]//@xml:lang[contains(., '-') and not(contains(., 'atn')) and not(contains(., 'hai'))]">
          <marc:datafield>
            <xsl:attribute name="tag">066</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:variable name="scriptCodesPreNS">
              <xsl:variable name="df880scriptNS" select="exsl:node-set($df880script)"/>
              <xsl:variable name="vLangs" select="//@xml:lang[contains(., '-') and not(contains(., 'atn'))]"/>
              <!-- <xsl:for-each select="$df880scriptNS/*[lang]/lang"> -->
              <marc:codes>
                <!-- Those defined in the map. -->
                <xsl:for-each select="$df880scriptNS/script/lang">
                  <xsl:variable name="vLang" select="."/>
                  <xsl:choose>
                    <xsl:when test="$vLangs[translate(.,$upper,$lower) = $vLang ]">
                      <marc:scriptCode>
                        <xsl:value-of select="../code"/>
                      </marc:scriptCode>
                    </xsl:when>
                    <xsl:when test="$vLangs[translate(substring-after(.,'-'),$upper,$lower) = $vLang ]">
                      <marc:scriptCode>
                        <xsl:value-of select="../code"/>
                      </marc:scriptCode>
                    </xsl:when>
                  </xsl:choose>
                </xsl:for-each>
                <!-- For those not defined in the map. -->
                <xsl:for-each select="$vLangs">
                  <xsl:variable name="vLang" select="translate(substring-after(.,'-'),$upper,$lower)"/>
                  <xsl:if test="count($df880scriptNS/script/lang[. = $vLang]) = 0">
                    <marc:scriptCode>
                      <xsl:value-of select="$vLang"/>
                    </marc:scriptCode>
                  </xsl:if>
                </xsl:for-each>
              </marc:codes>
            </xsl:variable>
            <xsl:variable name="scriptCodes" select="exsl:node-set($scriptCodesPreNS)"/>
            <xsl:for-each select="$scriptCodes//marc:scriptCode[not(.=preceding::*[1])]">
              <xsl:choose>
                <xsl:when test="contains(., '/')">
                  <marc:subfield code="c">
                    <xsl:value-of select="substring-before(., '/')"/>
                  </marc:subfield>
                </xsl:when>
                <xsl:otherwise>
                  <marc:subfield code="c">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:apply-templates select="bf:Work/bf:classification/bf:ClassificationNal|bf:Work/bf:classification/bf:Classification[bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnal' or                     bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dnal']" mode="generate-070">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:subject/bf:Topic[bf:code[not(@rdf:datatype) or @rdf:datatype!='http://id.loc.gov/datatypes/codes/gac'] or madsrdf:code[not(@rdf:datatype) or @rdf:datatype!='http://id.loc.gov/datatypes/codes/gac']]" mode="generate-072">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dgpo' or bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dgpo']" mode="generate-074">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:classification/*[(local-name()='ClassificationUdc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationUdc') and bf:classificationPortion/text()]" mode="generate-080">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:classification/*[(local-name()='ClassificationDdc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationDdc') and bf:classificationPortion/text()]" mode="generate-082">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:classification/bf:Classification[not(                                                                       rdf:type or                                                                        bf:assigner//@rdf:*[contains(., 'dnal')] or                                                                        bf:source//@rdf:*[contains(., 'sudocs')] or                                                                        bf:source//@rdf:*[contains(., 'cacodoc')]                                                                 )]" mode="generate-084">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="//bf:Item/bf:shelfMark/bf:ShelfMark[not(rdf:type)]" mode="generate-084">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:classification/bf:Classification[bf:source//@rdf:*[contains(., 'sudocs') or contains(., 'cacodoc')]]" mode="generate-086">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:identifiedBy/*[local-name()='ReportNumber' or rdf:type='http://id.loc.gov/ontologies/bibframe/ReportNumber']" mode="generate-088">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/bf:*[bflc:marcKey]">
        <xsl:variable name="agentURI">
          <xsl:choose>
            <xsl:when test="contains(@rdf:about,'id.loc.gov/authorities/names')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'id.loc.gov/rwo/agents')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'d-nb.info/gnd/')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vNameAuthPreNS">
          <xsl:call-template name="tGetMiniMARCFromKey">
            <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))][1]"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vNameAuth" select="exsl:node-set($vNameAuthPreNS)"/>
        <xsl:variable name="vNameTag">
          <xsl:choose>
            <xsl:when test="$vNameAuth//marc:datafield[@tag!='']">
              <xsl:choose>
                <xsl:when test="$vNameAuth//marc:datafield[@tag='100']">
                  <xsl:text>100</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuth//marc:datafield[@tag='110']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuth//marc:datafield[@tag='111']">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuth//marc:datafield[@tag='151']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vAuthSubfields">
          <xsl:choose>
            <xsl:when test="$vNameTag='100'">
              <xsl:text>abcdgjq</xsl:text>
            </xsl:when>
            <xsl:when test="$vNameTag='110'">
              <xsl:text>abcdgn</xsl:text>
            </xsl:when>
            <xsl:when test="$vNameTag='111'">
              <xsl:text>acdegnq</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagLabel" select="self::node()/bflc:marcKey[             contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or              string-length(@xml:lang)='2' or              string-length(@xml:lang)='3'         ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="self::node()/bflc:marcKey[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript!=''">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vNameVariantPreNS">
          <xsl:if test="$v880Script != '' and self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
            </xsl:call-template>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vNameVariant" select="exsl:node-set($vNameVariantPreNS)"/>
        <xsl:variable name="vNameVariantTag">
          <xsl:choose>
            <xsl:when test="$vNameVariant//marc:datafield[@tag!='']">
              <xsl:choose>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='400']">
                  <xsl:text>100</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='410']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='411']">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='451']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vSourceUri">
          <xsl:choose>
            <xsl:when test="bf:source/@rdf:resource">
              <xsl:value-of select="bf:source/@rdf:resource"/>
            </xsl:when>
            <xsl:when test="bf:source/bf:Source/@rdf:about">
              <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vShared">
          <xsl:choose>
            <xsl:when test="$vNameTag='100' or $vNameTag='110'">
              <xsl:for-each select="ancestor::bf:Contribution/bf:role/*[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']] |                            ancestor::bf:PrimaryContribution/bf:role/*[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']]">
                <marc:subfield code="e">
                  <xsl:choose>
                    <xsl:when test="madsrdf:authoritativeLabel">
                      <xsl:for-each select="madsrdf:authoritativeLabel">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="translate(., $upper, $lower)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="translate(., $upper, $lower)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="ancestor::bf:Contribution/bf:role/@rdf:resource | ancestor::bf:PrimaryContribution/bf:role/@rdf:resource">
                <marc:subfield code="e">
                  <xsl:if test="contains(., 'id.loc.gov/vocabulary/relators/')">
                    <xsl:value-of select="substring-after(., 'vocabulary/relators/')"/>
                  </xsl:if>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="$vNameTag='111'">
              <xsl:for-each select="ancestor::bf:Contribution/bf:role/*[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']] |                            ancestor::bf:PrimaryContribution/bf:role/*[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']]">
                <marc:subfield code="j">
                  <xsl:choose>
                    <xsl:when test="madsrdf:authoritativeLabel">
                      <xsl:for-each select="madsrdf:authoritativeLabel">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $j.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $j.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="1=1">
              <xsl:for-each select="ancestor::bf:Contribution/bf:role/*[madsrdf:code[.!='ctb'] or bf:code[.!='ctb']]|../bf:role/*[madsrdf:code[.!='ctb'] or bf:code[.!='ctb']] |                            ancestor::bf:PrimaryContribution/bf:role/*[madsrdf:code[.!='ctb'] or bf:code[.!='ctb']]|../bf:role/*[madsrdf:code[.!='ctb'] or bf:code[.!='ctb']]">
                <marc:subfield code="4">
                  <xsl:choose>
                    <xsl:when test="madsrdf:code">
                      <xsl:for-each select="madsrdf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $4.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="bf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $4.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="               ancestor::bf:Contribution/bf:role/*/@rdf:about[not(contains(., 'relators/ctb'))] |                ancestor::bf:PrimaryContribution/bf:role/*/@rdf:about[not(contains(., 'relators/ctb'))] |                ancestor::bf:Contribution/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))] |                ancestor::bf:PrimaryContribution/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
                <marc:subfield code="4">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label">
              <xsl:variable name="v-2">
                <xsl:choose>
                  <xsl:when test="bf:source/bf:Source/bf:code">
                    <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                  </xsl:when>
                  <xsl:when test="$vSourceUri != ''">
                    <xsl:choose>
                      <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                        <xsl:call-template name="tUriCode">
                          <xsl:with-param name="pUri" select="$vSourceUri"/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$vSourceUri"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v-2"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="1=1">
              <xsl:variable name="v-0">
                <xsl:choose>
                  <xsl:when test="$agentURI != '' and contains($agentURI, '/authorities/')">
                    <xsl:value-of select="$agentURI"/>
                  </xsl:when>
                  <xsl:when test="$agentURI != '' and contains($agentURI, 'id.loc.gov/rwo/agents/')">
                    <xsl:value-of select="concat(substring-before($agentURI,'rwo/agents'), 'authorities/names/', substring-after($agentURI,'rwo/agents/'))"/>
                  </xsl:when>
                  <xsl:when test="@rdf:about[                   not(contains(.,'example.org')) and                    not(contains(.,'REPLACE')) and                    not(contains(., '/agents/')) and                   not(contains(., '/isni/')) and                   not(contains(., '/gnd/'))                   ]">
                    <xsl:for-each select="@rdf:about[                     not(contains(.,'example.org')) and                      not(contains(.,'REPLACE')) and                      not(contains(., '/agents/')) and                     not(contains(., '/isni/')) and                     not(contains(., '/gnd/'))                     ]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:value-of select="."/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $0.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v-0"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                <marc:subfield code="0">
                  <xsl:variable name="vIdType">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vIdType != ''">
                      <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="rdf:value"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:variable name="v-1">
                <xsl:choose>
                  <xsl:when test="$agentURI != '' and (contains($agentURI, '/agents/') or contains($agentURI, '/gnd/'))">
                    <xsl:value-of select="$agentURI"/>
                  </xsl:when>
                  <xsl:when test="$agentURI != '' and contains($agentURI, 'id.loc.gov/authorities/')">
                    <xsl:value-of select="concat(substring-before($agentURI,'authorities/names'), 'rwo/agents/', substring-after($agentURI,'authorities/names/'))"/>
                  </xsl:when>
                  <xsl:when test="@rdf:about[                   contains(., '/agents/') or contains(., '/gnd/') or contains(., '/isni/')                    ]">
                    <xsl:for-each select="@rdf:about[                     contains(., '/agents/') or contains(., '/gnd/') or contains(., '/isni/')                     ]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:value-of select="."/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $1.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">
            <xsl:value-of select="$vNameTag"/>
          </xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="local-name()='Place' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place'] or                        local-name()='Jurisdiction' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='Organization' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization']">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuth//marc:datafield[@tag=$vNameTag]">
                  <xsl:value-of select="$vNameAuth//marc:datafield[@tag=$vNameTag]/@ind1"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>2</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$vNameVariant//marc:datafield[@tag!='']">
              <xsl:variable name="vvNameTag-6">
                <xsl:value-of select="concat('880-0', '1')"/>
              </xsl:variable>
              <xsl:if test="$vvNameTag-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$vvNameTag-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="$vNameAuth//marc:datafield/marc:subfield[contains($vAuthSubfields,@code)]">
            <marc:subfield>
              <xsl:attribute name="code">
                <xsl:value-of select="@code"/>
              </xsl:attribute>
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:copy-of select="$vShared"/>
          <!--<xsl:if test="$vLangTagLabel!=''">
          <marc:subfield code="7">
            <xsl:value-of select="concat('(bcp47)', $vLangTagLabel)"/>
          </marc:subfield>
        </xsl:if>-->
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$vNameVariant//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name()='Place' or                           rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place'] or                            local-name()='Jurisdiction' or                           rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="local-name()='Organization' or                           rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vNameVariant//marc:datafield[@tag=$vNameTag]">
                      <xsl:value-of select="$vNameVariant//marc:datafield[@tag=$vNameTag]/@ind1"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>2</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat($vNameTag, '-0', '1', '/', $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="$vNameVariant//marc:datafield/marc:subfield[contains($vAuthSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vShared"/>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent[@rdf:resource]|       bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/bf:*[not(bflc:marcKey)] |       bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/madsrdf:*" mode="generate-vMainEntryTag">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:expressionOf/bf:*[(local-name() = 'Hub' or local-name() = 'Work') and                                                    (                                                     (                                                       bf:title and                                                        not(../../bf:contribution/bf:PrimaryContribution) and                                                        not(../../bf:contribution/bflc:PrimaryContribution) and                                                        not(../../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')])                                                     )                                                   ) or (                                                     bflc:marcKey[starts-with(., '130')]                                                   )                                             ]">
        <xsl:variable name="vTitleResourcePreNS">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pUri" select="@rdf:about"/>
            <xsl:with-param name="pContext" select="."/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
        <xsl:variable name="vLangTagLabel" select="self::node()/bflc:marcKey[               contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                string-length(@xml:lang)='2' or                string-length(@xml:lang)='3'             ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript!=''">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelVariantPreNS">
          <xsl:if test="$v880Script != '' and self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
            </xsl:call-template>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vRelVariant" select="exsl:node-set($vRelVariantPreNS)"/>
        <xsl:choose>
          <xsl:when test="$xslProcessor='libxslt' and contains(@rdf:about, 'resources/hubs') and not(bflc:marcKey)">
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed expressionOf node/Hub.  No 130 output.</xsl:message>
          </xsl:when>
        </xsl:choose>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="bf:mainTitle/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">130</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="bf:title/bf:Title/bflc:nonSortNum">
                  <xsl:value-of select="bf:title/bf:Title/bflc:nonSortNum"/>
                </xsl:when>
                <xsl:when test="bf:title/bf:Title/bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:title/bf:Title/bf:mainTitle))">
                  <xsl:value-of select="string-length(bf:title/bf:Title/bf:mainTitle) - string-length(bf:title/bf:Title/bflc:titleSortKey)"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>0</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
              <xsl:variable name="v130-6">
                <xsl:value-of select="concat('880-0', '1')"/>
              </xsl:variable>
              <xsl:if test="$v130-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v130-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vTitleResource//marc:datafield[@tag='130']">
              <xsl:for-each select="$vTitleResource//marc:datafield[@tag='130']/marc:subfield[contains('adfghklmnoprst',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:variable name="v130-a">
                <xsl:choose>
                  <xsl:when test="bf:title/bf:Title/rdfs:label">
                    <xsl:for-each select="bf:title/bf:Title/rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 130 $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="bf:title/bf:Title/bf:mainTitle">
                    <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 130 $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v130-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$v130-a"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="bf:legalDate">
                <marc:subfield code="d">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:originDate">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 130 $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                <marc:subfield code="m">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                <marc:subfield code="n">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:title/bf:Title/bf:partName">
                <marc:subfield code="p">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                  <marc:subfield code="o">arranged</marc:subfield>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="bf:musicKey">
                <marc:subfield code="r">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:version">
                <marc:subfield code="s">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(., 'REPLACE'))]">
            <marc:subfield code="1">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:identifiedBy/bf:Identifier">
            <marc:subfield code="0">
              <xsl:variable name="vIdType">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vIdType != ''">
                  <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="rdf:value"/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:source/bf:Source/bf:code">
            <marc:subfield code="2">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vRelVariant//marc:datafield[@tag!='']/@ind1 != ' '">
                      <xsl:value-of select="$vRelVariant//marc:datafield[@tag!='']/@ind1"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('130-0', '1', '/', $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="$vRelVariant//marc:datafield[@tag!='']/marc:subfield[contains('adfghklmnoprst',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(., 'REPLACE'))]">
                <marc:subfield code="1">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                <marc:subfield code="0">
                  <xsl:variable name="vIdType">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vIdType != ''">
                      <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="rdf:value"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:source/bf:Source/bf:code">
                <marc:subfield code="2">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Instance/bf:title/*[local-name() = 'AbbreviatedTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AbbreviatedTitle']] |                     bf:Work/bf:title/*[local-name() = 'AbbreviatedTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AbbreviatedTitle']]" mode="generate-210">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:title/*[local-name() = 'KeyTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/KeyTitle']]" mode="generate-222">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:expressionOf[contains(@rdf:resource, 'hubs')][../bf:contribution/*[local-name()='PrimaryContribution'] or ../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')]] |                     bf:Work/bf:expressionOf/bf:*[contains(@rdf:about, 'hubs') or bflc:marcKey or marc:record][../../bf:contribution/*[local-name()='PrimaryContribution'] or ../../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]       ">
        <xsl:variable name="relURI">
          <xsl:choose>
            <xsl:when test="contains(@rdf:resource,'id.loc.gov/resources/hubs')">
              <xsl:value-of select="@rdf:resource"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'id.loc.gov/resources/hubs')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelResourcePreNS">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pRelUri" select="$relURI"/>
            <xsl:with-param name="pContext" select="."/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
        <xsl:variable name="vLangTagLabel" select="self::node()/bflc:marcKey[             contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or              string-length(@xml:lang)='2' or              string-length(@xml:lang)='3'           ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript!=''">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelVariantPreNS">
          <xsl:if test="$v880Script != '' and self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
            </xsl:call-template>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vRelVariant" select="exsl:node-set($vRelVariantPreNS)"/>
        <xsl:choose>
          <xsl:when test="$xslProcessor='libxslt' and contains($relURI, 'resources/hubs') and not(bflc:marcKey)">
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed expressionOf node/Hub.  No 240 output.</xsl:message>
          </xsl:when>
        </xsl:choose>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">240</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text>1</xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text>0</xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
              <xsl:variable name="v240-6">
                <xsl:value-of select="concat('880-0', '2')"/>
              </xsl:variable>
              <xsl:if test="$v240-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v240-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vRelResource//marc:datafield[@tag = '240']">
              <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[(@code = 't' or preceding-sibling::marc:subfield[@code = 't']) and contains('dgfhklmnoprst',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="translate(@code, 't', 'a')"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:variable name="v240-1">
            <xsl:choose>
              <xsl:when test="$relURI != ''">
                <xsl:value-of select="$relURI"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v240-1 != ''">
            <marc:subfield code="1">
              <xsl:value-of select="$v240-1"/>
            </marc:subfield>
          </xsl:if>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text>1</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text>0</xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('240-0', '2', '/', $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="$vRelVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[(@code = 't' or preceding-sibling::marc:subfield[@code = 't']) and contains('dgfhklmnoprst',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="translate(@code, 't', 'a')"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:variable name="v880-1">
                <xsl:choose>
                  <xsl:when test="$relURI != ''">
                    <xsl:value-of select="$relURI"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v880-1"/>
                </marc:subfield>
              </xsl:if>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:expressionOf/child::node()[         not(contains(@rdf:resource, 'hubs')) and not(contains(@rdf:about, 'hubs')) and          not(contains(@rdf:resource, 'REPLACE')) and not(contains(@rdf:about, 'REPLACE')) and          not(bflc:marcKey or marc:record) and          (local-name() = 'Hub' or local-name() = 'Work') and bf:title][../../bf:contribution/*[local-name()='PrimaryContribution'] or ../../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')]][not(bf:mainTitle/@xml:lang) or contains(translate(bf:mainTitle/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="bf:Work/bf:expressionOf/child::node()[         not(contains(@rdf:resource, 'hubs')) and not(contains(@rdf:about, 'hubs')) and          not(contains(@rdf:resource, 'REPLACE')) and not(contains(@rdf:about, 'REPLACE')) and          not(bflc:marcKey or marc:record) and          (local-name() = 'Hub' or local-name() = 'Work') and bf:title][../../bf:contribution/*[local-name()='PrimaryContribution'] or ../../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')]][not(bf:mainTitle/@xml:lang) or contains(translate(bf:mainTitle/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position()=1">
                <xsl:variable name="vXmlLang">
                  <xsl:value-of select="bf:mainTitle/@xml:lang"/>
                </xsl:variable>
                <marc:datafield>
                  <xsl:attribute name="tag">240</xsl:attribute>
                  <xsl:if test="$vXmlLang != ''">
                    <xsl:attribute name="xml:lang">
                      <xsl:value-of select="$vXmlLang"/>
                    </xsl:attribute>
                  </xsl:if>
                  <xsl:attribute name="ind1">
                    <xsl:text>1</xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="bf:title/bf:Title/bflc:nonSortNum">
                          <xsl:value-of select="bf:title/bf:Title/bflc:nonSortNum"/>
                        </xsl:when>
                        <xsl:when test="bf:title/bf:Title/bflc:titleSortKey and (string-length(bf:title/bf:Title/bflc:titleSortKey) &lt; string-length(bf:title/bf:Title/bf:mainTitle))">
                          <xsl:value-of select="string-length(bf:title/bf:Title/bf:mainTitle) - string-length(bf:title/bf:Title/bflc:titleSortKey)"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>0</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:variable name="v240-a">
                    <xsl:choose>
                      <xsl:when test="bf:title/bf:Title/bf:mainTitle">
                        <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 240 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v240-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v240-a"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 240 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                      <marc:subfield code="o">arranged</marc:subfield>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bf:musicKey">
                    <marc:subfield code="r">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:source/bf:Source/bf:code">
                    <marc:subfield code="2">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (240).</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:Work/bf:expressionOf/child::node()[         not(contains(@rdf:resource, 'hubs')) and not(contains(@rdf:about, 'hubs')) and          not(contains(@rdf:resource, 'REPLACE')) and not(contains(@rdf:about, 'REPLACE')) and          not(bflc:marcKey or marc:record) and          (local-name() = 'Hub' or local-name() = 'Work') and bf:title][../../bf:contribution/*[local-name()='PrimaryContribution'] or ../../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]">
            <xsl:choose>
              <xsl:when test="position()=1">
                <xsl:variable name="vXmlLang">
                  <xsl:value-of select="bf:mainTitle/@xml:lang"/>
                </xsl:variable>
                <marc:datafield>
                  <xsl:attribute name="tag">240</xsl:attribute>
                  <xsl:if test="$vXmlLang != ''">
                    <xsl:attribute name="xml:lang">
                      <xsl:value-of select="$vXmlLang"/>
                    </xsl:attribute>
                  </xsl:if>
                  <xsl:attribute name="ind1">
                    <xsl:text>1</xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="bf:title/bf:Title/bflc:nonSortNum">
                          <xsl:value-of select="bf:title/bf:Title/bflc:nonSortNum"/>
                        </xsl:when>
                        <xsl:when test="bf:title/bf:Title/bflc:titleSortKey and (string-length(bf:title/bf:Title/bflc:titleSortKey) &lt; string-length(bf:title/bf:Title/bf:mainTitle))">
                          <xsl:value-of select="string-length(bf:title/bf:Title/bf:mainTitle) - string-length(bf:title/bf:Title/bflc:titleSortKey)"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>0</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:variable name="v240-a">
                    <xsl:choose>
                      <xsl:when test="bf:title/bf:Title/bf:mainTitle">
                        <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 240 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v240-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v240-a"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 240 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                      <marc:subfield code="o">arranged</marc:subfield>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bf:musicKey">
                    <marc:subfield code="r">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:source/bf:Source/bf:code">
                    <marc:subfield code="2">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (240).</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:apply-templates select="bf:Instance/bf:title/*[(local-name() = 'VariantTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle']) and bf:variantType = 'translated']" mode="generate-242">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:title/*[                       local-name()='CollectiveTitle' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/CollectiveTitle']                     ][not(bf:mainTitle/@xml:lang) or contains(translate(bf:mainTitle/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="bf:Work/bf:title/*[                       local-name()='CollectiveTitle' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/CollectiveTitle']                     ][not(bf:mainTitle/@xml:lang) or contains(translate(bf:mainTitle/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position()=1">
                <xsl:variable name="vXmlLang">
                  <xsl:value-of select="bf:mainTitle/@xml:lang"/>
                </xsl:variable>
                <marc:datafield>
                  <xsl:attribute name="tag">243</xsl:attribute>
                  <xsl:if test="$vXmlLang != ''">
                    <xsl:attribute name="xml:lang">
                      <xsl:value-of select="$vXmlLang"/>
                    </xsl:attribute>
                  </xsl:if>
                  <xsl:attribute name="ind1">
                    <xsl:text>1</xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="bflc:nonSortNum">
                          <xsl:value-of select="bflc:nonSortNum"/>
                        </xsl:when>
                        <xsl:when test="bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:mainTitle))">
                          <xsl:value-of select="string-length(bf:mainTitle) - string-length(bflc:titleSortKey)"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>0</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 243 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (243).</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:Work/bf:title/*[                       local-name()='CollectiveTitle' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/CollectiveTitle']                     ]">
            <xsl:choose>
              <xsl:when test="position()=1">
                <xsl:variable name="vXmlLang">
                  <xsl:value-of select="bf:mainTitle/@xml:lang"/>
                </xsl:variable>
                <marc:datafield>
                  <xsl:attribute name="tag">243</xsl:attribute>
                  <xsl:if test="$vXmlLang != ''">
                    <xsl:attribute name="xml:lang">
                      <xsl:value-of select="$vXmlLang"/>
                    </xsl:attribute>
                  </xsl:if>
                  <xsl:attribute name="ind1">
                    <xsl:text>1</xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="bflc:nonSortNum">
                          <xsl:value-of select="bflc:nonSortNum"/>
                        </xsl:when>
                        <xsl:when test="bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:mainTitle))">
                          <xsl:value-of select="string-length(bf:mainTitle) - string-length(bflc:titleSortKey)"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>0</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 243 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (243).</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:apply-templates select="bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]/bf:title/bf:Title[not(rdf:type)]|bf:Work[not(../bf:Instance/bf:title/bf:Title[not(rdf:type)])]/bf:title/bf:Title[not(rdf:type)]" mode="generate-245">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]/bf:title/bf:Title[not(rdf:type)]|bf:Work[not(../bf:Instance/bf:title/bf:Title[not(rdf:type)])]/bf:title/bf:Title[not(rdf:type)]">
        <xsl:variable name="vLangTagScript" select="bf:mainTitle[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="position()=1 and (count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))])">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="/rdf:RDF/bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="bflc:nonSortNum[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:value-of select="bflc:nonSortNum[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]"/>
                    </xsl:when>
                    <xsl:when test="bflc:titleSortKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and                           (string-length(bflc:titleSortKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]) &lt; string-length(bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]))">
                      <xsl:value-of select="string-length(bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]) - string-length(bflc:titleSortKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))])"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:value-of select="concat('245-03/',$v880Script)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>245-01</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-a">
                <xsl:choose>
                  <xsl:when test="bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:for-each select="bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="                   bf:partNumber[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and                   not(                     substring(                       bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))],                        string-length(bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]),                       1) = '.'                   )                 ">
                    <xsl:text>.</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:partName[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text>.</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:subtitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> :</xsl:text>
                  </xsl:when>
                  <xsl:when test="ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> /</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$v880-a"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-n">
                <xsl:variable name="nExists">
                  <xsl:choose>
                    <xsl:when test="bf:partNumber[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:value-of select="'1'"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="bf:partNumber[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:for-each select="bf:partNumber[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $n.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="$nExists='1' and bf:partName[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text>.</xsl:text>
                  </xsl:when>
                  <xsl:when test="$nExists='1' and bf:subtitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> :</xsl:text>
                  </xsl:when>
                  <xsl:when test="$nExists='1' and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> /</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-n != ''">
                <marc:subfield code="n">
                  <xsl:value-of select="$v880-n"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-p">
                <xsl:variable name="pExists">
                  <xsl:choose>
                    <xsl:when test="bf:partName[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:value-of select="'1'"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="bf:partName[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:for-each select="bf:partName[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $p.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="$pExists='1' and bf:subtitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> :</xsl:text>
                  </xsl:when>
                  <xsl:when test="$pExists='1' and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> /</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-p != ''">
                <marc:subfield code="p">
                  <xsl:value-of select="$v880-p"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-b">
                <xsl:variable name="bExists">
                  <xsl:choose>
                    <xsl:when test="bf:subtitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:value-of select="'1'"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="bf:subtitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:for-each select="bf:subtitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $b.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="$bExists='1' and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:text> /</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-b != ''">
                <marc:subfield code="b">
                  <xsl:value-of select="$v880-b"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-c">
                <xsl:choose>
                  <xsl:when test="ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:for-each select="ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:value-of select="."/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $c.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:variable name="vEndsWith">
                      <xsl:call-template name="tEndsWith">
                        <xsl:with-param name="pStr" select="ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]"/>
                        <xsl:with-param name="pEndChar" select="'.'"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$vEndsWith = '0'">
                      <xsl:text>.</xsl:text>
                    </xsl:if>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-c != ''">
                <marc:subfield code="c">
                  <xsl:value-of select="$v880-c"/>
                </marc:subfield>
              </xsl:if>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="                       bf:*[local-name()='Instance' or local-name()='Work']/bf:title/bf:*[(                         local-name()='VariantTitle' or                         local-name()='ParallelTitle' or                         local-name()='TranscribedTitle' or                         rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle'] or                         rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/ParallelTitle'] or                         rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/TranscribedTitle']                       ) and                         not(rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']) and                         not(bf:variantType = 'translated') and                         not(bf:variantType = 'former') and                         bf:mainTitle != ''                         ]                       |                       bf:Instance/bf:hasItem/bf:Item/bf:title/bf:*[                         bflc:applicableInstitution/*/bf:code='DLC' and                          (                         local-name()='VariantTitle' or                         local-name()='ParallelTitle' or                         local-name()='TranscribedTitle' or                         rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle'] or                         rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/ParallelTitle'] or                         rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/TranscribedTitle']                       ) and                        not(rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']) and                       not(bf:variantType = 'translated') and                       not(bf:variantType = 'former') and                       bf:mainTitle != ''                       ]                     ">
        <xsl:variable name="vOccurrenceNumber">
          <xsl:if test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="prevTitleCount" select="count(parent::bf:title/preceding-sibling::bf:title/*[(               local-name()='VariantTitle' or               local-name()='ParallelTitle' or               local-name()='TranscribedTitle' or               rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle'] or               rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/ParallelTitle'] or               rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/TranscribedTitle']               ) and                not(rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']) and               not(bf:variantType = 'translated') and               not(bf:variantType = 'former') and               bf:mainTitle[@xml:lang]])"/>
            <xsl:value-of select="4 + $prevTitleCount"/>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vTag">
          <xsl:choose>
            <xsl:when test="$vOccurrenceNumber != ''">
              <xsl:text>246</xsl:text>
            </xsl:when>
            <xsl:when test="count(bf:mainTitle)='1' and                       bf:mainTitle[                           not(@xml:lang) or                            contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            (                             string-length(@xml:lang)='2' or                              string-length(@xml:lang)='3'                           )                       ]">
              <xsl:text>246</xsl:text>
            </xsl:when>
            <xsl:when test="count(bf:mainTitle)='1' and                       bf:mainTitle[                         @xml:lang and                          contains(@xml:lang, '-') and                          not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))                       ]">
              <xsl:text>880</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagLabel" select="bf:mainTitle[                     not(@xml:lang) or                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                      (                       string-length(@xml:lang)='2' or                        string-length(@xml:lang)='3'                     )                   ]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="bf:mainTitle[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <marc:datafield>
          <xsl:attribute name="tag">
            <xsl:value-of select="$vTag"/>
          </xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/atp']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cap']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/run']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cov']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/spi']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'added title page'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'caption'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'running'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'spine'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'cover'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>3</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="local-name()='ParallelTitle' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/ParallelTitle']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/por']">
                  <xsl:text>0</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/dis']">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cov']">
                  <xsl:text>4</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/atp']">
                  <xsl:text>5</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cap']">
                  <xsl:text>6</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/run']">
                  <xsl:text>7</xsl:text>
                </xsl:when>
                <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/spi']">
                  <xsl:text>8</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'portion'">
                  <xsl:text>0</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'distinctive'">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'cover'">
                  <xsl:text>4</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'added title page'">
                  <xsl:text>5</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'caption'">
                  <xsl:text>6</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'running'">
                  <xsl:text>7</xsl:text>
                </xsl:when>
                <xsl:when test="bf:variantType = 'spine'">
                  <xsl:text>8</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text> </xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vvTag-6">
                <xsl:value-of select="concat('880-0', $vOccurrenceNumber)"/>
              </xsl:variable>
              <xsl:if test="$vvTag-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$vvTag-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="$vTag = '880'">
              <xsl:variable name="vScript">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:variable name="v880Script">
                <xsl:variable name="vlang">
                  <xsl:value-of select="$vScript"/>
                </xsl:variable>
                <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
              </xsl:variable>
              <xsl:variable name="vvTag-6">
                <xsl:value-of select="concat('246-00', '/' , $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$vvTag-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$vvTag-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bf:note/bf:Note/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="i">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $i.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="$vTag = '246'">
              <xsl:for-each select="bf:mainTitle[                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                         ]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:subtitle[                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                         ]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $b.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:date[                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                         ]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:partNumber[                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                         ]">
                <marc:subfield code="n">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:partName[                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                         ]">
                <marc:subfield code="p">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="$vTag = '880'">
              <xsl:for-each select="bf:mainTitle[                             @xml:lang and                               not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))                       ]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:subtitle[                             @xml:lang and                               not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))                       ]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $b.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:date[                             @xml:lang and                               not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))                       ]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:partNumber[                             @xml:lang and                               not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))                      ]">
                <marc:subfield code="n">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:partName[                             @xml:lang and                               not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))                       ]">
                <marc:subfield code="p">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="5">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vTag $5.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="vLangTag" select="bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
            <xsl:variable name="vScript">
              <xsl:value-of select="translate(substring-after($vLangTag,'-'),$upper,$lower)"/>
            </xsl:variable>
            <xsl:variable name="v880Script">
              <xsl:variable name="vlang">
                <xsl:value-of select="$vScript"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/atp']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cap']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/run']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cov']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/spi']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'added title page'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'caption'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'running'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'spine'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'cover'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>3</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name()='ParallelTitle' or                   rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/ParallelTitle']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/por']">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/dis']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cov']">
                      <xsl:text>4</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/atp']">
                      <xsl:text>5</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/cap']">
                      <xsl:text>6</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/run']">
                      <xsl:text>7</xsl:text>
                    </xsl:when>
                    <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/spi']">
                      <xsl:text>8</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'portion'">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'distinctive'">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'cover'">
                      <xsl:text>4</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'added title page'">
                      <xsl:text>5</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'caption'">
                      <xsl:text>6</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'running'">
                      <xsl:text>7</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:variantType = 'spine'">
                      <xsl:text>8</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('246-0', $vOccurrenceNumber, '/' , $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="bf:note/bf:Note/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="i">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $i.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:subtitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $b.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:date[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:partNumber[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="n">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:partName[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="p">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Work/bf:title/*[(     local-name()='VariantTitle' or     rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle']     ) and     (       bf:variantType = 'former' or rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']     ) and      (       bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))] or        rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]     )     ] |     bf:Instance[rdf:type/@rdf:resource!='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/*[(     local-name()='VariantTitle' or     rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle']     ) and     (       bf:variantType = 'former' or rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']     ) and      (     bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))] or      rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]     )     ]">
        <xsl:variable name="vLangTagLabel" select="bf:mainTitle[                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                    string-length(@xml:lang)='2' or                    string-length(@xml:lang)='3'                   ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="bf:mainTitle[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="vOccurrenceNumber">
          <xsl:if test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="prevTitleCount" select="count(parent::bf:title/preceding-sibling::bf:title/*[(             local-name()='VariantTitle' or             rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle']             ) and             (               bf:variantType = 'former' or rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']             ) and             bf:mainTitle[@xml:lang]])"/>
            <xsl:value-of select="7 + $prevTitleCount"/>
          </xsl:if>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">247</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text>1</xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text>0</xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="v247-6">
                <xsl:value-of select="concat('880-0', $vOccurrenceNumber)"/>
              </xsl:variable>
              <xsl:if test="$v247-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v247-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:variable name="v247-a">
            <xsl:choose>
              <xsl:when test="bf:mainTitle">
                <xsl:for-each select="bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 247 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="rdfs:label">
                <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 247 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v247-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v247-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:for-each select="bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="b">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 247 $b.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:date[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="f">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 247 $f.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:qualifier[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="g">
                  <xsl:value-of select="concat('(',.,')')"/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 247 $g.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:partNumber[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <marc:subfield code="n">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:partName[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <marc:subfield code="p">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']]/rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="x">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 247 $x.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="vLangTag" select="bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
            <xsl:variable name="vScript">
              <xsl:value-of select="translate(substring-after($vLangTag,'-'),$upper,$lower)"/>
            </xsl:variable>
            <xsl:variable name="v880Script">
              <xsl:variable name="vlang">
                <xsl:value-of select="$vScript"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text>1</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text>0</xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('247-0', $vOccurrenceNumber, '/' , $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-a">
                <xsl:choose>
                  <xsl:when test="bf:mainTitle">
                    <xsl:for-each select="bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="rdfs:label">
                    <xsl:for-each select="rdfs:label[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$v880-a"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="bf:subtitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $b.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:date[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:qualifier[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="g">
                      <xsl:value-of select="concat('(',.,')')"/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $g.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:partNumber[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="n">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:partName[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="p">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']]/rdf:value">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="x">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $x.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Instance/bf:editionStatement[                     not(@xml:lang) or                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                      string-length(@xml:lang)='2' or                      string-length(@xml:lang)='3']">
        <xsl:variable name="vLangTagLabel" select="self::node()/@xml:lang"/>
        <xsl:variable name="v880" select="ancestor::bf:Instance/bf:editionStatement[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]"/>
        <xsl:variable name="vLangTagScript" select="$v880/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">250</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$v880/@xml:lang">
              <xsl:variable name="v250-6">
                <xsl:value-of select="'880-20'"/>
              </xsl:variable>
              <xsl:if test="$v250-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v250-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:variable name="v250-a">
            <xsl:value-of select="."/>
            <xsl:variable name="vEndsWith">
              <transform xmlns="http://www.loc.gov/bf2marc">
                <xsl:call-template name="tEndsWith">
                  <xsl:with-param name="pStr" select="."/>
                  <xsl:with-param name="pEndChar" select="'.'"/>
                </xsl:call-template>
              </transform>
            </xsl:variable>
            <xsl:if test="$vEndsWith = '0'">
              <xsl:text>.</xsl:text>
            </xsl:if>
          </xsl:variable>
          <xsl:if test="$v250-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v250-a"/>
            </marc:subfield>
          </xsl:if>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$v880/@xml:lang">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('250-20/',$v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:variable name="v880-a">
                <xsl:value-of select="$v880"/>
                <xsl:variable name="vEndsWith">
                  <transform xmlns="http://www.loc.gov/bf2marc">
                    <xsl:call-template name="tEndsWith">
                      <xsl:with-param name="pStr" select="$v880"/>
                      <xsl:with-param name="pEndChar" select="'.'"/>
                    </xsl:call-template>
                  </transform>
                </xsl:variable>
                <xsl:if test="$vEndsWith = '0'">
                  <xsl:text>.</xsl:text>
                </xsl:if>
              </xsl:variable>
              <xsl:if test="$v880-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$v880-a"/>
                </marc:subfield>
              </xsl:if>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Work/bf:scale[not(bf:Scale)]" mode="generate-255">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:scale/bf:Scale/rdfs:label">
        <xsl:choose>
          <xsl:when test="translate(.,$upper,$lower) != 'linear scale'">
            <marc:datafield>
              <xsl:attribute name="tag">255</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <marc:subfield code="a">
                <xsl:value-of select="."/>
              </marc:subfield>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Work/bf:scale/bf:Scale/bf:note/bf:Note/rdfs:label" mode="generate-255">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:cartographicAttributes/bf:Cartographic[bf:projection or                     bf:coordinates or                     bf:ascensionAndDeclination or                     bf:equinox or                     bf:outerGRing or                     bf:exclusionGRing]" mode="generate-255">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:originPlace/bf:Place" mode="generate-257">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bflc:projectedProvisionDate" mode="generate-263">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Instance/bf:provisionActivity/*[                     (local-name()='Production' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Production'] or                     local-name()='Distribution' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Distribution'] or                     local-name()='Manufacture' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manufacture'] or                     local-name()='Publication' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Publication']) and                     (                       (bflc:simplePlace or bflc:simpleAgent or bflc:simpleDate) or                        (bf:place/bf:*[not(@rdf:about)]/rdfs:label or bf:agent/bf:*[not(@rdf:about)]/rdfs:label or bf:date[not(@rdf:datatype)])                     )]">
        <xsl:variable name="serlORintg">
          <xsl:choose>
            <xsl:when test="ancestor::bf:Instance/bf:issuance//@rdf:*[. = 'http://id.loc.gov/vocabulary/issuance/serl']">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Instance/bf:issuance//@rdf:*[. = 'http://id.loc.gov/vocabulary/issuance/intg']">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>0</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="v264type">
          <xsl:choose>
            <xsl:when test="local-name()='Publication' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Publication']">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Production' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Production']">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Distribution' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Distribution']">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Manufacture' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manufacture']">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>1</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="v264typeCount">
          <xsl:choose>
            <xsl:when test="$v264type='1'">
              <xsl:value-of select="count(ancestor::bf:Instance/bf:provisionActivity/*[(local-name()='Publication' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Publication'])])"/>
            </xsl:when>
            <xsl:when test="$v264type='0'">
              <xsl:value-of select="count(ancestor::bf:Instance/bf:provisionActivity/*[(local-name()='Production' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Production'])])"/>
            </xsl:when>
            <xsl:when test="$v264type='2'">
              <xsl:value-of select="count(ancestor::bf:Instance/bf:provisionActivity/*[(local-name()='Distribution' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Distribution'])])"/>
            </xsl:when>
            <xsl:when test="$v264type='3'">
              <xsl:value-of select="count(ancestor::bf:Instance/bf:provisionActivity/*[(local-name()='Manufacture' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manufacture'])])"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagLabel">
          <xsl:choose>
            <xsl:when test="bflc:simpleAgent[                       contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                        string-length(@xml:lang)='2' or                        string-length(@xml:lang)='3'                     ]/@xml:lang">
              <xsl:value-of select="bflc:simpleAgent[                           contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            string-length(@xml:lang)='2' or                            string-length(@xml:lang)='3'                         ]/@xml:lang"/>
            </xsl:when>
            <xsl:when test="bflc:simplePlace[                       contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                        string-length(@xml:lang)='2' or                        string-length(@xml:lang)='3'                     ]/@xml:lang">
              <xsl:value-of select="bflc:simplePlace[                           contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            string-length(@xml:lang)='2' or                            string-length(@xml:lang)='3'                         ]/@xml:lang"/>
            </xsl:when>
            <xsl:when test="bf:place/bf:*[not(@rdf:about)]/rdfs:label[                       contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                        string-length(@xml:lang)='2' or                        string-length(@xml:lang)='3'                     ]/@xml:lang">
              <xsl:value-of select="bf:place/bf:*[not(@rdf:about)]/rdfs:label[                           contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            string-length(@xml:lang)='2' or                            string-length(@xml:lang)='3'                       ]/@xml:lang"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagScript">
          <xsl:choose>
            <xsl:when test="bflc:simpleAgent[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]/@xml:lang">
              <xsl:value-of select="bflc:simpleAgent[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]/@xml:lang"/>
            </xsl:when>
            <xsl:when test="bflc:simplePlace[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]/@xml:lang">
              <xsl:value-of select="bflc:simplePlace[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]/@xml:lang"/>
            </xsl:when>
            <xsl:when test="bf:place/bf:*[not(@rdf:about)]/rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(bf:place/*/rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]/@xml:lang">
              <xsl:value-of select="bf:place/*/rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(bf:place/*/rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]/@xml:lang"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurence">
          <xsl:value-of select="21+position()"/>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$v880Occurence &lt; 41">
            <marc:datafield>
              <xsl:attribute name="tag">264</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$serlORintg='1' and $v264typeCount='1'">
                      <xsl:text> </xsl:text>
                    </xsl:when>
                    <xsl:when test="$serlORintg='1' and $v264typeCount!='1' and bf:status/bf:Status//@rdf:*[. = 'http://id.loc.gov/vocabulary/mstatus/current']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="$serlORintg='1' and $v264typeCount!='1' and bf:status/bf:Status//@rdf:*[. = 'http://id.loc.gov/vocabulary/mstatus/ceased']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="$serlORintg='1' and bf:status/bf:Status//@rdf:*[. = 'http://id.loc.gov/vocabulary/mstatus/earliest']">
                      <xsl:text> </xsl:text>
                    </xsl:when>
                    <xsl:when test="$serlORintg='1' and $v264typeCount!='1' and not(bf:status/bf:Status)">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="$serlORintg='2' and $v264typeCount='1' and bf:status/bf:Status//@rdf:*[. = 'http://id.loc.gov/vocabulary/mstatus/current']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="$serlORintg='2' and $v264typeCount='1' and bf:status/bf:Status//@rdf:*[. = 'http://id.loc.gov/vocabulary/mstatus/ceased']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name()='Production' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Production']">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="local-name()='Distribution' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Distribution']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="local-name()='Manufacture' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manufacture']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>1</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$v880Script != ''">
                  <xsl:variable name="v264-6">
                    <xsl:value-of select="concat('880-',$v880Occurence)"/>
                  </xsl:variable>
                  <xsl:if test="$v264-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v264-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 264 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="bflc:simplePlace[                           not(@xml:lang) or                            contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            (                             string-length(@xml:lang)='2' or                              string-length(@xml:lang)='3'                           )                           ]">
                  <xsl:for-each select="bflc:simplePlace[                                         not(@xml:lang) or                                          contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                          (                                           string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3'                                         )                                   ]">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bflc:simplePlace[                                     not(@xml:lang) or                                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                      (                                       string-length(@xml:lang)='2' or                                        string-length(@xml:lang)='3'                                     )                                 ]">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                      <xsl:if test="position() = last()">
                        <xsl:if test="../bflc:simpleAgent[                                       not(@xml:lang) or                                        contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                        (                                         string-length(@xml:lang)='2' or                                          string-length(@xml:lang)='3'                                       )                                   ]">
                          <xsl:text> :</xsl:text>
                        </xsl:if>
                        <xsl:if test="not(../bflc:simpleAgent[                                         not(@xml:lang) or                                          contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                          (                                           string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3'                                         )                                         ]) and ../bflc:simpleDate[                                             not(@xml:lang) or                                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                              (                                             string-length(@xml:lang)='2' or                                              string-length(@xml:lang)='3'                                           )                                         ]">
                          <xsl:text> ,</xsl:text>
                        </xsl:if>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="bf:place/*[                       (local-name()='Place' or local-name()='Geographic' or local-name()='Authority' or local-name()='Resource') and                       rdfs:label[                         not(@xml:lang) or                          contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                          (                         string-length(@xml:lang)='2' or                          string-length(@xml:lang)='3'                         )                       ]                      ]">
                  <xsl:for-each select="bf:place/*/rdfs:label[                           not(@xml:lang) or                            contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            (                             string-length(@xml:lang)='2' or                              string-length(@xml:lang)='3'                           )                       ]">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="bf:place/*[                       (local-name()='Place' or local-name()='Geographic' or local-name()='Authority') and                       madsrdf:authoritativeLabel[                               not(@xml:lang) or                                contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                (                                 string-length(@xml:lang)='2' or                                  string-length(@xml:lang)='3'                             )                           ]                       ]">
                  <xsl:for-each select="bf:place/*/madsrdf:authoritativeLabel[                                     not(@xml:lang) or                                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                      (                                       string-length(@xml:lang)='2' or                                        string-length(@xml:lang)='3'                                     )                                 ]">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bflc:simpleAgent[                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                           ]">
                  <xsl:for-each select="bflc:simpleAgent[                                         not(@xml:lang) or                                          contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                          (                                           string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3'                                         )                                     ]">
                    <marc:subfield code="b">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bflc:simpleAgent[                                     not(@xml:lang) or                                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                      (                                       string-length(@xml:lang)='2' or                                        string-length(@xml:lang)='3'                                     )                                 ]">
                        <xsl:text> :</xsl:text>
                      </xsl:if>
                      <xsl:if test="position() = last()">
                        <xsl:if test="../bflc:simpleDate[                                         not(@xml:lang) or                                          contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                          (                                           string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3'                                         )                                   ]">
                          <xsl:text>,</xsl:text>
                        </xsl:if>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="bf:agent/bf:Agent/rdfs:label[                           not(@xml:lang) or                            contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            (                             string-length(@xml:lang)='2' or                              string-length(@xml:lang)='3'                           )                         ]">
                  <xsl:for-each select="bf:agent/bf:Agent/rdfs:label[                           not(@xml:lang) or                            contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            (                             string-length(@xml:lang)='2' or                              string-length(@xml:lang)='3'                            )                         ]">
                    <marc:subfield code="b">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bflc:simpleDate[                           not(@xml:lang) or                            contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                            (                             string-length(@xml:lang)='2' or                              string-length(@xml:lang)='3'                           )                         ]">
                  <xsl:for-each select="bflc:simpleDate[                                         not(@xml:lang) or                                          contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                          (                                           string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3'                                         )                                     ]">
                    <marc:subfield code="c">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bflc:simpleDate[                                     not(@xml:lang) or                                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                      (                                       string-length(@xml:lang)='2' or                                        string-length(@xml:lang)='3'                                     )                                   ]">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="position() = last()">
                        <xsl:variable name="vEndsWithBracket">
                          <xsl:call-template name="tEndsWith">
                            <xsl:with-param name="pStr" select="."/>
                            <xsl:with-param name="pEndChar" select="']'"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:variable name="vEndsWithDash">
                          <xsl:call-template name="tEndsWith">
                            <xsl:with-param name="pStr" select="."/>
                            <xsl:with-param name="pEndChar" select="'-'"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:variable name="vEndsWithPeriod">
                          <xsl:call-template name="tEndsWith">
                            <xsl:with-param name="pStr" select="."/>
                            <xsl:with-param name="pEndChar" select="'.'"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vEndsWithBracket = '1'"/>
                          <xsl:when test="$vEndsWithDash = '1'"/>
                          <xsl:when test="$vEndsWithPeriod = '0'">
                            <xsl:text>.</xsl:text>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="bf:date[                           not(@rdf:datatype) and                            (                             not(@xml:lang) or                              contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                              (                               string-length(@xml:lang)='2' or                                string-length(@xml:lang)='3'                             )                           )                       ]">
                  <xsl:for-each select="bf:date[                                 not(@rdf:datatype) and                                  (                                   not(@xml:lang) or                                    contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                    (                                     string-length(@xml:lang)='2' or                                      string-length(@xml:lang)='3'                                   )                                 )                             ]">
                    <marc:subfield code="c">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </marc:datafield>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <marc:datafield>
                  <xsl:attribute name="tag">880</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="bf:status/bf:Status/@rdf:about = 'http://id.loc.gov/vocabulary/mstatus/current'">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:when test="bf:status/@rdf:resource = 'http://id.loc.gov/vocabulary/mstatus/current'">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text> </xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="local-name()='Production' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Production']">
                          <xsl:text>0</xsl:text>
                        </xsl:when>
                        <xsl:when test="local-name()='Distribution' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Distribution']">
                          <xsl:text>2</xsl:text>
                        </xsl:when>
                        <xsl:when test="local-name()='Manufacture' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Manufacture']">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>1</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:variable name="v880-6">
                    <xsl:value-of select="concat('264-',$v880Occurence,'/',$v880Script)"/>
                  </xsl:variable>
                  <xsl:if test="$v880-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v880-6"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:choose>
                    <xsl:when test="bflc:simplePlace[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:for-each select="bflc:simplePlace[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="a">
                          <xsl:value-of select="."/>
                          <xsl:if test="following-sibling::bflc:simplePlace[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                            <xsl:text> ;</xsl:text>
                          </xsl:if>
                          <xsl:if test="position() = last()">
                            <xsl:if test="../bflc:simpleAgent[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                              <xsl:text> :</xsl:text>
                            </xsl:if>
                            <xsl:if test="not(../bflc:simpleAgent[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]) and ../bflc:simpleDate[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                              <xsl:text>,</xsl:text>
                            </xsl:if>
                          </xsl:if>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="bf:place/*[                              (local-name()='Place' or local-name()='Geographic' or local-name()='Authority') and                               rdfs:label[@xml:lang or not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]                              ]">
                      <xsl:for-each select="bf:place/bf:*/rdfs:label[@xml:lang or not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="a">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="bf:place/*[                               (local-name()='Place' or local-name()='Geographic' or local-name()='Authority') and                               madsrdf:authoritativeLabel[@xml:lang or not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]                              ]">
                      <xsl:for-each select="bf:place/bf:*/madsrdf:authoritativeLabel[@xml:lang or not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="a">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="bflc:simpleAgent[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:for-each select="bflc:simpleAgent[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="b">
                          <xsl:value-of select="."/>
                          <xsl:if test="following-sibling::bflc:simpleAgent[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                            <xsl:text> :</xsl:text>
                          </xsl:if>
                          <xsl:if test="position() = last()">
                            <xsl:if test="../bflc:simpleDate[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                              <xsl:text>,</xsl:text>
                            </xsl:if>
                          </xsl:if>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="bf:agent/bf:Agent/rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:for-each select="bf:agent/bf:Agent/rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="b">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="bflc:simpleDate[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:for-each select="bflc:simpleDate[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="c">
                          <xsl:value-of select="."/>
                          <xsl:if test="following-sibling::bflc:simpleDate[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                            <xsl:text>,</xsl:text>
                          </xsl:if>
                          <xsl:if test="position() = last()">
                            <xsl:variable name="vEndsWithBracket">
                              <xsl:call-template name="tEndsWith">
                                <xsl:with-param name="pStr" select="."/>
                                <xsl:with-param name="pEndChar" select="']'"/>
                              </xsl:call-template>
                            </xsl:variable>
                            <xsl:variable name="vEndsWithDash">
                              <xsl:call-template name="tEndsWith">
                                <xsl:with-param name="pStr" select="."/>
                                <xsl:with-param name="pEndChar" select="'-'"/>
                              </xsl:call-template>
                            </xsl:variable>
                            <xsl:variable name="vEndsWithPeriod">
                              <xsl:call-template name="tEndsWith">
                                <xsl:with-param name="pStr" select="."/>
                                <xsl:with-param name="pEndChar" select="'.'"/>
                              </xsl:call-template>
                            </xsl:variable>
                            <xsl:choose>
                              <xsl:when test="$vEndsWithBracket = '1'"/>
                              <xsl:when test="$vEndsWithDash = '1'"/>
                              <xsl:when test="$vEndsWithPeriod = '0'">
                                <xsl:text>.</xsl:text>
                              </xsl:when>
                            </xsl:choose>
                          </xsl:if>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="bf:date[not(@rdf:datatype) and @xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                      <xsl:for-each select="bf:date[not(@rdf:datatype) and @xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                        <marc:subfield code="c">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Maximum number of 264 fields reached (10).</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]/bf:copyrightDate[. != '']" mode="generate-264">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:extent/bf:Extent" mode="generate-300">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:choose>
        <xsl:when test="bf:Instance[not(rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance'])]/bf:duration[@rdf:datatype='http://www.w3.org/2001/XMLSchema#duration']">
          <marc:datafield>
            <xsl:attribute name="tag">306</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:for-each select="bf:Instance[not(rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance'])]/bf:duration[@rdf:datatype='http://www.w3.org/2001/XMLSchema#duration']">
              <marc:subfield code="a">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="."/>
                </xsl:call-template>
              </marc:subfield>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:apply-templates select="bf:Instance[not(rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance'])]/bf:frequency/bf:Frequency[rdfs:label or bf:date]" mode="generate-vFreqTag">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance[not(rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance'])]/bf:issuance" mode="generate-334">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:content/*[local-name()='Content' or                                                  rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Content'] or                                                  local-name()='Authority' or                                                  rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]" mode="generate-336">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:media/*[local-name()='Media' or                                                    rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Media'] or                                                    local-name()='Authority' or                                                    rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]" mode="generate-337">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:carrier/*[local-name()='Carrier' or                                                      rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Carrier'] or                                                      local-name()='Authority' or                                                      rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]" mode="generate-338">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:baseMaterial/bf:BaseMaterial |                     bf:Instance/bf:appliedMaterial/bf:AppliedMaterial |                     bf:Instance/bf:productionMethod/bf:ProductionMethod |                     bf:Instance/bf:mount/bf:Mount |                     bf:Instance/bf:reductionRatio/bf:ReductionRatio |                     bf:Work/bf:colorContent/bf:ColorContent |                     bf:Instance/bf:generation/bf:Generation |                     bf:Instance/bf:layout/bf:Layout |                     bf:Instance/bf:bookFormat/bf:BookFormat |                     bf:Instance/bf:fontSize/bf:FontSize |                     bf:Instance/bf:polarity/bf:Polarity |                     bf:Instance/bf:binding/bf:Binding |                     bf:Work/bf:illustrativeContent/bf:Illustration" mode="generate-340">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:soundCharacteristic/bf:RecordingMethod |                     bf:Instance/bf:soundCharacteristic/bf:RecordingMedium |                     bf:Instance/bf:soundCharacteristic/bf:PlayingSpeed |                     bf:Instance/bf:soundCharacteristic/bf:GrooveCharacteristic |                     bf:Instance/bf:soundCharacteristic/bf:TrackConfig |                     bf:Instance/bf:soundCharacteristic/bf:TapeConfig |                     bf:Instance/bf:soundCharacteristic/bf:PlaybackChannels |                     bf:Instance/bf:soundCharacteristic/bf:PlaybackCharacteristic |                     bf:Instance/bf:soundCharacteristic/bf:CaptureStorage |                     bf:Instance/bf:soundCharacteristic/bflc:CaptureStorage |                     bf:Work/bf:soundContent/bf:SoundContent" mode="generate-344">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:projectionCharacteristic/bf:PresentationFormat |                     bf:Instance/bf:projectionCharacteristic/bf:ProjectionSpeed" mode="generate-345">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:aspectRatio/bf:AspectRatio[rdfs:label|rdf:value]" mode="generate-345">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:videoCharacteristic/bf:VideoFormat |                     bf:Instance/bf:videoCharacteristic/bf:BroadcastStandard" mode="generate-346">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:digitalCharacteristic/bf:FileType |                     bf:Instance/bf:digitalCharacteristic/bf:EncodingFormat |                     bf:Instance/bf:digitalCharacteristic/bf:FileSize |                     bf:Instance/bf:digitalCharacteristic/bf:Resolution |                     bf:Instance/bf:digitalCharacteristic/bf:RegionalEncoding |                     bf:Instance/bf:digitalCharacteristic/bf:EncodedBitrate" mode="generate-347">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:musicFormat/bf:MusicFormat | bf:Work/bf:notation/bf:MusicNotation |                     bf:Instance/bf:musicFormat/bf:MusicFormat | bf:Instance/bf:notation/bf:MusicNotation" mode="generate-348">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:collectionArrangement/bf:CollectionArrangement" mode="generate-351">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:digitalCharacteristic/bf:CartographicDataType |                     bf:Instance/bf:digitalCharacteristic/bf:CartographicObjectType" mode="generate-352">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:supplementaryContent/bf:SupplementaryContent[@rdf:about]" mode="generate-353">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:firstIssue" mode="generate-362">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:originPlace/bf:Place" mode="generate-370">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:musicMedium/bf:MusicMedium[bflc:readMarc382]" mode="generate-382">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:musicSerialNumber or                 bf:Work/bf:musicOpusNumber or                 bf:Work/bf:musicThematicNumber">
          <marc:datafield>
            <xsl:attribute name="tag">383</xsl:attribute>
            <xsl:attribute name="ind1">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:attribute name="ind2">
              <xsl:text> </xsl:text>
            </xsl:attribute>
            <xsl:for-each select="bf:Work/bf:musicSerialNumber |                        bf:Work/bf:musicOpusNumber |                        bf:Work/bf:musicThematicNumber">
              <xsl:choose>
                <xsl:when test="local-name() = 'musicSerialNumber'">
                  <marc:subfield code="a">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:when>
                <xsl:when test="local-name() = 'musicOpusNumber'">
                  <marc:subfield code="b">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:when>
                <xsl:when test="local-name() = 'musicThematicNumber'">
                  <marc:subfield code="c">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:when>
              </xsl:choose>
            </xsl:for-each>
          </marc:datafield>
        </xsl:when>
      </xsl:choose>
      <xsl:apply-templates select="bf:Work/bf:musicKey" mode="generate-384">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:intendedAudience">
        <xsl:variable name="vSourceUri">
          <xsl:choose>
            <xsl:when test="*/bf:source/@rdf:resource">
              <xsl:value-of select="*/bf:source/@rdf:resource"/>
            </xsl:when>
            <xsl:when test="*/bf:source/bf:Source/@rdf:about">
              <xsl:value-of select="*/bf:source/bf:Source/@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vSharedDollar2">
          <xsl:choose>
            <xsl:when test="contains(self::node()/@rdf:resource, 'id.loc.gov/authorities/demographicTerms') or                      contains(*/@rdf:about, 'id.loc.gov/authorities/demographicTerms')">
              <marc:subfield code="2">lcdgt</marc:subfield>
            </xsl:when>
            <xsl:when test="contains(self::node()/@rdf:resource, 'id.loc.gov/authorities/subjects') or                      contains(*/@rdf:about, 'id.loc.gov/authorities/subjects')">
              <marc:subfield code="2">lcsh</marc:subfield>
            </xsl:when>
            <xsl:when test="*/bf:source/bf:Source/*[local-name()='code']">
              <xsl:variable name="v-2">
                <xsl:value-of select="*/bf:source/bf:Source/*[local-name()='code'][1]"/>
              </xsl:variable>
              <xsl:if test="$v-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v-2"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="$vSourceUri != ''">
              <xsl:variable name="v-2">
                <xsl:choose>
                  <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vSourceUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vSourceUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v-2"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="@rdf:resource[not(contains(., '/maudience/'))] or                    bf:IntendedAudience[                     @rdf:about[not(contains(., '/maudience/'))] or                      bf:source//@rdf:*[. = 'http://id.loc.gov/vocabulary/subjectSchemes/lcdgt'] or                      bf:source//@rdf:*[. = 'http://id.loc.gov/vocabulary/subjectSchemes/lcsh'] or                      bf:source//bf:code[. = 'lcsh']                  ]">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="bf:IntendedAudience/rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">385</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v385-3">
                <xsl:choose>
                  <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
                    <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 385 $3.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 385 $3.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v385-3 != ''">
                <marc:subfield code="3">
                  <xsl:value-of select="$v385-3"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="bf:IntendedAudience/bflc:demographicGroup/bflc:DemographicGroup/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 385 $m.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:IntendedAudience/bflc:demographicGroup[@rdf:resource or */@rdf:about]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="n">
                      <xsl:variable name="vDGUri">
                        <xsl:choose>
                          <xsl:when test="@rdf:resource">
                            <xsl:value-of select="@rdf:resource"/>
                          </xsl:when>
                          <xsl:when test="*/@rdf:about">
                            <xsl:value-of select="*/@rdf:about"/>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="contains($vDGUri,'id.loc.gov')">
                          <xsl:call-template name="tUriCode">
                            <xsl:with-param name="pUri" select="$vDGUri"/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="."/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 385 $n.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:IntendedAudience/rdfs:label">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vSharedDollar2"/>
              <xsl:for-each select="@rdf:resource|bf:IntendedAudience/@rdf:about">
                <marc:subfield code="0">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
          <xsl:when test="bf:IntendedAudience[not(@rdf:about)]/rdfs:label">
            <marc:datafield>
              <xsl:attribute name="tag">521</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="bf:IntendedAudience/bf:note/bf:Note/rdfs:label = 'reading grade level'">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:IntendedAudience/bf:note/bf:Note/rdfs:label = 'interest age level'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:IntendedAudience/bf:note/bf:Note/rdfs:label = 'interest grade level'">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="bf:IntendedAudience/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 521 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:IntendedAudience/rdfs:label">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:IntendedAudience/bf:source/bf:Source/rdfs:label">
                <marc:subfield code="b">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vSharedDollar2"/>
            </marc:datafield>
          </xsl:when>
          <xsl:when test="bflc:DemographicGroup[not(@rdf:about)]/rdfs:label">
            <marc:datafield>
              <xsl:attribute name="tag">385</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="bflc:DemographicGroup/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 385 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bflc:DemographicGroup/rdfs:label">
                <marc:subfield code="m">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vSharedDollar2"/>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Work/bflc:creatorCharacteristic" mode="generate-386">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:Series[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bflc:Uncontrolled[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |         //bf:Item/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |              bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:Series[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bflc:Uncontrolled[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |         //bf:Item/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |                  bf:Work/bf:hasSeries/bf:Series[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']] |         //bf:Item/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[bf:status/@rdf:resource[.='http://id.loc.gov/vocabulary/mstatus/t'] or bf:status/bf:Status/@rdf:about[.='http://id.loc.gov/vocabulary/mstatus/t']]">
        <xsl:variable name="vLangTagLabel" select="bf:title/bf:Title/bf:mainTitle[                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                    string-length(@xml:lang)='2' or                    string-length(@xml:lang)='3'                 ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="bf:title/bf:Title/bf:mainTitle[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="vScript">
          <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
        </xsl:variable>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="$vScript"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurence">
          <xsl:value-of select="35+position()"/>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="bf:title/bf:Title/bf:mainTitle[                     not(@xml:lang) or                      contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                      string-length(@xml:lang)='2' or                      string-length(@xml:lang)='3']">
            <marc:datafield>
              <xsl:attribute name="tag">490</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="bf:status//@rdf:*[1] = 'http://id.loc.gov/vocabulary/mstatus/tr'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$v880Script != ''">
                  <xsl:variable name="v490-6">
                    <xsl:value-of select="concat('880-',$v880Occurence)"/>
                  </xsl:variable>
                  <xsl:if test="$v490-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v490-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 490 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:variable name="vMainTitle">
                <xsl:choose>
                  <xsl:when test="bf:title/bf:Title/bf:mainTitle[                                 not(@xml:lang) or                                  contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                  string-length(@xml:lang)='2' or                                  string-length(@xml:lang)='3']">
                    <xsl:for-each select="bf:title/bf:Title/bf:mainTitle[                                       not(@xml:lang) or                                         contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                        string-length(@xml:lang)='2' or                                        string-length(@xml:lang)='3']">
                      <xsl:value-of select="."/>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vParallelTitle">
                <xsl:choose>
                  <xsl:when test="bf:title/bf:ParallelTitle/bf:mainTitle[                                 not(@xml:lang) or                                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                  string-length(@xml:lang)='2' or                                  string-length(@xml:lang)='3']">
                    <xsl:for-each select="bf:title/bf:ParallelTitle/bf:mainTitle[                                   not(@xml:lang) or                                     contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                    string-length(@xml:lang)='2' or                                    string-length(@xml:lang)='3']">
                      <xsl:value-of select="."/>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vMainTitle != '' and $vParallelTitle != ''">
                  <xsl:variable name="v490-a">
                    <xsl:value-of select="concat($vMainTitle, ' =')"/>
                  </xsl:variable>
                  <xsl:if test="$v490-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v490-a"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="$vMainTitle != ''">
                  <xsl:variable name="v490-a">
                    <xsl:choose>
                      <xsl:when test="bf:identifiedBy/*[local-name()='Issn']">
                        <xsl:value-of select="concat($vMainTitle, ',')"/>
                      </xsl:when>
                      <xsl:when test="ancestor::bf:Relation/bf:seriesEnumeration[                                               not(@xml:lang) or                                                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                                string-length(@xml:lang)='2' or                                                string-length(@xml:lang)='3']">
                        <xsl:value-of select="concat($vMainTitle, ' ;')"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$vMainTitle"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v490-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v490-a"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vParallelTitle != ''">
                  <xsl:for-each select="bf:title/bf:ParallelTitle/bf:mainTitle[                                               not(@xml:lang) or                                                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                                string-length(@xml:lang)='2' or                                                string-length(@xml:lang)='3']">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                      <xsl:if test="position() != last()">
                        <xsl:text> =</xsl:text>
                      </xsl:if>
                      <xsl:choose>
                        <xsl:when test="position() != last()">
                          <xsl:text> =</xsl:text>
                        </xsl:when>
                        <xsl:when test="bf:identifiedBy/*[local-name()='Issn']">
                          <xsl:value-of select="concat($vMainTitle, ',')"/>
                        </xsl:when>
                        <xsl:when test="ancestor::bf:Relation/bf:seriesEnumeration[                                                 not(@xml:lang) or                                                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                                  string-length(@xml:lang)='2' or                                                  string-length(@xml:lang)='3']">
                          <xsl:value-of select="concat($vMainTitle, ' ;')"/>
                        </xsl:when>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and not(bf:status)]/rdf:value">
                  <xsl:for-each select="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and not(bf:status)]/rdf:value">
                    <marc:subfield code="x">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="ancestor::bf:Relation/bf:seriesEnumeration[                                         not(@xml:lang) or                                           contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                          string-length(@xml:lang)='2' or                                          string-length(@xml:lang)='3']">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/incorrect']/rdf:value">
                  <xsl:for-each select="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/incorrect']/rdf:value">
                    <marc:subfield code="y">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="ancestor::bf:Relation/bf:seriesEnumeration[                                           not(@xml:lang) or                                             contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                            string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3']">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv']/rdf:value">
                  <xsl:for-each select="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv']/rdf:value">
                    <marc:subfield code="z">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="ancestor::bf:Relation/bf:seriesEnumeration[                                           not(@xml:lang) or                                             contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                            string-length(@xml:lang)='2' or                                            string-length(@xml:lang)='3']">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="../../bf:seriesEnumeration[                                   not(@xml:lang) or                                     contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                                    string-length(@xml:lang)='2' or                                    string-length(@xml:lang)='3']">
                <marc:subfield code="v">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$v880Script!=''">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="bf:status//@rdf:*[1] = 'http://id.loc.gov/vocabulary/mstatus/tr'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('490-',$v880Occurence,'/',$v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:variable name="vMainTitle">
                <xsl:choose>
                  <xsl:when test="bf:title/bf:Title/bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                    <xsl:for-each select="bf:title/bf:Title/bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                      <xsl:value-of select="."/>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vParallelTitle">
                <xsl:choose>
                  <xsl:when test="bf:title/bf:ParallelTitle/bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                    <xsl:for-each select="bf:title/bf:ParallelTitle/bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                      <xsl:value-of select="."/>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vMainTitle != '' and $vParallelTitle != ''">
                  <xsl:variable name="v880-a">
                    <xsl:value-of select="concat($vMainTitle, ' =')"/>
                  </xsl:variable>
                  <xsl:if test="$v880-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v880-a"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="$vMainTitle != ''">
                  <xsl:variable name="v880-a">
                    <xsl:choose>
                      <xsl:when test="bf:identifiedBy/*[local-name()='Issn']">
                        <xsl:value-of select="concat($vMainTitle, ',')"/>
                      </xsl:when>
                      <xsl:when test="ancestor::bf:Relation/bf:seriesEnumeration[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                        <xsl:value-of select="concat($vMainTitle, ' ;')"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$vMainTitle"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v880-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v880-a"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vParallelTitle != ''">
                  <xsl:for-each select="bf:title/bf:ParallelTitle/bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                      <xsl:if test="position() != last()">
                        <xsl:text> =</xsl:text>
                      </xsl:if>
                      <xsl:choose>
                        <xsl:when test="position() != last()">
                          <xsl:text> =</xsl:text>
                        </xsl:when>
                        <xsl:when test="bf:identifiedBy/*[local-name()='Issn']">
                          <xsl:value-of select="concat($vMainTitle, ',')"/>
                        </xsl:when>
                        <xsl:when test="ancestor::bf:Relation/bf:seriesEnumeration[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                          <xsl:value-of select="concat($vMainTitle, ' ;')"/>
                        </xsl:when>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and not(bf:status)]/rdf:value">
                  <xsl:for-each select="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and not(bf:status)]/rdf:value">
                    <marc:subfield code="x">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="ancestor::bf:Relation/bf:seriesEnumeration[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/incorrect']/rdf:value">
                  <xsl:for-each select="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/incorrect']/rdf:value">
                    <marc:subfield code="y">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="ancestor::bf:Relation/bf:seriesEnumeration[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv']/rdf:value">
                  <xsl:for-each select="bf:identifiedBy/*[(local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn') and bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv']/rdf:value">
                    <marc:subfield code="z">
                      <xsl:value-of select="."/>
                      <xsl:if test="following-sibling::bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']">
                        <xsl:text>,</xsl:text>
                      </xsl:if>
                      <xsl:if test="ancestor::bf:Relation/bf:seriesEnumeration[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                        <xsl:text> ;</xsl:text>
                      </xsl:if>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="../../bf:seriesEnumeration[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="v">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Instance/bf:seriesStatement">
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after(@xml:lang,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text>0</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('490-00/',$v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <marc:subfield code="a">
                <xsl:value-of select="."/>
              </marc:subfield>
            </marc:datafield>
          </xsl:when>
          <xsl:otherwise>
            <marc:datafield>
              <xsl:attribute name="tag">490</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text>0</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <marc:subfield code="a">
                <xsl:value-of select="."/>
              </marc:subfield>
            </marc:datafield>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Instance/bf:note/bf:Note[rdfs:*[. != ''] or rdf:value[. != ''] or bf:*]|bf:Work/bf:note/bf:Note[rdfs:*[. != ''] or rdf:value[. != ''] or bf:*]|//bf:Item/bf:note/bf:Note[rdfs:*[. != ''] or rdf:value[. != ''] or bf:*]">
        <xsl:variable name="vLabel" select="rdfs:label[                 not(@xml:lang) or                  (                   string-length(@xml:lang)='2' or                    string-length(@xml:lang)='3' or                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))                 )                ][1]"/>
        <xsl:variable name="vLangTagLabel" select="rdfs:label[                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                  string-length(@xml:lang)='2' or                  string-length(@xml:lang)='3'             ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="string($vLabel) = ''">
              <xsl:text>00</xsl:text>
            </xsl:when>
            <xsl:when test="$v880Script != '' and ancestor::bf:Instance">
              <xsl:value-of select="count(../preceding-sibling::bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) + 50"/>
            </xsl:when>
            <xsl:when test="$v880Script != '' and ancestor::bf:Work">
              <xsl:value-of select="count(../preceding-sibling::bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) + 40"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>00</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vTag">
          <xsl:choose>
            <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and                      ( translate(bf:noteType,$upper,$lower)='with' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/with')">
              <xsl:text>501</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      (translate(bf:noteType,$upper,$lower)='report type' or                      rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/report')">
              <xsl:text>513</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='issuance information' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/issuance')">
              <xsl:text>515</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='type of computer data' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/computer')">
              <xsl:text>516</xsl:text>
            </xsl:when>
            <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and                      ( translate(bf:noteType,$upper,$lower)='reproduction version' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/repro')">
              <xsl:text>533</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='additional physical form' or                      rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/addphys')">
              <xsl:text>530</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='original version' or                      rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/orig')">
              <xsl:text>534</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='index' or                      rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/index')">
              <xsl:text>555</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='finding aid' or                      rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/finding')">
              <xsl:text>555</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Instance' and                      ( translate(bf:noteType,$upper,$lower)='issuing body' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/issuing')">
              <xsl:text>550</xsl:text>
            </xsl:when>
            <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and                      ( translate(bf:noteType,$upper,$lower)='exhibition' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/exhibit')">
              <xsl:text>585</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Work' and                      ( translate(bf:noteType,$upper,$lower)='credits' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/credits')">
              <xsl:text>508</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(../..)='Work' and                      ( translate(bf:noteType,$upper,$lower)='participants' or                      rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/participants')">
              <xsl:text>511</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vCast">
          <xsl:choose>
            <xsl:when test="$vTag='511' and starts-with(rdfs:label[1], 'Cast:')">
              <xsl:text>true</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vSimple880sf6">
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:variable name="v-6">
                <xsl:value-of select="concat('880-', $v880Occurrence)"/>
              </xsl:variable>
              <xsl:if test="$v-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vSimple880">
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:for-each select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <marc:datafield>
                  <xsl:attribute name="tag">880</xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="$vCast = 'true'">
                      <xsl:attribute name="ind1">
                        <xsl:text>1</xsl:text>
                      </xsl:attribute>
                    </xsl:when>
                    <xsl:when test="$vTag = '555'">
                      <xsl:attribute name="ind1">
                        <xsl:variable name="vInd">
                          <xsl:choose>
                            <xsl:when test="contains(../rdf:type/@rdf:resource, 'index')">
                              <xsl:text> </xsl:text>
                            </xsl:when>
                            <xsl:when test="contains(../bf:noteType, 'index')">
                              <xsl:text> </xsl:text>
                            </xsl:when>
                            <xsl:when test="contains(../rdf:type/@rdf:resource, 'finding')">
                              <xsl:text>0</xsl:text>
                            </xsl:when>
                            <xsl:when test="contains(../bf:noteType, 'finding')">
                              <xsl:text>0</xsl:text>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:text>8</xsl:text>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vInd != ''">
                            <xsl:value-of select="$vInd"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:text/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:attribute>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:attribute name="ind1">
                        <xsl:text> </xsl:text>
                      </xsl:attribute>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:attribute name="ind2">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:variable name="v880-6">
                    <xsl:value-of select="concat($vTag, '-', $v880Occurrence, '/', $v880Script)"/>
                  </xsl:variable>
                  <xsl:if test="$v880-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v880-6"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:choose>
                    <xsl:when test="$vTag = '508' or $vTag = '511' or $vTag = '533' or $vTag = '534' or $vTag = '585'">
                      <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vCast = 'true'">
                      <xsl:variable name="v880-a">
                        <xsl:value-of select="substring-after(., 'Cast: ')"/>
                      </xsl:variable>
                      <xsl:if test="$v880-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v880-a"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                    <xsl:otherwise>
                      <marc:subfield code="a">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vTag = '530'">
                      <xsl:for-each select="../bf:identifiedBy/*[local-name()='StockNumber' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/StockNumber']/rdf:value">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="d">
                              <xsl:value-of select="."/>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $d.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vTag = '534'">
                      <xsl:for-each select="../bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                        <marc:subfield code="x">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vTag = '534'">
                      <xsl:for-each select="../bf:identifiedBy/*[local-name()='Isbn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']/rdf:value">
                        <marc:subfield code="z">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vTag = '530' or $vTag = '555'">
                      <xsl:for-each select="../bf:electronicLocator/@rdf:resource|../rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                        <marc:subfield code="u">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vTag = '501' or $vTag = '533' or $vTag = '585'">
                      <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="5">
                              <xsl:value-of select="."/>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $5.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                </marc:datafield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="local-name(../..)='Instance' and                   (rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/computer' or translate(bf:noteType,$upper,$lower)='computer file characteristics')">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">256</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 256 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='numbering' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/number')">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">362</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text>1</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 362 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
          <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and (translate(bf:noteType,$upper,$lower)='with' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/with')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">501</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="5">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 501 $5.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="(                     local-name(../..)='Work' and                      (                        translate(bf:noteType,$upper,$lower)='credits' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/credits'                     )                   )">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">508</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 508 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="(                     local-name(../..)='Work' and                      (                        translate(bf:noteType,$upper,$lower)='participants' or                        rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/participants'                     )                   )">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">511</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:choose>
                  <xsl:when test="$vCast = 'true'">
                    <xsl:attribute name="ind1">
                      <xsl:text>1</xsl:text>
                    </xsl:attribute>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:attribute name="ind1">
                      <xsl:text> </xsl:text>
                    </xsl:attribute>
                  </xsl:otherwise>
                </xsl:choose>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="$vCast = 'true'">
                    <xsl:variable name="v511-a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Cast:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v511-a != ''">
                      <marc:subfield code="a">
                        <xsl:value-of select="$v511-a"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:otherwise>
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:otherwise>
                </xsl:choose>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 511 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='report type' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/report')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">513</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='issuance information' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/issuance')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">515</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='type of computer data' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/computer')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">516</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='additional physical form' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/addphys')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <marc:datafield>
                <xsl:attribute name="tag">530</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 530 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bf:identifiedBy/*[local-name()='StockNumber' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/StockNumber']/rdf:value">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="d">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 530 $d.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="../bf:electronicLocator/@rdf:resource|../rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                  <marc:subfield code="u">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and (translate(bf:noteType,$upper,$lower)='reproduction version' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/repro')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <marc:datafield>
                <xsl:attribute name="tag">533</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 533 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bflc:applicableInstitution/*/*[local-name()='code']">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="5">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 533 $5.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='original version' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/orig')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <marc:datafield>
                <xsl:attribute name="tag">534</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <marc:subfield code="3">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:for-each>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                  <marc:subfield code="x">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="../bf:identifiedBy/*[local-name()='Isbn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']/rdf:value">
                  <marc:subfield code="z">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='funding information' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/fundinfo')">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">536</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$v880Script != ''">
                  <xsl:variable name="v536-6">
                    <xsl:value-of select="concat('880-', $v880Occurrence)"/>
                  </xsl:variable>
                  <xsl:if test="$v536-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v536-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="rdfs:label[not(@xml:lang) or              string-length(@xml:lang)='2' or              string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:choose>
                  <xsl:when test="starts-with(.,'Contract:')">
                    <xsl:variable name="v536-b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Contract:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v536-b != ''">
                      <marc:subfield code="b">
                        <xsl:value-of select="$v536-b"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="starts-with(.,'Grant:')">
                    <xsl:variable name="v536-c">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Grant:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v536-c != ''">
                      <marc:subfield code="c">
                        <xsl:value-of select="$v536-c"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="starts-with(.,'Program element:')">
                    <xsl:variable name="v536-e">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Program element:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v536-e != ''">
                      <marc:subfield code="e">
                        <xsl:value-of select="$v536-e"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="starts-with(.,'Project:')">
                    <xsl:variable name="v536-f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Project:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v536-f != ''">
                      <marc:subfield code="f">
                        <xsl:value-of select="$v536-f"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="starts-with(.,'Task:')">
                    <xsl:variable name="v536-g">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Task:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v536-g != ''">
                      <marc:subfield code="g">
                        <xsl:value-of select="$v536-g"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="starts-with(.,'Work unit:')">
                    <xsl:variable name="v536-h">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="substring-after(.,'Work unit:')"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:if test="$v536-h != ''">
                      <marc:subfield code="h">
                        <xsl:value-of select="$v536-h"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:otherwise>
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <marc:datafield>
                  <xsl:attribute name="tag">880</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:variable name="v880-6">
                    <xsl:value-of select="concat('536-', $v880Occurrence, '/', $v880Script)"/>
                  </xsl:variable>
                  <xsl:if test="$v880-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v880-6"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:for-each select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                    <xsl:choose>
                      <xsl:when test="starts-with(.,'Contract:')">
                        <xsl:variable name="v880-b">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="substring-after(.,'Contract:')"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:if test="$v880-b != ''">
                          <marc:subfield code="b">
                            <xsl:value-of select="$v880-b"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'Grant:')">
                        <xsl:variable name="v880-c">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="substring-after(.,'Grant:')"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:if test="$v880-c != ''">
                          <marc:subfield code="c">
                            <xsl:value-of select="$v880-c"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'Program element:')">
                        <xsl:variable name="v880-e">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="substring-after(.,'Program element:')"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:if test="$v880-e != ''">
                          <marc:subfield code="e">
                            <xsl:value-of select="$v880-e"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'Project:')">
                        <xsl:variable name="v880-f">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="substring-after(.,'Project:')"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:if test="$v880-f != ''">
                          <marc:subfield code="f">
                            <xsl:value-of select="$v880-f"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'Task:')">
                        <xsl:variable name="v880-g">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="substring-after(.,'Task:')"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:if test="$v880-g != ''">
                          <marc:subfield code="g">
                            <xsl:value-of select="$v880-g"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'Work unit:')">
                        <xsl:variable name="v880-h">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="substring-after(.,'Work unit:')"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:if test="$v880-h != ''">
                          <marc:subfield code="h">
                            <xsl:value-of select="$v880-h"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:otherwise>
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and                   (translate(bf:noteType,$upper,$lower)='biographical data' or translate(bf:noteType,$upper,$lower)='administrative history' or                   rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/biogdata' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/adminhist')">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">545</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="translate(bf:noteType,$upper,$lower)='biographical data' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/biogdata'">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="translate(bf:noteType,$upper,$lower)='administrative history' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/adminhist'">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 545 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                <marc:subfield code="u">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='issuing body' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/issuing')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">550</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and                   (translate(bf:noteType,$upper,$lower)='index' or translate(bf:noteType,$upper,$lower)='finding aid' or                   rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/index' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/finding')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]/@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">555</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="translate(../bf:noteType,$upper,$lower)='index' or ../rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/index'">
                        <xsl:text> </xsl:text>
                      </xsl:when>
                      <xsl:when test="translate(../bf:noteType,$upper,$lower)='finding aid' or ../rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/finding'">
                        <xsl:text>0</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text>8</xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <xsl:for-each select="self::node()[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="a">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 555 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="../bf:electronicLocator/@rdf:resource|../rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                  <marc:subfield code="u">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='documentation' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/doc')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">556</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text>8</xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="local-name(../..)='Instance' and (translate(bf:noteType,$upper,$lower)='related material' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/related')">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">581</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text>8</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 581 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/*[local-name()='Isbn' or rdf:type/rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']/rdf:value">
                <marc:subfield code="z">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
          <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and (translate(bf:noteType,$upper,$lower)='exhibition' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/exhibit')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">585</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:copy-of select="$vSimple880sf6"/>
                  </xsl:when>
                </xsl:choose>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 585 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="5">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 585 $5.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:copy-of select="$vSimple880"/>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and (translate(bf:noteType,$upper,$lower)='description source' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/descsource')">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or            string-length(@xml:lang)='2' or            string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">588</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="starts-with(.,'Source of description:') or starts-with(rdfs:label,'Description based on:')">
                        <xsl:text>0</xsl:text>
                      </xsl:when>
                      <xsl:when test="starts-with(.,'Latest issue consulted:')">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:variable name="v588-6">
                      <xsl:value-of select="concat('880-', $v880Occurrence)"/>
                    </xsl:variable>
                    <xsl:if test="$v588-6 != ''">
                      <marc:subfield code="6">
                        <xsl:value-of select="$v588-6"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                </xsl:choose>
                <xsl:variable name="v588-a">
                  <xsl:choose>
                    <xsl:when test="starts-with(.,'Source of description:')">
                      <xsl:value-of select="normalize-space(substring-after(.,'Source of description:'))"/>
                    </xsl:when>
                    <xsl:when test="starts-with(.,'Latest issue consulted:')">
                      <xsl:value-of select="normalize-space(substring-after(.,'Latest issue consulted:'))"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="."/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:if test="$v588-a != ''">
                  <marc:subfield code="a">
                    <xsl:value-of select="$v588-a"/>
                  </marc:subfield>
                </xsl:if>
                <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="5">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 588 $5.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:for-each select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                  <marc:datafield>
                    <xsl:attribute name="tag">880</xsl:attribute>
                    <xsl:attribute name="ind1">
                      <xsl:variable name="vInd">
                        <xsl:choose>
                          <xsl:when test="starts-with(.,'Source of description:') or starts-with(rdfs:label,'Description based on:')">
                            <xsl:text>0</xsl:text>
                          </xsl:when>
                          <xsl:when test="starts-with(.,'Latest issue consulted:')">
                            <xsl:text>1</xsl:text>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vInd != ''">
                          <xsl:value-of select="$vInd"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text> </xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:attribute>
                    <xsl:attribute name="ind2">
                      <xsl:text> </xsl:text>
                    </xsl:attribute>
                    <xsl:variable name="v880-6">
                      <xsl:value-of select="concat('588-', $v880Occurrence, '/', $v880Script)"/>
                    </xsl:variable>
                    <xsl:if test="$v880-6 != ''">
                      <marc:subfield code="6">
                        <xsl:value-of select="$v880-6"/>
                      </marc:subfield>
                    </xsl:if>
                    <xsl:variable name="v880-a">
                      <xsl:choose>
                        <xsl:when test="starts-with(.,'Source of description:')">
                          <xsl:value-of select="normalize-space(substring-after(.,'Source of description:'))"/>
                        </xsl:when>
                        <xsl:when test="starts-with(.,'Latest issue consulted:')">
                          <xsl:value-of select="normalize-space(substring-after(.,'Latest issue consulted:'))"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="."/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v880-a != ''">
                      <marc:subfield code="a">
                        <xsl:value-of select="$v880-a"/>
                      </marc:subfield>
                    </xsl:if>
                    <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="5">
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $5.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </marc:datafield>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="(local-name(../..)='Work' and          (           translate(bf:noteType,$upper,$lower)='language' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/lang' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/award' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/credits' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/participants' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/doc' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/citeas' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/suppl'         ))"/>
          <xsl:when test="(           local-name(../..)='Work' and            contains(rdf:type/@rdf:resource, 'http://id.loc.gov/vocabulary/resourceComponents')         )"/>
          <xsl:when test="(local-name(../..)='Instance' or local-name(../..)='Item') and                    (                   (translate(bf:noteType,$upper,$lower)='physical details' or translate(bf:noteType,$upper,$lower)='accompanying material' or translate(bf:noteType,$upper,$lower)='binding' or translate(bf:noteType,$upper,$lower)='action') or                    (rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/physical' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/accmat' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/binding' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/action')                   )"/>
          <xsl:when test="(         local-name(../..)='Instance' and          rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/biblio'         )"/>
          <xsl:when test="(local-name(../..)='Instance' and          (           rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/doc' or            rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/citeas' or           rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/refcitation'         ))"/>
          <xsl:otherwise>
            <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))][1]">
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="./@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">500</xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:choose>
                  <xsl:when test="$v880Script != ''">
                    <xsl:variable name="v500-6">
                      <xsl:value-of select="concat('880-', $v880Occurrence)"/>
                    </xsl:variable>
                    <xsl:if test="$v500-6 != ''">
                      <marc:subfield code="6">
                        <xsl:value-of select="$v500-6"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                </xsl:choose>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 500 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:variable name="v500-a">
                  <xsl:variable name="vNoteText">
                    <xsl:for-each select="../rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                      <xsl:choose>
                        <xsl:when test="position() = last()">
                          <xsl:value-of select="."/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="concat(.,' ')"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:variable>
                  <!-- Do not chop punctuation - 20241119 -->
                  <!--
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="$vNoteText"/>
                </xsl:call-template>
                -->
                  <xsl:value-of select="$vNoteText"/>
                </xsl:variable>
                <xsl:if test="$v500-a != ''">
                  <marc:subfield code="a">
                    <xsl:value-of select="$v500-a"/>
                  </marc:subfield>
                </xsl:if>
                <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="5">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 500 $5.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
            <xsl:choose>
              <xsl:when test="$v880Script != ''">
                <xsl:for-each select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                  <marc:datafield>
                    <xsl:attribute name="tag">880</xsl:attribute>
                    <xsl:attribute name="ind1">
                      <xsl:text> </xsl:text>
                    </xsl:attribute>
                    <xsl:attribute name="ind2">
                      <xsl:text> </xsl:text>
                    </xsl:attribute>
                    <xsl:variable name="v880-6">
                      <xsl:value-of select="concat('500-', $v880Occurrence, '/', $v880Script)"/>
                    </xsl:variable>
                    <xsl:if test="$v880-6 != ''">
                      <marc:subfield code="6">
                        <xsl:value-of select="$v880-6"/>
                      </marc:subfield>
                    </xsl:if>
                    <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="3">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $3.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:variable name="v880-a">
                      <xsl:variable name="vNoteText">
                        <xsl:for-each select="../rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                          <xsl:choose>
                            <xsl:when test="position() = last()">
                              <xsl:value-of select="."/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:value-of select="concat(.,' ')"/>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:variable>
                      <!-- Do not chop punctuation - 20241119 -->
                      <!--
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="$vNoteText"/>
                </xsl:call-template>
                -->
                      <xsl:value-of select="$vNoteText"/>
                    </xsl:variable>
                    <xsl:if test="$v880-a != ''">
                      <marc:subfield code="a">
                        <xsl:value-of select="$v880-a"/>
                      </marc:subfield>
                    </xsl:if>
                    <xsl:for-each select="../bflc:applicableInstitution/bf:Agent/bf:code">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="5">
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $5.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </marc:datafield>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Work/bf:dissertation/bf:Dissertation">
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="rdfs:label[@xml:lang and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after(rdfs:label/@xml:lang,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
            <xsl:when test="bf:degree[@xml:lang and not(contains(translate(bf:degree/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after(bf:degree/@xml:lang,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
            <xsl:when test="bf:grantingInstitution/*/rdfs:label[@xml:lang and not(contains(translate(bf:grantingInstitution/*/rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after(bf:grantingInstitution/*/rdfs:label,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="$v880Script != '' and ancestor::bf:Work">
              <!-- 
              This should be the next in the numerical sequence for work notes, 
              when also accounting for tableOfContents and supplementary content 
              and dissertation .. -->
              <xsl:value-of select="               39 +                count(ancestor::bf:Work/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +                count(ancestor::bf:Work/bf:tableOfContents/bf:TableOfContents[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +               count(ancestor::bf:Work/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != '' and @xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and not(@rdf:about)]) +               count(ancestor::bf:Work/bf:dissertation/bf:Dissertation) +               position()"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">502</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:variable name="v502-6">
                <xsl:value-of select="concat('880-', $v880Occurrence)"/>
              </xsl:variable>
              <xsl:if test="$v502-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v502-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 502 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:degree[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="b">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 502 $b.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:grantingInstitution/*/rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="c">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 502 $c.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:date[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="d">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 502 $d.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:note/*/rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <marc:subfield code="g">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:identifiedBy/*/rdf:value[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <marc:subfield code="o">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:value-of select="concat('502-', $v880Occurrence, '/', $v880Script)"/>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:degree[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $b.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:grantingInstitution/*/rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="c">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $c.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:date[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="d">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $d.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:note/*/rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <marc:subfield code="g">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/*/rdf:value[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
                <marc:subfield code="o">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Work/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != ''] and not(@rdf:about)]  |     bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != ''] and not(@rdf:about)]     ">
        <xsl:variable name="vLangTagLabel" select="rdfs:label[                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                    string-length(@xml:lang)='2' or                    string-length(@xml:lang)='3'                 ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="rdfs:label/bflc:marcKey[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="$v880Script != '' and ancestor::bf:Work">
              <!-- 
              This should be the next in the numerical sequence for work notes, 
              when also accounting for tableOfContents and supplementary content .. -->
              <xsl:value-of select="               39 +                count(ancestor::bf:Work/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +                count(ancestor::bf:Work/bf:tableOfContents/bf:TableOfContents[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +               count(ancestor::bf:Work/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != '' and @xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and not(@rdf:about)]) +                position()"/>
            </xsl:when>
            <xsl:when test="$v880Script != '' and ancestor::bf:Instance">
              <!-- 
              This should be the next in the numerical sequence for instance notes, 
              when also accounting for supplementary content .. -->
              <xsl:value-of select="             49 +              count(ancestor::bf:Instance/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +              count(ancestor::bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != '' and @xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and not(@rdf:about)]) +              position()"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">504</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:variable name="v504-6">
                <xsl:value-of select="concat('880-', $v880Occurrence)"/>
              </xsl:variable>
              <xsl:if test="$v504-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v504-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 504 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:count">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="b">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 504 $b.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <xsl:for-each select="rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <marc:datafield>
                <xsl:attribute name="tag">880</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:variable name="v880-6">
                  <xsl:value-of select="concat('504-', $v880Occurrence, '/', $v880Script)"/>
                </xsl:variable>
                <xsl:if test="$v880-6 != ''">
                  <marc:subfield code="6">
                    <xsl:value-of select="$v880-6"/>
                  </marc:subfield>
                </xsl:if>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="bf:count">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="b">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $b.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Instance/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/biblio' and rdfs:label[. != '']]">
        <xsl:variable name="vLangTagLabel" select="rdfs:label[                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                  string-length(@xml:lang)='2' or                  string-length(@xml:lang)='3'               ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <!-- 
              This should be the next in the numerical sequence for instance notes, 
              when also accounting for supplementary content .. -->
              <xsl:value-of select="               49 +                count(ancestor::bf:Instance/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +                count(ancestor::bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != '' and @xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and not(@rdf:about)]) +                position() +                1"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">504</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:variable name="v504-6">
                <xsl:value-of select="concat('880-', $v880Occurrence)"/>
              </xsl:variable>
              <xsl:if test="$v504-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v504-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 504 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:count">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="b">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 504 $b.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <xsl:for-each select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <marc:datafield>
                <xsl:attribute name="tag">880</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:variable name="v880-6">
                  <xsl:value-of select="concat('504-', $v880Occurrence, '/', $v880Script)"/>
                </xsl:variable>
                <xsl:if test="$v880-6 != ''">
                  <marc:subfield code="6">
                    <xsl:value-of select="$v880-6"/>
                  </marc:subfield>
                </xsl:if>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="bf:count">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="b">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $b.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Work/bf:tableOfContents/bf:TableOfContents[rdfs:label]">
        <xsl:variable name="vLangTagLabel" select="rdfs:label[       contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or        string-length(@xml:lang)='2' or        string-length(@xml:lang)='3'       ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <!-- This should be the next in the numerical sequence for work notes. -->
              <xsl:value-of select="39 + count(ancestor::bf:Work/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) + position()"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label[not(@xml:lang) or        string-length(@xml:lang)='2' or        string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">505</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="bf:status//@rdf:*[.='http://id.loc.gov/vocabulary/mstatus/incmp']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="bf:status//@rdf:*[.='http://id.loc.gov/vocabulary/mstatus/part']">
                  <xsl:text>2</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>0</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:variable name="v505-6">
                <xsl:value-of select="concat('880-', $v880Occurrence)"/>
              </xsl:variable>
              <xsl:if test="$v505-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v505-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="rdfs:label[not(@xml:lang) or          string-length(@xml:lang)='2' or          string-length(@xml:lang)='3' or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 505 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
            <marc:subfield code="u">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <xsl:for-each select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <marc:datafield>
                <xsl:attribute name="tag">880</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="../bf:status//@rdf:*[.='http://id.loc.gov/vocabulary/mstatus/incmp']">
                        <xsl:text>1</xsl:text>
                      </xsl:when>
                      <xsl:when test="../bf:status//@rdf:*[.='http://id.loc.gov/vocabulary/mstatus/part']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text>0</xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:variable name="v880-6">
                  <xsl:value-of select="concat('505-', $v880Occurrence, '/', $v880Script)"/>
                </xsl:variable>
                <xsl:if test="$v880-6 != ''">
                  <marc:subfield code="6">
                    <xsl:value-of select="$v880-6"/>
                  </marc:subfield>
                </xsl:if>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="../bf:electronicLocator/@rdf:resource|../rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                  <marc:subfield code="u">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Instance/bf:usageAndAccessPolicy/* | //bf:Item/bf:usageAndAccessPolicy/*">
        <xsl:choose>
          <xsl:when test="local-name()='UsePolicy' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/UsePolicy'">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">540</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:note/bf:Note/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="d">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $d.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:qualifier">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                <marc:subfield code="u">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $0.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:source/bf:Source/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="2">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $2.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 540 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">506</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 506 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 506 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:qualifier">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="f">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 506 $f.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                <marc:subfield code="u">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 506 $0.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:source/bf:Source/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="2">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 506 $2.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 506 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Instance/bf:note/bf:*[rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/refcitation']] |                     bf:Work/bf:relation/bf:Relation[bf:relationship//@rdf:*[1]='http://id.loc.gov/vocabulary/relationship/references']/bf:associatedResource/bf:Work |                     bf:Work/bf:relation/bf:Relation[bf:relationship//@rdf:*[1]='http://id.loc.gov/vocabulary/relationship/indexedin']/bf:associatedResource/bf:Work |                     bf:Work/bflc:indexedIn/bf:Work |                     bf:Work/bf:references/bf:Work" mode="generate-510">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:capture/bf:Capture[not(bf:date[@rdf:datatype='http://id.loc.gov/datatypes/edtf']) and not(bf:place/@rdf:resource)]" mode="generate-518">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:summary/bf:Summary[rdfs:label]">
        <xsl:variable name="vLabel" select="rdfs:label[                   not(@xml:lang) or                    (                     string-length(@xml:lang)='2' or                      string-length(@xml:lang)='3' or                     contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))                   )                 ][1]"/>
        <xsl:variable name="vLangTagLabel" select="rdfs:label[                   @xml:lang and                   (                       ( contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))) ) or                      string-length(@xml:lang)='2' or                      string-length(@xml:lang)='3'                   )                   ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="string($vLabel) = ''">
              <xsl:text>00</xsl:text>
            </xsl:when>
            <xsl:when test="$v880Script != ''">
              <!-- This should be the next in the numerical sequence for work notes, when also accounting for tableOfContents .. -->
              <xsl:value-of select="                             39 +                              count(ancestor::bf:Work/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +                              count(ancestor::bf:Work/bf:tableOfContents/bf:TableOfContents[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +                              position()"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="string($vLabel) != ''">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">520</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$v880Script != ''">
                  <xsl:variable name="v520-6">
                    <xsl:value-of select="concat('880-', $v880Occurrence)"/>
                  </xsl:variable>
                  <xsl:if test="$v520-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v520-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 520 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 520 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                <marc:subfield code="u">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <xsl:for-each select="rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <marc:datafield>
                <xsl:attribute name="tag">880</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:variable name="v880-6">
                  <xsl:value-of select="concat('520-', $v880Occurrence, '/', $v880Script)"/>
                </xsl:variable>
                <xsl:if test="$v880-6 != ''">
                  <marc:subfield code="6">
                    <xsl:value-of select="$v880-6"/>
                  </marc:subfield>
                </xsl:if>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
                  <marc:subfield code="u">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Work/bf:geographicCoverage/*[               not(                 bf:source/@rdf:resource='http://id.loc.gov/authorities/classification/G' or                  bf:source/bf:Source/@rdf:about='http://id.loc.gov/authorities/classification/G'               ) and not(@rdf:about) and rdfs:label]" mode="generate-522">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:preferredCitation |                      bf:Instance/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/citeas']/rdfs:label" mode="generate-524">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/suppl' and rdfs:label[. != '']]       " mode="generate-525">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:contentAccessibility/bf:ContentAccessibility/rdfs:label" mode="generate-532">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:systemRequirement/bf:SystemRequirement[not(contains(rdf:type/@rdf:resource,'bflc'))] |                     //bf:Item/bf:systemRequirement/bf:SystemRequirement[not(contains(rdf:type/@rdf:resource,'bflc'))]" mode="generate-538">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="//bf:Item/bf:immediateAcquisition/bf:ImmediateAcquisition[rdfs:label[. != '']]" mode="generate-541">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource = 'http://id.loc.gov/vocabulary/mnotetype/lang' and rdfs:label]">
        <xsl:variable name="vLangTagLabel" select="rdfs:label[                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                  string-length(@xml:lang)='2' or                  string-length(@xml:lang)='3'               ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="v880Occurrence">
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <!-- This should be the next in the numerical sequence for work notes, 
                 when also accounting for tableOfContents, supplementarycontent, dissertation, and padding .. -->
              <xsl:value-of select="               41 +                count(ancestor::bf:Work/bf:note/bf:Note[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +                count(ancestor::bf:Work/bf:tableOfContents/bf:TableOfContents[rdfs:label[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]]) +               count(ancestor::bf:Work/bf:supplementaryContent/bf:SupplementaryContent[rdfs:label[. != '' and @xml:lang and contains(@xml:lang, '-') and not(contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))] and not(@rdf:about)]) +               count(ancestor::bf:Work/bf:dissertation/bf:Dissertation) +               position()"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">546</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$v880Script != ''">
              <xsl:variable name="v546-6">
                <xsl:value-of select="concat('880-', $v880Occurrence)"/>
              </xsl:variable>
              <xsl:if test="$v546-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v546-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="3">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 546 $3.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 546 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="ancestor::bf:Work/bf:notation/bf:Script[contains(@rdf:about, 'id.loc.gov/vocabulary/mscript')] | ancestor::bf:Work/bf:notation/bf:Notation[contains(@rdf:about, 'id.loc.gov/vocabulary/mscript')]">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <marc:subfield code="b">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="."/>
                </xsl:call-template>
              </marc:subfield>
            </xsl:for-each>
          </xsl:for-each>
          <xsl:for-each select="ancestor::bf:Work/bf:notation/bf:Script[not(@rdf:about)] | ancestor::bf:Work/bf:notation/bf:Notation[not(@rdf:about)]">
            <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <marc:subfield code="b">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="."/>
                </xsl:call-template>
              </marc:subfield>
            </xsl:for-each>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$v880Script != ''">
            <xsl:for-each select="rdfs:label[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]">
              <marc:datafield>
                <xsl:attribute name="tag">880</xsl:attribute>
                <xsl:attribute name="ind1">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:text> </xsl:text>
                </xsl:attribute>
                <xsl:variable name="v880-6">
                  <xsl:value-of select="concat('546-', $v880Occurrence, '/', $v880Script)"/>
                </xsl:variable>
                <xsl:if test="$v880-6 != ''">
                  <marc:subfield code="6">
                    <xsl:value-of select="$v880-6"/>
                  </marc:subfield>
                </xsl:if>
                <xsl:for-each select="../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="3">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $3.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
                <xsl:for-each select="ancestor::bf:Work/bf:notation/bf:Script[contains(@rdf:about, 'id.loc.gov/vocabulary/mscript')] | ancestor::bf:Work/bf:notation/bf:Notation[contains(@rdf:about, 'id.loc.gov/vocabulary/mscript')]">
                  <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:for-each>
                <xsl:for-each select="ancestor::bf:Work/bf:notation/bf:Script[not(@rdf:about)] | ancestor::bf:Work/bf:notation/bf:Notation[not(@rdf:about)]">
                  <xsl:for-each select="rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Work[not(bf:note/bf:Note/rdf:type/@rdf:resource[.='http://id.loc.gov/vocabulary/mnotetype/lang'])]/bf:notation/bf:Notation[rdfs:label] |                      bf:Work[not(bf:note/bf:Note/rdf:type/@rdf:resource[.='http://id.loc.gov/vocabulary/mnotetype/lang'])]/bf:notation/bf:Script[rdfs:label]" mode="generate-546">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:title/bf:VariantTitle[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']/bf:note/bf:Note/rdfs:label" mode="generate-547">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Instance/bf:custodialHistory|//bf:Item/bf:custodialHistory" mode="generate-561">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="     //bf:Item/bf:note/*[bf:noteType='binding' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/binding'] |     bf:Instance/bf:note/*[bf:noteType='binding' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/binding'] " mode="generate-563">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="       bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/relnote']/rdfs:label |       bf:Work/bf:relation/bf:Relation/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/relnote']/rdfs:label " mode="generate-580">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="       //bf:Item/bf:note/*[bf:noteType='action' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/action'] |       bf:Instance/bf:note/*[bf:noteType='action' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/action'] " mode="generate-583">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:awards" mode="generate-586">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource = 'http://id.loc.gov/vocabulary/mnotetype/award']" mode="generate-586">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:for-each select="bf:Instance/bf:credits">
        <xsl:choose>
          <xsl:when test="starts-with(., 'Cast:')">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="./@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">511</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text>1</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v511-a">
                <xsl:value-of select="substring-after(., 'Cast: ')"/>
              </xsl:variable>
              <xsl:if test="$v511-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$v511-a"/>
                </marc:subfield>
              </xsl:if>
            </marc:datafield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="./@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">508</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <marc:subfield code="a">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="."/>
                </xsl:call-template>
              </marc:subfield>
            </marc:datafield>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:Work/bf:subject">
        <xsl:choose>
          <xsl:when test="self::node()/*/bflc:marcKey |                   self::node()/*/marc:record |                   self::node()[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |                   self::node()/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |                   self::node()[contains(@rdf:resource, 'd-nb.info/gnd/') and not(contains(@rdf:resource, '#'))] |                   self::node()/*[contains(@rdf:about, 'd-nb.info/gnd/') and not(contains(@rdf:about, '#'))] |                   self::node()[contains(@rdf:resource, 'id.worldcat.org/fast/')] |                   self::node()/*[contains(@rdf:about, 'id.worldcat.org/fast/')]               ">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="contains(self::node()/@rdf:resource,'id.') and contains(self::node()/@rdf:resource, 'rwo/agents')">
                  <xsl:value-of select="concat(substring-before(self::node()/@rdf:resource,'rwo/agents'), 'authorities/names/', substring-after(self::node()/@rdf:resource,'rwo/agents/'))"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/*/@rdf:about,'id.') and contains(self::node()/*/@rdf:about, 'rwo/agents')">
                  <xsl:value-of select="concat(substring-before(self::node()/*/@rdf:about,'rwo/agents'), 'authorities/names/', substring-after(self::node()/*/@rdf:about,'rwo/agents/'))"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/@rdf:resource,'id.loc') and not(contains(self::node()/@rdf:resource, 'REPLACE'))">
                  <xsl:value-of select="self::node()/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/*/@rdf:about,'id.loc') and not(contains(self::node()/*/@rdf:about, 'REPLACE'))">
                  <xsl:value-of select="self::node()/*/@rdf:about"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/@rdf:resource,'d-nb.info/gnd/') and not(contains(self::node()/@rdf:resource, '#'))">
                  <xsl:value-of select="self::node()/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/*/@rdf:about,'d-nb.info/gnd/') and not(contains(self::node()/*/@rdf:about, '#'))">
                  <xsl:value-of select="self::node()/*/@rdf:about"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/@rdf:resource,'id.worldcat.org/fast/')">
                  <xsl:value-of select="self::node()/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(self::node()/*/@rdf:about,'id.worldcat.org/fast/')">
                  <xsl:value-of select="self::node()/*/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vRelResourcePreNS">
              <xsl:call-template name="tGetRelResource">
                <xsl:with-param name="pRelUri" select="$relURI"/>
                <xsl:with-param name="pContext" select="self::node()/*[name()]"/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
            <xsl:variable name="vSubjectTag">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:record">
                  <xsl:choose>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                      <xsl:text>600</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                      <xsl:text>610</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                      <xsl:text>611</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                      <xsl:text>630</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='147']">
                      <xsl:text>647</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='150']">
                      <xsl:text>650</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='151']">
                      <xsl:text>651</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vValidSubfields">
              <xsl:choose>
                <xsl:when test="$vSubjectTag='600'">
                  <xsl:text>abcdfghjklmnopqrst</xsl:text>
                </xsl:when>
                <xsl:when test="$vSubjectTag='610'">
                  <xsl:text>abcdfghklmnopqrst</xsl:text>
                </xsl:when>
                <xsl:when test="$vSubjectTag='611'">
                  <xsl:text>acdefghklmnpqst</xsl:text>
                </xsl:when>
                <xsl:when test="$vSubjectTag='630'">
                  <xsl:text>adfghklmnoprs</xsl:text>
                </xsl:when>
                <xsl:when test="$vSubjectTag='647'">
                  <xsl:text>acdg</xsl:text>
                </xsl:when>
                <xsl:when test="$vSubjectTag='650'">
                  <xsl:text>a</xsl:text>
                </xsl:when>
                <xsl:when test="$vSubjectTag='651'">
                  <xsl:text>a</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vMainSourceUri">
              <xsl:choose>
                <xsl:when test="*/bf:source//@rdf:*[1] != ''">
                  <xsl:value-of select="*/bf:source//@rdf:*[1]"/>
                </xsl:when>
                <xsl:when test="*/madsrdf:isMemberOfMADSScheme//@rdf:*[1] != ''">
                  <xsl:value-of select="*/madsrdf:isMemberOfMADSScheme//@rdf:*[1]"/>
                </xsl:when>
                <xsl:when test="$relURI != ''">
                  <xsl:value-of select="$relURI"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="v880Script">
              <xsl:choose>
                <xsl:when test="self::node()/*/rdfs:label/@xml:lang">
                  <xsl:variable name="vLangTag" select="self::node()/*/bflc:marcKey[starts-with(. , '4') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
                  <xsl:variable name="vlang">
                    <xsl:value-of select="translate(substring-after($vLangTag,'-'),$upper,$lower)"/>
                  </xsl:variable>
                  <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vNameVariantPreNS">
              <xsl:if test="$v880Script != ''">
                <xsl:choose>
                  <xsl:when test="self::node()/*/bflc:marcKey[starts-with(. , '4') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
                    <xsl:call-template name="tGetMiniMARCFromKey">
                      <xsl:with-param name="pFieldStr" select="self::node()/*/bflc:marcKey[starts-with(. , '4') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
                    </xsl:call-template>
                  </xsl:when>
                </xsl:choose>
              </xsl:if>
            </xsl:variable>
            <xsl:variable name="vNameVariant" select="exsl:node-set($vNameVariantPreNS)"/>
            <xsl:variable name="vNameVariantTag">
              <xsl:choose>
                <xsl:when test="$vNameVariant//marc:record">
                  <xsl:choose>
                    <xsl:when test="$vNameVariant//marc:datafield[@tag='100']">
                      <xsl:text>600</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vNameVariant//marc:datafield[@tag='110']">
                      <xsl:text>610</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vNameVariant//marc:datafield[@tag='111']">
                      <xsl:text>611</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vNameVariant//marc:datafield[@tag='151']">
                      <xsl:text>651</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vOccurrenceNumber">
              <xsl:if test="$v880Script != ''">
                <xsl:variable name="previousSubjectCount" select="count(preceding-sibling::bf:subject[*/madsrdf:componentList/*[1]/bflc:marcKey[@xml:lang] or */bflc:marcKey[@xml:lang]])"/>
                <xsl:value-of select="60 + $previousSubjectCount"/>
              </xsl:if>
            </xsl:variable>
            <xsl:variable name="vShared0and1">
              <xsl:choose>
                <xsl:when test="($vSubjectTag = '600' or $vSubjectTag = '610' or $vSubjectTag = '611') and                not($vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('tvxyz',@code)])">
                  <xsl:choose>
                    <xsl:when test="$relURI != '' and contains($relURI, 'authorities/names')">
                      <xsl:variable name="v-1">
                        <xsl:value-of select="concat(substring-before($relURI,'authorities/names/'), 'rwo/agents/', substring-after($relURI,'authorities/names/'))"/>
                      </xsl:variable>
                      <xsl:if test="$v-1 != ''">
                        <marc:subfield code="1">
                          <xsl:value-of select="$v-1"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                    <xsl:when test="$relURI != '' and                    ( contains($relURI, 'd-nb.info/gnd/') or contains($relURI, 'isni.org/isni/') )">
                      <xsl:variable name="v-1">
                        <xsl:value-of select="$relURI"/>
                      </xsl:variable>
                      <xsl:if test="$v-1 != ''">
                        <marc:subfield code="1">
                          <xsl:value-of select="$v-1"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                    <xsl:when test="$relURI != ''">
                      <xsl:variable name="v-0">
                        <xsl:value-of select="$relURI"/>
                      </xsl:variable>
                      <xsl:if test="$v-0 != ''">
                        <marc:subfield code="0">
                          <xsl:value-of select="$v-0"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="contains($relURI, 'id.worldcat.org/fast')">
                      <xsl:variable name="v-0">
                        <xsl:variable name="vFastID">
                          <xsl:call-template name="tPadLeft">
                            <xsl:with-param name="pInput" select="substring-after($relURI,'http://id.worldcat.org/fast/')"/>
                            <xsl:with-param name="pPadChar" select="'0'"/>
                            <xsl:with-param name="pStringLength" select="'8'"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:value-of select="concat('(OCoLC)fst', $vFastID)"/>
                      </xsl:variable>
                      <xsl:if test="$v-0 != ''">
                        <marc:subfield code="0">
                          <xsl:value-of select="$v-0"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
                <xsl:when test="($vSubjectTag = '600' or $vSubjectTag = '610' or $vSubjectTag = '611') and                not($vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)]) and                $vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('t',@code)]">
                  <xsl:choose>
                    <xsl:when test="$relURI != '' and contains($relURI, 'resources/hubs')">
                      <xsl:variable name="v-1">
                        <xsl:value-of select="$relURI"/>
                      </xsl:variable>
                      <xsl:if test="$v-1 != ''">
                        <marc:subfield code="1">
                          <xsl:value-of select="$v-1"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
                <xsl:when test="$vSubjectTag = '630' and contains($relURI, 'resources/hubs')">
                  <xsl:variable name="v-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$v-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$v-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="$vSubjectTag = '630' and contains($relURI, 'resources/hubs')">
                  <xsl:variable name="v-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$v-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$v-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="($vSubjectTag = '651' or $vSubjectTag = '662') and                not($vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)])">
                  <xsl:choose>
                    <xsl:when test="$relURI != '' and contains($relURI, 'authorities/names')">
                      <xsl:variable name="v-1">
                        <xsl:value-of select="concat(substring-before($relURI,'authorities/names/'), 'rwo/agents/', substring-after($relURI,'authorities/names/'))"/>
                      </xsl:variable>
                      <xsl:if test="$v-1 != ''">
                        <marc:subfield code="1">
                          <xsl:value-of select="$v-1"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                    <xsl:when test="$relURI != ''">
                      <xsl:variable name="v-1">
                        <xsl:value-of select="$relURI"/>
                      </xsl:variable>
                      <xsl:if test="$v-1 != ''">
                        <marc:subfield code="1">
                          <xsl:value-of select="$v-1"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
                <xsl:when test="$relURI != ''">
                  <xsl:variable name="v-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$v-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$v-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="contains($relURI, 'id.worldcat.org/fast')">
                  <xsl:variable name="v-0">
                    <xsl:variable name="vFastID">
                      <xsl:call-template name="tPadLeft">
                        <xsl:with-param name="pInput" select="substring-after($relURI,'http://id.worldcat.org/fast/')"/>
                        <xsl:with-param name="pPadChar" select="'0'"/>
                        <xsl:with-param name="pStringLength" select="'8'"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:value-of select="concat('(OCoLC)fst', $vFastID)"/>
                  </xsl:variable>
                  <xsl:if test="$v-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$v-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vSubjectTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vSubjectTag = '630' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 != ' '">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSubjectTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="$vSubjectTag = '630' and ($vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 = '' or $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 = ' ')">
                      <xsl:value-of select="'0'"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSubjectTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/cyac') or                            contains($vMainSourceUri, '/authorities/childrensSubjects') or                           contains($vMainSourceUri, '/subjectSchemes/lcshac')">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/names/') or contains($relURI, '/resources/hubs/')">
                      <xsl:choose>
                        <xsl:when test="ancestor::bf:Work/bf:subject/*/bf:source//@rdf:*[contains(., '/subjectSchemes/cyac') or contains(., '/authorities/childrensSubjects')]">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                        <xsl:when test="ancestor::bf:Work/bf:subject/*/madsrdf:isMemberOfMADSScheme//@rdf:*[contains(., '/subjectSchemes/cyac') or contains(., '/authorities/childrensSubjects')]">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>0</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/subjects/')">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/mesh/')">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/nalt/')">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/genreForms/') or                            contains($relURI, '/demographicTerms/') or                            contains($relURI, '/graphicMaterials/') or                            contains($relURI, '/fast/') or                           contains($relURI, 'd-nb.info/gnd/')">
                      <xsl:text>7</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($vMainSourceUri, '/authorities/subjects') or                            contains($vMainSourceUri, '/subjectSchemes/lcsh') or                            contains($vMainSourceUri, '/authorities/subjects')">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/mesh')">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/nal')">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/cash')">
                      <xsl:text>5</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/rvm')">
                      <xsl:text>6</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>4</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="(                           $vSubjectTag='600' or                            $vSubjectTag='610' or                            $vSubjectTag='611'                         ) and $vNameVariant//marc:record">
                  <xsl:variable name="vvSubjectTag-6">
                    <xsl:value-of select="concat('880-', $vOccurrenceNumber)"/>
                  </xsl:variable>
                  <xsl:if test="$vvSubjectTag-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$vvSubjectTag-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield[contains('adfghklmnoprs',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:variable name="vvSubjectTag-2">
                <xsl:choose>
                  <xsl:when test="contains($relURI, '/genreForms/')">
                    <xsl:text>lcgft</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/demogrpahicTerms/')">
                    <xsl:text>lcdgt</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/graphicMaterials/')">
                    <xsl:text>lctgm</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/fast/')">
                    <xsl:text>fast</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, 'd-nb.info/gnd/')">
                    <xsl:text>gnd</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$vvSubjectTag-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$vvSubjectTag-2"/>
                </marc:subfield>
              </xsl:if>
              <xsl:copy-of select="$vShared0and1"/>
            </marc:datafield>
            <xsl:choose>
              <xsl:when test="(                     $vSubjectTag='600' or                      $vSubjectTag='610' or                      $vSubjectTag='611'                   ) and $vNameVariant//marc:record">
                <marc:datafield>
                  <xsl:attribute name="tag">880</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vSubjectTag = '630' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 != ' '">
                          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:when test="$vSubjectTag = '630' and ($vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 = '' or $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2 = ' ')">
                          <xsl:value-of select="'0'"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text> </xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/cyac') or                                contains($vMainSourceUri, '/authorities/childrensSubjects') or                               contains($vMainSourceUri, '/subjectSchemes/lcshac')">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($relURI, '/names/') or contains($relURI, '/resources/hubs/')">
                          <xsl:choose>
                            <xsl:when test="ancestor::bf:Work/bf:subject/*/bf:source//@rdf:*[contains(., '/subjectSchemes/cyac') or contains(., '/authorities/childrensSubjects')]">
                              <xsl:text>1</xsl:text>
                            </xsl:when>
                            <xsl:when test="ancestor::bf:Work/bf:subject/*/madsrdf:isMemberOfMADSScheme//@rdf:*[contains(., '/subjectSchemes/cyac') or contains(., '/authorities/childrensSubjects')]">
                              <xsl:text>1</xsl:text>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:text>0</xsl:text>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:when>
                        <xsl:when test="contains($relURI, '/subjects/')">
                          <xsl:text>0</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($relURI, '/mesh/')">
                          <xsl:text>2</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($relURI, '/nalt/')">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($relURI, '/genreForms/') or                                contains($relURI, '/demographicTerms/') or                                contains($relURI, '/graphicMaterials/') or                                contains($relURI, '/fast/') or                               contains($relURI, 'd-nb.info/gnd/')">
                          <xsl:text>7</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($vMainSourceUri, '/authorities/subjects') or                                contains($vMainSourceUri, '/subjectSchemes/lcsh') or                                contains($vMainSourceUri, '/authorities/subjects')">
                          <xsl:text>0</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/mesh')">
                          <xsl:text>2</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/nal')">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/cash')">
                          <xsl:text>5</xsl:text>
                        </xsl:when>
                        <xsl:when test="contains($vMainSourceUri, '/subjectSchemes/rvm')">
                          <xsl:text>6</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="$vNameVariant//marc:record">
                      <xsl:variable name="v880-6">
                        <xsl:value-of select="concat($vSubjectTag, '-', $vOccurrenceNumber, '/', $v880Script)"/>
                      </xsl:variable>
                      <xsl:if test="$v880-6 != ''">
                        <marc:subfield code="6">
                          <xsl:value-of select="$v880-6"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="$vNameVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="$vNameVariant//marc:datafield[@tag = '240']/marc:subfield[contains('adfghklmnoprs',@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="$vNameVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:variable name="v880-2">
                    <xsl:choose>
                      <xsl:when test="contains($relURI, '/genreForms/')">
                        <xsl:text>lcgft</xsl:text>
                      </xsl:when>
                      <xsl:when test="contains($relURI, '/demogrpahicTerms/')">
                        <xsl:text>lcdgt</xsl:text>
                      </xsl:when>
                      <xsl:when test="contains($relURI, '/graphicMaterials/')">
                        <xsl:text>lctgm</xsl:text>
                      </xsl:when>
                      <xsl:when test="contains($relURI, '/fast/')">
                        <xsl:text>fast</xsl:text>
                      </xsl:when>
                      <xsl:when test="contains($relURI, 'd-nb.info/gnd/')">
                        <xsl:text>gnd</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v880-2 != ''">
                    <marc:subfield code="2">
                      <xsl:value-of select="$v880-2"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:copy-of select="$vShared0and1"/>
                </marc:datafield>
              </xsl:when>
            </xsl:choose>
          </xsl:when>
          <xsl:when test="self::node()[                     not(@rdf:resource) and                      (                       (                         not(*/@rdf:about) or                          contains(*/@rdf:about, 'example') or                          contains(*/@rdf:about, 'REPLACE') or                          ( contains(*/@rdf:about, 'd-nb.info/') and contains(*/@rdf:about, '#') ) or                          contains(*/@rdf:about, 'homosaurus.org/v')                       ) and                       not(*/bflc:marcKey) and                        (*/rdfs:label or */madsrdf:authoritativeLabel or */madsrdf:componentList)                     ) and                     not(*/*[local-name()='code'])]             ">
            <xsl:variable name="vDollar0Uri">
              <xsl:value-of select="*/@rdf:about[                 not(contains(.,'example.org')) and                  not(contains(.,'REPLACE')) and                  ( contains(*/@rdf:about, 'd-nb.info/') and not(contains(*/@rdf:about, '#')) )                 ]"/>
            </xsl:variable>
            <xsl:variable name="vInd2Val">
              <xsl:choose>
                <xsl:when test="contains(*/madsrdf:componentList/*[1]/@rdf:about, 'id.loc.gov/authorities/childrensSubjects/')">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='lcshac' or               */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or                */bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or               */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcshac'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="contains(*/bf:source//@rdf:*[1], '/subjectSchemes/cyac') or                          contains(*/bf:source//@rdf:*[1], '/authorities/childrensSubjects') or                         contains(*/bf:source//@rdf:*[1], '/subjectSchemes/lcshac') or                          */bf:source/bf:Source/bf:code='lcshac' or                         */bf:source/bf:Source/bf:code='cyac' or                         */madsrdf:isMemberOfMADSScheme//@rdf:*[1]='http://id.loc.gov/authorities/childrensSubjects' or                          */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='cyac' or                          */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcshac'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="               contains(*/madsrdf:componentList/*[1]/@rdf:about, 'id.loc.gov/authorities/subjects/') or               contains(*/madsrdf:componentList/*[1]/@rdf:about, 'id.loc.gov/authorities/names/') or               contains(*/madsrdf:componentList/*[1]/@rdf:about, 'id.loc.gov/resources/hubs/')">
                  <xsl:text>0</xsl:text>
                </xsl:when>
                <xsl:when test="contains(*/bf:source//@rdf:*[1], '/subjectSchemes/lcsh') or                          contains(*/bf:source//@rdf:*[1], '/authorities/subjects') or                         */bf:source/bf:Source/bf:code='lcsh' or                         */madsrdf:isMemberOfMADSScheme//@rdf:*[1]='http://id.loc.gov/authorities/subjects' or                          */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcsh'">
                  <xsl:text>0</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='mesh' or               */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/mesh'] or               */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='mesh'">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='nal' or               */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/nal'] or               */madsrdf:componentList/*[1]/*/bf:source/bf:Source/bf:code='nal'">
                  <xsl:text>3</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='cash' or               */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/cash'] or               */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='cash'">
                  <xsl:text>5</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='rvm' or               */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/rvm'] or               */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='rvm'">
                  <xsl:text>6</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source or */madsrdf:isMemberOfMADSScheme or */madsrdf:componentList/*[1]/bf:source">
                  <xsl:text>7</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSf2val">
              <xsl:choose>
                <xsl:when test="$vInd2Val = '7'">
                  <xsl:for-each select="(*/bf:source|*/madsrdf:isMemberOfMADSScheme|*/madsrdf:componentList/*[1]/bf:source)[1]">
                    <xsl:variable name="vSourceUri">
                      <xsl:choose>
                        <xsl:when test="@rdf:resource">
                          <xsl:value-of select="@rdf:resource"/>
                        </xsl:when>
                        <xsl:when test="*/@rdf:about">
                          <xsl:value-of select="*/@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="bf:Source/bf:code">
                        <xsl:value-of select="bf:Source/bf:code"/>
                      </xsl:when>
                      <xsl:when test="$vSourceUri != ''">
                        <xsl:choose>
                          <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="$vSourceUri"/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="$vSourceUri"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="bf:Source/rdfs:label"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSharedDollar0s">
              <xsl:choose>
                <xsl:when test="1=1">
                  <xsl:for-each select="*/@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSharedDollar2">
              <xsl:choose>
                <xsl:when test="1=1">
                  <xsl:variable name="v-2">
                    <xsl:choose>
                      <xsl:when test="$vSf2val != ''">
                        <xsl:value-of select="$vSf2val"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v-2 != ''">
                    <marc:subfield code="2">
                      <xsl:value-of select="$v-2"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vShared">
              <xsl:choose>
                <xsl:when test="1=1">
                  <xsl:for-each select="*/madsrdf:componentList/*">
                    <xsl:choose>
                      <xsl:when test="position() &gt; 1">
                        <xsl:choose>
                          <xsl:when test="local-name()='GenreForm' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#GenreForm']">
                            <xsl:variable name="v-v">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $v.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $v.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v-v != ''">
                              <marc:subfield code="v">
                                <xsl:value-of select="$v-v"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='Temporal' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal']">
                            <xsl:variable name="v-y">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $y.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $y.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v-y != ''">
                              <marc:subfield code="y">
                                <xsl:value-of select="$v-y"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='Geographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic']">
                            <xsl:variable name="v-z">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $z.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $z.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v-z != ''">
                              <marc:subfield code="z">
                                <xsl:value-of select="$v-z"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='HierarchicalGeographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic']">
                            <xsl:choose>
                              <xsl:when test="contains(madsrdf:authoritativeLabel, '--')">
                                <xsl:call-template name="tToken2Subfields">
                                  <xsl:with-param name="pString" select="madsrdf:authoritativeLabel"/>
                                  <xsl:with-param name="pSeparator" select="'--'"/>
                                  <xsl:with-param name="pSubfieldCode" select="'z'"/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:variable name="v-z">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:for-each select="madsrdf:authoritativeLabel">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $z.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:for-each select="rdfs:label">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $z.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <xsl:if test="$v-z != ''">
                                  <marc:subfield code="z">
                                    <xsl:value-of select="$v-z"/>
                                  </marc:subfield>
                                </xsl:if>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:variable name="v-x">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $x.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element  $x.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v-x != ''">
                              <marc:subfield code="x">
                                <xsl:value-of select="$v-x"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:copy-of select="$vSharedDollar0s"/>
                  <xsl:copy-of select="$vSharedDollar2"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="*[(local-name()='PersonalName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName'] or                       local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or                       local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                       local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family'] or                       local-name(madsrdf:componentList/*[1])='PersonalName' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName' or                       local-name(madsrdf:componentList/*[1])='FamilyName' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName' or                       local-name(madsrdf:componentList/*[1])='Person' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person' or                       local-name(madsrdf:componentList/*[1])='Family' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family' or                       bf:contribution/*/bf:agent/*[local-name()='PersonalName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName'] or local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']] or                       madsrdf:componentList/*[1]/bf:contribution/*/bf:agent/*[local-name()='PersonalName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName'] or local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']] or                        madsrdf:componentList/*[1]/bflc:marcKey[starts-with(., '100')]) and                       (madsrdf:componentList or madsrdf:authoritativeLabel)]">
                <marc:datafield>
                  <xsl:attribute name="tag">600</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="*[local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family'] or                               local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or                               local-name(madsrdf:componentList/*[1])='Family' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family' or                               local-name(madsrdf:componentList/*[1])='FamilyName' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName' or                               bf:Hub/bf:contribution/*/bf:agent/*[local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']] or                               bf:Hub/bf:contribution/*/bf:agent/*[local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName']] or                               madsrdf:componentList/*[1]/bf:Hub/bf:contribution/*/bf:agent/*[local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']] or                               madsrdf:componentList/*[1]/bf:Hub/bf:contribution/*/bf:agent/*[local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName']]]">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:when test="*/madsrdf:componentList/*/bflc:marcKey[starts-with(., '1000')]">
                          <xsl:text>0</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>1</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="*/madsrdf:componentList/*[                                     position()=1 and                                      (                                       contains('Hub,PersonalName,FamilyName,', local-name()) or                                       contains('PersonalName,FamilyName', substring-after(rdf:type/@rdf:resource, '#')) or                                        rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                                        rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']                                      ) and                                      (@rdf:about or bflc:marcKey)                                 ]">
                    <xsl:variable name="relURI">
                      <xsl:choose>
                        <xsl:when test="contains(@rdf:about,'id.') and not(contains(@rdf:about, 'REPLACE'))">
                          <xsl:value-of select="@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="vRelResourcePreNS">
                      <xsl:call-template name="tGetRelResource">
                        <xsl:with-param name="pRelUri" select="$relURI"/>
                        <xsl:with-param name="pContext" select="."/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
                    <xsl:choose>
                      <xsl:when test="$vRelResource/marc:record/marc:datafield[@tag='100']">
                        <xsl:for-each select="$vRelResource/marc:record/marc:datafield[@tag='100']/marc:subfield[contains('abcdghjklmnopqrst',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="                   *[                                            contains('Hub,Work,Person,Family', local-name()) or                       rdf:type[contains('PersonalName,FamilyName', @rdf:resource)] or                        rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                        rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']                                         ] |                   */madsrdf:componentList/*[                     position()=1 and                      (                       contains('Hub,Work,Person,Family', local-name()) or                       rdf:type[contains('PersonalName,FamilyName', @rdf:resource)] or                        rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                        rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']                        ) and                        not(bflc:marcKey) and                        (                       not(@rdf:about) or                       contains(@rdf:about, 'REPLACE') or                        contains(@rdf:about, 'example')                       )                     ]">
                    <xsl:choose>
                      <xsl:when test="bf:title">
                        <xsl:variable name="v600-a">
                          <xsl:choose>
                            <xsl:when test="bf:contribution/*/bf:agent/*/madsrdf:authoritativeLabel">
                              <xsl:for-each select="bf:contribution/*/bf:agent/*/madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="bf:contribution/*/bf:agent/*/rdfs:label">
                              <xsl:for-each select="bf:contribution/*/bf:agent/*/rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v600-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v600-a"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="v600-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:elementList/madsrdf:FullNameElement/madsrdf:elementValue">
                              <xsl:for-each select="madsrdf:elementList/madsrdf:FullNameElement/madsrdf:elementValue[1]">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v600-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v600-a"/>
                          </marc:subfield>
                        </xsl:if>
                        <xsl:for-each select="madsrdf:elementList/madsrdf:TermsOfAddressNameElement/madsrdf:elementValue">
                          <marc:subfield code="c">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="madsrdf:elementList/madsrdf:DateNameElement/madsrdf:elementValue">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="d">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $d.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="madsrdf:fullerName/*/rdfs:label">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="q">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $q.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="t">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $t.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:originDate">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="f">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $f.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                      <marc:subfield code="m">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                      <marc:subfield code="n">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                      <marc:subfield code="p">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicKey">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="r">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 600 $r.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:version">
                      <marc:subfield code="s">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:copy-of select="$vShared"/>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or                       local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                       local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction'] or                       local-name(madsrdf:componentList/*[1])='CorporateName' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName' or                       local-name(madsrdf:componentList/*[1])='Organization' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization' or                       local-name(madsrdf:componentList/*[1])='Jurisdiction' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction' or                       bf:contribution/*/bf:agent/*[local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']] or                       madsrdf:componentList/*[1]/bf:contribution/*/bf:agent/*[local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']] or                       madsrdf:componentList/*[1]/bflc:marcKey[starts-with(., '110')]) and                       (madsrdf:componentList or madsrdf:authoritativeLabel)]">
                <marc:datafield>
                  <xsl:attribute name="tag">610</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="*[local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction'] or                               local-name(madsrdf:componentList/*[1])='Jurisdiction' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction' or                               bf:Hub/bf:contribution/*/bf:agent/*[local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']] or                               madsrdf:componentList/*[1]/bf:Hub/bf:contribution/*/bf:agent/*[local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']]]">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>2</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="*/madsrdf:componentList/*[                                   position()=1 and                                    (                                     contains('Hub,Work,CorporateName,Organization,Jurisdiction,', local-name()) or                                     contains('PersonalName,FamilyName', substring-after(rdf:type/@rdf:resource, '#')) or                                      rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                                     rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                                     rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                                      rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']                                    ) and                                    (@rdf:about or bflc:marcKey)                              ]">
                    <xsl:variable name="relURI">
                      <xsl:choose>
                        <xsl:when test="contains(@rdf:about,'id.') and not(contains(@rdf:about, 'REPLACE'))">
                          <xsl:value-of select="@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="vRelResourcePreNS">
                      <xsl:choose>
                        <xsl:when test="self::node()/bflc:marcKey[starts-with(. , '1')][1]">
                          <xsl:call-template name="tGetMiniMARCFromKey">
                            <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[starts-with(. , '1')][1]"/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:call-template name="tGetRelResource">
                            <xsl:with-param name="pRelUri" select="$relURI"/>
                            <xsl:with-param name="pContext" select="."/>
                          </xsl:call-template>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
                    <xsl:choose>
                      <xsl:when test="$vRelResource/marc:record/marc:datafield[@tag='110']">
                        <xsl:for-each select="$vRelResource/marc:record/marc:datafield[@tag='110']/marc:subfield[contains('abcdfghklmnoprst',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="                 *[                 (                 contains('Hub,Work,CorporateName,Organization,Jurisdiction', local-name()) or                 rdf:type[contains('CorporateName', @rdf:resource)] or                  rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                  rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']                  )                 ] |                 */madsrdf:componentList/*[                 position()=1 and                  (                 contains('Hub,Work,CorporateName,Organization,Jurisdiction', local-name()) or                 contains('CorporateName', substring-after(rdf:type/@rdf:resource, '#')) or                  rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                  rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']                  ) and                  not(bflc:marcKey) and                  (                   not(@rdf:about) or                   contains(@rdf:about, 'REPLACE') or                    contains(@rdf:about, 'example')                 )                 ]">
                    <xsl:choose>
                      <xsl:when test="bf:title">
                        <xsl:variable name="v610-a">
                          <xsl:choose>
                            <xsl:when test="bf:contribution/*/bf:agent/*/madsrdf:authoritativeLabel">
                              <xsl:for-each select="bf:contribution/*/bf:agent/*/madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="bf:contribution/*/bf:agent/*/rdfs:label">
                              <xsl:for-each select="bf:contribution/*/bf:agent/*/rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v610-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v610-a"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="v610-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:elementList">
                              <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v610-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v610-a"/>
                          </marc:subfield>
                        </xsl:if>
                        <xsl:for-each select="madsrdf:elementList/*[position() &gt; 1]/madsrdf:elementValue">
                          <marc:subfield code="b">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="t">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $t.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:legalDate">
                      <marc:subfield code="d">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:originDate">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="f">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $f.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:language/*/rdfs:label|bf:language/*/madsrdf:authoritativeLabel">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="l">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $l.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                      <marc:subfield code="m">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                      <marc:subfield code="n">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                      <marc:subfield code="p">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicKey">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="r">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 610 $r.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:version">
                      <marc:subfield code="s">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:copy-of select="$vShared"/>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or                       local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting'] or                       local-name(madsrdf:componentList/*[1])='ConferenceName' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName' or                       local-name(madsrdf:componentList/*[1])='Meeting' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting' or                       bf:contribution/*/bf:agent/*[local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']] or                       madsrdf:componentList/*[1]/bf:contribution/*/bf:agent/*[local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']] or                       madsrdf:componentList/*[1]/bflc:marcKey[starts-with(., '111')]) and                       (madsrdf:componentList or madsrdf:authoritativeLabel)]">
                <marc:datafield>
                  <xsl:attribute name="tag">611</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text>2</xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="*/madsrdf:componentList/*[                                 position()=1 and                                  (                                   contains('Hub,Work,ConferenceName,Meeting', local-name()) or                                   rdf:type[contains('ConferenceName', @rdf:resource)] or                                    rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                                   rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                                   rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']                                  ) and                                  (@rdf:about or bflc:marcKey)                              ]">
                    <xsl:variable name="relURI">
                      <xsl:choose>
                        <xsl:when test="contains(@rdf:about,'id.') and not(contains(@rdf:about, 'REPLACE'))">
                          <xsl:value-of select="@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="vRelResourcePreNS">
                      <xsl:call-template name="tGetRelResource">
                        <xsl:with-param name="pRelUri" select="$relURI"/>
                        <xsl:with-param name="pContext" select="."/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
                    <xsl:choose>
                      <xsl:when test="$vRelResource/marc:record/marc:datafield[@tag='111']">
                        <xsl:for-each select="$vRelResource/marc:record/marc:datafield[@tag='111']/marc:subfield[contains('acdefghklnpqst',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="                 *[                 (                 contains('Hub,Work,ConferenceName,Meeting', local-name()) or                 rdf:type[contains('ConferenceName', @rdf:resource)] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']                  )                 ] |                 */madsrdf:componentList/*[                 position()=1 and                  (                 contains('Hub,Work,ConferenceName,Meeting', local-name()) or                 rdf:type[contains('ConferenceName', @rdf:resource)] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']                 ) and                  not(bflc:marcKey) and                  (                 not(@rdf:about) or                 contains(@rdf:about, 'REPLACE') or                  contains(@rdf:about, 'example')                 )                 ]">
                    <xsl:choose>
                      <xsl:when test="bf:title">
                        <xsl:variable name="v611-a">
                          <xsl:choose>
                            <xsl:when test="bf:contribution/*/bf:agent/*/madsrdf:authoritativeLabel">
                              <xsl:for-each select="bf:contribution/*/bf:agent/*/madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="bf:contribution/*/bf:agent/*/rdfs:label">
                              <xsl:for-each select="bf:contribution/*/bf:agent/*/rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v611-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v611-a"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="v611-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:elementList">
                              <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v611-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v611-a"/>
                          </marc:subfield>
                        </xsl:if>
                        <xsl:for-each select="madsrdf:elementList/*[local-name()='GeographicElement' and position() &gt; 1]/madsrdf:elementValue">
                          <marc:subfield code="c">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="madsrdf:elementList/*[local-name()='NameElement' and position() &gt; 1]/madsrdf:elementValue">
                          <marc:subfield code="q">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="t">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $t.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:legalDate">
                      <marc:subfield code="d">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:originDate">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="f">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $f.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:language/*/rdfs:label|bf:language/*/madsrdf:authoritativeLabel">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="l">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $l.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                      <marc:subfield code="m">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                      <marc:subfield code="n">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                      <marc:subfield code="p">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicKey">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="r">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 611 $r.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:version">
                      <marc:subfield code="s">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:copy-of select="$vShared"/>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='Hub' or local-name()='Work' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] or                       local-name(madsrdf:componentList/*[1])='Hub' or                       local-name(madsrdf:componentList/*[1])='Work' or                       madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub' or                       madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work') and                       (madsrdf:componentList or madsrdf:authoritativeLabel or rdfs:label)]">
                <marc:datafield>
                  <xsl:attribute name="tag">630</xsl:attribute>
                  <xsl:for-each select="*/madsrdf:componentList/*[                 position()=1 and                  (                 contains('Hub,Work', local-name()) or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work']                 ) and                  (@rdf:about or bflc:marcKey)                  ]">
                    <xsl:variable name="relURI">
                      <xsl:choose>
                        <xsl:when test="contains(@rdf:about,'id.') and not(contains(@rdf:about, 'REPLACE'))">
                          <xsl:value-of select="@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="vRelResourcePreNS">
                      <xsl:call-template name="tGetRelResource">
                        <xsl:with-param name="pRelUri" select="$relURI"/>
                        <xsl:with-param name="pContext" select="."/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
                    <xsl:choose>
                      <xsl:when test="$vRelResource/marc:record/marc:datafield[@tag='130']">
                        <xsl:attribute name="ind1">
                          <xsl:variable name="vInd">
                            <xsl:for-each select="$vRelResource/marc:record/marc:datafield[@tag='130']/@ind2">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:variable>
                          <xsl:choose>
                            <xsl:when test="$vInd != ''">
                              <xsl:value-of select="$vInd"/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:text>0</xsl:text>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:attribute>
                        <xsl:attribute name="ind2">
                          <xsl:variable name="vInd">
                            <xsl:choose>
                              <xsl:when test="$vInd2Val != ''">
                                <xsl:value-of select="$vInd2Val"/>
                              </xsl:when>
                            </xsl:choose>
                          </xsl:variable>
                          <xsl:choose>
                            <xsl:when test="$vInd != ''">
                              <xsl:value-of select="$vInd"/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:text>4</xsl:text>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:attribute>
                        <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="3">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630 $3.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="$vRelResource/marc:record/marc:datafield[@tag='130']/marc:subfield[contains('adfghklmnoprst',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="                 *[                 (                 contains('Hub,Work', local-name()) or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work']                  )                 ] |                 */madsrdf:componentList/*[                 position()=1 and                  (                 contains('Hub,Work', local-name()) or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hub'] or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work']                 ) and                  not(bflc:marcKey) and                  (                 not(@rdf:about) or                 contains(@rdf:about, 'REPLACE') or                  contains(@rdf:about, 'example')                 )                 ]">
                    <xsl:attribute name="ind1">
                      <xsl:variable name="vInd">
                        <xsl:for-each select="bf:title/bf:Title">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:choose>
                                <xsl:when test="bflc:nonSortNum">
                                  <xsl:value-of select="bflc:nonSortNum"/>
                                </xsl:when>
                                <xsl:when test="bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:mainTitle))">
                                  <xsl:value-of select="string-length(bf:mainTitle) - string-length(bflc:titleSortKey)"/>
                                </xsl:when>
                              </xsl:choose>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vInd != ''">
                          <xsl:value-of select="$vInd"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>0</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:attribute>
                    <xsl:attribute name="ind2">
                      <xsl:variable name="vInd">
                        <xsl:choose>
                          <xsl:when test="$vInd2Val != ''">
                            <xsl:value-of select="$vInd2Val"/>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vInd != ''">
                          <xsl:value-of select="$vInd"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>4</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:attribute>
                    <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="3">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630 $3.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:variable name="v630-a">
                      <xsl:choose>
                        <xsl:when test="bf:title/bf:Title/bf:mainTitle">
                          <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630 $a.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630 $a.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v630-a != ''">
                      <marc:subfield code="a">
                        <xsl:value-of select="$v630-a"/>
                      </marc:subfield>
                    </xsl:if>
                    <xsl:for-each select="bf:legalDate">
                      <marc:subfield code="d">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:originDate">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="f">
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 630 $f.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                      <marc:subfield code="m">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                      <marc:subfield code="n">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:title/bf:Title/bf:partName">
                      <marc:subfield code="p">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:choose>
                      <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                        <marc:subfield code="o">arranged</marc:subfield>
                      </xsl:when>
                    </xsl:choose>
                    <xsl:for-each select="bf:musicKey">
                      <marc:subfield code="r">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:version">
                      <marc:subfield code="s">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/bflc:Relation/rdfs:label">
                      <marc:subfield code="e">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:copy-of select="$vShared"/>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='Event' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Event'] or             local-name()='Event' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Event'] or             local-name(madsrdf:componentList/*[1])='Event' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#Event' or             local-name(madsrdf:componentList/*[1])='Event' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Event') and             (madsrdf:componentList or madsrdf:authoritativeLabel or rdfs:label)]">
                <marc:datafield>
                  <xsl:attribute name="tag">647</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="*/madsrdf:componentList">
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 647 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v647-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 647 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 647 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v647-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v647-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vShared"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 647 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v647-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 647 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/rdfs:label[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 647 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v647-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v647-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='Temporal' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal'] or                       local-name()='Temporal' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Temporal'] or                       local-name(madsrdf:componentList/*[1])='Temporal' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal' or                       local-name(madsrdf:componentList/*[1])='Temporal' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Temporal') and                       (madsrdf:componentList or madsrdf:authoritativeLabel or rdfs:label)]">
                <marc:datafield>
                  <xsl:attribute name="tag">648</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="*/madsrdf:componentList">
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 648 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v648-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 648 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 648 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v648-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v648-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vShared"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 648 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v648-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 648 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/rdfs:label[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 648 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v648-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v648-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='Topic' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Topic']) and             (               local-name(madsrdf:componentList/*[1])='GenreForm' or                madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#GenreForm' or               madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/GenreForm'             ) and             (madsrdf:componentList or madsrdf:authoritativeLabel)]">
                <marc:datafield>
                  <xsl:attribute name="tag">655</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="*/madsrdf:componentList">
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v655-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v655-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v655-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vShared"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v655-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/rdfs:label[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v655-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v655-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[local-name()='HierarchicalGeographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic']]">
                <marc:datafield>
                  <xsl:attribute name="tag">662</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:for-each select="*/madsrdf:componentList/*">
                    <xsl:choose>
                      <xsl:when test="local-name()='Country' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Country']">
                        <xsl:variable name="v662-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v662-a"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="local-name()='State' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#State']">
                        <xsl:variable name="v662-b">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $b.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $b.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-b != ''">
                          <marc:subfield code="b">
                            <xsl:value-of select="$v662-b"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="local-name()='County' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#County']">
                        <xsl:variable name="v662-c">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $c.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $c.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-c != ''">
                          <marc:subfield code="c">
                            <xsl:value-of select="$v662-c"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="local-name()='City' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#City']">
                        <xsl:variable name="v662-d">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $d.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $d.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-d != ''">
                          <marc:subfield code="d">
                            <xsl:value-of select="$v662-d"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="local-name()='CitySection' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CitySection']">
                        <xsl:variable name="v662-f">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $f.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $f.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-f != ''">
                          <marc:subfield code="f">
                            <xsl:value-of select="$v662-f"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="local-name()='Region' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Region']">
                        <xsl:variable name="v662-g">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $g.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $g.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-g != ''">
                          <marc:subfield code="g">
                            <xsl:value-of select="$v662-g"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                      <xsl:when test="local-name()='ExtraterrestrialArea' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ExtraterrestrialArea']">
                        <xsl:variable name="v662-h">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $h.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 662 $h.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v662-h != ''">
                          <marc:subfield code="h">
                            <xsl:value-of select="$v662-h"/>
                          </marc:subfield>
                        </xsl:if>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="*/bf:role/bf:Role/rdfs:label">
                    <marc:subfield code="e">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:copy-of select="$vSharedDollar0s"/>
                  <xsl:copy-of select="$vSharedDollar2"/>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='Geographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic'] or                       local-name()='Place' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place'] or                       local-name(madsrdf:componentList/*[1])='Geographic' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic' or                       local-name(madsrdf:componentList/*[1])='Place' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place') and                       (madsrdf:componentList or madsrdf:authoritativeLabel or rdfs:label)]">
                <marc:datafield>
                  <xsl:attribute name="tag">651</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 651 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="*/madsrdf:componentList">
                      <xsl:variable name="v651-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or @xml:lang='en']">
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 651 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or @xml:lang='en']">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 651 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v651-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v651-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:for-each select="*/bf:role/bf:Role/rdfs:label">
                        <marc:subfield code="e">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:for-each>
                      <xsl:copy-of select="$vShared"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:variable name="v651-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:authoritativeLabel[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or @xml:lang='en']">
                            <xsl:for-each select="*/madsrdf:authoritativeLabel[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or @xml:lang='en']">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 651 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/rdfs:label[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or @xml:lang='en']">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 651 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v651-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v651-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:for-each select="*/bf:role/bf:Role/rdfs:label">
                        <marc:subfield code="e">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:for-each>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[(local-name()='Occupation' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Occupation'] or                       local-name(madsrdf:componentList/*[1])='Occupation' or madsrdf:componentList/*[1]/rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#Occupation') and                       (madsrdf:componentList or madsrdf:authoritativeLabel) and                       bf:source]">
                <marc:datafield>
                  <xsl:attribute name="tag">656</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:text>7</xsl:text>
                  </xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="*/madsrdf:componentList">
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 656 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v656-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 656 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 656 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v656-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v656-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vShared"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 656 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v656-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 656 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/rdfs:label[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 656 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v656-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v656-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="*[madsrdf:componentList or madsrdf:authoritativeLabel or (rdfs:label and (madsrdf:* or bf:source))]">
                <marc:datafield>
                  <xsl:attribute name="tag">650</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vInd2Val != ''">
                          <xsl:value-of select="$vInd2Val"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>4</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:choose>
                    <xsl:when test="*/madsrdf:componentList[1]/*[1]/madsrdf:authoritativeLabel or */madsrdf:componentList[1]/*[1]/rdfs:label">
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v650-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v650-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v650-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:for-each select="*/bf:role/bf:Role/rdfs:label">
                        <marc:subfield code="e">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:for-each>
                      <xsl:for-each select="*/madsrdf:componentList/*">
                        <xsl:choose>
                          <xsl:when test="position() &gt; 1">
                            <xsl:choose>
                              <xsl:when test="local-name()='GenreForm' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#GenreForm']">
                                <xsl:variable name="v650-v">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:for-each select="madsrdf:authoritativeLabel">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $v.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:for-each select="rdfs:label">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $v.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <xsl:if test="$v650-v != ''">
                                  <marc:subfield code="v">
                                    <xsl:value-of select="$v650-v"/>
                                  </marc:subfield>
                                </xsl:if>
                              </xsl:when>
                              <xsl:when test="local-name()='Temporal' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal']">
                                <xsl:variable name="v650-y">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:for-each select="madsrdf:authoritativeLabel">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $y.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:for-each select="rdfs:label">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $y.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <xsl:if test="$v650-y != ''">
                                  <marc:subfield code="y">
                                    <xsl:value-of select="$v650-y"/>
                                  </marc:subfield>
                                </xsl:if>
                              </xsl:when>
                              <xsl:when test="                               (                                 local-name()='HierarchicalGeographic' or                                  rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic'] or                                  local-name()='Geographic' or                                  rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic']                               )                                and                                (                                 contains(madsrdf:authoritativeLabel, '--') or contains(rdfs:label, '--')                               )                               ">
                                <xsl:variable name="v650z1">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:value-of select="substring-before(madsrdf:authoritativeLabel, '--')"/>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:value-of select="substring-before(rdfs:label, '--')"/>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <xsl:variable name="v650z2">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:value-of select="substring-after(madsrdf:authoritativeLabel, '--')"/>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:value-of select="substring-after(rdfs:label, '--')"/>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <marc:subfield code="z">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="$v650z1"/>
                                  </xsl:call-template>
                                </marc:subfield>
                                <marc:subfield code="z">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="$v650z2"/>
                                  </xsl:call-template>
                                </marc:subfield>
                              </xsl:when>
                              <xsl:when test="local-name()='Geographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic']">
                                <xsl:variable name="v650-z">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:for-each select="madsrdf:authoritativeLabel">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $z.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:for-each select="rdfs:label">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $z.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <xsl:if test="$v650-z != ''">
                                  <marc:subfield code="z">
                                    <xsl:value-of select="$v650-z"/>
                                  </marc:subfield>
                                </xsl:if>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:variable name="v650-x">
                                  <xsl:choose>
                                    <xsl:when test="madsrdf:authoritativeLabel">
                                      <xsl:for-each select="madsrdf:authoritativeLabel">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $x.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:when>
                                    <xsl:otherwise>
                                      <xsl:for-each select="rdfs:label">
                                        <xsl:choose>
                                          <xsl:when test="position() = 1">
                                            <xsl:call-template name="tChopPunct">
                                              <xsl:with-param name="pString" select="."/>
                                            </xsl:call-template>
                                          </xsl:when>
                                          <xsl:otherwise>
                                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $x.</xsl:message>
                                          </xsl:otherwise>
                                        </xsl:choose>
                                      </xsl:for-each>
                                    </xsl:otherwise>
                                  </xsl:choose>
                                </xsl:variable>
                                <xsl:if test="$v650-x != ''">
                                  <marc:subfield code="x">
                                    <xsl:value-of select="$v650-x"/>
                                  </marc:subfield>
                                </xsl:if>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <marc:subfield code="3">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $3.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                      <xsl:variable name="v650-a">
                        <xsl:choose>
                          <xsl:when test="*/madsrdf:authoritativeLabel">
                            <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="*/rdfs:label[1]">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 650 $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v650-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$v650-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:for-each select="*/bf:role/bf:Role/rdfs:label">
                        <marc:subfield code="e">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:for-each>
                      <xsl:copy-of select="$vSharedDollar0s"/>
                      <xsl:copy-of select="$vSharedDollar2"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:datafield>
              </xsl:when>
              <xsl:otherwise>
                <marc:datafield>
                  <xsl:attribute name="tag">653</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="*[local-name() = 'Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person']]">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                        <xsl:when test="*[local-name() = 'Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization']]">
                          <xsl:text>2</xsl:text>
                        </xsl:when>
                        <xsl:when test="*[local-name() = 'Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']]">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:when test="*[local-name() = 'Temporal' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Temporal']]">
                          <xsl:text>4</xsl:text>
                        </xsl:when>
                        <xsl:when test="*[local-name() = 'Place' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place']]">
                          <xsl:text>5</xsl:text>
                        </xsl:when>
                        <xsl:when test="*[local-name() = 'GenreForm' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/GenreForm']]">
                          <xsl:text>6</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text> </xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="*/rdfs:label">
                    <marc:subfield code="a">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="       bf:Work/bf:genreForm/*[bflc:marcKey or marc:record] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'd-nb.info/gnd/') and not(contains(@rdf:resource, '#'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'd-nb.info/gnd/') and not(contains(@rdf:about, '#'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.worldcat.org/fast/')] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.worldcat.org/fast/')] |       //bf:Item/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[bflc:marcKey or marc:record]        [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="       bf:Work/bf:genreForm/*[bflc:marcKey or marc:record] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'd-nb.info/gnd/') and not(contains(@rdf:resource, '#'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'd-nb.info/gnd/') and not(contains(@rdf:about, '#'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.worldcat.org/fast/')] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.worldcat.org/fast/')] |       //bf:Item/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[bflc:marcKey or marc:record]        [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="contains(@rdf:resource,'id.loc') and not(contains(@rdf:resource, 'REPLACE'))">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'id.loc') and not(contains(@rdf:about, 'REPLACE'))">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:resource,'d-nb.info/gnd/') and not(contains(@rdf:resource, '#'))">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'d-nb.info/gnd/') and not(contains(@rdf:about, '#'))">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:resource,'id.worldcat.org/fast/')">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'id.worldcat.org/fast/')">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vRelResourcePreNS">
              <xsl:call-template name="tGetRelResource">
                <xsl:with-param name="pRelUri" select="$relURI"/>
                <xsl:with-param name="pContext" select="."/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
            <xsl:variable name="vGenreTag">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:record">
                  <xsl:choose>
                    <xsl:when test="(self::bf:genreForm or ancestor::bf:genreForm) and contains($relURI, 'd-nb.info/gnd/')">
                      <xsl:text>655</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='155']">
                      <xsl:text>655</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vValidSubfields">
              <xsl:choose>
                <xsl:when test="$vGenreTag='655'">
                  <xsl:text>a</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vGenreTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vGenreTag = '630'">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vGenreTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vGenreTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="contains($relURI, '/subjects/') or contains($relURI, '/names/')">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/childrensSubjects/')">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/mesh/')">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/nalt/')">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/names/') or contains($relURI, '/genreForms/') or              contains($relURI, '/demographicTerms/') or contains($relURI, '/graphicMaterials/') or              contains($relURI, '/fast/') or             contains($relURI, 'd-nb.info/gnd/')">
                      <xsl:text>7</xsl:text>
                    </xsl:when>
                    <xsl:when test="madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/subjects'] or              bf:source[@rdf:resource='http://id.loc.gov/authorities/subjects']">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects'] or              bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash']">
                      <xsl:text>5</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm']">
                      <xsl:text>6</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>4</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:variable name="vvGenreTag-2">
                <xsl:choose>
                  <xsl:when test="contains($relURI, '/genreForms/')">
                    <xsl:text>lcgft</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/demogrpahicTerms/')">
                    <xsl:text>lcdgt</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/graphicMaterials/')">
                    <xsl:text>lctgm</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/fast/')">
                    <xsl:text>fast</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, 'd-nb.info/gnd/')">
                    <xsl:text>gnd</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$vvGenreTag-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$vvGenreTag-2"/>
                </marc:subfield>
              </xsl:if>
              <xsl:choose>
                <xsl:when test="$relURI != ''">
                  <xsl:variable name="vvGenreTag-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvGenreTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvGenreTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="contains($relURI, 'id.worldcat.org/fast')">
                  <xsl:variable name="vvGenreTag-0">
                    <xsl:variable name="vFastID">
                      <xsl:call-template name="tPadLeft">
                        <xsl:with-param name="pInput" select="substring-after($relURI,'http://id.worldcat.org/fast/')"/>
                        <xsl:with-param name="pPadChar" select="'0'"/>
                        <xsl:with-param name="pStringLength" select="'8'"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:value-of select="concat('(OCoLC)fst', $vFastID)"/>
                  </xsl:variable>
                  <xsl:if test="$vvGenreTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvGenreTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </marc:datafield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="       bf:Work/bf:genreForm/*[bflc:marcKey or marc:record] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'd-nb.info/gnd/') and not(contains(@rdf:resource, '#'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'd-nb.info/gnd/') and not(contains(@rdf:about, '#'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.worldcat.org/fast/')] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.worldcat.org/fast/')] |       //bf:Item/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[bflc:marcKey or marc:record]        ">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="contains(@rdf:resource,'id.loc') and not(contains(@rdf:resource, 'REPLACE'))">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'id.loc') and not(contains(@rdf:about, 'REPLACE'))">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:resource,'d-nb.info/gnd/') and not(contains(@rdf:resource, '#'))">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'d-nb.info/gnd/') and not(contains(@rdf:about, '#'))">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:resource,'id.worldcat.org/fast/')">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'id.worldcat.org/fast/')">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vRelResourcePreNS">
              <xsl:call-template name="tGetRelResource">
                <xsl:with-param name="pRelUri" select="$relURI"/>
                <xsl:with-param name="pContext" select="."/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
            <xsl:variable name="vGenreTag">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:record">
                  <xsl:choose>
                    <xsl:when test="(self::bf:genreForm or ancestor::bf:genreForm) and contains($relURI, 'd-nb.info/gnd/')">
                      <xsl:text>655</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='155']">
                      <xsl:text>655</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vValidSubfields">
              <xsl:choose>
                <xsl:when test="$vGenreTag='655'">
                  <xsl:text>a</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vGenreTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vGenreTag = '630'">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vGenreTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vGenreTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="contains($relURI, '/subjects/') or contains($relURI, '/names/')">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/childrensSubjects/')">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/mesh/')">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/nalt/')">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="contains($relURI, '/names/') or contains($relURI, '/genreForms/') or              contains($relURI, '/demographicTerms/') or contains($relURI, '/graphicMaterials/') or              contains($relURI, '/fast/') or             contains($relURI, 'd-nb.info/gnd/')">
                      <xsl:text>7</xsl:text>
                    </xsl:when>
                    <xsl:when test="madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/subjects'] or              bf:source[@rdf:resource='http://id.loc.gov/authorities/subjects']">
                      <xsl:text>0</xsl:text>
                    </xsl:when>
                    <xsl:when test="madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects'] or              bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal']">
                      <xsl:text>3</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash']">
                      <xsl:text>5</xsl:text>
                    </xsl:when>
                    <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm']">
                      <xsl:text>6</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>4</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:variable name="vvGenreTag-2">
                <xsl:choose>
                  <xsl:when test="contains($relURI, '/genreForms/')">
                    <xsl:text>lcgft</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/demogrpahicTerms/')">
                    <xsl:text>lcdgt</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/graphicMaterials/')">
                    <xsl:text>lctgm</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, '/fast/')">
                    <xsl:text>fast</xsl:text>
                  </xsl:when>
                  <xsl:when test="contains($relURI, 'd-nb.info/gnd/')">
                    <xsl:text>gnd</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$vvGenreTag-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$vvGenreTag-2"/>
                </marc:subfield>
              </xsl:if>
              <xsl:choose>
                <xsl:when test="$relURI != ''">
                  <xsl:variable name="vvGenreTag-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvGenreTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvGenreTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="contains($relURI, 'id.worldcat.org/fast')">
                  <xsl:variable name="vvGenreTag-0">
                    <xsl:variable name="vFastID">
                      <xsl:call-template name="tPadLeft">
                        <xsl:with-param name="pInput" select="substring-after($relURI,'http://id.worldcat.org/fast/')"/>
                        <xsl:with-param name="pPadChar" select="'0'"/>
                        <xsl:with-param name="pStringLength" select="'8'"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:value-of select="concat('(OCoLC)fst', $vFastID)"/>
                  </xsl:variable>
                  <xsl:if test="$vvGenreTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvGenreTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </marc:datafield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ] |                      //bf:Item/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ][not(*/rdfs:label/@xml:lang) or contains(translate(*/rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="bf:Work/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ] |                      //bf:Item/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ][not(*/rdfs:label/@xml:lang) or contains(translate(*/rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="not(contains(.,'example.org')) and not(contains(bf:*/@rdf:about, 'REPLACE'))">
                  <xsl:value-of select="bf:*/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vInd2Val">
              <xsl:choose>
                <xsl:when test="*/bf:source/bf:Source/bf:code='lcsh' or             */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/subjects' or */@rdf:about='http://id.loc.gov/authorities/subjects'] or             */bf:source[@rdf:resource='http://id.loc.gov/authorities/subjects' or */@rdf:about='http://id.loc.gov/authorities/subjects'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcsh'">
                  <xsl:text>0</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='lcshac' or             */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or             */bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcshac'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='mesh' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/mesh'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='mesh'">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='nal' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/nal'] or             */madsrdf:componentList/*[1]/*/bf:source/bf:Source/bf:code='nal'">
                  <xsl:text>3</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='cash' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/cash'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='cash'">
                  <xsl:text>5</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='rvm' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/rvm'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='rvm'">
                  <xsl:text>6</xsl:text>
                </xsl:when>
                <xsl:when test="contains($relURI, '/vocabulary/rbmscv/')">
                  <xsl:text>7</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source or */madsrdf:componentList/*[1]/bf:source">
                  <xsl:text>7</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSf2val">
              <xsl:choose>
                <xsl:when test="$vInd2Val = '7' and contains($relURI, '/vocabulary/rbmscv/')">
                  <xsl:text>rbmscv</xsl:text>
                </xsl:when>
                <xsl:when test="$vInd2Val = '7'">
                  <xsl:for-each select="*/bf:source|*/madsrdf:componentList/*[1]/bf:source">
                    <xsl:variable name="vSourceUri">
                      <xsl:choose>
                        <xsl:when test="@rdf:resource">
                          <xsl:value-of select="@rdf:resource"/>
                        </xsl:when>
                        <xsl:when test="*/@rdf:about">
                          <xsl:value-of select="*/@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="bf:Source/bf:code">
                        <xsl:value-of select="bf:Source/bf:code"/>
                      </xsl:when>
                      <xsl:when test="$vSourceUri != ''">
                        <xsl:choose>
                          <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="$vSourceUri"/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="$vSourceUri"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="bf:Source/rdfs:label"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="*/rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">655</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vInd2Val != ''">
                      <xsl:value-of select="$vInd2Val"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>4</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="*/madsrdf:componentList">
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:variable name="v655-a">
                    <xsl:choose>
                      <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                        <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v655-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v655-a"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:for-each select="*/madsrdf:componentList/*">
                    <xsl:choose>
                      <xsl:when test="position() &gt; 1">
                        <xsl:choose>
                          <xsl:when test="local-name()='GenreForm' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#GenreForm']">
                            <xsl:variable name="v655-v">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $v.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $v.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-v != ''">
                              <marc:subfield code="v">
                                <xsl:value-of select="$v655-v"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='Temporal' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal']">
                            <xsl:variable name="v655-y">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $y.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $y.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-y != ''">
                              <marc:subfield code="y">
                                <xsl:value-of select="$v655-y"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='Geographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic']">
                            <xsl:variable name="v655-z">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $z.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $z.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-z != ''">
                              <marc:subfield code="z">
                                <xsl:value-of select="$v655-z"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:variable name="v655-x">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $x.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $x.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-x != ''">
                              <marc:subfield code="x">
                                <xsl:value-of select="$v655-x"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="*/@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="*/madsrdf:authoritativeLabel or */rdfs:label">
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:variable name="v655-a">
                    <xsl:choose>
                      <xsl:when test="*/madsrdf:authoritativeLabel">
                        <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:for-each select="*/rdfs:label[1]">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v655-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v655-a"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:choose>
                    <xsl:when test="$relURI != ''">
                      <xsl:variable name="v655-0">
                        <xsl:value-of select="$relURI"/>
                      </xsl:variable>
                      <xsl:if test="$v655-0 != ''">
                        <marc:subfield code="0">
                          <xsl:value-of select="$v655-0"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:variable name="v655-2">
                <xsl:choose>
                  <xsl:when test="$vSf2val != ''">
                    <xsl:value-of select="$vSf2val"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v655-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v655-2"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="*/bflc:applicableInstitution/*/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:Work/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ] |                      //bf:Item/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ]">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="not(contains(.,'example.org')) and not(contains(bf:*/@rdf:about, 'REPLACE'))">
                  <xsl:value-of select="bf:*/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vInd2Val">
              <xsl:choose>
                <xsl:when test="*/bf:source/bf:Source/bf:code='lcsh' or             */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/subjects' or */@rdf:about='http://id.loc.gov/authorities/subjects'] or             */bf:source[@rdf:resource='http://id.loc.gov/authorities/subjects' or */@rdf:about='http://id.loc.gov/authorities/subjects'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcsh'">
                  <xsl:text>0</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='lcshac' or             */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or             */bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcshac'">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='mesh' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/mesh'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='mesh'">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='nal' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/nal'] or             */madsrdf:componentList/*[1]/*/bf:source/bf:Source/bf:code='nal'">
                  <xsl:text>3</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='cash' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/cash'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='cash'">
                  <xsl:text>5</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source/bf:Source/bf:code='rvm' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/rvm'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='rvm'">
                  <xsl:text>6</xsl:text>
                </xsl:when>
                <xsl:when test="contains($relURI, '/vocabulary/rbmscv/')">
                  <xsl:text>7</xsl:text>
                </xsl:when>
                <xsl:when test="*/bf:source or */madsrdf:componentList/*[1]/bf:source">
                  <xsl:text>7</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSf2val">
              <xsl:choose>
                <xsl:when test="$vInd2Val = '7' and contains($relURI, '/vocabulary/rbmscv/')">
                  <xsl:text>rbmscv</xsl:text>
                </xsl:when>
                <xsl:when test="$vInd2Val = '7'">
                  <xsl:for-each select="*/bf:source|*/madsrdf:componentList/*[1]/bf:source">
                    <xsl:variable name="vSourceUri">
                      <xsl:choose>
                        <xsl:when test="@rdf:resource">
                          <xsl:value-of select="@rdf:resource"/>
                        </xsl:when>
                        <xsl:when test="*/@rdf:about">
                          <xsl:value-of select="*/@rdf:about"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="bf:Source/bf:code">
                        <xsl:value-of select="bf:Source/bf:code"/>
                      </xsl:when>
                      <xsl:when test="$vSourceUri != ''">
                        <xsl:choose>
                          <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                            <xsl:call-template name="tUriCode">
                              <xsl:with-param name="pUri" select="$vSourceUri"/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="$vSourceUri"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="bf:Source/rdfs:label"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="*/rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">655</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vInd2Val != ''">
                      <xsl:value-of select="$vInd2Val"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>4</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="*/madsrdf:componentList">
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:variable name="v655-a">
                    <xsl:choose>
                      <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                        <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v655-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v655-a"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:for-each select="*/madsrdf:componentList/*">
                    <xsl:choose>
                      <xsl:when test="position() &gt; 1">
                        <xsl:choose>
                          <xsl:when test="local-name()='GenreForm' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#GenreForm']">
                            <xsl:variable name="v655-v">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $v.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $v.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-v != ''">
                              <marc:subfield code="v">
                                <xsl:value-of select="$v655-v"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='Temporal' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal']">
                            <xsl:variable name="v655-y">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $y.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $y.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-y != ''">
                              <marc:subfield code="y">
                                <xsl:value-of select="$v655-y"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:when test="local-name()='Geographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic']">
                            <xsl:variable name="v655-z">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $z.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $z.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-z != ''">
                              <marc:subfield code="z">
                                <xsl:value-of select="$v655-z"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:variable name="v655-x">
                              <xsl:choose>
                                <xsl:when test="madsrdf:authoritativeLabel">
                                  <xsl:for-each select="madsrdf:authoritativeLabel">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $x.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:for-each select="rdfs:label">
                                    <xsl:choose>
                                      <xsl:when test="position() = 1">
                                        <xsl:call-template name="tChopPunct">
                                          <xsl:with-param name="pString" select="."/>
                                        </xsl:call-template>
                                      </xsl:when>
                                      <xsl:otherwise>
                                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $x.</xsl:message>
                                      </xsl:otherwise>
                                    </xsl:choose>
                                  </xsl:for-each>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>
                            <xsl:if test="$v655-x != ''">
                              <marc:subfield code="x">
                                <xsl:value-of select="$v655-x"/>
                              </marc:subfield>
                            </xsl:if>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="*/@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="*/madsrdf:authoritativeLabel or */rdfs:label">
                  <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:variable name="v655-a">
                    <xsl:choose>
                      <xsl:when test="*/madsrdf:authoritativeLabel">
                        <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:for-each select="*/rdfs:label[1]">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="$v655-a != ''">
                    <marc:subfield code="a">
                      <xsl:value-of select="$v655-a"/>
                    </marc:subfield>
                  </xsl:if>
                  <xsl:choose>
                    <xsl:when test="$relURI != ''">
                      <xsl:variable name="v655-0">
                        <xsl:value-of select="$relURI"/>
                      </xsl:variable>
                      <xsl:if test="$v655-0 != ''">
                        <marc:subfield code="0">
                          <xsl:value-of select="$v655-0"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:variable name="v655-2">
                <xsl:choose>
                  <xsl:when test="$vSf2val != ''">
                    <xsl:value-of select="$vSf2val"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v655-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v655-2"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="*/bflc:applicableInstitution/*/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)]       [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)]       [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="contains(@rdf:resource,'id.loc.gov')">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vRelResourcePreNS">
              <xsl:call-template name="tGetRelResource">
                <xsl:with-param name="pRelUri" select="$relURI"/>
                <xsl:with-param name="pContext" select="."/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
            <xsl:variable name="vAddedEntryNameLookupTag">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
                  <xsl:choose>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                      <xsl:text>700</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                      <xsl:text>710</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                      <xsl:text>711</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='151']">
                      <xsl:text>710</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vValidSubfields">
              <xsl:choose>
                <xsl:when test="$vAddedEntryNameLookupTag='700'">
                  <xsl:text>abcdgjq</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddedEntryNameLookupTag='710'">
                  <xsl:text>abcdgn</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddedEntryNameLookupTag='711'">
                  <xsl:text>acdegnq</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vAddedEntryNameLookupTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:for-each select="$vRelResource//marc:datafield[@tag='110']/@ind1">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddedEntryNameLookupTag.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:value-of select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1"/>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
                  <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="             ancestor::node()/bf:role/bf:Role/rdfs:label[.!='Contributor']|             ancestor::node()/bf:role/bf:Role/madsrdf:authoritativeLabel[.!='Contributor']">
                <marc:subfield code="e">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="           ancestor::node()/bf:role/bf:Role[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about[not(contains(., 'relators/ctb'))] |            ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
                <xsl:variable name="vRelationURI">
                  <xsl:choose>
                    <xsl:when test="contains(.,'id.loc.gov/')">
                      <xsl:value-of select="."/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vRelationLabel">
                  <xsl:choose>
                    <xsl:when test="$vRelationURI != ''">
                      <xsl:call-template name="tGetLabel">
                        <xsl:with-param name="pUri" select="$vRelationURI"/>
                      </xsl:call-template>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vvAddedEntryNameLookupTag-e"/>
                <xsl:if test="$vvAddedEntryNameLookupTag-e != ''">
                  <marc:subfield code="e">
                    <xsl:value-of select="$vvAddedEntryNameLookupTag-e"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="ancestor::node()/bf:role/bf:Role/@rdf:about[not(contains(., 'relators/ctb'))] or ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
                  <xsl:for-each select="ancestor::node()/bf:role/bf:Role/@rdf:about | ancestor::node()/bf:role/@rdf:resource">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="ancestor::node()/bf:role/bf:Role[bf:code[.!='ctb'] or madsrdf:code[.!='ctb']]">
                  <xsl:for-each select="ancestor::node()/bf:role/bf:Role/*[local-name() = 'code']">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/authorities/')">
                  <xsl:variable name="vvAddedEntryNameLookupTag-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/rwo/agents/')">
                  <xsl:variable name="vvAddedEntryNameLookupTag-0">
                    <xsl:value-of select="concat(substring-before($relURI,'rwo/agents'), 'authorities/names/', substring-after($relURI,'rwo/agents/'))"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="not(contains($relURI,'example.org')) and not(contains($relURI,'REPLACE')) and not(contains($relURI,'rwo'))">
                  <xsl:variable name="vvAddedEntryNameLookupTag-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$relURI != '' and (contains($relURI, '/agents/') or contains($relURI, '/gnd/'))">
                  <xsl:variable name="vvAddedEntryNameLookupTag-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="not(contains($relURI,'example.org')) and not(contains($relURI,'REPLACE')) and not(contains($relURI,'authorities'))">
                  <xsl:variable name="vvAddedEntryNameLookupTag-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </marc:datafield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)]       ">
            <xsl:variable name="relURI">
              <xsl:choose>
                <xsl:when test="contains(@rdf:resource,'id.loc.gov')">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                  <xsl:value-of select="@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vRelResourcePreNS">
              <xsl:call-template name="tGetRelResource">
                <xsl:with-param name="pRelUri" select="$relURI"/>
                <xsl:with-param name="pContext" select="."/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
            <xsl:variable name="vAddedEntryNameLookupTag">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
                  <xsl:choose>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                      <xsl:text>700</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                      <xsl:text>710</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                      <xsl:text>711</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='151']">
                      <xsl:text>710</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vValidSubfields">
              <xsl:choose>
                <xsl:when test="$vAddedEntryNameLookupTag='700'">
                  <xsl:text>abcdgjq</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddedEntryNameLookupTag='710'">
                  <xsl:text>abcdgn</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddedEntryNameLookupTag='711'">
                  <xsl:text>acdegnq</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vAddedEntryNameLookupTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:for-each select="$vRelResource//marc:datafield[@tag='110']/@ind1">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddedEntryNameLookupTag.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:value-of select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1"/>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
                  <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="             ancestor::node()/bf:role/bf:Role/rdfs:label[.!='Contributor']|             ancestor::node()/bf:role/bf:Role/madsrdf:authoritativeLabel[.!='Contributor']">
                <marc:subfield code="e">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="           ancestor::node()/bf:role/bf:Role[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about[not(contains(., 'relators/ctb'))] |            ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
                <xsl:variable name="vRelationURI">
                  <xsl:choose>
                    <xsl:when test="contains(.,'id.loc.gov/')">
                      <xsl:value-of select="."/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vRelationLabel">
                  <xsl:choose>
                    <xsl:when test="$vRelationURI != ''">
                      <xsl:call-template name="tGetLabel">
                        <xsl:with-param name="pUri" select="$vRelationURI"/>
                      </xsl:call-template>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vvAddedEntryNameLookupTag-e"/>
                <xsl:if test="$vvAddedEntryNameLookupTag-e != ''">
                  <marc:subfield code="e">
                    <xsl:value-of select="$vvAddedEntryNameLookupTag-e"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="ancestor::node()/bf:role/bf:Role/@rdf:about[not(contains(., 'relators/ctb'))] or ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
                  <xsl:for-each select="ancestor::node()/bf:role/bf:Role/@rdf:about | ancestor::node()/bf:role/@rdf:resource">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="ancestor::node()/bf:role/bf:Role[bf:code[.!='ctb'] or madsrdf:code[.!='ctb']]">
                  <xsl:for-each select="ancestor::node()/bf:role/bf:Role/*[local-name() = 'code']">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/authorities/')">
                  <xsl:variable name="vvAddedEntryNameLookupTag-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/rwo/agents/')">
                  <xsl:variable name="vvAddedEntryNameLookupTag-0">
                    <xsl:value-of select="concat(substring-before($relURI,'rwo/agents'), 'authorities/names/', substring-after($relURI,'rwo/agents/'))"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="not(contains($relURI,'example.org')) and not(contains($relURI,'REPLACE')) and not(contains($relURI,'rwo'))">
                  <xsl:variable name="vvAddedEntryNameLookupTag-0">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
                    <marc:subfield code="0">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$relURI != '' and (contains($relURI, '/agents/') or contains($relURI, '/gnd/'))">
                  <xsl:variable name="vvAddedEntryNameLookupTag-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
                <xsl:when test="not(contains($relURI,'example.org')) and not(contains($relURI,'REPLACE')) and not(contains($relURI,'authorities'))">
                  <xsl:variable name="vvAddedEntryNameLookupTag-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameLookupTag-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$vvAddedEntryNameLookupTag-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </marc:datafield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[bflc:marcKey or marc:record] |     bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[bflc:marcKey or marc:record] |     //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[bflc:marcKey or marc:record]">
        <xsl:variable name="relURI">
          <xsl:choose>
            <xsl:when test="contains(@rdf:about,'id.loc.gov')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'isni.org/isni/')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'viaf.org/viaf/')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'id.oclc.org/worldcat/entity/')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
            <xsl:when test="contains(@rdf:about,'d-nb.info/gnd/')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelResourcePreNS">
          <xsl:call-template name="tGetMiniMARCFromKey">
            <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))][1]"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
        <xsl:variable name="vAddedEntryNameMarcKeyTag">
          <xsl:choose>
            <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                  <xsl:text>700</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                  <xsl:text>710</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                  <xsl:text>711</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='151']">
                  <xsl:text>710</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
            <xsl:otherwise>
              <xsl:choose>
                <xsl:when test="local-name()='Person' or contains(rdf:type/@rdf:resource, '/Person')">
                  <xsl:text>700</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='Organization' or contains(rdf:type/@rdf:resource, '/Organization')">
                  <xsl:text>710</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='Meeting' or contains(rdf:type/@rdf:resource, '/Meeting')">
                  <xsl:text>711</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='Place' or contains(rdf:type/@rdf:resource, '/Place')">
                  <xsl:text>710</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vValidSubfields">
          <xsl:choose>
            <xsl:when test="$vAddedEntryNameMarcKeyTag='700'">
              <xsl:text>abcdgjq</xsl:text>
            </xsl:when>
            <xsl:when test="$vAddedEntryNameMarcKeyTag='710'">
              <xsl:text>abcdgn</xsl:text>
            </xsl:when>
            <xsl:when test="$vAddedEntryNameMarcKeyTag='711'">
              <xsl:text>acdegnq</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagLabel" select="self::node()/bflc:marcKey[                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                  string-length(@xml:lang)='2' or                  string-length(@xml:lang)='3'               ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="self::node()/bflc:marcKey[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript!=''">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vNameVariantPreNS">
          <xsl:if test="$v880Script != '' and self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
            </xsl:call-template>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vNameVariant" select="exsl:node-set($vNameVariantPreNS)"/>
        <xsl:variable name="vNameVariantTag">
          <xsl:choose>
            <xsl:when test="$vNameVariant//marc:record">
              <xsl:choose>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='100']">
                  <xsl:text>100</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='110']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='111']">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameVariant//marc:datafield[@tag='151']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vShared">
          <xsl:choose>
            <xsl:when test="ancestor::node()/bf:role/bf:Role[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']]">
              <xsl:for-each select="ancestor::node()/bf:role/bf:Role/rdfs:label|ancestor::node()/bf:role/bf:Role/madsrdf:authoritativeLabel">
                <xsl:variable name="v-e">
                  <xsl:value-of select="translate(., $upper, $lower)"/>
                </xsl:variable>
                <xsl:if test="$v-e != ''">
                  <marc:subfield code="e">
                    <xsl:value-of select="$v-e"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="ancestor::node()/bf:role/bf:Role[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about[not(contains(., 'relators/ctb'))] or ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
              <xsl:for-each select="ancestor::node()/bf:role/bf:Role[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about | ancestor::node()/bf:role/@rdf:resource">
                <xsl:variable name="vRelationURI">
                  <xsl:choose>
                    <xsl:when test="contains(.,'id.loc.gov/')">
                      <xsl:value-of select="."/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vRelationLabel">
                  <xsl:choose>
                    <xsl:when test="$vRelationURI != ''">
                      <xsl:call-template name="tGetLabel">
                        <xsl:with-param name="pUri" select="$vRelationURI"/>
                      </xsl:call-template>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="v-e"/>
                <xsl:if test="$v-e != ''">
                  <marc:subfield code="e">
                    <xsl:value-of select="$v-e"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="ancestor::node()/bf:role/bf:Role/@rdf:about[not(contains(., 'relators/ctb'))] or ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
              <xsl:for-each select="ancestor::node()/bf:role/bf:Role/@rdf:about | ancestor::node()/bf:role/@rdf:resource">
                <marc:subfield code="4">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="ancestor::node()/bf:role/bf:Role[bf:code[.!='ctb'] or madsrdf:code[.!='ctb']]">
              <xsl:for-each select="ancestor::node()/bf:role/bf:Role/*[local-name() = 'code']">
                <marc:subfield code="4">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/authorities/')">
              <xsl:variable name="v-0">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/rwo/agents/')">
              <xsl:variable name="v-0">
                <xsl:value-of select="concat(substring-before($relURI,'rwo/agents'), 'authorities/names/', substring-after($relURI,'rwo/agents/'))"/>
              </xsl:variable>
              <xsl:if test="$v-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="not(contains($relURI,'example.org')) and            not(contains($relURI,'REPLACE')) and            not(contains($relURI,'rwo')) and            not(contains($relURI,'id.oclc.org/worldcat/entity/')) and            not(contains($relURI,'isni.org/isni/')) and            not(contains($relURI,'viaf.org/viaf/')) and            not(contains($relURI,'d-nb.info/gnd/'))">
              <xsl:variable name="v-0">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$relURI != '' and (contains($relURI, '/agents/') or contains($relURI, '/gnd/'))">
              <xsl:variable name="v-1">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/authorities/')">
              <xsl:variable name="v-1">
                <xsl:value-of select="concat(substring-before($relURI,'authorities/names'), 'rwo/agents/', substring-after($relURI,'authorities/names/'))"/>
              </xsl:variable>
              <xsl:if test="$v-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="contains($relURI,'id.oclc.org/worldcat/entity/') or            contains($relURI,'isni.org/isni/') or            contains($relURI,'viaf.org/viaf/') or            contains($relURI,'d-nb.info/gnd/')">
              <xsl:variable name="v-1">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="not(contains($relURI,'example.org')) and            not(contains($relURI,'REPLACE')) and            not(contains($relURI,'authorities'))">
              <xsl:variable name="v-1">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vAddedEntryNameMarcKeyTag"/>
              </xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vRelResource//marc:datafield[@tag='110']/@ind1 != ''">
                      <xsl:for-each select="$vRelResource//marc:datafield[@tag='110']/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddedEntryNameMarcKeyTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="local-name()='Place' or             rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place'] or              local-name()='Jurisdiction' or             rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="local-name()='Organization' or             rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ''">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddedEntryNameMarcKeyTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="$vAddedEntryNameMarcKeyTag='710'">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="' '"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vNameVariant//marc:datafield[@tag!='']">
                  <xsl:variable name="vvAddedEntryNameMarcKeyTag-6">
                    <xsl:value-of select="concat('880-', 69+position())"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddedEntryNameMarcKeyTag-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$vvAddedEntryNameMarcKeyTag-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vShared"/>
              <!--<xsl:if test="$vLangTagLabel!=''">
          <marc:subfield code="7">
            <xsl:value-of select="concat('(bcp47)', $vLangTagLabel)"/>
          </marc:subfield>
        </xsl:if>-->
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$vNameVariant//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name()='Place' or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Place'] or                  local-name()='Jurisdiction' or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                      <xsl:text>1</xsl:text>
                    </xsl:when>
                    <xsl:when test="local-name()='Organization' or                 rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ''">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:when test="$vNameVariant//marc:datafield[@tag=$vNameVariantTag]">
                      <xsl:value-of select="$vNameVariant//marc:datafield[@tag=$vNameVariantTag]/@ind1"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
                    <xsl:value-of select="concat($vAddedEntryNameMarcKeyTag, '-', 69+position(), '/', $v880Script)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="concat($vAddedEntryNameMarcKeyTag, '-00', '/', $v880Script)"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="$vNameVariant//marc:datafield/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vShared"/>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:if test="$xslProcessor != 'libxslt'">
        <xsl:choose>
          <xsl:when test="bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries')) and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries'))and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:hasPart[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasPart/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]         [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:for-each select="bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries')) and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries'))and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:hasPart[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasPart/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]         [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="relURI">
                <xsl:choose>
                  <xsl:when test="contains(@rdf:resource,'id.loc.gov/resources/hubs')">
                    <xsl:value-of select="@rdf:resource"/>
                  </xsl:when>
                  <xsl:when test="contains(@rdf:about,'id.loc.gov/resources/hubs')">
                    <xsl:value-of select="@rdf:about"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vRelResourcePreNS">
                <xsl:call-template name="tGetRelResource">
                  <xsl:with-param name="pRelUri" select="$relURI"/>
                  <xsl:with-param name="pContext" select="."/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
              <xsl:variable name="vAddRelationLookupTag">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:record">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                        <xsl:text>700</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                        <xsl:text>710</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                        <xsl:text>711</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                        <xsl:text>730</xsl:text>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>758</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>758</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vValidSubfields">
                <xsl:choose>
                  <xsl:when test="$vAddRelationLookupTag='700'">
                    <xsl:text>abcdfghjklmnopqrst</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vAddRelationLookupTag='710'">
                    <xsl:text>abcdfghklmnoprst</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vAddRelationLookupTag='711'">
                    <xsl:text>acdeghklnpqst</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vAddRelationLookupTag='730'">
                    <xsl:text>adfghklmnoprst</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="rdfs:label/@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">
                  <xsl:value-of select="$vAddRelationLookupTag"/>
                </xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="$vAddRelationLookupTag = '730'">
                        <xsl:choose>
                          <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                            <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddRelationLookupTag.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:text>0</xsl:text>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:value-of select="."/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddRelationLookupTag.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/vocabulary/relationship/part']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                      <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                      <xsl:when test="ancestor::bflc:Relationship/bflc:relation//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                      <xsl:when test="self::bf:hasPart or ancestor::bf:hasPart">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:for-each select="../bf:relationship/bf:Relationship[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about | ../bf:relationship/@rdf:resource |                        ../bflc:relation/bflc:Relation[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about | ../bflc:relation/@rdf:resource">
                  <xsl:variable name="vRelationURI">
                    <xsl:choose>
                      <xsl:when test="contains(.,'id.loc.gov/entities')">
                        <xsl:value-of select="."/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:variable name="vRelationLabel">
                    <xsl:choose>
                      <xsl:when test="parent::node()/marc:record">
                        <xsl:copy-of select="parent::node()/marc:record"/>
                      </xsl:when>
                      <xsl:when test="$vRelationURI != ''">
                        <xsl:call-template name="tGetLabel">
                          <xsl:with-param name="pUri" select="$vRelationURI"/>
                        </xsl:call-template>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:variable name="vvAddRelationLookupTag-i">
                    <xsl:value-of select="$vRelationLabel"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddRelationLookupTag-i != ''">
                    <marc:subfield code="i">
                      <xsl:value-of select="$vvAddRelationLookupTag-i"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:for-each>
                <xsl:for-each select="../../bf:relationship/bf:Relationship/rdfs:label|../../bf:relationship/bf:Relationship/madsrdf:authoritativeLabel |                          ../../bflc:relation/bflc:Relation/rdfs:label|../../bflc:relation/bflc:Relation/madsrdf:authoritativeLabel">
                  <marc:subfield code="i">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
                    <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                      <marc:subfield>
                        <xsl:attribute name="code">
                          <xsl:value-of select="@code"/>
                        </xsl:attribute>
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[@tag = '240'] and $vAddRelationLookupTag != '730'">
                    <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield[contains('adfghklmnoprs',@code)]">
                      <marc:subfield>
                        <xsl:choose>
                          <xsl:when test="@code = 'a'">
                            <xsl:attribute name="code">t</xsl:attribute>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                          </xsl:otherwise>
                        </xsl:choose>
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="../../bf:relationship/bf:Relationship/@rdf:about or ../bf:relationship/@rdf:resource">
                    <xsl:for-each select="../../bf:relationship/bf:Relationship/@rdf:about | ../bf:relationship/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="../../bflc:relation/bflc:Relation/@rdf:about or ../bflc:relation/@rdf:resource">
                    <xsl:for-each select="../../bflc:relation/bflc:Relation/@rdf:about | ../bflc:relation/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:variable name="vvAddRelationLookupTag-1">
                  <xsl:choose>
                    <xsl:when test="$relURI != ''">
                      <xsl:value-of select="$relURI"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:if test="$vvAddRelationLookupTag-1 != ''">
                  <marc:subfield code="1">
                    <xsl:value-of select="$vvAddRelationLookupTag-1"/>
                  </marc:subfield>
                </xsl:if>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries')) and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries'))and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:hasPart[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasPart/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]         ">
              <xsl:variable name="relURI">
                <xsl:choose>
                  <xsl:when test="contains(@rdf:resource,'id.loc.gov/resources/hubs')">
                    <xsl:value-of select="@rdf:resource"/>
                  </xsl:when>
                  <xsl:when test="contains(@rdf:about,'id.loc.gov/resources/hubs')">
                    <xsl:value-of select="@rdf:about"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vRelResourcePreNS">
                <xsl:call-template name="tGetRelResource">
                  <xsl:with-param name="pRelUri" select="$relURI"/>
                  <xsl:with-param name="pContext" select="."/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
              <xsl:variable name="vAddRelationLookupTag">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:record">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                        <xsl:text>700</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                        <xsl:text>710</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                        <xsl:text>711</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                        <xsl:text>730</xsl:text>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>758</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>758</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vValidSubfields">
                <xsl:choose>
                  <xsl:when test="$vAddRelationLookupTag='700'">
                    <xsl:text>abcdfghjklmnopqrst</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vAddRelationLookupTag='710'">
                    <xsl:text>abcdfghklmnoprst</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vAddRelationLookupTag='711'">
                    <xsl:text>acdeghklnpqst</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vAddRelationLookupTag='730'">
                    <xsl:text>adfghklmnoprst</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="rdfs:label/@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">
                  <xsl:value-of select="$vAddRelationLookupTag"/>
                </xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="$vAddRelationLookupTag = '730'">
                        <xsl:choose>
                          <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                            <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddRelationLookupTag.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:text>0</xsl:text>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:value-of select="."/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddRelationLookupTag.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/vocabulary/relationship/part']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                      <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                      <xsl:when test="ancestor::bflc:Relationship/bflc:relation//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                      <xsl:when test="self::bf:hasPart or ancestor::bf:hasPart">
                        <xsl:text>2</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:for-each select="../bf:relationship/bf:Relationship[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about | ../bf:relationship/@rdf:resource |                        ../bflc:relation/bflc:Relation[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about | ../bflc:relation/@rdf:resource">
                  <xsl:variable name="vRelationURI">
                    <xsl:choose>
                      <xsl:when test="contains(.,'id.loc.gov/entities')">
                        <xsl:value-of select="."/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:variable name="vRelationLabel">
                    <xsl:choose>
                      <xsl:when test="parent::node()/marc:record">
                        <xsl:copy-of select="parent::node()/marc:record"/>
                      </xsl:when>
                      <xsl:when test="$vRelationURI != ''">
                        <xsl:call-template name="tGetLabel">
                          <xsl:with-param name="pUri" select="$vRelationURI"/>
                        </xsl:call-template>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:variable name="vvAddRelationLookupTag-i">
                    <xsl:value-of select="$vRelationLabel"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddRelationLookupTag-i != ''">
                    <marc:subfield code="i">
                      <xsl:value-of select="$vvAddRelationLookupTag-i"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:for-each>
                <xsl:for-each select="../../bf:relationship/bf:Relationship/rdfs:label|../../bf:relationship/bf:Relationship/madsrdf:authoritativeLabel |                          ../../bflc:relation/bflc:Relation/rdfs:label|../../bflc:relation/bflc:Relation/madsrdf:authoritativeLabel">
                  <marc:subfield code="i">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
                    <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                      <marc:subfield>
                        <xsl:attribute name="code">
                          <xsl:value-of select="@code"/>
                        </xsl:attribute>
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[@tag = '240'] and $vAddRelationLookupTag != '730'">
                    <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield[contains('adfghklmnoprs',@code)]">
                      <marc:subfield>
                        <xsl:choose>
                          <xsl:when test="@code = 'a'">
                            <xsl:attribute name="code">t</xsl:attribute>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                          </xsl:otherwise>
                        </xsl:choose>
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:choose>
                  <xsl:when test="../../bf:relationship/bf:Relationship/@rdf:about or ../bf:relationship/@rdf:resource">
                    <xsl:for-each select="../../bf:relationship/bf:Relationship/@rdf:about | ../bf:relationship/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="../../bflc:relation/bflc:Relation/@rdf:about or ../bflc:relation/@rdf:resource">
                    <xsl:for-each select="../../bflc:relation/bflc:Relation/@rdf:about | ../bflc:relation/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:when>
                </xsl:choose>
                <xsl:variable name="vvAddRelationLookupTag-1">
                  <xsl:choose>
                    <xsl:when test="$relURI != ''">
                      <xsl:value-of select="$relURI"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:if test="$vvAddRelationLookupTag-1 != ''">
                  <marc:subfield code="1">
                    <xsl:value-of select="$vvAddRelationLookupTag-1"/>
                  </marc:subfield>
                </xsl:if>
              </marc:datafield>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:if>
      <xsl:if test="$xslProcessor = 'libxslt'">
        <xsl:choose>
          <xsl:when test="bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(@rdf:resource, '/relationship/series'))]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |                     bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(@rdf:resource, '/relationship/series'))]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                     bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries'))]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |                     bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries'))]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo[contains(@rdf:resource, 'hubs')] |                     bf:Work/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                     bf:Work/bf:hasPart[contains(@rdf:resource, 'hubs')] |                     bf:Work/bf:hasPart/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]             ">
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed relationship node(s)/Hub(s) <xsl:value-of select="name()"/>.  Repeatable target field 7XX.</xsl:message>
          </xsl:when>
        </xsl:choose>
      </xsl:if>
      <xsl:for-each select="bf:Work/bf:relation/bf:Relation[bf:relationship[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bf:Relationship/@rdf:about, 'hasSeries')) and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:associatedResource/bf:*[bflc:marcKey or marc:record] |     bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[not(contains(@rdf:resource, 'hasSeries')) and not(contains(bflc:Relation/@rdf:about, 'hasSeries'))and not(contains(@rdf:resource, '/relationship/series')) and not(contains(bf:Relationship/@rdf:about, '/relationship/series'))]]/bf:relatedTo/bf:*[bflc:marcKey or marc:record] |     bf:Work/bf:relatedTo/bf:*[bflc:marcKey or marc:record] |     bf:Work/bf:hasPart/bf:*[bflc:marcKey or marc:record]     ">
        <xsl:variable name="relURI">
          <xsl:choose>
            <xsl:when test="contains(@rdf:about,'id.loc.gov/resources/hubs')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagLabel" select="self::node()/bflc:marcKey[                 contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                  string-length(@xml:lang)='2' or                  string-length(@xml:lang)='3'                 ][1]/@xml:lang"/>
        <xsl:variable name="vRelResourcePreNS">
          <!--<xsl:choose>
          <xsl:when test="self::node()/bflc:marcKey[not(@xml:lang)]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[not(@xml:lang)][1]"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:when test="$vLangTagLabel != ''">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang = $vLangTagLabel][1]"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:when test="self::node()/bflc:marcKey[@xml:lang]" /><!-\- marcKey with @xml:lang and likely in a non-latin script -\->
          <xsl:otherwise>
            <xsl:call-template name="tGetRelResource">
              <xsl:with-param name="pRelUri" select="$relURI"/>
              <xsl:with-param name="pContext" select="."/>
            </xsl:call-template>
          </xsl:otherwise>
        </xsl:choose>-->
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pRelUri" select="$relURI"/>
            <xsl:with-param name="pContext" select="."/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
        <xsl:variable name="vAddRelationMarcKeyTag">
          <xsl:choose>
            <xsl:when test="$vRelResource//marc:record">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                  <xsl:text>700</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                  <xsl:text>710</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                  <xsl:text>711</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                  <xsl:text>730</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vValidSubfields">
          <xsl:choose>
            <xsl:when test="$vAddRelationMarcKeyTag='700'">
              <xsl:text>abcdfghjklmnopqrst</xsl:text>
            </xsl:when>
            <xsl:when test="$vAddRelationMarcKeyTag='710'">
              <xsl:text>abcdfghklmnoprst</xsl:text>
            </xsl:when>
            <xsl:when test="$vAddRelationMarcKeyTag='711'">
              <xsl:text>acdeghklnpqst</xsl:text>
            </xsl:when>
            <xsl:when test="$vAddRelationMarcKeyTag='730'">
              <xsl:text>adfghklmnoprst</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagScript" select="self::node()/bflc:marcKey[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript!=''">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelVariantPreNS">
          <xsl:if test="$v880Script != '' and self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
            </xsl:call-template>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vRelVariant" select="exsl:node-set($vRelVariantPreNS)"/>
        <xsl:variable name="vRelVariantTag">
          <xsl:choose>
            <xsl:when test="$vRelVariant//marc:record">
              <xsl:choose>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='100']">
                  <xsl:text>100</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='110']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='111']">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='151']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelStrs">
          <xsl:value-of select="'           http://id.loc.gov/vocabulary/relationship/subseries            http://id.loc.gov/vocabulary/relationship/series            http://id.loc.gov/vocabulary/relationship/translationof            http://id.loc.gov/vocabulary/relationship/translatedas            http://id.loc.gov/vocabulary/relationship/supplementto            http://id.loc.gov/vocabulary/relationship/supplement            http://id.loc.gov/vocabulary/relationship/partof            http://id.loc.gov/vocabulary/relationship/part            http://id.loc.gov/vocabulary/relationship/otheredition            http://id.loc.gov/vocabulary/relationship/otherphysicalformat            http://id.loc.gov/vocabulary/relationship/issuedwith            http://id.loc.gov/vocabulary/relationship/continuedinpart            http://id.loc.gov/vocabulary/relationship/continuationof            http://id.loc.gov/vocabulary/relationship/continues            http://id.loc.gov/vocabulary/relationship/precededby            http://id.loc.gov/vocabulary/relationship/mergerof            http://id.loc.gov/vocabulary/relationship/absorbedby            http://id.loc.gov/vocabulary/relationship/absorptionof            http://id.loc.gov/vocabulary/relationship/separatedby            http://id.loc.gov/vocabulary/relationship/continuedby            http://id.loc.gov/vocabulary/relationship/continuedinpartby            http://id.loc.gov/vocabulary/relationship/succeededby            http://id.loc.gov/vocabulary/relationship/splitinto            http://id.loc.gov/vocabulary/relationship/mergedtoform            http://id.loc.gov/vocabulary/relationship/datasource            http://id.loc.gov/vocabulary/relationship/relatedwork           '"/>
        </xsl:variable>
        <xsl:variable name="iSubfieldShared">
          <xsl:for-each select="ancestor::bf:Relation/bf:relationship[           (            @rdf:resource and            not(contains($vRelStrs, @rdf:resource)) and            not(contains(@rdf:resource, 'ontologies/bibframe'))           ) or           (            bf:Relationship/@rdf:about and            not(contains($vRelStrs, bf:Relationship/@rdf:about)) and           not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))           )           ]/bf:Relationship[rdfs:label or madsrdf:authoritativeLabel]                       |                       ancestor::bflc:Relationship/bflc:relation[           (            @rdf:resource and            not(contains($vRelStrs, @rdf:resource)) and            not(contains(@rdf:resource, 'ontologies/bibframe'))           ) or           (            bf:Relationship/@rdf:about and            not(contains($vRelStrs, bf:Relationship/@rdf:about)) and           not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))           )           ]/bflc:Relation[rdfs:label or madsrdf:authoritativeLabel]                       ">
            <marc:subfield code="i">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:value-of select="madsrdf:authoritativeLabel"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="rdfs:label"/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
        </xsl:variable>
        <xsl:variable name="vShared">
          <xsl:for-each select="ancestor::bf:Relation/bf:relationship[           (            @rdf:resource and            not(contains($vRelStrs, @rdf:resource)) and            not(contains(@rdf:resource, 'ontologies/bibframe'))           ) or           (            bf:Relationship/@rdf:about and            not(contains($vRelStrs, bf:Relationship/@rdf:about)) and           not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))           )           ]//@rdf:*                       |                       ancestor::bflc:Relationship/bflc:relation[           (            @rdf:resource and            not(contains($vRelStrs, @rdf:resource)) and            not(contains(@rdf:resource, 'ontologies/bibframe'))           ) or           (            bf:Relationship/@rdf:about and            not(contains($vRelStrs, bf:Relationship/@rdf:about)) and           not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))           )           ]//@rdf:*                      ">
            <marc:subfield code="4">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="contains($relURI,'resources/hubs/')">
              <xsl:variable name="v-1">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$v-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vAddRelationMarcKeyTag"/>
              </xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vAddRelationMarcKeyTag = '730'">
                      <xsl:choose>
                        <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddRelationMarcKeyTag.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>0</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddRelationMarcKeyTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/vocabulary/relationship/part']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="ancestor::bflc:Relationship/bflc:relation//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="self::bf:hasPart or ancestor::bf:hasPart">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
                  <xsl:variable name="vvAddRelationMarcKeyTag-6">
                    <xsl:value-of select="concat('880-', 63 + position())"/>
                  </xsl:variable>
                  <xsl:if test="$vvAddRelationMarcKeyTag-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$vvAddRelationMarcKeyTag-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:copy-of select="$iSubfieldShared"/>
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
                  <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[@tag = '240'] and $vAddRelationMarcKeyTag != '730'">
                  <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield[contains('adfghklmnoprs',@code)]">
                    <marc:subfield>
                      <xsl:choose>
                        <xsl:when test="@code = 'a'">
                          <xsl:attribute name="code">t</xsl:attribute>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:attribute name="code">
                            <xsl:value-of select="@code"/>
                          </xsl:attribute>
                        </xsl:otherwise>
                      </xsl:choose>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:copy-of select="$vShared"/>
              <!--<xsl:if test="$vLangTagLabel!=''">
              <marc:subfield code="7">
                <xsl:value-of select="concat('(bcp47)', $vLangTagLabel)"/>
              </marc:subfield>
            </xsl:if>-->
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vAddRelationMarcKeyTag = '730'">
                      <xsl:choose>
                        <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>0</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/vocabulary/relationship/part']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="ancestor::bflc:Relationship/bflc:relation//@rdf:*[.='http://id.loc.gov/ontologies/bibframe/hasPart']">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                    <xsl:when test="self::bf:hasPart or ancestor::bf:hasPart">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
                    <xsl:value-of select="concat($vAddRelationMarcKeyTag, '-', 63 + position(), '/', $v880Script)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="concat($vAddRelationMarcKeyTag, '-00', '/', $v880Script)"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:copy-of select="$iSubfieldShared"/>
              <xsl:for-each select="$vRelVariant//marc:datafield/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:copy-of select="$vShared"/>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/* |                     bf:Work/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     //bf:Item/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/*[not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/* |                     bf:Work/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     //bf:Item/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/*[not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="vNameAuthPreNS">
              <xsl:choose>
                <xsl:when test="bflc:marcKey">
                  <xsl:call-template name="tGetRelResource">
                    <xsl:with-param name="pUri" select="@rdf:about"/>
                    <xsl:with-param name="pContext" select="."/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vNameAuth" select="exsl:node-set($vNameAuthPreNS)"/>
            <xsl:variable name="vAddEntryTag">
              <xsl:choose>
                <xsl:when test="local-name()='Uncontrolled' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/Uncontrolled']">
                  <xsl:text>720</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='PersonalName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName'] or                       local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or                       local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                       local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']">
                  <xsl:text>700</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or                       local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                       local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                  <xsl:text>710</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or                       local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']">
                  <xsl:text>711</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>720</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vNameAuthTag">
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='710'">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddEntryTag='711'">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>100</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vAuthSubfields">
              <xsl:choose>
                <xsl:when test="$vNameAuthTag='100'">
                  <xsl:text>abcdgjq</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuthTag='110'">
                  <xsl:text>abcdgn</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuthTag='111'">
                  <xsl:text>acdegnq</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSourceUri">
              <xsl:choose>
                <xsl:when test="bf:source/@rdf:resource">
                  <xsl:value-of select="bf:source/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="bf:source/bf:Source/@rdf:about">
                  <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vWorkUri">
              <xsl:value-of select="../../../../@rdf:about"/>
            </xsl:variable>
            <xsl:variable name="vTitleResourcePreNS">
              <xsl:choose>
                <xsl:when test="../../../../bf:title/bf:Title/bflc:marcKey">
                  <xsl:call-template name="tGetRelResource">
                    <xsl:with-param name="pUri" select="@rdf:about"/>
                    <xsl:with-param name="pContext" select="../../../../bf:title/bf:Title"/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
            <xsl:variable name="vTitleTag">
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='710'">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddEntryTag='711'">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>100</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vTitleSubfields">
              <xsl:choose>
                <xsl:when test="$vTitleTag='100'">
                  <xsl:text>fhklmnoprst</xsl:text>
                </xsl:when>
                <xsl:when test="$vTitleTag='110'">
                  <xsl:text>fhklmnoprst</xsl:text>
                </xsl:when>
                <xsl:when test="$vTitleTag='111'">
                  <xsl:text>fhklnpst</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vAddEntryTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]">
                      <xsl:value-of select="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]/@ind1"/>
                    </xsl:when>
                    <xsl:when test="$vAddEntryTag='700'">
                      <xsl:choose>
                        <xsl:when test="contains(local-name(),'Family')">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>1</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$vAddEntryTag='710'">
                      <xsl:choose>
                        <xsl:when test="local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$vAddEntryTag='720'">
                      <xsl:choose>
                        <xsl:when test="local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person']">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text> </xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>2</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="ancestor::bf:hasPart">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='720'">
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                    <marc:subfield code="e">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="translate(., $upper, $lower)"/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="translate(., $upper, $lower)"/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                    <marc:subfield code="4">
                      <xsl:choose>
                        <xsl:when test="madsrdf:code">
                          <xsl:for-each select="madsrdf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="bf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label|../../../../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="../../../../../../bflc:relationship/bflc:Relationship[bf:relatedTo/@rdf:resource=$vWorkUri]/bflc:relation/bflc:Relation/rdfs:label">
                    <marc:subfield code="i">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]">
                      <xsl:for-each select="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]/marc:subfield[contains($vAuthSubfields,@code)]">
                        <marc:subfield>
                          <xsl:attribute name="code">
                            <xsl:value-of select="@code"/>
                          </xsl:attribute>
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:variable name="vvAddEntryTag-a">
                        <xsl:choose>
                          <xsl:when test="madsrdf:elementList">
                            <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:when test="madsrdf:authoritativeLabel">
                            <xsl:for-each select="madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$vvAddEntryTag-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$vvAddEntryTag-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='710'">
                          <xsl:for-each select="madsrdf:elementList/*[position() &gt; 1]/madsrdf:elementValue">
                            <marc:subfield code="b">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='700'">
                          <xsl:for-each select="madsrdf:elementList/madsrdf:TermsOfAddressNameElement/madsrdf:elementValue">
                            <marc:subfield code="c">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='711'">
                          <xsl:for-each select="madsrdf:elementList/*[local-name()='GeographicElement' and position() &gt; 1]/madsrdf:elementValue">
                            <marc:subfield code="c">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='700'">
                          <xsl:for-each select="madsrdf:elementList/madsrdf:DateNameElement/madsrdf:elementValue">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <marc:subfield code="d">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </marc:subfield>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $d.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='700'">
                          <xsl:for-each select="madsrdf:fullerName/*/rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <marc:subfield code="q">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </marc:subfield>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $q.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='711'">
                          <xsl:for-each select="madsrdf:elementList/*[local-name()='NameElement' and position() &gt; 1]/madsrdf:elementValue">
                            <marc:subfield code="q">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vAddEntryTag='711'">
                      <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                        <marc:subfield code="j">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $j.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $j.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                        <marc:subfield code="e">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:value-of select="translate(., $upper, $lower)"/>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:value-of select="translate(., $upper, $lower)"/>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                    <marc:subfield code="4">
                      <xsl:choose>
                        <xsl:when test="madsrdf:code">
                          <xsl:for-each select="madsrdf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="bf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and                                          not(contains(.,'REPLACE')) and                                          not(contains(., 'id.oclc.org/worldcat/entity/')) and                                         not(contains(., 'isni.org/isni/')) and                                         (contains(., 'viaf.org/') and contains(., '#'))]">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[                             contains(., 'id.oclc.org/worldcat/entity/') or                              contains(., 'isni.org/isni/') or                             (contains(., 'viaf.org/') and not(contains(., '#')))]">
                    <marc:subfield code="1">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="exsl:node-set($vTitleResource)//marc:datafield[@tag=$vTitleTag]">
                      <xsl:for-each select="exsl:node-set($vTitleResource)//marc:datafield[@tag=$vTitleTag]/marc:subfield[contains($vTitleSubfields,@code)]">
                        <marc:subfield>
                          <xsl:attribute name="code">
                            <xsl:value-of select="@code"/>
                          </xsl:attribute>
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="ancestor::bf:Hub">
                        <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="t">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $t.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="bf:legalDate">
                          <marc:subfield code="d">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:originDate">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="f">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $f.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                          <marc:subfield code="m">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                          <marc:subfield code="n">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                          <marc:subfield code="p">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:musicKey">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="r">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $r.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="bf:version">
                          <marc:subfield code="s">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:for-each select="ancestor::bf:Hub">
                    <xsl:for-each select="bf:identifier/*[local-name()=Issn or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="x">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $x.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                      <marc:subfield code="0">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                      <marc:subfield code="0">
                        <xsl:variable name="vIdType">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vIdType != ''">
                            <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="rdf:value"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="$vSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label">
                      <xsl:variable name="vvAddEntryTag-2">
                        <xsl:choose>
                          <xsl:when test="bf:source/bf:Source/bf:code">
                            <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:when test="$vSourceUri != ''">
                            <xsl:choose>
                              <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                                <xsl:call-template name="tUriCode">
                                  <xsl:with-param name="pUri" select="$vSourceUri"/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="$vSourceUri"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$vvAddEntryTag-2 != ''">
                        <marc:subfield code="2">
                          <xsl:value-of select="$vvAddEntryTag-2"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="../../bflc:applicableInstitution/*/bf:code">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="5">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $5.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:datafield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/* |                     bf:Work/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     //bf:Item/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/*">
            <xsl:variable name="vNameAuthPreNS">
              <xsl:choose>
                <xsl:when test="bflc:marcKey">
                  <xsl:call-template name="tGetRelResource">
                    <xsl:with-param name="pUri" select="@rdf:about"/>
                    <xsl:with-param name="pContext" select="."/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vNameAuth" select="exsl:node-set($vNameAuthPreNS)"/>
            <xsl:variable name="vAddEntryTag">
              <xsl:choose>
                <xsl:when test="local-name()='Uncontrolled' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/Uncontrolled']">
                  <xsl:text>720</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='PersonalName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName'] or                       local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or                       local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                       local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']">
                  <xsl:text>700</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or                       local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                       local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                  <xsl:text>710</xsl:text>
                </xsl:when>
                <xsl:when test="local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or                       local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']">
                  <xsl:text>711</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>720</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vNameAuthTag">
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='710'">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddEntryTag='711'">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>100</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vAuthSubfields">
              <xsl:choose>
                <xsl:when test="$vNameAuthTag='100'">
                  <xsl:text>abcdgjq</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuthTag='110'">
                  <xsl:text>abcdgn</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuthTag='111'">
                  <xsl:text>acdegnq</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vSourceUri">
              <xsl:choose>
                <xsl:when test="bf:source/@rdf:resource">
                  <xsl:value-of select="bf:source/@rdf:resource"/>
                </xsl:when>
                <xsl:when test="bf:source/bf:Source/@rdf:about">
                  <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vWorkUri">
              <xsl:value-of select="../../../../@rdf:about"/>
            </xsl:variable>
            <xsl:variable name="vTitleResourcePreNS">
              <xsl:choose>
                <xsl:when test="../../../../bf:title/bf:Title/bflc:marcKey">
                  <xsl:call-template name="tGetRelResource">
                    <xsl:with-param name="pUri" select="@rdf:about"/>
                    <xsl:with-param name="pContext" select="../../../../bf:title/bf:Title"/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
            <xsl:variable name="vTitleTag">
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='710'">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vAddEntryTag='711'">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>100</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vTitleSubfields">
              <xsl:choose>
                <xsl:when test="$vTitleTag='100'">
                  <xsl:text>fhklmnoprst</xsl:text>
                </xsl:when>
                <xsl:when test="$vTitleTag='110'">
                  <xsl:text>fhklmnoprst</xsl:text>
                </xsl:when>
                <xsl:when test="$vTitleTag='111'">
                  <xsl:text>fhklnpst</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">
                <xsl:value-of select="$vAddEntryTag"/>
              </xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]">
                      <xsl:value-of select="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]/@ind1"/>
                    </xsl:when>
                    <xsl:when test="$vAddEntryTag='700'">
                      <xsl:choose>
                        <xsl:when test="contains(local-name(),'Family')">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>1</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$vAddEntryTag='710'">
                      <xsl:choose>
                        <xsl:when test="local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$vAddEntryTag='720'">
                      <xsl:choose>
                        <xsl:when test="local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person']">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text> </xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>2</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="ancestor::bf:hasPart">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='720'">
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                    <marc:subfield code="e">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="translate(., $upper, $lower)"/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="translate(., $upper, $lower)"/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                    <marc:subfield code="4">
                      <xsl:choose>
                        <xsl:when test="madsrdf:code">
                          <xsl:for-each select="madsrdf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="bf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label|../../../../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="../../../../../../bflc:relationship/bflc:Relationship[bf:relatedTo/@rdf:resource=$vWorkUri]/bflc:relation/bflc:Relation/rdfs:label">
                    <marc:subfield code="i">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]">
                      <xsl:for-each select="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]/marc:subfield[contains($vAuthSubfields,@code)]">
                        <marc:subfield>
                          <xsl:attribute name="code">
                            <xsl:value-of select="@code"/>
                          </xsl:attribute>
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:variable name="vvAddEntryTag-a">
                        <xsl:choose>
                          <xsl:when test="madsrdf:elementList">
                            <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:when test="madsrdf:authoritativeLabel">
                            <xsl:for-each select="madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$vvAddEntryTag-a != ''">
                        <marc:subfield code="a">
                          <xsl:value-of select="$vvAddEntryTag-a"/>
                        </marc:subfield>
                      </xsl:if>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='710'">
                          <xsl:for-each select="madsrdf:elementList/*[position() &gt; 1]/madsrdf:elementValue">
                            <marc:subfield code="b">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='700'">
                          <xsl:for-each select="madsrdf:elementList/madsrdf:TermsOfAddressNameElement/madsrdf:elementValue">
                            <marc:subfield code="c">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='711'">
                          <xsl:for-each select="madsrdf:elementList/*[local-name()='GeographicElement' and position() &gt; 1]/madsrdf:elementValue">
                            <marc:subfield code="c">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='700'">
                          <xsl:for-each select="madsrdf:elementList/madsrdf:DateNameElement/madsrdf:elementValue">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <marc:subfield code="d">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </marc:subfield>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $d.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='700'">
                          <xsl:for-each select="madsrdf:fullerName/*/rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <marc:subfield code="q">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </marc:subfield>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $q.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                      <xsl:choose>
                        <xsl:when test="$vAddEntryTag='711'">
                          <xsl:for-each select="madsrdf:elementList/*[local-name()='NameElement' and position() &gt; 1]/madsrdf:elementValue">
                            <marc:subfield code="q">
                              <xsl:call-template name="tChopPunct">
                                <xsl:with-param name="pString" select="."/>
                              </xsl:call-template>
                            </marc:subfield>
                          </xsl:for-each>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:choose>
                    <xsl:when test="$vAddEntryTag='711'">
                      <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                        <marc:subfield code="j">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $j.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $j.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                        <marc:subfield code="e">
                          <xsl:choose>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:value-of select="translate(., $upper, $lower)"/>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:value-of select="translate(., $upper, $lower)"/>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                    <marc:subfield code="4">
                      <xsl:choose>
                        <xsl:when test="madsrdf:code">
                          <xsl:for-each select="madsrdf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="bf:code">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                    <marc:subfield code="4">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and                                          not(contains(.,'REPLACE')) and                                          not(contains(., 'id.oclc.org/worldcat/entity/')) and                                         not(contains(., 'isni.org/isni/')) and                                         (contains(., 'viaf.org/') and contains(., '#'))]">
                    <marc:subfield code="0">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[                             contains(., 'id.oclc.org/worldcat/entity/') or                              contains(., 'isni.org/isni/') or                             (contains(., 'viaf.org/') and not(contains(., '#')))]">
                    <marc:subfield code="1">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="exsl:node-set($vTitleResource)//marc:datafield[@tag=$vTitleTag]">
                      <xsl:for-each select="exsl:node-set($vTitleResource)//marc:datafield[@tag=$vTitleTag]/marc:subfield[contains($vTitleSubfields,@code)]">
                        <marc:subfield>
                          <xsl:attribute name="code">
                            <xsl:value-of select="@code"/>
                          </xsl:attribute>
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="ancestor::bf:Hub">
                        <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="t">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $t.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="bf:legalDate">
                          <marc:subfield code="d">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:originDate">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="f">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $f.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                          <marc:subfield code="m">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                          <marc:subfield code="n">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                          <marc:subfield code="p">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="bf:musicKey">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="r">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $r.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="bf:version">
                          <marc:subfield code="s">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                  <xsl:for-each select="ancestor::bf:Hub">
                    <xsl:for-each select="bf:identifier/*[local-name()=Issn or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <marc:subfield code="x">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $x.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                    <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                      <marc:subfield code="0">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                      <marc:subfield code="0">
                        <xsl:variable name="vIdType">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vIdType != ''">
                            <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="rdf:value"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="$vSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label">
                      <xsl:variable name="vvAddEntryTag-2">
                        <xsl:choose>
                          <xsl:when test="bf:source/bf:Source/bf:code">
                            <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:when test="$vSourceUri != ''">
                            <xsl:choose>
                              <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                                <xsl:call-template name="tUriCode">
                                  <xsl:with-param name="pUri" select="$vSourceUri"/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="$vSourceUri"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$vvAddEntryTag-2 != ''">
                        <marc:subfield code="2">
                          <xsl:value-of select="$vvAddEntryTag-2"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="../../bflc:applicableInstitution/*/bf:code">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="5">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $5.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:datafield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)][not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)][not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="vTitleResourcePreNS">
              <xsl:choose>
                <xsl:when test="bf:title/bf:Title/bflc:marcKey">
                  <xsl:call-template name="tGetRelResource">
                    <xsl:with-param name="pUri" select="@rdf:about"/>
                    <xsl:with-param name="pContext" select="bf:title/bf:Title"/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">730</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:nonSortNum">
                      <xsl:value-of select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:nonSortNum"/>
                    </xsl:when>
                    <xsl:when test="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey and (string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey) &lt; string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:mainTitle))">
                      <xsl:value-of select="string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:mainTitle) - string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey)"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name(parent::*)='hasPart'">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:variable name="vNodeUri" select="@rdf:about"/>
              <xsl:for-each select="../../bflc:relationship/bflc:Relationship[bf:relatedTo/@rdf:resource=$vNodeUri or bf:relatedTo=$vNodeUri]/bflc:relation/bflc:Relation/rdfs:label">
                <marc:subfield code="i">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="$vTitleResource//marc:datafield[@tag='130']">
                  <xsl:for-each select="$vTitleResource//marc:datafield[@tag='130']/marc:subfield[contains('adfghklmnoprst',@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                      <marc:subfield code="o">arranged</marc:subfield>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bf:musicKey">
                    <marc:subfield code="r">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifier/*[local-name()=Issn or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
              <xsl:for-each select="bf:source/bf:Source/bf:code">
                <marc:subfield code="2">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                <marc:subfield code="0">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                <marc:subfield code="0">
                  <xsl:variable name="vIdType">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vIdType != ''">
                      <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="rdf:value"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)]">
            <xsl:variable name="vTitleResourcePreNS">
              <xsl:choose>
                <xsl:when test="bf:title/bf:Title/bflc:marcKey">
                  <xsl:call-template name="tGetRelResource">
                    <xsl:with-param name="pUri" select="@rdf:about"/>
                    <xsl:with-param name="pContext" select="bf:title/bf:Title"/>
                  </xsl:call-template>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">730</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:nonSortNum">
                      <xsl:value-of select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:nonSortNum"/>
                    </xsl:when>
                    <xsl:when test="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey and (string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey) &lt; string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:mainTitle))">
                      <xsl:value-of select="string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:mainTitle) - string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey)"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name(parent::*)='hasPart'">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="3">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $3.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:variable name="vNodeUri" select="@rdf:about"/>
              <xsl:for-each select="../../bflc:relationship/bflc:Relationship[bf:relatedTo/@rdf:resource=$vNodeUri or bf:relatedTo=$vNodeUri]/bflc:relation/bflc:Relation/rdfs:label">
                <marc:subfield code="i">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="$vTitleResource//marc:datafield[@tag='130']">
                  <xsl:for-each select="$vTitleResource//marc:datafield[@tag='130']/marc:subfield[contains('adfghklmnoprst',@code)]">
                    <marc:subfield>
                      <xsl:attribute name="code">
                        <xsl:value-of select="@code"/>
                      </xsl:attribute>
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                      <marc:subfield code="o">arranged</marc:subfield>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bf:musicKey">
                    <marc:subfield code="r">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifier/*[local-name()=Issn or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
              <xsl:for-each select="bf:source/bf:Source/bf:code">
                <marc:subfield code="2">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                <marc:subfield code="0">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                <marc:subfield code="0">
                  <xsl:variable name="vIdType">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vIdType != ''">
                      <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="rdf:value"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:Work[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/Uncontrolled'] |     bf:Work/bf:relation/bf:Relation/bf:associatedResource/bflc:Uncontrolled[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Work'] |     bf:Work/bf:relatedTo/bf:Work[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/Uncontrolled'] |     bf:Work/bf:hasPart/bf:Work[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/Uncontrolled']">
        <xsl:variable name="vLangTagLabel" select="bf:title/bf:Title/bf:mainTitle[                   contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                    string-length(@xml:lang)='2' or                    string-length(@xml:lang)='3'                 ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="bf:title/bf:Title/bf:mainTitle[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="vScript">
          <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
        </xsl:variable>
        <xsl:variable name="v880Script">
          <xsl:variable name="vlang">
            <xsl:value-of select="$vScript"/>
          </xsl:variable>
          <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
        </xsl:variable>
        <xsl:variable name="vOccurrenceNumber">
          <xsl:if test="$vLangTagScript != ''">
            <xsl:variable name="prevRelationCount" select="position()"/>
            <xsl:value-of select="6 + $prevRelationCount"/>
          </xsl:if>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">740</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text>0</xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="local-name(..)='hasPart'">
                  <xsl:text>2</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text> </xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$vLangTagScript != ''">
              <xsl:variable name="v740-6">
                <xsl:value-of select="concat('880-9', $vOccurrenceNumber)"/>
              </xsl:variable>
              <xsl:if test="$v740-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v740-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bf:title/bf:Title/bf:mainTitle[not(@xml:lang) or @xml:lang=$vLangTagLabel]">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 740 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:partNumber[not(@xml:lang) or @xml:lang=$vLangTagLabel]">
            <marc:subfield code="n">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:partName[not(@xml:lang) or @xml:lang=$vLangTagLabel]">
            <marc:subfield code="p">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="5">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 740 $5.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$vLangTagScript != ''">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:text>0</xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="local-name(..)='hasPart'">
                      <xsl:text>2</xsl:text>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:choose>
                <xsl:when test="$vLangTagScript != ''">
                  <xsl:variable name="v880-6">
                    <xsl:value-of select="concat('740-9', $vOccurrenceNumber)"/>
                  </xsl:variable>
                  <xsl:if test="$v880-6 != ''">
                    <marc:subfield code="6">
                      <xsl:value-of select="$v880-6"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
              <xsl:for-each select="bf:title/bf:Title/bf:mainTitle[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="a">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $a.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="bf:partNumber[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="n">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:partName[contains(translate(@xml:lang,$upper,$lower), $vScript)]">
                <marc:subfield code="p">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $5.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:Work/bf:place/*[local-name()='HierarchicalGeographic' or rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic'][not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
          <xsl:for-each select="bf:Work/bf:place/*[local-name()='HierarchicalGeographic' or rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic'][not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">752</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="madsrdf:componentList/*">
                <xsl:choose>
                  <xsl:when test="local-name()='Country' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Country']">
                    <xsl:variable name="v752-a">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $a.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $a.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-a != ''">
                      <marc:subfield code="a">
                        <xsl:value-of select="$v752-a"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='State' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#State']">
                    <xsl:variable name="v752-b">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $b.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $b.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-b != ''">
                      <marc:subfield code="b">
                        <xsl:value-of select="$v752-b"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='County' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#County']">
                    <xsl:variable name="v752-c">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $c.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $c.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-c != ''">
                      <marc:subfield code="c">
                        <xsl:value-of select="$v752-c"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='City' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#City']">
                    <xsl:variable name="v752-d">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $d.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $d.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-d != ''">
                      <marc:subfield code="d">
                        <xsl:value-of select="$v752-d"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='CitySection' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CitySection']">
                    <xsl:variable name="v752-f">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $f.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $f.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-f != ''">
                      <marc:subfield code="f">
                        <xsl:value-of select="$v752-f"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='Region' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Region']">
                    <xsl:variable name="v752-g">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $g.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $g.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-g != ''">
                      <marc:subfield code="g">
                        <xsl:value-of select="$v752-g"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='ExtraterrestrialArea' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ExtraterrestrialArea']">
                    <xsl:variable name="v752-h">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $h.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $h.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-h != ''">
                      <marc:subfield code="h">
                        <xsl:value-of select="$v752-h"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                <marc:subfield code="0">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                <marc:subfield code="0">
                  <xsl:variable name="vIdType">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vIdType != ''">
                      <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="rdf:value"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[rdfs:label or madsrdf:authoritativeLabel]">
                <marc:subfield code="e">
                  <xsl:choose>
                    <xsl:when test="madsrdf:authoritativeLabel">
                      <xsl:for-each select="madsrdf:authoritativeLabel">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[madsrdf:code or bf:code]">
                <marc:subfield code="4">
                  <xsl:choose>
                    <xsl:when test="madsrdf:code">
                      <xsl:for-each select="madsrdf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $4.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="bf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $4.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*/@rdf:about|bflc:relationship/bflc:Relationship/bflc:relation/@rdf:resource">
                <marc:subfield code="4">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:source/bf:Source/bf:code|*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="2">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $2.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:Work/bf:place/*[local-name()='HierarchicalGeographic' or rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic']">
            <xsl:variable name="vXmlLang">
              <xsl:value-of select="rdfs:label/@xml:lang"/>
            </xsl:variable>
            <marc:datafield>
              <xsl:attribute name="tag">752</xsl:attribute>
              <xsl:if test="$vXmlLang != ''">
                <xsl:attribute name="xml:lang">
                  <xsl:value-of select="$vXmlLang"/>
                </xsl:attribute>
              </xsl:if>
              <xsl:attribute name="ind1">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:text> </xsl:text>
              </xsl:attribute>
              <xsl:for-each select="madsrdf:componentList/*">
                <xsl:choose>
                  <xsl:when test="local-name()='Country' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Country']">
                    <xsl:variable name="v752-a">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $a.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $a.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-a != ''">
                      <marc:subfield code="a">
                        <xsl:value-of select="$v752-a"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='State' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#State']">
                    <xsl:variable name="v752-b">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $b.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $b.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-b != ''">
                      <marc:subfield code="b">
                        <xsl:value-of select="$v752-b"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='County' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#County']">
                    <xsl:variable name="v752-c">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $c.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $c.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-c != ''">
                      <marc:subfield code="c">
                        <xsl:value-of select="$v752-c"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='City' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#City']">
                    <xsl:variable name="v752-d">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $d.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $d.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-d != ''">
                      <marc:subfield code="d">
                        <xsl:value-of select="$v752-d"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='CitySection' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CitySection']">
                    <xsl:variable name="v752-f">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $f.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $f.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-f != ''">
                      <marc:subfield code="f">
                        <xsl:value-of select="$v752-f"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='Region' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Region']">
                    <xsl:variable name="v752-g">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $g.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $g.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-g != ''">
                      <marc:subfield code="g">
                        <xsl:value-of select="$v752-g"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='ExtraterrestrialArea' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ExtraterrestrialArea']">
                    <xsl:variable name="v752-h">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $h.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $h.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v752-h != ''">
                      <marc:subfield code="h">
                        <xsl:value-of select="$v752-h"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                </xsl:choose>
              </xsl:for-each>
              <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                <marc:subfield code="0">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                <marc:subfield code="0">
                  <xsl:variable name="vIdType">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vIdType != ''">
                      <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="rdf:value"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[rdfs:label or madsrdf:authoritativeLabel]">
                <marc:subfield code="e">
                  <xsl:choose>
                    <xsl:when test="madsrdf:authoritativeLabel">
                      <xsl:for-each select="madsrdf:authoritativeLabel">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[madsrdf:code or bf:code]">
                <marc:subfield code="4">
                  <xsl:choose>
                    <xsl:when test="madsrdf:code">
                      <xsl:for-each select="madsrdf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $4.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="bf:code">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $4.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*/@rdf:about|bflc:relationship/bflc:Relationship/bflc:relation/@rdf:resource">
                <marc:subfield code="4">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
              <xsl:for-each select="bf:source/bf:Source/bf:code|*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="2">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $2.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </marc:datafield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:apply-templates select="bf:Instance/bf:systemRequirement/*[       local-name() = 'MachineModel' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/MachineModel' or       local-name() = 'ProgrammingLanguage' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/ProgrammingLanguage' or       local-name() = 'OperatingSystem' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/OperatingSystem']" mode="generate-753">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="       bf:Work/bf:relation/bf:Relation[bf:relationship/@rdf:resource and bf:associatedResource/@rdf:resource] |       bf:Work/bf:relation/bf:Relation[bf:relationship/bf:Relationship/rdfs:label and bf:associatedResource/@rdf:resource] |       bf:Work/bflc:relationship/bflc:Relationship[bflc:relation/@rdf:resource and bf:relatedTo/@rdf:resource] |       bf:Work/bflc:relationship/bflc:Relationship[bflc:relation/bflc:Relation/rdfs:label and bf:relatedTo/@rdf:resource]" mode="generate-758">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="       bf:Work/@rdf:about |       bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')][1]/@rdf:about" mode="generate-758">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'subseries') or contains(bf:Relationship/@rdf:about, 'subseries')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'series') or contains(bf:Relationship/@rdf:about, 'series')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translationof') or contains(bf:Relationship/@rdf:about, 'translationof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translatedas') or contains(bf:Relationship/@rdf:about, 'translatedas')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplementto') or contains(bf:Relationship/@rdf:about, 'supplementto')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplement') or contains(bf:Relationship/@rdf:about, 'supplement')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'partof') or contains(bf:Relationship/@rdf:about, 'partof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/part') or contains(bf:Relationship/@rdf:about, '/part')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otheredition') or contains(bf:Relationship/@rdf:about, 'otheredition')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'revisionof') or contains(bf:Relationship/@rdf:about, 'revisionof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otherphysicalformat') or contains(bf:Relationship/@rdf:about, 'otherphysicalformat')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'issuedwith') or contains(bf:Relationship/@rdf:about, 'issuedwith')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedinpart') or contains(bf:Relationship/@rdf:about, 'continuedinpart')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuationof') or contains(bf:Relationship/@rdf:about, 'continuationof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'precededby') or contains(bf:Relationship/@rdf:about, 'precededby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergerof') or contains(bf:Relationship/@rdf:about, 'mergerof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorbedby') or contains(bf:Relationship/@rdf:about, 'absorbedby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorptionof') or contains(bf:Relationship/@rdf:about, 'absorptionof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'separatedby') or contains(bf:Relationship/@rdf:about, 'separatedby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedby') or contains(bf:Relationship/@rdf:about, 'continuedby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedinpartby') or contains(bf:Relationship/@rdf:about, 'continuedinpartby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'succeededby') or contains(bf:Relationship/@rdf:about, 'succeededby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'splitinto') or contains(bf:Relationship/@rdf:about, 'splitinto')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergedtoform') or contains(bf:Relationship/@rdf:about, 'mergedtoform')]]/bf:mergedWith/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergedtoform') or contains(bf:Relationship/@rdf:about, 'mergedtoform')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'datasource') or contains(bf:Relationship/@rdf:about, 'datasource')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'relatedwork') or contains(bf:Relationship/@rdf:about, 'relatedwork')]]/bf:associatedResource/bf:*[bf:hasInstance] |              bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSubseries') or contains(bf:Relationship/@rdf:about, 'hasSubseries')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translationOf') or contains(bf:Relationship/@rdf:about, 'translationOf')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translation') or contains(bf:Relationship/@rdf:about, 'translation')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplementTo') or contains(bf:Relationship/@rdf:about, 'supplementTo')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplement') or contains(bf:Relationship/@rdf:about, 'supplement')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'partOf') or contains(bf:Relationship/@rdf:about, 'partOf')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasPart') or contains(bf:Relationship/@rdf:about, 'hasPart')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otherEdition') or contains(bf:Relationship/@rdf:about, 'otherEdition')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otherPhysicalFormat') or contains(bf:Relationship/@rdf:about, 'otherPhysicalFormat')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'issuedWith') or contains(bf:Relationship/@rdf:about, 'issuedWith')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuesInPart') or contains(bf:Relationship/@rdf:about, 'continuesInPart')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'precededBy') or contains(bf:Relationship/@rdf:about, 'precededBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergerOf') or contains(bf:Relationship/@rdf:about, 'mergerOf')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorbedBy') or contains(bf:Relationship/@rdf:about, 'absorbedBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorbed') or contains(bf:Relationship/@rdf:about, 'absorbed')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'separatedBy') or contains(bf:Relationship/@rdf:about, 'separatedBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedBy') or contains(bf:Relationship/@rdf:about, 'continuedBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedInPartBy') or contains(bf:Relationship/@rdf:about, 'continuedInPartBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'succeededBy') or contains(bf:Relationship/@rdf:about, 'succeededBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'splitInto') or contains(bf:Relationship/@rdf:about, 'splitInto')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergedToForm') or contains(bf:Relationship/@rdf:about, 'mergedToForm')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'dataSource') or contains(bf:Relationship/@rdf:about, 'dataSource')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'relatedTo') or contains(bf:Relationship/@rdf:about, 'relatedTo')]]/bf:associatedResource/bf:*[bf:hasInstance]       " mode="generate-vLinkTagFromWork2">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:hasSeries/bf:Work[bf:hasInstance] |                     bf:Work/bf:hasSubseries/bf:Work[bf:hasInstance] |                     bf:Work/bf:translationOf/bf:Work[bf:hasInstance] |                     bf:Work/bf:translation/bf:Work[bf:hasInstance] |                     bf:Work/bf:supplement/bf:Work[bf:hasInstance] |                     bf:Work/bf:supplementTo/bf:Work[bf:hasInstance] |                     bf:Work/bf:partOf/bf:Work[bf:hasInstance] |                     bf:Work/bf:hasPart/bf:Work[bf:hasInstance] |                     bf:Work/bf:otherEdition/bf:Work[bf:hasInstance] |                     bf:Work/bf:otherPhysicalFormat/bf:Work[bf:hasInstance] |                     bf:Work/bf:issuedWith/bf:Work[bf:hasInstance] |                     bf:Work/bf:continues/bf:Work[bf:hasInstance] |                     bf:Work/bf:continuesInPart/bf:Work[bf:hasInstance] |                     bf:Work/bf:precededBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:mergerOf/bf:Work[bf:hasInstance] |                     bf:Work/bf:absorbed/bf:Work[bf:hasInstance] |                     bf:Work/bf:separatedBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:continuedBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:continuedInPartBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:succeededBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:absorbedBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:splitInto/bf:Work[bf:hasInstance] |                     bf:Work/bf:mergedToForm/bf:Work[bf:hasInstance] |                     bf:Work/bf:dataSource/bf:Work[bf:hasInstance] |                     bf:Work/bf:relatedTo/bf:Work[bf:hasInstance]" mode="generate-vLinkTagFromWork">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:if test="$xslProcessor != 'libxslt'">
        <xsl:choose>
          <xsl:when test="         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                  bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |          bf:Work/bf:hasSeries[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasSeries/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]       [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
            <xsl:for-each select="         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                  bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |          bf:Work/bf:hasSeries[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasSeries/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]       [not(rdfs:label/@xml:lang) or contains(translate(rdfs:label/@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <xsl:variable name="relURI">
                <xsl:choose>
                  <xsl:when test="contains(@rdf:resource,'id.loc.gov')">
                    <xsl:value-of select="@rdf:resource"/>
                  </xsl:when>
                  <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                    <xsl:value-of select="@rdf:about"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vRelResourcePreNS">
                <xsl:call-template name="tGetRelResource">
                  <xsl:with-param name="pRelUri" select="$relURI"/>
                  <xsl:with-param name="pContext" select="."/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
              <xsl:variable name="vSeriesLookupTag">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:record">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                        <xsl:text>800</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                        <xsl:text>810</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                        <xsl:text>811</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                        <xsl:text>830</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vValidSubfields">
                <xsl:choose>
                  <xsl:when test="$vSeriesLookupTag='800'">
                    <xsl:text>abcdgjq</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vSeriesLookupTag='810'">
                    <xsl:text>abcdgn</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vSeriesLookupTag='811'">
                    <xsl:text>acdegnq</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vSeriesLookupTag='830'">
                    <xsl:text>adfghklmnoprst</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="rdfs:label/@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">
                  <xsl:value-of select="$vSeriesLookupTag"/>
                </xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="$vSeriesLookupTag != '830'">
                        <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:value-of select="."/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="$vSeriesLookupTag = '830'">
                        <xsl:choose>
                          <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                            <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:text>0</xsl:text>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                  <marc:subfield>
                    <xsl:attribute name="code">
                      <xsl:value-of select="@code"/>
                    </xsl:attribute>
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield">
                  <marc:subfield>
                    <xsl:choose>
                      <xsl:when test="@code='a'">
                        <xsl:attribute name="code">t</xsl:attribute>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:attribute name="code">
                          <xsl:value-of select="@code"/>
                        </xsl:attribute>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="ancestor::bf:Relation/bf:seriesEnumeration[not(@xml:lang)]|ancestor::bflc:Relationship/bf:seriesEnumeration[not(@xml:lang)]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="v">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag $v.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="x">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag $x.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                  <marc:subfield code="w">
                    <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="$relURI">
                  <marc:subfield code="1">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                  bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |          bf:Work/bf:hasSeries[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasSeries/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |                bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]       ">
              <xsl:variable name="relURI">
                <xsl:choose>
                  <xsl:when test="contains(@rdf:resource,'id.loc.gov')">
                    <xsl:value-of select="@rdf:resource"/>
                  </xsl:when>
                  <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                    <xsl:value-of select="@rdf:about"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vRelResourcePreNS">
                <xsl:call-template name="tGetRelResource">
                  <xsl:with-param name="pRelUri" select="$relURI"/>
                  <xsl:with-param name="pContext" select="."/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
              <xsl:variable name="vSeriesLookupTag">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:record">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                        <xsl:text>800</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                        <xsl:text>810</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                        <xsl:text>811</xsl:text>
                      </xsl:when>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                        <xsl:text>830</xsl:text>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vValidSubfields">
                <xsl:choose>
                  <xsl:when test="$vSeriesLookupTag='800'">
                    <xsl:text>abcdgjq</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vSeriesLookupTag='810'">
                    <xsl:text>abcdgn</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vSeriesLookupTag='811'">
                    <xsl:text>acdegnq</xsl:text>
                  </xsl:when>
                  <xsl:when test="$vSeriesLookupTag='830'">
                    <xsl:text>adfghklmnoprst</xsl:text>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vXmlLang">
                <xsl:value-of select="rdfs:label/@xml:lang"/>
              </xsl:variable>
              <marc:datafield>
                <xsl:attribute name="tag">
                  <xsl:value-of select="$vSeriesLookupTag"/>
                </xsl:attribute>
                <xsl:if test="$vXmlLang != ''">
                  <xsl:attribute name="xml:lang">
                    <xsl:value-of select="$vXmlLang"/>
                  </xsl:attribute>
                </xsl:if>
                <xsl:attribute name="ind1">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="$vSeriesLookupTag != '830'">
                        <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <xsl:value-of select="."/>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:attribute name="ind2">
                  <xsl:variable name="vInd">
                    <xsl:choose>
                      <xsl:when test="$vSeriesLookupTag = '830'">
                        <xsl:choose>
                          <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                            <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:text>0</xsl:text>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="$vInd != ''">
                      <xsl:value-of select="$vInd"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text> </xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:attribute>
                <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                  <marc:subfield>
                    <xsl:attribute name="code">
                      <xsl:value-of select="@code"/>
                    </xsl:attribute>
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="$vRelResource//marc:datafield[@tag = '240']/marc:subfield">
                  <marc:subfield>
                    <xsl:choose>
                      <xsl:when test="@code='a'">
                        <xsl:attribute name="code">t</xsl:attribute>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:attribute name="code">
                          <xsl:value-of select="@code"/>
                        </xsl:attribute>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="ancestor::bf:Relation/bf:seriesEnumeration[not(@xml:lang)]|ancestor::bflc:Relationship/bf:seriesEnumeration[not(@xml:lang)]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="v">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag $v.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="x">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesLookupTag $x.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                  <marc:subfield code="w">
                    <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="$relURI">
                  <marc:subfield code="1">
                    <xsl:value-of select="."/>
                  </marc:subfield>
                </xsl:for-each>
              </marc:datafield>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:if>
      <xsl:if test="$xslProcessor = 'libxslt'">
        <xsl:choose>
          <xsl:when test="         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bf:hasSeries[contains(@rdf:resource, 'hubs')] |         bf:Work/bf:hasSeries/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo[contains(@rdf:resource, 'hubs')] |         bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[contains(@rdf:about, 'hubs') and not(bflc:marcKey)]         ">
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed relationship node(s)/Hub(s) <xsl:value-of select="name()"/>.  Repeatable target field 8XX.</xsl:message>
          </xsl:when>
        </xsl:choose>
      </xsl:if>
      <xsl:for-each select="     bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[bflc:marcKey] |     bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[bflc:marcKey] |     bf:Work/bf:hasSeries/bf:*[bflc:marcKey] |     bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[bflc:marcKey]     ">
        <xsl:variable name="relURI">
          <xsl:choose>
            <xsl:when test="contains(@rdf:about,'id.loc.gov')">
              <xsl:value-of select="@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelResourcePreNS">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pRelUri" select="$relURI"/>
            <xsl:with-param name="pContext" select="."/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
        <xsl:variable name="vSeriesMarcKeyTag">
          <xsl:choose>
            <xsl:when test="$vRelResource//marc:record">
              <xsl:choose>
                <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                  <xsl:text>800</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                  <xsl:text>810</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                  <xsl:text>811</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelResource//marc:datafield[@tag='130']">
                  <xsl:text>830</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vValidSubfields">
          <xsl:choose>
            <xsl:when test="$vSeriesMarcKeyTag='800'">
              <xsl:text>abcdfghjklmnopqrstv</xsl:text>
            </xsl:when>
            <xsl:when test="$vSeriesMarcKeyTag='810'">
              <xsl:text>abcdfghklmnoprstv</xsl:text>
            </xsl:when>
            <xsl:when test="$vSeriesMarcKeyTag='811'">
              <xsl:text>acdefghklnpqstv</xsl:text>
            </xsl:when>
            <xsl:when test="$vSeriesMarcKeyTag='830'">
              <xsl:text>adfghklmnoprstv</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vLangTagLabel" select="self::node()/bflc:marcKey[                     contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                      string-length(@xml:lang)='2' or                      string-length(@xml:lang)='3'                   ][1]/@xml:lang"/>
        <xsl:variable name="vLangTagScript" select="self::node()/bflc:marcKey[@xml:lang and contains(@xml:lang, '-') and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]/@xml:lang"/>
        <xsl:variable name="v880Script">
          <xsl:choose>
            <xsl:when test="$vLangTagScript!=''">
              <xsl:variable name="vlang">
                <xsl:value-of select="translate(substring-after($vLangTagScript,'-'),$upper,$lower)"/>
              </xsl:variable>
              <xsl:value-of select="exsl:node-set($df880script)/*[lang=$vlang]/code"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelVariantPreNS">
          <xsl:if test="$v880Script != '' and self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]">
            <xsl:call-template name="tGetMiniMARCFromKey">
              <xsl:with-param name="pFieldStr" select="self::node()/bflc:marcKey[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))][1]"/>
            </xsl:call-template>
          </xsl:if>
        </xsl:variable>
        <xsl:variable name="vRelVariant" select="exsl:node-set($vRelVariantPreNS)"/>
        <xsl:variable name="vRelVariantTag">
          <xsl:choose>
            <xsl:when test="$vRelVariant//marc:record">
              <xsl:choose>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='100']">
                  <xsl:text>100</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='110']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='111']">
                  <xsl:text>111</xsl:text>
                </xsl:when>
                <xsl:when test="$vRelVariant//marc:datafield[@tag='151']">
                  <xsl:text>110</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="rdfs:label/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">
            <xsl:value-of select="$vSeriesMarcKeyTag"/>
          </xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="$vSeriesMarcKeyTag != '830'">
                  <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesMarcKeyTag.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text> </xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="$vSeriesMarcKeyTag = '830'">
                  <xsl:choose>
                    <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesMarcKeyTag.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:text>0</xsl:text>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text> </xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
              <xsl:variable name="vvSeriesMarcKeyTag-6">
                <xsl:value-of select="concat('880-', 86 + position())"/>
              </xsl:variable>
              <xsl:if test="$vvSeriesMarcKeyTag-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$vvSeriesMarcKeyTag-6"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
            <marc:subfield>
              <xsl:attribute name="code">
                <xsl:value-of select="@code"/>
              </xsl:attribute>
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="not($vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[@code='v'])">
              <xsl:for-each select="ancestor::bf:Relation/bf:seriesEnumeration[not(@xml:lang)]|ancestor::bflc:Relationship/bf:seriesEnumeration[not(@xml:lang)]">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="v">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesMarcKeyTag $v.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="not($vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[@code='x'])">
              <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="x">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vSeriesMarcKeyTag $x.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="not($vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[@code='w'])">
              <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                <marc:subfield code="w">
                  <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$relURI != ''">
              <xsl:variable name="vvSeriesMarcKeyTag-1">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$vvSeriesMarcKeyTag-1 != ''">
                <marc:subfield code="1">
                  <xsl:value-of select="$vvSeriesMarcKeyTag-1"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </marc:datafield>
        <xsl:choose>
          <xsl:when test="$vRelVariant//marc:datafield[@tag!='']">
            <marc:datafield>
              <xsl:attribute name="tag">880</xsl:attribute>
              <xsl:attribute name="ind1">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vSeriesMarcKeyTag != '830'">
                      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="."/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:attribute name="ind2">
                <xsl:variable name="vInd">
                  <xsl:choose>
                    <xsl:when test="$vSeriesMarcKeyTag = '830'">
                      <xsl:choose>
                        <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != '' and $vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1 != ' '">
                          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:value-of select="."/>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>0</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vInd != ''">
                    <xsl:value-of select="$vInd"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text> </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:attribute>
              <xsl:variable name="v880-6">
                <xsl:choose>
                  <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
                    <xsl:value-of select="concat($vSeriesMarcKeyTag, '-', 86 + position(), '/', $v880Script)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="concat($vSeriesMarcKeyTag, '-00', '/', $v880Script)"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v880-6 != ''">
                <marc:subfield code="6">
                  <xsl:value-of select="$v880-6"/>
                </marc:subfield>
              </xsl:if>
              <xsl:for-each select="$vRelVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
              <xsl:choose>
                <xsl:when test="not($vRelVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[@code='v'])">
                  <xsl:for-each select="ancestor::bf:Relation/bf:seriesEnumeration[@xml:lang]|ancestor::bflc:Relationship/bf:seriesEnumeration[@xml:lang]">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="v">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $v.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="not($vRelVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[@code='x'])">
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 880 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="not($vRelVariant//marc:datafield[starts-with(@tag, '1')]/marc:subfield[@code='w'])">
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                    <marc:subfield code="w">
                      <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$relURI != ''">
                  <xsl:variable name="v880-1">
                    <xsl:value-of select="$relURI"/>
                  </xsl:variable>
                  <xsl:if test="$v880-1 != ''">
                    <marc:subfield code="1">
                      <xsl:value-of select="$v880-1"/>
                    </marc:subfield>
                  </xsl:if>
                </xsl:when>
              </xsl:choose>
            </marc:datafield>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="     bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey) and bf:title and not(contains(bf:status/@rdf:resource, 'mstatus/t')) and not(contains(bf:status/bf:Status/@rdf:about, '/mstatus/t'))] |     //bf:Item/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/relationship/series') or contains(bf:Relationship/@rdf:about, '/relationship/series')]]/bf:associatedResource/bf:*[not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey) and bf:title and not(contains(bf:status/@rdf:resource, 'mstatus/t')) and not(contains(bf:status/bf:Status/@rdf:about, '/mstatus/t'))] |     bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey) and bf:title and not(contains(bf:status/@rdf:resource, 'mstatus/t')) and not(contains(bf:status/bf:Status/@rdf:about, '/mstatus/t'))] |     //bf:Item/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey) and bf:title and not(contains(bf:status/@rdf:resource, 'mstatus/t')) and not(contains(bf:status/bf:Status/@rdf:about, '/mstatus/t'))] |     bf:Work/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey) and bf:title and not(contains(bf:status/@rdf:resource, 'mstatus/t')) and not(contains(bf:status/bf:Status/@rdf:about, '/mstatus/t'))] |     //bf:Item/bflc:relationship/bflc:Relationship[bflc:relation[contains(@rdf:resource, 'hasSeries') or contains(bflc:Relation/@rdf:about, 'hasSeries')]]/bf:relatedTo/bf:*[not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey) and bf:title and not(contains(bf:status/@rdf:resource, 'mstatus/t')) and not(contains(bf:status/bf:Status/@rdf:about, '/mstatus/t'))]">
        <xsl:variable name="vScriptSubtag">
          <xsl:call-template name="tScriptCode">
            <xsl:with-param name="pXmlLang" select="rdfs:label/@xml:lang"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vContribSourceUri">
          <xsl:choose>
            <xsl:when test="bf:contribution/*/bf:agent/*/bf:source/@rdf:resource">
              <xsl:value-of select="bf:contribution/*/bf:agent/*/bf:source/@rdf:resource"/>
            </xsl:when>
            <xsl:when test="bf:contribution/*/bf:agent/*/bf:source/bf:Source/@rdf:about">
              <xsl:value-of select="bf:contribution/*/bf:agent/*/bf:source/bf:Source/@rdf:about"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vNameAuth">
          <xsl:choose>
            <xsl:when test="bf:contribution/*/bf:agent/*">
              <xsl:call-template name="tGetRelResource">
                <xsl:with-param name="pUri" select="bf:contribution/*/bf:agent/*/@rdf:about"/>
              </xsl:call-template>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="agentRelURI">
          <xsl:choose>
            <xsl:when test="not(contains(../bf:contribution/bf:*/bf:agent/@rdf:resource,'REPLACE'))">
              <xsl:value-of select="../bf:contribution/bf:*/bf:agent/@rdf:resource"/>
            </xsl:when>
            <xsl:when test="not(contains(../bf:contribution/bf:*/bf:agent/*/@rdf:about,'REPLACE'))">
              <xsl:value-of select="not(contains(../bf:contribution/bf:*/bf:agent/*/@rdf:about,'REPLACE'))"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelResourcePreNS">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pRelUri" select="$agentRelURI"/>
            <xsl:with-param name="pContext" select="../bf:contribution/bf:*/bf:agent/*[1]"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
        <xsl:choose>
          <xsl:when test="$vScriptSubtag='' or translate($vScriptSubtag,$upper,$lower)=translate($pCatScript,$upper,$lower)">
            <xsl:choose>
              <xsl:when test="bf:contribution/*/bf:agent/*[                       local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or                       local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                       local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']                       ]">
                <marc:datafield>
                  <xsl:attribute name="tag">810</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                          <xsl:value-of select="$vRelResource//marc:datafield[@tag='110']/@ind1"/>
                        </xsl:when>
                        <xsl:when test="bf:contribution/*/bf:agent/*[local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']]">
                          <xsl:text>1</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>2</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:contribution/*/bf:agent/*">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
                        <xsl:for-each select="$vRelResource//marc:datafield[@tag='110']/marc:subfield[contains('abcdgn',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="v810-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:elementList">
                              <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v810-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v810-a"/>
                          </marc:subfield>
                        </xsl:if>
                        <xsl:for-each select="madsrdf:elementList/*[position() &gt; 1]/madsrdf:elementValue">
                          <marc:subfield code="b">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                      <marc:subfield code="e">
                        <xsl:choose>
                          <xsl:when test="madsrdf:authoritativeLabel">
                            <xsl:for-each select="madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $e.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $e.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                      <marc:subfield code="4">
                        <xsl:choose>
                          <xsl:when test="madsrdf:code">
                            <xsl:for-each select="madsrdf:code">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $4.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="bf:code">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $4.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                      <marc:subfield code="1">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                      <marc:subfield code="0">
                        <xsl:variable name="vIdType">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vIdType != ''">
                            <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="rdf:value"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="t">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $t.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicKey">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="r">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $r.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:seriesEnumeration">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="v">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $v.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 810 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                    <marc:subfield code="w">
                      <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="1">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier[not(contains(rdf:type,'bibframe'))]">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="$vContribSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label or */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                      <xsl:variable name="v810-2">
                        <xsl:choose>
                          <xsl:when test="bf:source/bf:Source/bf:code">
                            <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:when test="$vContribSourceUri != ''">
                            <xsl:choose>
                              <xsl:when test="contains($vContribSourceUri,'id.loc.gov')">
                                <xsl:call-template name="tUriCode">
                                  <xsl:with-param name="pUri" select="$vContribSourceUri"/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="$vContribSourceUri"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                          <xsl:when test="*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                            <xsl:value-of select="*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v810-2 != ''">
                        <marc:subfield code="2">
                          <xsl:value-of select="$v810-2"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="bf:contribution/*/bf:agent/*[                       local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or                       local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']                       ]">
                <marc:datafield>
                  <xsl:attribute name="tag">811</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                          <xsl:value-of select="$vRelResource//marc:datafield[@tag='111']/@ind1"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>2</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:contribution/*/bf:agent/*">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
                        <xsl:for-each select="$vRelResource//marc:datafield[@tag='111']/marc:subfield[contains('acdegnq',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="v811-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:elementList">
                              <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v811-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v811-a"/>
                          </marc:subfield>
                        </xsl:if>
                        <xsl:for-each select="madsrdf:elementList/*[local-name()='GeographicElement' and position() &gt; 1]/madsrdf:elementValue">
                          <marc:subfield code="c">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="madsrdf:elementList/*[local-name()='NameElement' and position() &gt; 1]/madsrdf:elementValue">
                          <marc:subfield code="q">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                      <marc:subfield code="j">
                        <xsl:choose>
                          <xsl:when test="madsrdf:authoritativeLabel">
                            <xsl:for-each select="madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $j.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $j.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                      <marc:subfield code="4">
                        <xsl:choose>
                          <xsl:when test="madsrdf:code">
                            <xsl:for-each select="madsrdf:code">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $4.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="bf:code">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $4.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                      <marc:subfield code="1">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                      <marc:subfield code="0">
                        <xsl:variable name="vIdType">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vIdType != ''">
                            <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="rdf:value"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="t">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $t.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicKey">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="r">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $r.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:seriesEnumeration">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="v">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $v.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 811 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                    <marc:subfield code="w">
                      <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="1">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier[not(contains(rdf:type,'bibframe'))]">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="$vContribSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label or */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                      <xsl:variable name="v811-2">
                        <xsl:choose>
                          <xsl:when test="bf:source/bf:Source/bf:code">
                            <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:when test="$vContribSourceUri != ''">
                            <xsl:choose>
                              <xsl:when test="contains($vContribSourceUri,'id.loc.gov')">
                                <xsl:call-template name="tUriCode">
                                  <xsl:with-param name="pUri" select="$vContribSourceUri"/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="$vContribSourceUri"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                          <xsl:when test="*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                            <xsl:value-of select="*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v811-2 != ''">
                        <marc:subfield code="2">
                          <xsl:value-of select="$v811-2"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:when test="bf:contribution/*/bf:agent/*">
                <marc:datafield>
                  <xsl:attribute name="tag">800</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                          <xsl:value-of select="$vRelResource//marc:datafield[@tag='100']/@ind1"/>
                        </xsl:when>
                        <xsl:when test="bf:contribution/*/bf:agent/*[local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family'] or local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName']]">
                          <xsl:text>3</xsl:text>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>1</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:contribution/*/bf:agent/*">
                    <xsl:choose>
                      <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
                        <xsl:for-each select="$vRelResource//marc:datafield[@tag='100']/marc:subfield[contains('abcdgjq',@code)]">
                          <marc:subfield>
                            <xsl:attribute name="code">
                              <xsl:value-of select="@code"/>
                            </xsl:attribute>
                            <xsl:value-of select="."/>
                          </marc:subfield>
                        </xsl:for-each>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:variable name="v800-a">
                          <xsl:choose>
                            <xsl:when test="madsrdf:elementList/madsrdf:FullNameElement/madsrdf:elementValue">
                              <xsl:for-each select="madsrdf:elementList/madsrdf:FullNameElement/madsrdf:elementValue[1]">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:when test="madsrdf:authoritativeLabel">
                              <xsl:for-each select="madsrdf:authoritativeLabel">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:for-each select="rdfs:label">
                                <xsl:choose>
                                  <xsl:when test="position() = 1">
                                    <xsl:call-template name="tChopPunct">
                                      <xsl:with-param name="pString" select="."/>
                                    </xsl:call-template>
                                  </xsl:when>
                                  <xsl:otherwise>
                                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $a.</xsl:message>
                                  </xsl:otherwise>
                                </xsl:choose>
                              </xsl:for-each>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:variable>
                        <xsl:if test="$v800-a != ''">
                          <marc:subfield code="a">
                            <xsl:value-of select="$v800-a"/>
                          </marc:subfield>
                        </xsl:if>
                        <xsl:for-each select="madsrdf:elementList/madsrdf:TermsOfAddressNameElement/madsrdf:elementValue">
                          <marc:subfield code="c">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </marc:subfield>
                        </xsl:for-each>
                        <xsl:for-each select="madsrdf:elementList/madsrdf:DateNameElement/madsrdf:elementValue">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="d">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $d.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                        <xsl:for-each select="madsrdf:fullerName/*/rdfs:label">
                          <xsl:choose>
                            <xsl:when test="position() = 1">
                              <marc:subfield code="q">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </marc:subfield>
                            </xsl:when>
                            <xsl:otherwise>
                              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $q.</xsl:message>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:for-each>
                      </xsl:otherwise>
                    </xsl:choose>
                    <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                      <marc:subfield code="e">
                        <xsl:choose>
                          <xsl:when test="madsrdf:authoritativeLabel">
                            <xsl:for-each select="madsrdf:authoritativeLabel">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $e.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="rdfs:label">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:call-template name="tChopPunct">
                                    <xsl:with-param name="pString" select="."/>
                                  </xsl:call-template>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $e.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
                      <marc:subfield code="4">
                        <xsl:choose>
                          <xsl:when test="madsrdf:code">
                            <xsl:for-each select="madsrdf:code">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $4.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:for-each select="bf:code">
                              <xsl:choose>
                                <xsl:when test="position() = 1">
                                  <xsl:value-of select="."/>
                                </xsl:when>
                                <xsl:otherwise>
                                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $4.</xsl:message>
                                </xsl:otherwise>
                              </xsl:choose>
                            </xsl:for-each>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
                      <marc:subfield code="4">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                      <marc:subfield code="1">
                        <xsl:value-of select="."/>
                      </marc:subfield>
                    </xsl:for-each>
                    <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                      <marc:subfield code="0">
                        <xsl:variable name="vIdType">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                          </xsl:call-template>
                        </xsl:variable>
                        <xsl:choose>
                          <xsl:when test="$vIdType != ''">
                            <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="rdf:value"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </marc:subfield>
                    </xsl:for-each>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="t">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $t.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicKey">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="r">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $r.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:seriesEnumeration">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="v">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $v.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 800 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                    <marc:subfield code="w">
                      <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="1">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier[not(contains(rdf:type,'bibframe'))]">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="$vContribSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label or */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                      <xsl:variable name="v800-2">
                        <xsl:choose>
                          <xsl:when test="bf:source/bf:Source/bf:code">
                            <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:when test="$vContribSourceUri != ''">
                            <xsl:choose>
                              <xsl:when test="contains($vContribSourceUri,'id.loc.gov')">
                                <xsl:call-template name="tUriCode">
                                  <xsl:with-param name="pUri" select="$vContribSourceUri"/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:value-of select="$vContribSourceUri"/>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:when>
                          <xsl:when test="*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
                            <xsl:value-of select="*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="$v800-2 != ''">
                        <marc:subfield code="2">
                          <xsl:value-of select="$v800-2"/>
                        </marc:subfield>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:when>
              <xsl:otherwise>
                <marc:datafield>
                  <xsl:attribute name="tag">830</xsl:attribute>
                  <xsl:attribute name="ind1">
                    <xsl:text> </xsl:text>
                  </xsl:attribute>
                  <xsl:attribute name="ind2">
                    <xsl:variable name="vInd">
                      <xsl:choose>
                        <xsl:when test="bf:title/bf:Title/bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:title/bf:Title/bf:mainTitle))">
                          <xsl:value-of select="string-length(bf:title/bf:Title/bf:mainTitle) - string-length(bf:title/bf:Title/bflc:titleSortKey)"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:choose>
                      <xsl:when test="$vInd != ''">
                        <xsl:value-of select="$vInd"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:text>0</xsl:text>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                  <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="3">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 830 $3.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="a">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 830 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
                    <marc:subfield code="1">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/bf:Identifier">
                    <marc:subfield code="0">
                      <xsl:variable name="vIdType">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                        </xsl:call-template>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="$vIdType != ''">
                          <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="rdf:value"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:legalDate">
                    <marc:subfield code="d">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:originDate">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="f">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 830 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                    <marc:subfield code="m">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
                    <marc:subfield code="n">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:title/bf:Title/bf:partName">
                    <marc:subfield code="p">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:choose>
                    <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
                      <marc:subfield code="o">arranged</marc:subfield>
                    </xsl:when>
                  </xsl:choose>
                  <xsl:for-each select="bf:musicKey">
                    <marc:subfield code="r">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:version">
                    <marc:subfield code="s">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="x">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 830 $x.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="../../bf:seriesEnumeration">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="v">
                          <xsl:value-of select="."/>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 830 $v.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                  <xsl:for-each select="bf:identifiedBy/*[local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']">
                    <marc:subfield code="w">
                      <xsl:value-of select="concat('(DLC)',rdf:value)"/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bf:source/bf:Source/bf:code">
                    <marc:subfield code="2">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                  <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
                    <marc:subfield code="5">
                      <xsl:value-of select="."/>
                    </marc:subfield>
                  </xsl:for-each>
                </marc:datafield>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:apply-templates select="bf:Instance[                       (bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/c' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/c') and                        bf:electronicLocator                       ]" mode="generate-856">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:tableOfContents/bf:TableOfContents[not(rdfs:label) and rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']] |                     bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']] |                     //bf:Item/bf:electronicLocator/*[rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']]" mode="generate-856">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <xsl:apply-templates select="bf:Work/bf:tableOfContents[@rdf:resource] |                     bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[bf:electronicLocator/@rdf:resource] |                     //bf:Item/bf:electronicLocator[@rdf:resource]" mode="generate-856">
        <xsl:with-param name="vRecordId" select="$vRecordId"/>
        <xsl:with-param name="vAdminMetadata" select="$vAdminMetadata"/>
      </xsl:apply-templates>
      <marc:datafield>
        <xsl:attribute name="tag">884</xsl:attribute>
        <xsl:attribute name="ind1">
          <xsl:text> </xsl:text>
        </xsl:attribute>
        <xsl:attribute name="ind2">
          <xsl:text> </xsl:text>
        </xsl:attribute>
        <xsl:variable name="v884-a"><xsl:value-of select="$vCurrentVersion"/> (<xsl:value-of select="$xslProcessor"/>)</xsl:variable>
        <xsl:if test="$v884-a != ''">
          <marc:subfield code="a">
            <xsl:value-of select="$v884-a"/>
          </marc:subfield>
        </xsl:if>
        <xsl:choose>
          <xsl:when test="$pGenerationDatestamp">
            <xsl:variable name="v884-g">
              <xsl:value-of select="substring($pGenerationDatestamp, 1, 8)"/>
            </xsl:variable>
            <xsl:if test="$v884-g != ''">
              <marc:subfield code="g">
                <xsl:value-of select="$v884-g"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$pSourceRecordId">
            <xsl:variable name="v884-k">
              <xsl:value-of select="$pSourceRecordId"/>
            </xsl:variable>
            <xsl:if test="$v884-k != ''">
              <marc:subfield code="k">
                <xsl:value-of select="$v884-k"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$pConversionAgency">
            <xsl:variable name="v884-q">
              <xsl:value-of select="$pConversionAgency"/>
            </xsl:variable>
            <xsl:if test="$v884-q != ''">
              <marc:subfield code="q">
                <xsl:value-of select="$v884-q"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
        </xsl:choose>
        <xsl:choose>
          <xsl:when test="$pGenerationUri">
            <xsl:variable name="v884-u">
              <xsl:value-of select="concat($pGenerationUri, '/releases/tag/', substring-after($vCurrentVersion, 'DLC bibframe2marc '))"/>
            </xsl:variable>
            <xsl:if test="$v884-u != ''">
              <marc:subfield code="u">
                <xsl:value-of select="$v884-u"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
        </xsl:choose>
      </marc:datafield>
      <xsl:for-each select="$vAdminMetadata/bflc:marcKey[starts-with(., '9')]">
        <xsl:variable name="vTag">
          <xsl:value-of select="substring(., 1, 3)"/>
        </xsl:variable>
        <xsl:variable name="vInd1">
          <xsl:value-of select="substring(., 4, 1)"/>
        </xsl:variable>
        <xsl:variable name="vInd2">
          <xsl:value-of select="substring(., 5, 1)"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">
            <xsl:value-of select="$vTag"/>
          </xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:value-of select="$vInd1"/>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text> </xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:value-of select="$vInd2"/>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text> </xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:call-template name="tParseMarcKey">
            <xsl:with-param name="pString" select="substring(., 6)"/>
          </xsl:call-template>
        </marc:datafield>
      </xsl:for-each>
    </marc:record>
  </xsl:template>
  <xsl:template match="/rdf:RDF/bf:Instance" mode="generate-007">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:controlfield>
      <xsl:attribute name="xml:space">preserve</xsl:attribute>
      <xsl:attribute name="tag">007</xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026058' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026058' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026061' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026061' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026387' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026387' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026113' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026113' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027245' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027245' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026530' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026530' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026295' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026295' or           bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2018026045' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2018026045'">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026058' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026058'">
                <xsl:text>ad </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026061' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026061'">
                <xsl:text>ag </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026387' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026387'">
                <xsl:text>aj </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026113' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026113'">
                <xsl:text>ak </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027245' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027245'">
                <xsl:text>aq </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026530' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026530'">
                <xsl:text>ar </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026295' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026295'">
                <xsl:text>as </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2018026045' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2018026045'">
                <xsl:text>ay </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>a| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>|||||</xsl:text>
        </xsl:when>
        <xsl:when test="(bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/n' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/n') and           (bf:carrier/@rdf:resource='http://id.loc.gov/vocabulary/carriers/nr' or bf:carrier/*/@rdf:about='http://id.loc.gov/vocabulary/carriers/nr') and            (           (bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026300' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026300') or            (bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026117' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026117')           )">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026117' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026117'">
                <xsl:text>da |||</xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>d| |||</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="(bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/g' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/g') and                     (                       (                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/gc'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/gd'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/gf'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/mo'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/gs'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/gt']                       )                     or                       (                         ../*[local-name()='StillImage'] or ../bf:Work/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/StillImage'                       )                      )">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/gc' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/gc']">
                <xsl:text>gc </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/gd' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/gd']">
                <xsl:text>gd </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/gf' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/gf']">
                <xsl:text>gf </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/mo' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/mo']">
                <xsl:text>go </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/gs' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/gs']">
                <xsl:text>gs </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/gt' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/gt']">
                <xsl:text>gt </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>g| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>||||||</xsl:text>
        </xsl:when>
        <xsl:when test="bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/h' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/h'">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/ha' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/ha']">
                <xsl:text>ha </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hb' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hb']">
                <xsl:text>hb </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hc' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hc']">
                <xsl:text>hc </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hd' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hd']">
                <xsl:text>hd </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/he' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/he']">
                <xsl:text>he </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hf' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hf']">
                <xsl:text>hf </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hg' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hg']">
                <xsl:text>hg </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hh' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hh']">
                <xsl:text>hh </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hj' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/hj']">
                <xsl:text>hj </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>h| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>||||||||||</xsl:text>
        </xsl:when>
        <xsl:when test="(bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/n' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/n') and                     (                       (                         bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2017027227'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2017027231'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2017027246'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/vocabulary/graphicMaterials/tgm007730'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2019026026'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/vocabulary/graphicMaterials/tgm007718'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2017027251'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2017027255'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2014026152'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/vocabulary/graphicMaterials/tgm009250'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2016026011'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2014026151'] or                          bf:genreForm//@rdf:*[.='http://id.loc.gov/authorities/genreForms/gf2017027249']                       )                     or                       (                         ../*[local-name()='StillImage'] or ../bf:Work/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/StillImage'                       )                     )">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027227' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027227'">
                <xsl:text>kc </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027231' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027231'">
                <xsl:text>kd </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027246' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027246'">
                <xsl:text>ke </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/vocabulary/graphicMaterials/tgm007730' or bf:genreForm/*/@rdf:about='http://id.loc.gov/vocabulary/graphicMaterials/tgm007730'">
                <xsl:text>kf </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2019026026' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2019026026'">
                <xsl:text>kg </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/vocabulary/graphicMaterials/tgm007718' or bf:genreForm/*/@rdf:about='http://id.loc.gov/vocabulary/graphicMaterials/tgm007718'">
                <xsl:text>kh </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027251' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027251'">
                <xsl:text>ki </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027255' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027255'">
                <xsl:text>kj </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026152' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026152'">
                <xsl:text>kk </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/vocabulary/graphicMaterials/tgm009250' or bf:genreForm/*/@rdf:about='http://id.loc.gov/vocabulary/graphicMaterials/tgm009250'">
                <xsl:text>kl </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026011' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026011'">
                <xsl:text>kn </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026151' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026151'">
                <xsl:text>kp </xsl:text>
              </xsl:when>
              <xsl:when test="bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027249' or bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027249'">
                <xsl:text>kv </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>k| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>|||</xsl:text>
        </xsl:when>
        <xsl:when test="(bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/g' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/g') and                     (                       (                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/mc'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/mf'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/mr'] or                         bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/mz']                       )                     or                       (                         ../*[local-name()='MovingImage'] or ../bf:Work/rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/MovingImage'                       )                      )">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/mc' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/mc']">
                <xsl:text>mc </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/mf' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/mf']">
                <xsl:text>mf </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/mr' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/mr']">
                <xsl:text>mr </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/mz' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/mz']">
                <xsl:text>mz </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>m| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>||||||||||||||||||||</xsl:text>
        </xsl:when>
        <xsl:when test="bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/s' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/s'">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/sd' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/sd']">
                <xsl:text>sd </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/se' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/se']">
                <xsl:text>se </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/sg' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/sg']">
                <xsl:text>sg </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/si' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/si']">
                <xsl:text>si </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/sq' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/sq']">
                <xsl:text>sq </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cr' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cr']">
                <xsl:text>sr </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/ss' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/ss']">
                <xsl:text>ss </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/st' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/st']">
                <xsl:text>st </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/sw' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/sw']">
                <xsl:text>sw </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>s| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>|||||||||||</xsl:text>
        </xsl:when>
        <xsl:when test="bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/v' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/v'">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/vc' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/vc']">
                <xsl:text>vc </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/vd' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/vd']">
                <xsl:text>vd </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/vf' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/vf']">
                <xsl:text>vf </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/vr' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/vr']">
                <xsl:text>vr </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>v| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>||||||</xsl:text>
        </xsl:when>
        <xsl:when test="(not(bf:media/@rdf:resource) and not(bf:media/*/@rdf:about)) or            (bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/n' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/n')           ">
          <xsl:text>t|</xsl:text>
        </xsl:when>
        <xsl:when test="bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/c' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/c'">
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/ca' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/ca']">
                <xsl:text>ca </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cb' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cb']">
                <xsl:text>cb </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cd' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cd']">
                <xsl:text>co </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/ce' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/ce']">
                <xsl:text>cj </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cf' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cf']">
                <xsl:text>cf </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/ch' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/ch']">
                <xsl:text>ch </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/ck' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/ck']">
                <xsl:text>ck </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cr' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cr']">
                <xsl:text>cr </xsl:text>
              </xsl:when>
              <xsl:when test="bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cz' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cz']">
                <xsl:text>cz </xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>c| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text>|||||||||||</xsl:text>
        </xsl:when>
      </xsl:choose>
    </marc:controlfield>
  </xsl:template>
  <xsl:template match="/rdf:RDF" mode="generate-008">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="v008Format">
      <xsl:choose>
        <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Cartography']">
          <xsl:text>MP</xsl:text>
        </xsl:when>
        <xsl:when test="bf:Instance/bf:issuance/bf:Issuance[@rdf:about='http://id.loc.gov/vocabulary/issuance/serl'] or                       bf:Instance/bf:issuance[@rdf:resource='http://id.loc.gov/vocabulary/issuance/serl'] or                       bf:Instance/bf:issuance/bf:Issuance[@rdf:about='http://id.loc.gov/vocabulary/issuance/intg'] or                       bf:Instance/bf:issuance[@rdf:resource='http://id.loc.gov/vocabulary/issuance/intg']">
          <xsl:text>CR</xsl:text>
        </xsl:when>
        <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Audio'] or                       bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/NotatedMusic']">
          <xsl:text>MU</xsl:text>
        </xsl:when>
        <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MovingImage'] or                       bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/StillImage'] or                       bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Object']">
          <xsl:text>VM</xsl:text>
        </xsl:when>
        <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MixedMaterial']">
          <xsl:text>MX</xsl:text>
        </xsl:when>
        <xsl:when test="bf:Instance/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Electronic']">
          <xsl:text>CF</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>BK</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vMUSupplContent">
      <xsl:variable name="vMUSupplRaw">
        <xsl:for-each select="bf:Work/bf:supplementaryContent">
          <xsl:choose>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/discography' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/discography'">a</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/bibliography' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/bibliography'">b</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/thematicindex' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/thematicindex'">c</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/libretto' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/libretto'">d</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/creatorbio' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/creatorbio'">e</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/performerhistory' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/performerhistory'">f</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/techinstruments' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/techinstruments'">g</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/techmusic' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/techmusic'">h</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/historicalinfo' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/historicalinfo'">i</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/ethnologicinfo' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/ethnologicinfo'">k</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/instructmaterial' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/instructmaterial'">r</xsl:when>
            <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/music' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/music'">s</xsl:when>
          </xsl:choose>
        </xsl:for-each>
      </xsl:variable>
      <xsl:variable name="vMUSupplPadded">
        <xsl:call-template name="tPadRight">
          <xsl:with-param name="pInput" select="$vMUSupplRaw"/>
          <xsl:with-param name="pStringLength">6</xsl:with-param>
        </xsl:call-template>
      </xsl:variable>
      <xsl:choose>
        <xsl:when test="string-length($vMUSupplPadded) &gt; 6">
          <xsl:value-of select="substring($vMUSupplPadded,1,6)"/>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$vMUSupplPadded"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <marc:controlfield>
          <xsl:attribute name="xml:space">preserve</xsl:attribute>
          <xsl:attribute name="tag">008</xsl:attribute>
          <xsl:variable name="vPosition-1">
            <xsl:choose>
              <xsl:when test="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]">
                <xsl:for-each select="$vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]/bf:date">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:choose>
                        <xsl:when test="@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://id.loc.gov/datatypes/edtf'">
                          <xsl:value-of select="translate(substring(.,3,8),'-','')"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:creationDate. Invalid datatype.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 008.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="$vAdminMetadata/bf:creationDate">
                <xsl:for-each select="$vAdminMetadata/bf:creationDate">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:choose>
                        <xsl:when test="@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://id.loc.gov/datatypes/edtf'">
                          <xsl:value-of select="translate(substring(.,3,8),'-','')"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:creationDate. Invalid datatype.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 008.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="$pGenerationDatestamp != ''">
                <xsl:value-of select="substring(translate($pGenerationDatestamp,'-',''), 3, 6)"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-1 != ''">
              <xsl:value-of select="$vPosition-1"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>700101</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-2">
            <xsl:choose>
              <xsl:when test="                   (                     bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Distribution']/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf' and                     bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Production']/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'                   ) or (                     bf:Instance/bf:provisionActivity/bf:Distribution/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf' and                     bf:Instance/bf:provisionActivity/bf:Production/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'                                   )                 ">
                <xsl:variable name="date1">
                  <xsl:choose>
                    <xsl:when test="bf:Instance/bf:provisionActivity/bf:Distribution/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'">
                      <xsl:value-of select="bf:Instance/bf:provisionActivity/bf:Distribution/bf:date[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Distribution']/bf:date[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="date2">
                  <xsl:choose>
                    <xsl:when test="bf:Instance/bf:provisionActivity/bf:Production/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'">
                      <xsl:value-of select="bf:Instance/bf:provisionActivity/bf:Production/bf:date[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Production']/bf:date[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="translate(concat('p', $date1, $date2), 'X', 'u')"/>
              </xsl:when>
              <xsl:when test="               bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Production']/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'                or                bf:Instance/bf:provisionActivity/bf:Production/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'               ">
                <xsl:variable name="vPAprenodeset">
                  <xsl:choose>
                    <xsl:when test="bf:Instance/bf:provisionActivity/bf:Production/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'">
                      <xsl:copy-of select="bf:Instance/bf:provisionActivity/bf:Production[bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:copy-of select="bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Production' and bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vPA" select="exsl:node-set($vPAprenodeset)"/>
                <xsl:variable name="date1">
                  <xsl:value-of select="$vPA/bf:*/bf:date[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vPA/bf:*/bf:note/bf:Note/rdfs:label = 'inclusive collection dates'">
                    <xsl:value-of select="translate(concat('i', translate($date1, '/', '')), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="$vPA/bf:*/bf:note/bf:Note/rdfs:label = 'bulk collection dates'">
                    <xsl:value-of select="translate(concat('k', translate($date1, '/', '')), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="string-length($date1) = 4">
                    <xsl:value-of select="translate(concat('s', $date1, '    '), 'X', 'u')"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="               bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Publication']/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'               or               bf:Instance/bf:provisionActivity/bf:Publication/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'               ">
                <xsl:variable name="vPAprenodeset">
                  <xsl:choose>
                    <xsl:when test="bf:Instance/bf:provisionActivity/bf:Publication/bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'">
                      <xsl:copy-of select="bf:Instance/bf:provisionActivity/bf:Publication[bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:copy-of select="bf:Instance/bf:provisionActivity/bf:ProvisionActivity[rdf:type/@rdf:resource = 'http://id.loc.gov/ontologies/bibframe/Publication' and bf:date/@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vPA" select="exsl:node-set($vPAprenodeset)"/>
                <xsl:variable name="theDate">
                  <xsl:value-of select="$vPA/bf:*/bf:date[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                </xsl:variable>
                <xsl:variable name="date1">
                  <xsl:choose>
                    <xsl:when test="string-length($theDate)=4">
                      <xsl:value-of select="substring($theDate, 1, 4)"/>
                    </xsl:when>
                    <xsl:when test="contains($theDate ,'/')">
                      <xsl:value-of select="substring-before($theDate, '/')"/>
                    </xsl:when>
                    <xsl:when test="contains($theDate ,'-')">
                      <xsl:value-of select="substring-before($theDate, '-')"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="cDateExists">
                  <xsl:choose>
                    <xsl:when test="bf:Instance/bf:copyrightDate[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']">1</xsl:when>
                    <xsl:otherwise>0</xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="cOriginDateExists">
                  <xsl:choose>
                    <xsl:when test="bf:Work/bf:originDate[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']">1</xsl:when>
                    <xsl:otherwise>0</xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="date2">
                  <xsl:choose>
                    <xsl:when test="$cDateExists = 1">
                      <xsl:value-of select="translate(bf:Instance/bf:copyrightDate[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf'], '©', '')"/>
                    </xsl:when>
                    <xsl:when test="$cOriginDateExists = 1">
                      <xsl:value-of select="bf:Work/bf:originDate[@rdf:datatype = 'http://id.loc.gov/datatypes/edtf']"/>
                    </xsl:when>
                    <xsl:when test="contains($theDate, '/..')">9999</xsl:when>
                    <xsl:when test="contains($theDate, '/')">
                      <xsl:value-of select="substring-after($theDate,'/')"/>
                    </xsl:when>
                    <xsl:when test="contains($theDate, '-')">
                      <xsl:value-of select="substring-after($theDate,'-')"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($date1) = 4 and $cDateExists = 1">
                    <xsl:value-of select="translate(concat('t', $date1, $date2), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="$vPA/bf:*/bf:status/bf:Status/@rdf:about = 'http://id.loc.gov/vocabulary/mstatus/current' and                     string-length($date1) = 4 and string-length($date2) = 4">
                    <xsl:value-of select="translate(concat('c', $date1, $date2), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="$vPA/bf:*/bf:status/bf:Status/@rdf:about = 'http://id.loc.gov/vocabulary/mstatus/ceased' and                                   string-length($date1) = 4 and string-length($date2) = 4">
                    <xsl:value-of select="translate(concat('d', $date1, $date2), 'X', 'u')"/>
                  </xsl:when>
                  <!-- <bf:date rdf:datatype="http://id.loc.gov/datatypes/edtf">1940~/1997~</bf:date> -->
                  <xsl:when test="string-length($date1)=5 and string-length($date2)=5 and                      (contains($date1, '~') or contains($date1, '?') or contains($date1, '%')) and                     (contains($date2, '~') or contains($date2, '?') or contains($date2, '%'))">
                    <xsl:value-of select="translate(concat('q', substring($date1, 1, 4), substring($date2, 1, 4)), 'X', 'u')"/>
                  </xsl:when>
                  <!-- <bf:date rdf:datatype="http://id.loc.gov/datatypes/edtf">1940~/1997</bf:date> -->
                  <xsl:when test="string-length($date1)=5 and string-length($date2)=4 and                      (contains($date1, '~') or contains($date1, '?') or contains($date1, '%'))">
                    <xsl:value-of select="translate(concat('q', substring($date1, 1, 4), $date2), 'X', 'u')"/>
                  </xsl:when>
                  <!-- <bf:date rdf:datatype="http://id.loc.gov/datatypes/edtf">1940/1997~</bf:date> -->
                  <xsl:when test="string-length($date1)=4 and string-length($date2)=5 and                      (contains($date2, '~') or contains($date2, '?') or contains($date2, '%'))">
                    <xsl:value-of select="translate(concat('q', $date1, substring($date2, 1, 4)), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="string-length($date1)=4 and string-length($date2)=4 and $cOriginDateExists = 0">
                    <xsl:value-of select="translate(concat('m', $date1, $date2), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="contains($date2, '-')">
                    <xsl:value-of select="translate(concat('e', $date1, translate($date2, '-', '')), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="$date1='XXXX' and $date2='XXXX'">
                    <xsl:value-of select="concat('n', '    ', '    ')"/>
                  </xsl:when>
                  <xsl:when test="string-length($date1) = 4 and $date1='XXXX'">
                    <xsl:value-of select="concat('n', '    ', '    ')"/>
                  </xsl:when>
                  <xsl:when test="string-length($date1) = 4 and $cOriginDateExists = 1 and $date1 != $date2">
                    <xsl:value-of select="translate(concat('r', $date1, $date2), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="$date2 != '' and $date1 != $date2">
                    <xsl:value-of select="translate(concat('e', $date1, $date2, '  '), 'X', 'u')"/>
                  </xsl:when>
                  <xsl:when test="string-length($date1) = 4">
                    <xsl:value-of select="translate(concat('s', $date1, '    '), 'X', 'u')"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-2 != ''">
              <xsl:value-of select="$vPosition-2"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>|||||||||</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-3">
            <xsl:for-each select="bf:Instance/bf:provisionActivity/bf:*/bf:place/@rdf:resource|                          bf:Instance/bf:provisionActivity/bf:*/bf:place/bf:*/@rdf:about">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:choose>
                    <xsl:when test="starts-with(.,'http://id.loc.gov/vocabulary/countries/')">
                      <xsl:variable name="vCode">
                        <xsl:value-of select="substring-after(.,'http://id.loc.gov/vocabulary/countries/')"/>
                      </xsl:variable>
                      <xsl:choose>
                        <xsl:when test="string-length($vCode)=3">
                          <xsl:value-of select="$vCode"/>
                        </xsl:when>
                        <xsl:when test="string-length($vCode)=2">
                          <xsl:value-of select="concat($vCode,' ')"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 008.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-3 != ''">
              <xsl:value-of select="$vPosition-3"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>xx </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-4">
            <xsl:choose>
              <xsl:when test="$v008Format='BK'">
                <xsl:variable name="vIllus">
                  <xsl:for-each select="*/bf:illustrativeContent">
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/ill' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/ill' or                                       */*[local-name()='code']='ill'">a</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/map' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/map' or                                       */*[local-name()='code']='map'">b</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/por' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/por' or                                       */*[local-name()='code']='por'">c</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/chr' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/chr' or                                       */*[local-name()='code']='chr'">d</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/pln' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/pln' or                                       */*[local-name()='code']='pln'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/plt' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/plt' or                                       */*[local-name()='code']='plt'">f</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/mus' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/mus' or                                       */*[local-name()='code']='mus'">g</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/fac' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/fac' or                                       */*[local-name()='code']='fac'">h</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/coa' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/coa' or                                       */*[local-name()='code']='coa'">i</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/gnt' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/gnt' or                                       */*[local-name()='code']='gnt'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/for' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/for' or                                       */*[local-name()='code']='for'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/sam' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/sam' or                                       */*[local-name()='code']='sam'">l</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/pho' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/pho' or                                       */*[local-name()='code']='pho'">m</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/pht' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/pht' or                                       */*[local-name()='code']='pht'">o</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/ilm' or                                       */@rdf:about='http://id.loc.gov/vocabulary/millus/ilm' or                                       */*[local-name()='code']='ilm'">p</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vIllusPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vIllus"/>
                    <!-- useful for testing. -->
                    <!-- <xsl:with-param name="pPadChar" select="'f'"/> -->
                    <xsl:with-param name="pStringLength">4</xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vIllusPadded) &gt; 4">
                    <xsl:value-of select="substring($vIllusPadded,1,4)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vIllusPadded"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='CR'">
                <xsl:variable name="vFrequency">
                  <xsl:choose>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/ann' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/ann' or */*[local-name()='code']='ann']">a</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/bmn' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/bmn' or */*[local-name()='code']='bmn']">b</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/swk' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/swk' or */*[local-name()='code']='swk']">c</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/dyl' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/dyl' or */*[local-name()='code']='dyl']">d</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/bwk' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/bwk' or */*[local-name()='code']='bwk']">e</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/san' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/san' or */*[local-name()='code']='san']">f</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/bin' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/bin' or */*[local-name()='code']='bin']">g</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/ten' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/ten' or */*[local-name()='code']='ten']">h</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/ttw' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/ttw' or */*[local-name()='code']='ttw']">i</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/ttm' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/ttm' or */*[local-name()='code']='ttm']">j</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/con' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/con' or */*[local-name()='code']='con']">k</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/mon' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/mon' or */*[local-name()='code']='mon']">m</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/qrt' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/qrt' or */*[local-name()='code']='qrt']">q</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/smn' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/smn' or */*[local-name()='code']='smn']">s</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/tty' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/tty' or */*[local-name()='code']='tty']">t</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/unk' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/unk' or */*[local-name()='code']='unk']">u</xsl:when>
                    <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/wkl' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/wkl' or */*[local-name()='code']='wkl']">w</xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="' '"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="$vFrequency"/>
                <xsl:variable name="vRegularity">
                  <xsl:choose>
                    <xsl:when test="$vFrequency != ' '">
                      <xsl:choose>
                        <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/irr' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/irr' or */*/*[local-name()='code']='irr']">n</xsl:when>
                        <xsl:otherwise>r</xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:choose>
                        <xsl:when test="bf:Instance/bf:frequency[@rdf:resource='http://id.loc.gov/vocabulary/frequencies/irr' or */@rdf:about='http://id.loc.gov/vocabulary/frequencies/irr' or */*/*[local-name()='code']='irr']">x</xsl:when>
                        <xsl:otherwise>|</xsl:otherwise>
                      </xsl:choose>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vCRType">
                  <xsl:choose>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/database' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/database' or */*/rdfs:label='database']">d</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/mag' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/mag' or */*/rdfs:label='mag']">g</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/blog' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/blog' or */*/rdfs:label='blog']">h</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/journal' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/journal' or */*/rdfs:label='journal']">j</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/looseleaf' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/looseleaf' or */*/rdfs:label='looseleaf']">l</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/monoseries' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/monoseries' or */*/rdfs:label='monoseries']">m</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/newspaper' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/newspaper' or */*/rdfs:label='newspaper']">n</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/periodical' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/periodical' or */*/rdfs:label='periodical']">p</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/repo' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/repo' or */*/rdfs:label='repo']">r</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/newsletter' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/newsletter' or */*/rdfs:label='newsletter']">s</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/directory' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/directory' or */*/rdfs:label='directory']">t</xsl:when>
                    <xsl:when test="bf:Work/bflc:serialPubType[@rdf:resource='http://id.loc.gov/vocabulary/mserialpubtype/web' or */@rdf:about='http://id.loc.gov/vocabulary/mserialpubtype/web' or */*/rdfs:label='web']">w</xsl:when>
                    <xsl:otherwise>|</xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="$vRegularity"/>
                <xsl:value-of select="' '"/>
                <xsl:value-of select="$vCRType"/>
              </xsl:when>
              <xsl:when test="$v008Format='MP'">
                <xsl:variable name="vRelief">
                  <xsl:for-each select="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:relief|bf:Work/bf:cartographicAttributes/bf:Cartographic/bflc:relief">
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/cont' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/cont'">a</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/shad' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/shad'">b</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/grad' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/grad'">c</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/hach' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/hach'">d</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/bath' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/bath'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/form' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/form'">f</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/spot' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/spot'">g</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/pict' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/pict'">i</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/land' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/land'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/isol' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/isol'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mrelief/rock' or */@rdf:about='http://id.loc.gov/vocabulary/mrelief/rock'">m</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vReliefPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vRelief"/>
                    <xsl:with-param name="pStringLength">4</xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vReliefPadded) &gt; 4">
                    <xsl:value-of select="substring($vReliefPadded,1,4)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vReliefPadded"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='MU'">
                <xsl:variable name="vCompForm">
                  <xsl:choose>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026635' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026635']">an</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026648' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026648']">bd</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026664' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026664']">bg</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026665' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026665']">bl</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026650' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026650']">bt</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026701' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026701']">ca</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026707' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026707']">cb</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026724' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026724']">cg</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026713' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026713']">ch</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026712' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026712']">cl</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026687' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026687']">cn</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026725' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026725']">co</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027007' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027007']">cp</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026695' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026695']">cr</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026624' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026624']">cs</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026688' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026688']">ct</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026739' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026739']">cy</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2018026012' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2018026012']">cz</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026753' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026753']">df</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027116' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027116']">dv</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026818' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026818']">fg</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026806' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026806']">fl</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026809' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026809']">fm</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2018026018' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2018026018']">ft</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026839' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026839']">gm</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026872' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026872']">hy</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026879' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026879']">jz</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027050' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027050']">mc</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026915' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026915']">md</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026940' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026940']">mi</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026949' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026949']">mo</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026950' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026950']">mp</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026922' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026922']">mr</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026926' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026926']">ms</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026928' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026928']">mz</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017026144' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017026144']">nc</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026976' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026976']">op</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026980' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026980']">ov</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027017' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027017']">pg</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026861' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026861']">pm</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027005' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027005']">po</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027009' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027009']">pp</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027013' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027013']">pr</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026989' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026989']">ps</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026984' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026984']">pt</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026994' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026994']">pv</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027054' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027054']">rc</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027057' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027057']">rd</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027034' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027034']">rg</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017026128' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017026128']">ri</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027051' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027051']">rp</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027048' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027048']">rq</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027111' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027111']">sd</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027103' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027103']">sg</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027099' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027099']">sn</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027120' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027120']">sp</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027115' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027115']">st</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027116' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027116']">su</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027121' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027121']">sy</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027140' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027140']">tc</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026059' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026059']">tl</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017026025' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017026025']">vi</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027156' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027156']">vr</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014027167' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014027167']">wz</xsl:when>
                    <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026059' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026059']">za</xsl:when>
                    <xsl:otherwise>||</xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vMusicForm">
                  <xsl:choose>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/score' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/score']">a</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/studyscore' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/studyscore']">b</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/pianoscore' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/pianoscore']">c</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/pianopart' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/pianopart']">e</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/chscore' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/chscore']">h</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/conscore' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/conscore']">i</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/perfconpt' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/perfconpt']">j</xsl:when>
                    <xsl:when test="bf:Work/bf:musicFormat[@rdf:resource='http://id.loc.gov/vocabulary/mmusicformat/vocalscore' or */@rdf:about='http://id.loc.gov/vocabulary/mmusicformat/vocalscore']">k</xsl:when>
                    <xsl:otherwise>|</xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="concat($vCompForm,$vMusicForm,'|')"/>
              </xsl:when>
              <xsl:when test="$v008Format='VM'">
                <xsl:choose>
                  <xsl:when test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MovingImage']">
                    <xsl:variable name="vDuration">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bf:duration[@rdf:datatype='http://www.w3.org/2001/XMLSchema#duration']">
                          <xsl:value-of select="substring-before(substring-after(bf:Work/bf:duration[@rdf:datatype='http://www.w3.org/2001/XMLSchema#duration'],'PT'),'M')"/>
                        </xsl:when>
                        <xsl:when test="bf:Work/bf:duration[(. = number(.))]">
                          <xsl:value-of select="bf:Work/bf:duration[(. = number(.))]"/>
                        </xsl:when>
                        <xsl:when test="bf:Work/bf:duration[contains(.,'999')]">000</xsl:when>
                        <xsl:otherwise>|||</xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:variable name="vDurationPadded">
                      <xsl:call-template name="tPadLeft">
                        <xsl:with-param name="pInput" select="$vDuration"/>
                        <xsl:with-param name="pStringLength">3</xsl:with-param>
                        <xsl:with-param name="pPadChar">0</xsl:with-param>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:variable name="vDurationFinal">
                      <xsl:choose>
                        <xsl:when test="$vDurationPadded &gt; 999">000</xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="$vDurationPadded"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:value-of select="concat($vDurationFinal,' ')"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>nnn </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-4 != ''">
              <xsl:value-of select="$vPosition-4"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>    </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-5">
            <xsl:choose>
              <xsl:when test="$v008Format='BK' or                         $v008Format='CF' or                         $v008Format='MU' or                         $v008Format='CR' or                         $v008Format='VM' or                         $v008Format='MX'">
                <!--<xsl:variable name="v008-22">-->
                <xsl:choose>
                  <xsl:when test="$v008Format='MX'">
                    <xsl:value-of select="' '"/>
                  </xsl:when>
                  <xsl:when test="$v008Format='CR'">
                    <xsl:value-of select="' '"/>
                  </xsl:when>
                  <!--<xsl:choose>
                        <xsl:when test="bf:Instance/bf:note/*[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/orig']">
                          <xsl:for-each select="bf:Instance/bf:note/*[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/orig']">
                            <xsl:if test="position()=1">
                              <xsl:choose>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='microfilm'">a</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='microfiche'">b</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='microopaque'">c</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='large print'">d</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='newspaper format'">e</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='braille'">f</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='online'">o</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='direct electronic'">q</xsl:when>
                                <xsl:when test="translate(rdfs:label,$upper,$lower)='electronic'">s</xsl:when>
                                <xsl:otherwise><xsl:value-of select="'|'"/></xsl:otherwise>
                              </xsl:choose>
                            </xsl:if>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="' '"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    -->
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/pre' or                                     */@rdf:about='http://id.loc.gov/vocabulary/maudience/pre'                                     or */*[local-name='code']='pre']">a</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/pri' or                                     */@rdf:about='http://id.loc.gov/vocabulary/maudience/pri'                                     or */*[local-name='code']='pri']">b</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/pad'                                     or */@rdf:about='http://id.loc.gov/vocabulary/maudience/pad'                                     or */*[local-name='code']='pad']">c</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/ado'                                     or */@rdf:about='http://id.loc.gov/vocabulary/maudience/ado'                                     or */*[local-name='code']='ado']">d</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/adu'                                     or */@rdf:about='http://id.loc.gov/vocabulary/maudience/adu'                                     or */*[local-name='code']='adu']">e</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/spe'                                     or */@rdf:about='http://id.loc.gov/vocabulary/maudience/spe'                                     or */*[local-name='code']='spe']">f</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/gen'                                     or */@rdf:about='http://id.loc.gov/vocabulary/maudience/gen'                                     or */*[local-name='code']='gen']">g</xsl:when>
                  <xsl:when test="bf:Work/bf:intendedAudience[@rdf:resource='http://id.loc.gov/vocabulary/maudience/juv'                                     or */@rdf:about='http://id.loc.gov/vocabulary/maudience/juv'                                     or */*[local-name='code']='juv']">j</xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="' '"/>
                  </xsl:otherwise>
                </xsl:choose>
                <!--</xsl:variable>-->
                <!--<xsl:variable name="v008-23">-->
                <xsl:choose>
                  <xsl:when test="$v008Format='VM'">
                    <xsl:value-of select="' '"/>
                  </xsl:when>
                  <xsl:when test="$v008Format='CF'">
                    <xsl:choose>
                      <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cr' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cr' or */*[local-name()='code']='cr']">o</xsl:when>
                      <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cz' or */@rdf:about='http://id.loc.gov/vocabulary/carriers/cz' or */*[local-name()='code']='cz']">q</xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="' '"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:fontSize[@rdf:resource='http://id.loc.gov/vocabulary/mfont/lp'] or                                     bf:Instance/bf:fontSize/*[@rdf:about='http://id.loc.gov/vocabulary/mfont/lp'] or                                     bf:Instance/bf:fontSize/*[contains(rdfs:label,'large print')]">d</xsl:when>
                  <xsl:when test="bf:Instance/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mtactile/brail'] or                                     bf:Instance/bf:notation/*[@rdf:about='http://id.loc.gov/vocabulary/mtactile/brail'] or                                     bf:Instance/bf:notation/*[contains(rdfs:label,'braille')]">f</xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hd'] or                                     bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/hd'] or                                     bf:Instance/bf:carrier/*/*[local-name()='code']='hd'">a</xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/he'] or                                     bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/he'] or                                     bf:Instance/bf:carrier/*/*[local-name()='code']='he'">b</xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hg'] or                                     bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/hg'] or                                     bf:Instance/bf:carrier/*/*[local-name()='code']='hg'">c</xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cr'] or                                     bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/cr'] or                                     bf:Instance/bf:carrier/*/*[local-name()='code']='cr'">o</xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cz' or                                                              */@rdf:about='http://id.loc.gov/vocabulary/carriers/cz' or                                                              */*[local-name()='code']='cz']">s</xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="' '"/>
                  </xsl:otherwise>
                </xsl:choose>
                <!--</xsl:variable>-->
                <!--<xsl:value-of select="concat($v008-22,$v008-23)"/>-->
              </xsl:when>
              <xsl:when test="$v008Format='MP'">
                <xsl:choose>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/aa' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/aa' or */*[local-name()='code']='aa']">
                    <xsl:text>aa</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ab' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ab' or */*[local-name()='code']='ab']">
                    <xsl:text>ab</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ac' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ac' or */*[local-name()='code']='ac']">
                    <xsl:text>ac</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ad' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ad' or */*[local-name()='code']='ad']">
                    <xsl:text>ad</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ae' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ae' or */*[local-name()='code']='ae']">
                    <xsl:text>ae</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/af' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/af' or */*[local-name()='code']='af']">
                    <xsl:text>af</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ag' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ag' or */*[local-name()='code']='ag']">
                    <xsl:text>ag</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/am' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/am' or */*[local-name()='code']='am']">
                    <xsl:text>am</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/an' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/an' or */*[local-name()='code']='an']">
                    <xsl:text>an</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ap' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ap' or */*[local-name()='code']='ap']">
                    <xsl:text>ap</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/au' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/au' or */*[local-name()='code']='au']">
                    <xsl:text>au</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/az' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/az' or */*[local-name()='code']='az']">
                    <xsl:text>az</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ba' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ba' or */*[local-name()='code']='ba']">
                    <xsl:text>ba</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bb' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bb' or */*[local-name()='code']='bb']">
                    <xsl:text>bb</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bc' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bc' or */*[local-name()='code']='bc']">
                    <xsl:text>bc</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bd' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bd' or */*[local-name()='code']='bd']">
                    <xsl:text>bd</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bf' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bf' or */*[local-name()='code']='bf']">
                    <xsl:text>bf</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bg' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bg' or */*[local-name()='code']='bg']">
                    <xsl:text>bg</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bh' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bh' or */*[local-name()='code']='bh']">
                    <xsl:text>bh</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bi' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bi' or */*[local-name()='code']='bi']">
                    <xsl:text>bi</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bj' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bj' or */*[local-name()='code']='bj']">
                    <xsl:text>bj</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bk' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bk' or */*[local-name()='code']='bk']">
                    <xsl:text>bk</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bl' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bl' or */*[local-name()='code']='bl']">
                    <xsl:text>bl</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bo' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bo' or */*[local-name()='code']='bo']">
                    <xsl:text>bo</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/br' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/br' or */*[local-name()='code']='br']">
                    <xsl:text>br</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bs' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bs' or */*[local-name()='code']='bs']">
                    <xsl:text>bs</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bu' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bu' or */*[local-name()='code']='bu']">
                    <xsl:text>bu</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/bz' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/bz' or */*[local-name()='code']='bz']">
                    <xsl:text>bz</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ca' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ca' or */*[local-name()='code']='ca']">
                    <xsl:text>ca</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/cb' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/cb' or */*[local-name()='code']='cb']">
                    <xsl:text>cb</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/cc' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/cc' or */*[local-name()='code']='cc']">
                    <xsl:text>cc</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/ce' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/ce' or */*[local-name()='code']='ce']">
                    <xsl:text>ce</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/cp' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/cp' or */*[local-name()='code']='cp']">
                    <xsl:text>cp</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/cu' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/cu' or */*[local-name()='code']='cu']">
                    <xsl:text>cu</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/cz' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/cz' or */*[local-name()='code']='cz']">
                    <xsl:text>cz</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/da' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/da' or */*[local-name()='code']='da']">
                    <xsl:text>da</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/db' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/db' or */*[local-name()='code']='db']">
                    <xsl:text>db</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/dc' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/dc' or */*[local-name()='code']='dc']">
                    <xsl:text>dc</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/dd' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/dd' or */*[local-name()='code']='dd']">
                    <xsl:text>dd</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/de' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/de' or */*[local-name()='code']='de']">
                    <xsl:text>de</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/df' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/df' or */*[local-name()='code']='df']">
                    <xsl:text>df</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/dg' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/dg' or */*[local-name()='code']='dg']">
                    <xsl:text>dg</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/dh' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/dh' or */*[local-name()='code']='dh']">
                    <xsl:text>dh</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:cartographicAttributes/bf:Cartographic/bf:projection[@rdf:resource='http://id.loc.gov/vocabulary/mprojection/dl' or */@rdf:about='http://id.loc.gov/vocabulary/mprojection/dl' or */*[local-name()='code']='dl']">
                    <xsl:text>dl</xsl:text>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>  </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-5 != ''">
              <xsl:value-of select="$vPosition-5"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>  </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-6">
            <xsl:choose>
              <xsl:when test="$v008Format='BK' or                         $v008Format='CR'">
                <xsl:variable name="vNoC">
                  <xsl:for-each select="bf:Work/bf:genreForm|bf:Work/bf:supplementaryContent">
                    <!--<xsl:for-each select="bf:Work/bf:supplementaryContent">-->
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/bibliography' or                         */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/bibliography'">b</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/discography' or                         */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/discography'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/film' or                         */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/film'">q</xsl:when>
                      <!-- 
                        Uncommented the comment because in Nov 2024, most of these are back! 
                        Except those that remain commented out.  The comment is from 2022.
                      -->
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026048' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026048'">b</xsl:when>
                      <!-- Catalogs -->
                      <xsl:when test="(                                         @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026057' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026057' or                                          */madsrdf:authoritativeLabel[contains(., 'catalogs')] or                                          */rdfs:label[contains(., 'catalogs')] or                                          @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026058' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026058' or                                          @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026088' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026088' or                                         @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2015026050' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2015026050'                                       )                                      and                                       not(                                           preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026057' or                                           preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026057' or                                            preceding-sibling::bf:genreForm/*/madsrdf:authoritativeLabel[contains(., 'catalogs')] or                                            preceding-sibling::bf:genreForm/*/rdfs:label[contains(., 'catalogs')] or                                            preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026058' or                                           preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026058' or                                            preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026088' or                                           preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026088' or                                           preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2015026050' or                                           preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2015026050'                                       )                                 ">c</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026086' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026086'">d</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026092' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026092'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026109' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026109'">f</xsl:when>
                      <!--
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026351' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026351'">g</xsl:when>
                      -->
                      <!--
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026049' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026049'">h</xsl:when>
                      -->
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026112' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026112'">i</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026438' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026438'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026351' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026351'">l</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026039' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026039'">m</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026087' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026087'">r</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026181' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026181'">s</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2015026093' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2015026093'">t</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026208' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026208'">y</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026707' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026707'">z</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026055' or                                       */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026055'">5</xsl:when>
                      <!-- Comics (graphic novels) -->
                      <!-- Manga -->
                      <!-- Graphic Novels -->
                      <xsl:when test="(                                         @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026266' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026266' or                                          */madsrdf:authoritativeLabel[contains(., 'comics')] or                                          */rdfs:label[contains(., 'comics')] or                                          */madsrdf:authoritativeLabel[contains(., '(Comics)')] or                                          */rdfs:label[contains(., '(Comics)')] or                                          @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026572' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026572' or                                                                                   @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2022026036' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2022026036' or                                         */madsrdf:authoritativeLabel[contains(., ' manga')] or                                          */rdfs:label[contains(., ' manga')] or                                          @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2023026096' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2023026096' or                                                                                   @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026362' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026362' or                                          @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026005' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026005' or                                          @rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017026130' or                                         */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017026130'                                       )                                        and                                       not(                                         preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026266' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026266' or                                          preceding-sibling::bf:genreForm/*/madsrdf:authoritativeLabel[contains(., 'comics')] or                                          preceding-sibling::bf:genreForm/*/rdfs:label[contains(., 'comics')] or                                          preceding-sibling::bf:genreForm/*/madsrdf:authoritativeLabel[contains(., '(Comics)')] or                                          preceding-sibling::bf:genreForm/*/rdfs:label[contains(., '(Comics)')] or                                          preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026572' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026572' or                                                                                   preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2022026036' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2022026036' or                                         preceding-sibling::bf:genreForm/*/madsrdf:authoritativeLabel[contains(., ' manga')] or                                          preceding-sibling::bf:genreForm/*/rdfs:label[contains(., ' manga')] or                                          preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2023026096' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2023026096' or                                                                                   preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026362' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026362' or                                          preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026005' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026005' or                                          preceding-sibling::bf:genreForm/@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017026130' or                                         preceding-sibling::bf:genreForm/*/@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017026130'                                       )                                       ">6</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vNoCLength">
                  <xsl:choose>
                    <xsl:when test="$v008Format='BK'">4</xsl:when>
                    <xsl:when test="$v008Format='CR'">3</xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="vNoCPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vNoC"/>
                    <!-- useful for testing. -->
                    <!-- <xsl:with-param name="pPadChar" select="'x'"/> -->
                    <xsl:with-param name="pStringLength">
                      <xsl:value-of select="$vNoCLength"/>
                    </xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:variable name="vNoCFinal">
                  <xsl:choose>
                    <xsl:when test="string-length($vNoCPadded) &gt; $vNoCLength">
                      <xsl:value-of select="substring($vNoCPadded,1,$vNoCLength)"/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="$vNoCPadded"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$v008Format='BK'">
                    <xsl:value-of select="$vNoCFinal"/>
                  </xsl:when>
                  <xsl:when test="$v008Format='CR'">
                    <xsl:value-of select="concat(' ',$vNoCFinal)"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='CF'">
                <xsl:choose>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/num' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/num' or */*[local-name()='code']='num']">
                    <xsl:text>  a </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/com' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/com' or */*[local-name()='code']='com']">
                    <xsl:text>  b </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/rep' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/rep' or */*[local-name()='code']='rep']">
                    <xsl:text>  c </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/doc' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/doc' or */*[local-name()='code']='doc']">
                    <xsl:text>  d </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/bda' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/bda' or */*[local-name()='code']='bda']">
                    <xsl:text>  e </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/fon' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/fon' or */*[local-name()='code']='fon']">
                    <xsl:text>  f </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/gam' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/gam' or */*[local-name()='code']='gam']">
                    <xsl:text>  g </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/sou' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/sou' or */*[local-name()='code']='sou']">
                    <xsl:text>  h </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/inm' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/inm' or */*[local-name()='code']='inm']">
                    <xsl:text>  i </xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/ons' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/ons' or */*[local-name()='code']='ons']">
                    <xsl:text>  j </xsl:text>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>  | </xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='MP'">
                <xsl:text> |  </xsl:text>
              </xsl:when>
              <xsl:when test="$v008Format='MU'">
                <xsl:value-of select="substring($vMUSupplContent,1,4)"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-6 != ''">
              <xsl:value-of select="$vPosition-6"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>    </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-7">
            <xsl:choose>
              <xsl:when test="$v008Format='BK' or                         $v008Format='CF' or                         $v008Format='MP' or                         $v008Format='CR' or                         $v008Format='VM'">
                <xsl:for-each select="bf:Work/bflc:governmentPubType">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:choose>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/a' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/a' or                               */*[local-name()='code']='a'">
                          <xsl:text>a</xsl:text>
                        </xsl:when>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/c' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/c' or                               */*[local-name()='code']='c'">
                          <xsl:text>c</xsl:text>
                        </xsl:when>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/f' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/f' or                               */*[local-name()='code']='f'">
                          <xsl:text>f</xsl:text>
                        </xsl:when>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/i' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/i' or                               */*[local-name()='code']='i'">
                          <xsl:text>i</xsl:text>
                        </xsl:when>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/l' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/l' or                               */*[local-name()='code']='l'">
                          <xsl:text>l</xsl:text>
                        </xsl:when>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/m' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/m' or                               */*[local-name()='code']='m'">
                          <xsl:text>m</xsl:text>
                        </xsl:when>
                        <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/mgovtpubtype/s' or                               */@rdf:about='http://id.loc.gov/vocabulary/mgovtpubtype/s' or                               */*[local-name()='code']='s'">
                          <xsl:text>s</xsl:text>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:text>o</xsl:text>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 008.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="$v008Format='MU'">
                <xsl:value-of select="substring($vMUSupplContent,5,1)"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-7 != ''">
              <xsl:value-of select="$vPosition-7"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text> </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-8">
            <xsl:choose>
              <xsl:when test="$v008Format='BK' or                         $v008Format='CR'">
                <xsl:choose>
                  <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026068' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026068']">
                    <xsl:text>1</xsl:text>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:text>0</xsl:text>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='MP' or $v008Format='VM'">
                <xsl:choose>
                  <xsl:when test="bf:Instance/bf:fontSize[@rdf:resource='http://id.loc.gov/vocabulary/mfont/lp'] or                             bf:Instance/bf:fontSize/*[@rdf:about='http://id.loc.gov/vocabulary/mfont/lp'] or                             bf:Instance/bf:fontSize/*[contains(rdfs:label,'large print')]">
                    <xsl:text>d</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mtactile/brail'] or                             bf:Instance/bf:notation/*[@rdf:about='http://id.loc.gov/vocabulary/mtactile/brail'] or                             bf:Instance/bf:notation/*[contains(rdfs:label,'braille')]">
                    <xsl:text>f</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hd'] or                             bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/hd'] or                             bf:Instance/bf:carrier/*/*[local-name()='code']='hd'">
                    <xsl:text>a</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/he'] or                             bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/he'] or                             bf:Instance/bf:carrier/*/*[local-name()='code']='he'">
                    <xsl:text>b</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/hg'] or                             bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/hg'] or                             bf:Instance/bf:carrier/*/*[local-name()='code']='hg'">
                    <xsl:text>c</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cr'] or                             bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/carriers/cr'] or                             bf:Instance/bf:carrier/*/*[local-name()='code']='cr'">
                    <xsl:text>o</xsl:text>
                  </xsl:when>
                  <xsl:when test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/carriers/cz' or                                                      */@rdf:about='http://id.loc.gov/vocabulary/carriers/cz' or                                                      */*[local-name()='code']='cz']">
                    <xsl:text>s</xsl:text>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="' '"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='MU'">
                <xsl:value-of select="substring($vMUSupplContent,6,1)"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-8 != ''">
              <xsl:value-of select="$vPosition-8"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text> </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-9">
            <xsl:choose>
              <xsl:when test="$v008Format='BK' or                         $v008Format='MP'">
                <xsl:variable name="v008-30">
                  <xsl:choose>
                    <xsl:when test="$v008Format='BK'">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026082' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026082']">1</xsl:when>
                        <xsl:otherwise>0</xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$v008Format='MP'">
                      <xsl:value-of select="' '"/>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="$v008-30"/>
                <xsl:variable name="v008-31">
                  <xsl:choose>
                    <xsl:when test="bf:Work/bf:supplementaryContent[@rdf:resource='http://id.loc.gov/vocabulary/msupplcont/index' or */@rdf:about='http://id.loc.gov/vocabulary/msupplcont/index']">1</xsl:when>
                    <xsl:when test="bf:Work/bf:supplementaryContent/*[contains(rdfs:label,'index')]">1</xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="'0'"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="$v008-31"/>
              </xsl:when>
              <xsl:when test="$v008Format='MU'">
                <xsl:variable name="vLitText">
                  <xsl:for-each select="bf:Work/bf:genreForm">
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026047' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026047'">a</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026049' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026049'">b</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026068' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026068'">c</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026297' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026297'">d</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026094' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026094'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026339' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026339'">f</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026113' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026113'">g</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/his' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/his'">h</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026114' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026114'">i</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/lan' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/lan'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026110' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026110'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026363' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026363'">l</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026047' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026047'">m</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026344' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026344'">o</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026481' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026481'">p</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/reh' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/reh'">r</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026594' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026594'">s</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026115' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026115'">t</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vLitTextPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vLitText"/>
                    <xsl:with-param name="pStringLength">2</xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vLitTextPadded) &gt; 2">
                    <xsl:value-of select="substring($vLitTextPadded,1,2)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vLitTextPadded"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:when test="$v008Format='CR' or $v008Format='VM'">
                <xsl:value-of select="' '"/>
                <xsl:value-of select="' '"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-9 != ''">
              <xsl:value-of select="$vPosition-9"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>||</xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text> </xsl:text>
          <xsl:variable name="vPosition-11">
            <xsl:choose>
              <xsl:when test="$v008Format='BK' or                         $v008Format='CR' or                         $v008Format='VM'">
                <xsl:variable name="v008-33">
                  <xsl:choose>
                    <xsl:when test="$v008Format='BK'">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026339' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026339']">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/madsrdf:authoritativeLabel[contains(., 'fiction') and not(contains(., 'onfiction'))]">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/rdfs:label[contains(., 'fiction') and not(contains(., 'onfiction'))]">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/madsrdf:authoritativeLabel[contains(., '(Fiction)')]">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2014026243'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2014026259'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2018026099'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2015026019'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2014026456'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2015026020'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2014026518'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2014026542'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm//@rdf:*[1]='http://id.loc.gov/authorities/genreForms/gf2014026559'">1</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026297' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026297']">d</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026094' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026094']">e</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2015026020' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2015026020']">f</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026110' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026110']">h</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/madsrdf:authoritativeLabel[contains(., 'Humor')]">h</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/rdfs:label[contains(., 'Humor')]">h</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026141' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026141']">i</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026054' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026054']">i</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026542' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026542']">j</xsl:when>
                        <!-- <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026339' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026339']">m</xsl:when> -->
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026488' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026488']">p</xsl:when>
                        <!-- Prose peoms. -->
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026481' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026481']">p</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/madsrdf:authoritativeLabel[contains(., 'poetry')]">p</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/rdfs:label[contains(., 'poetry')]">p</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026363' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026363']">s</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/madsrdf:authoritativeLabel[contains(., 'speeches')]">s</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm/*/rdfs:label[contains(., 'speeches')]">s</xsl:when>
                        <xsl:otherwise>0</xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$v008Format='CR'">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/a' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/a' or */*[local-name()='code']='a']">a</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/b' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/b' or */*[local-name()='code']='b']">b</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/c' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/c' or */*[local-name()='code']='c']">c</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/d' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/d' or */*[local-name()='code']='d']">d</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/e' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/e' or */*[local-name()='code']='e']">e</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/f' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/f' or */*[local-name()='code']='f']">f</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/g' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/g' or */*[local-name()='code']='g']">g</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/h' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/h' or */*[local-name()='code']='h']">h</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/i' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/i' or */*[local-name()='code']='i']">i</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/j' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/j' or */*[local-name()='code']='j']">j</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/k' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/k' or */*[local-name()='code']='k']">k</xsl:when>
                        <xsl:when test="bf:Work/bf:notation[@rdf:resource='http://id.loc.gov/vocabulary/mscript/l' or */@rdf:about='http://id.loc.gov/vocabulary/mscript/l' or */*[local-name()='code']='l']">l</xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="' '"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$v008Format='VM'">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027218' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027218']">a</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/kit' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/kit']">b</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/art' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/art']">c</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/dio' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/dio']">d</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/fls' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/fls']">f</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026158' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026158']">g</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027251' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027251']">i</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/gra' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/gra']">k</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/ted' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/ted']">l</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026406' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026406']">m</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/cha' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/cha']">n</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/fla' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/fla']">o</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/mic' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/mic']">p</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027245' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027245']">q</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/rea' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/rea']">r</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/sli' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/sli']">s</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/tra' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/tra']">t</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026723' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026723']">v</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/toy' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/toy']">w</xsl:when>
                        <xsl:otherwise>|</xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="$v008-33"/>
                <xsl:variable name="v008-34">
                  <xsl:choose>
                    <xsl:when test="$v008Format='BK'">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026047' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026047']">a</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026085' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026085']">a</xsl:when>
                        <xsl:when test="bf:Work/bf:note/bf:Note/rdfs:label[contains(., 'Contains biographical information')]">d</xsl:when>
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026049' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026049']">b</xsl:when>
                        <!-- Autobiographical comics -->
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026229' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026229']">a</xsl:when>
                        <!-- Biographical comics -->
                        <xsl:when test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026244' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026244']">b</xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="' '"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="$v008Format='CR'">
                      <xsl:for-each select="$vAdminMetadata/bf:note/*[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/metaentry']">
                        <xsl:if test="position()=1">
                          <xsl:choose>
                            <xsl:when test="contains(translate(rdfs:label,$upper,$lower),'successive')">0</xsl:when>
                            <xsl:when test="contains(translate(rdfs:label,$upper,$lower),'latest')">1</xsl:when>
                            <xsl:when test="contains(translate(rdfs:label,$upper,$lower),'integrated')">2</xsl:when>
                            <xsl:otherwise>
                              <xsl:value-of select="' '"/>
                            </xsl:otherwise>
                          </xsl:choose>
                        </xsl:if>
                      </xsl:for-each>
                      <xsl:if test="not($vAdminMetadata/bf:note/*[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/metaentry'])">|</xsl:if>
                    </xsl:when>
                    <xsl:when test="$v008Format='VM'">
                      <xsl:choose>
                        <xsl:when test="bf:Work/bflc:movingImageTechnique[@rdf:resource='http://id.loc.gov/vocabulary/mtechnique/anim' or */@rdf:about='http://id.loc.gov/vocabulary/mtechnique/anim']">a</xsl:when>
                        <xsl:when test="bf:Work/bflc:movingImageTechnique[@rdf:resource='http://id.loc.gov/vocabulary/mtechnique/animlive' or */@rdf:about='http://id.loc.gov/vocabulary/mtechnique/animlive']">c</xsl:when>
                        <xsl:when test="bf:Work/bflc:movingImageTechnique[@rdf:resource='http://id.loc.gov/vocabulary/mtechnique/live' or */@rdf:about='http://id.loc.gov/vocabulary/mtechnique/live']">l</xsl:when>
                        <xsl:when test="bf:Work/bflc:movingImageTechnique[@rdf:resource='http://id.loc.gov/vocabulary/mtechnique/other' or */@rdf:about='http://id.loc.gov/vocabulary/mtechnique/other']">z</xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="' '"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:when>
                  </xsl:choose>
                </xsl:variable>
                <xsl:value-of select="$v008-34"/>
              </xsl:when>
              <xsl:when test="$v008Format='MP'">
                <xsl:variable name="vSpecFormat">
                  <xsl:for-each select="bf:Work/bf:genreForm">
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026385' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026385'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026151' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026151'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026055' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026055'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026158' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026158'">l</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026728' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026728'">o</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2017027252' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2017027252'">o</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026373' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026373'">o</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vSpecFormatPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vSpecFormat"/>
                    <xsl:with-param name="pStringLength">2</xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vSpecFormatPadded) &gt; 2">
                    <xsl:value-of select="substring($vSpecFormatPadded,1,2)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vSpecFormatPadded"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-11 != ''">
              <xsl:value-of select="$vPosition-11"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>| </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:variable name="vPosition-12">
            <xsl:for-each select="bf:Work/bf:language[@rdf:resource]|bf:Work/bf:language[*/@rdf:about]|bf:Work/bf:language[*/*[local-name()='code']]">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:choose>
                    <xsl:when test="*/*[local-name()='code']">
                      <xsl:choose>
                        <xsl:when test="string-length(*/*[local-name()='code']) = 3">
                          <xsl:value-of select="*/*[local-name()='code']"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:when>
                    <xsl:when test="*[starts-with(@rdf:about,'http://id.loc.gov/vocabulary/languages/')] or starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                      <xsl:variable name="vCode">
                        <xsl:choose>
                          <xsl:when test="*[starts-with(@rdf:about,'http://id.loc.gov/vocabulary/languages/')]">
                            <xsl:value-of select="substring-after(*/@rdf:about,'http://id.loc.gov/vocabulary/languages/')"/>
                          </xsl:when>
                          <xsl:when test="starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                            <xsl:value-of select="substring-after(@rdf:resource,'http://id.loc.gov/vocabulary/languages/')"/>
                          </xsl:when>
                        </xsl:choose>
                      </xsl:variable>
                      <xsl:if test="string-length($vCode)=3">
                        <xsl:value-of select="$vCode"/>
                      </xsl:if>
                    </xsl:when>
                  </xsl:choose>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 008.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-12 != ''">
              <xsl:value-of select="$vPosition-12"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text>   </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:text> </xsl:text>
          <xsl:variable name="vPosition-14">
            <xsl:choose>
              <xsl:when test="contains($vAdminMetadata[bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/n']]/bf:agent//@rdf:*[1], '/dlc')">
                <xsl:value-of select="' '"/>
              </xsl:when>
              <xsl:when test="contains($vAdminMetadata/bf:descriptionAuthentication//@rdf:*[1], '/pcc')">
                <xsl:text>c</xsl:text>
              </xsl:when>
              <xsl:when test="contains($vAdminMetadata/bf:descriptionAuthentication//@rdf:*[1], '/lccopycat')">
                <xsl:text>d</xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vPosition-14 != ''">
              <xsl:value-of select="$vPosition-14"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:text> </xsl:text>
            </xsl:otherwise>
          </xsl:choose>
        </marc:controlfield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (008).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[         (local-name()='Lccn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']) and         not(           bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or           bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/cancinv' or           bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/cancinv'         )]" mode="generate-010">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vLccnValue" select="rdf:value"/>
    <xsl:variable name="vLccn">
      <xsl:choose>
        <xsl:when test="string-length($vLccnValue) = 10">
          <xsl:call-template name="tPadLeft">
            <xsl:with-param name="pInput" select="$vLccnValue"/>
            <!-- useful for testing. -->
            <xsl:with-param name="pPadChar" select="' '"/>
            <xsl:with-param name="pStringLength">12</xsl:with-param>
          </xsl:call-template>
        </xsl:when>
        <xsl:when test="string-length($vLccnValue) &lt; 10">
          <xsl:variable name="vLccnPart1">
            <xsl:call-template name="tPadLeft">
              <xsl:with-param name="pInput" select="$vLccnValue"/>
              <!-- useful for testing. -->
              <xsl:with-param name="pPadChar" select="' '"/>
              <xsl:with-param name="pStringLength">11</xsl:with-param>
            </xsl:call-template>
          </xsl:variable>
          <xsl:value-of select="concat($vLccnPart1, ' ')"/>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$vLccnValue"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <marc:datafield>
          <xsl:attribute name="tag">010</xsl:attribute>
          <xsl:attribute name="xml:space">preserve</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:variable name="v010-a">
            <xsl:value-of select="$vLccn"/>
          </xsl:variable>
          <xsl:if test="$v010-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v010-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:for-each select="ancestor::bf:Instance/bf:identifiedBy/*[             (local-name()='Lccn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn']) and             (               bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or               bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/cancinv' or               bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/cancinv'             )]/rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (010).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='Nbn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Nbn']]" mode="generate-015">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="bf:source/@rdf:resource">
          <xsl:value-of select="bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">015</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="bf:source/bf:Source/*[local-name()='code']">
          <xsl:variable name="v015-2">
            <xsl:value-of select="bf:source/bf:Source/*[local-name()='code'][1]"/>
          </xsl:variable>
          <xsl:if test="$v015-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$v015-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="$vSourceUri != ''">
          <xsl:variable name="v015-2">
            <xsl:choose>
              <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="$vSourceUri"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="$vSourceUri"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v015-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$v015-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/bf:Local[bf:source]|bf:Instance/bf:adminMetadata/bf:AdminMetadata/bf:identifiedBy/bf:Local[bf:source//@rdf:*[.='http://id.loc.gov/authorities/names/no2004037399']]" mode="generate-016">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="bf:source/@rdf:resource">
          <xsl:value-of select="bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vLAC">
      <xsl:choose>
        <xsl:when test="$vSourceUri='http://id.loc.gov/authorities/names/no2004037399' or                       bf:source/bf:Source/rdfs:label='OONL' or                       bf:source/bf:Source/rdfs:label='Library and Archives Canada'">
          <xsl:text>true</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">016</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="$vLAC!='true'">
              <xsl:text>7</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 016 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="not($vLAC='true')">
          <xsl:choose>
            <xsl:when test="bf:source/bf:Source/*[local-name()='code']">
              <xsl:variable name="v016-2">
                <xsl:value-of select="bf:source/bf:Source/*[local-name()='code'][1]"/>
              </xsl:variable>
              <xsl:if test="$v016-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v016-2"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
            <xsl:when test="$vSourceUri != ''">
              <xsl:variable name="v016-2">
                <xsl:choose>
                  <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                    <xsl:variable name="vC">
                      <xsl:call-template name="tUriCode">
                        <xsl:with-param name="pUri" select="$vSourceUri"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:value-of select="translate($vC, $lower, $upper)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vSourceUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$v016-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$v016-2"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='CopyrightNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/CopyrightNumber']]" mode="generate-017">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">017</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:assigner/bf:*/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 017 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:date">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="d">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 017 $d.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="i">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 017 $i.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[(local-name()='Isbn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']) and rdf:value/text()]" mode="generate-020">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">020</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or                     bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 020 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:acquisitionTerms">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="c">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 020 $c.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:qualifier">
        <marc:subfield code="q">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:identifiedBy/*[(local-name()='Issn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']) and rdf:value/text()] |        bf:Instance/bf:identifiedBy/*[(local-name()='Issn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']) and rdf:value/text()]" mode="generate-022">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">022</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or                     bf:status/bf:Status/rdfs:label[text()='canceled'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="bf:status/bf:Status/rdfs:label[text()='incorrect'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/incorrect' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/incorrect'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="y">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 022 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:assigner/bf:Agent/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 022 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:identifiedBy/*[(local-name()='IssnL' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/IssnL']) and rdf:value/text()] |        bf:Instance/bf:identifiedBy/*[(local-name()='IssnL' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/IssnL']) and rdf:value/text()]" mode="generate-023">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">023</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text>0</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or           bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or           bf:status/bf:Status/rdfs:label[text()='canceled'] or           bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or           bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="bf:status/bf:Status/rdfs:label[text()='incorrect'] or           bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/incorrect' or           bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/incorrect'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="y">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 023 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:assigner/bf:Agent/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 023 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='Isrc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isrc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Upc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Upc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Ismn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ismn']] |       bf:Instance/bf:identifiedBy/*[local-name()='Ean' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ean']] |       bf:Instance/bf:identifiedBy/*[local-name()='Sici' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Sici']] |       bf:Instance/bf:identifiedBy/*[local-name()='Ansi' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ansi']] |       bf:Instance/bf:identifiedBy/*[local-name()='Doi' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Doi']] |       bf:Work/bf:identifiedBy/*[local-name()='Eidr' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/Eidr'] or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Eidr']] |       bf:Instance/bf:identifiedBy/*[local-name()='Gtin14Number' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Gtin14Number']] |       bf:Instance/bf:identifiedBy/*[local-name()='Hdl' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hdl']] |       bf:Instance/bf:identifiedBy/*[local-name()='Isan' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isan']] |       bf:Instance/bf:identifiedBy/*[local-name()='Isni' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isni']] |       bf:Instance/bf:identifiedBy/*[local-name()='Iso' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Iso']] |       bf:Instance/bf:identifiedBy/*[local-name()='Istc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Istc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Iswc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Iswc']] |       bf:Instance/bf:identifiedBy/*[local-name()='Urn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Urn']] |       bf:Instance/bf:identifiedBy/bf:Identifier[not(rdf:type or bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dgpo' or bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dgpo')]" mode="generate-024">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">024</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name()='Isrc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isrc']">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Upc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Upc']">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Ismn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ismn']">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Ean' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ean']">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Sici' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Sici']">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='Identifier' and not(rdf:type) and not(rdfs:label) and not (bf:source)">
              <xsl:text>8</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>7</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or                     bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 024 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:acquisitionTerms">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="c">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 024 $c.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:qualifier">
        <marc:subfield code="q">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:variable name="v024-2">
        <xsl:choose>
          <xsl:when test="local-name()='Ansi' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Ansi']">
            <xsl:text>ansi</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Doi' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Doi']">
            <xsl:text>doi</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Eidr' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/Eidr'] or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Eidr']">
            <xsl:text>eidr</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Hdl' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Hdl']">
            <xsl:text>hdl</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Gtin14Number' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Gtin14Number']">
            <xsl:text>gtin-14</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Isan' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isan']">
            <xsl:text>isan</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Isni' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isni']">
            <xsl:text>isni</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Iso' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Iso']">
            <xsl:text>iso</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Istc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Istc']">
            <xsl:text>istc</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Iswc' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Iswc']">
            <xsl:text>iswc</xsl:text>
          </xsl:when>
          <xsl:when test="local-name()='Urn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Urn']">
            <xsl:text>urn</xsl:text>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 024 $2.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v024-2 != ''">
        <marc:subfield code="2">
          <xsl:value-of select="$v024-2"/>
        </marc:subfield>
      </xsl:if>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='LcOverseasAcq' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/LcOverseasAcq']] |                     //bf:Item/bf:identifiedBy/*[local-name()='LcOverseasAcq' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/LcOverseasAcq']]" mode="generate-025">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">025</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdf:value">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='Fingerprint' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Fingerprint']]|                     //bf:Item/bf:identifiedBy/*[local-name()='Fingerprint' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Fingerprint']]" mode="generate-026">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="bf:source/@rdf:resource">
          <xsl:value-of select="bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">026</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="e">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 026 $e.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:source/bf:Source/*[local-name()='code']">
          <xsl:variable name="v026-2">
            <xsl:value-of select="bf:source/bf:Source/*[local-name()='code'][1]"/>
          </xsl:variable>
          <xsl:if test="$v026-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$v026-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="$vSourceUri != ''">
          <xsl:variable name="v026-2">
            <xsl:choose>
              <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="$vSourceUri"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="$vSourceUri"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v026-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$v026-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
        <marc:subfield code="5">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='Strn' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Strn']]" mode="generate-027">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">027</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or                     bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 027 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:qualifier">
        <marc:subfield code="q">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[(local-name()='AudioIssueNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AudioIssueNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MatrixNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MatrixNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MusicPlate' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicPlate']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MusicPublisherNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicPublisherNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='VideoRecordingNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VideoRecordingNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='PublisherNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/PublisherNumber']) and rdf:value/text()] |           bf:Instance/bf:identifiedBy/*[(local-name()='MusicDistributorNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicDistributorNumber']) and rdf:value/text()]" mode="generate-028">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">028</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name()='AudioIssueNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AudioIssueNumber']">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='MatrixNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MatrixNumber']">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='MusicPlate' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicPlate']">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='MusicPublisherNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicPublisherNumber']">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='VideoRecordingNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VideoRecordingNumber']">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="local-name()='MusicDistributorNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MusicDistributorNumber']">
              <xsl:text>6</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>5</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text>2</xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 028 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:assigner/bf:*/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 028 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:qualifier">
        <marc:subfield code="q">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='Coden' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Coden']]" mode="generate-030">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">030</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or                     bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 030 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='PostalRegistration' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/PostalRegistration']]" mode="generate-032">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">032</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 032 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:assigner/bf:*/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 032 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:capture/bf:Capture[bf:date[@rdf:datatype='http://id.loc.gov/datatypes/edtf'] or bf:place/@rdf:resource]" mode="generate-033">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="bf:source/@rdf:resource">
          <xsl:value-of select="bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">033</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="count(bf:date)=1">
              <xsl:choose>
                <xsl:when test="contains(bf:date,'/')">
                  <xsl:text>2</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>0</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:when>
            <xsl:when test="count(bf:date) &gt; 1">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:note/bf:Note[rdfs:label='capture']">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="bf:note/bf:Note[rdfs:label='broadcast']">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="bf:note/bf:Note[rdfs:label='finding']">
              <xsl:text>2</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 033 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="count(bf:date)=1">
          <xsl:choose>
            <xsl:when test="bf:date/@rdf:datatype='http://id.loc.gov/datatypes/edtf'">
              <xsl:choose>
                <xsl:when test="contains(bf:date,'/')">
                  <xsl:variable name="vDate1">
                    <xsl:variable name="vEDTFDate1">
                      <xsl:call-template name="EDTF-Date1">
                        <xsl:with-param name="pEDTFDate" select="bf:date"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:call-template name="EDTF-to-033">
                      <xsl:with-param name="pEDTFDate" select="$vEDTFDate1"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:variable name="vDate2">
                    <xsl:variable name="vEDTFDate2">
                      <xsl:call-template name="EDTF-Date2">
                        <xsl:with-param name="pEDTFDate" select="bf:date"/>
                      </xsl:call-template>
                    </xsl:variable>
                    <xsl:call-template name="EDTF-to-033">
                      <xsl:with-param name="pEDTFDate" select="$vEDTFDate2"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <marc:subfield code="a">
                    <xsl:value-of select="$vDate1"/>
                  </marc:subfield>
                  <marc:subfield code="a">
                    <xsl:value-of select="$vDate2"/>
                  </marc:subfield>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:variable name="v033Date">
                    <xsl:call-template name="EDTF-to-033">
                      <xsl:with-param name="pEDTFDate" select="bf:date"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <marc:subfield code="a">
                    <xsl:value-of select="$v033Date"/>
                  </marc:subfield>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:when>
            <xsl:otherwise>
              <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:date node, value <xsl:value-of select="bf:date"/>. Unknown data type (must be EDTF)</xsl:message>
              <marc:subfield code="a">--------</marc:subfield>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:date">
            <xsl:choose>
              <xsl:when test="@rdf:datatype='http://id.loc.gov/datatypes/edtf'">
                <xsl:choose>
                  <xsl:when test="contains(.,'/')">
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:date node, value <xsl:value-of select="."/>. Range of EDTF dates detected where only single value allowed.</xsl:message>
                    <marc:subfield code="a">--------</marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:variable name="v033Date">
                      <xsl:call-template name="EDTF-to-033">
                        <xsl:with-param name="pEDTFDate" select="."/>
                      </xsl:call-template>
                    </xsl:variable>
                    <marc:subfield code="a">
                      <xsl:value-of select="$v033Date"/>
                    </marc:subfield>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:date node, value <xsl:value-of select="."/>. Unknown data type (must be EDTF)</xsl:message>
                <marc:subfield code="a">--------</marc:subfield>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:place">
        <xsl:variable name="vPlaceUri" select="@rdf:resource|bf:Place/@rdf:about"/>
        <xsl:choose>
          <xsl:when test="starts-with($vPlaceUri,'http://id.loc.gov/authorities/classification/G')">
            <xsl:variable name="vPlaceCode">
              <xsl:call-template name="tUriCode">
                <xsl:with-param name="pUri" select="$vPlaceUri"/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="contains($vPlaceCode,'.')">
                <marc:subfield code="b">
                  <xsl:value-of select="substring-before($vPlaceCode,'.')"/>
                </marc:subfield>
                <marc:subfield code="c">
                  <xsl:value-of select="substring-after($vPlaceCode,'.')"/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <marc:subfield code="b">
                  <xsl:value-of select="$vPlaceCode"/>
                </marc:subfield>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:when>
          <xsl:otherwise>
            <xsl:if test="bf:Place/rdf:value or bf:Place/rdfs:label">
              <marc:subfield code="p">
                <xsl:choose>
                  <xsl:when test="bf:Place/rdf:value">
                    <xsl:value-of select="bf:Place/rdf:value"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:Place/rdfs:label"/>
                    </xsl:call-template>
                  </xsl:otherwise>
                </xsl:choose>
              </marc:subfield>
            </xsl:if>
            <xsl:choose>
              <xsl:when test="bf:Place/bf:source/bf:Source/*[local-name()='code']">
                <xsl:variable name="v033-2">
                  <xsl:value-of select="bf:Place/bf:source/bf:Source/*[local-name()='code'][1]"/>
                </xsl:variable>
                <xsl:if test="$v033-2 != ''">
                  <marc:subfield code="2">
                    <xsl:value-of select="$v033-2"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
              <xsl:when test="$vSourceUri != ''">
                <xsl:variable name="v033-2">
                  <xsl:choose>
                    <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                      <xsl:call-template name="tUriCode">
                        <xsl:with-param name="pUri" select="$vSourceUri"/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="$vSourceUri"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:if test="$v033-2 != ''">
                  <marc:subfield code="2">
                    <xsl:value-of select="$v033-2"/>
                  </marc:subfield>
                </xsl:if>
              </xsl:when>
            </xsl:choose>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:scale/bf:Scale[starts-with(rdfs:label,'linear') or starts-with(rdfs:label,'angular')]" mode="generate-034">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">034</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text>1</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v034-a">
        <xsl:choose>
          <xsl:when test="starts-with(rdfs:label,'linear')">
            <xsl:text>a</xsl:text>
          </xsl:when>
          <xsl:when test="starts-with(rdfs:label,'angular')">
            <xsl:text>b</xsl:text>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v034-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v034-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="rdfs:label='linear horizontal'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="rdfs:label='linear vertical'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="c">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[(local-name()='Local' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local']) and bf:assigner]" mode="generate-035">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vAssignerUri">
      <xsl:choose>
        <xsl:when test="bf:assigner/@rdf:resource">
          <xsl:value-of select="bf:assigner/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:assigner/*/@rdf:about">
          <xsl:value-of select="bf:assigner/*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vAssignerCode">
      <xsl:choose>
        <xsl:when test="bf:assigner/*/*[local-name()='code']">
          <xsl:value-of select="bf:assigner/*/*[local-name()='code'][1]"/>
        </xsl:when>
        <xsl:when test="$vAssignerUri != ''">
          <xsl:choose>
            <xsl:when test="contains($vAssignerUri,'id.loc.gov')">
              <xsl:call-template name="tUriCode">
                <xsl:with-param name="pUri" select="$vAssignerUri"/>
              </xsl:call-template>
            </xsl:when>
            <xsl:when test="contains($vAssignerUri,'ld.zdb-services.de')">
              <xsl:call-template name="tUriCode">
                <xsl:with-param name="pUri" select="$vAssignerUri"/>
              </xsl:call-template>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="$vAssignerUri"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vAssignerString">
      <xsl:choose>
        <xsl:when test="$vAssignerCode != ''">
          <xsl:value-of select="concat('(',$vAssignerCode,')')"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">035</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or                     bf:status/bf:Status/rdfs:label[text()='invalid'] or                     bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:variable name="v035-z">
            <xsl:value-of select="concat($vAssignerString,rdf:value)"/>
          </xsl:variable>
          <xsl:if test="$v035-z != ''">
            <marc:subfield code="z">
              <xsl:value-of select="$v035-z"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:otherwise>
          <xsl:variable name="v035-a">
            <xsl:value-of select="concat($vAssignerString,rdf:value)"/>
          </xsl:variable>
          <xsl:if test="$v035-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v035-a"/>
            </marc:subfield>
          </xsl:if>
        </xsl:otherwise>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[(local-name()='OclcNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/OclcNumber']) and rdf:value]" mode="generate-035">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">035</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1]='http://id.loc.gov/vocabulary/mstatus/cancinv' or           bf:status/bf:Status/rdfs:label[text()='canceled or invalid'] or           bf:status/bf:Status/rdfs:label[text()='invalid'] or           bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/invalid' or           bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/invalid'">
          <xsl:variable name="v035-z">
            <xsl:value-of select="concat('(OCoLC)',rdf:value)"/>
          </xsl:variable>
          <xsl:if test="$v035-z != ''">
            <marc:subfield code="z">
              <xsl:value-of select="$v035-z"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:otherwise>
          <xsl:variable name="v035-a">
            <xsl:value-of select="concat('(OCoLC)',rdf:value)"/>
          </xsl:variable>
          <xsl:if test="$v035-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v035-a"/>
            </marc:subfield>
          </xsl:if>
        </xsl:otherwise>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='StudyNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/StudyNumber']]" mode="generate-036">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <marc:datafield>
          <xsl:attribute name="tag">036</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 036 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:assigner/bf:*/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="b">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 036 $b.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (036).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:acquisitionSource/bf:AcquisitionSource |                     //bf:Item/bf:acquisitionSource/bf:AcquisitionSource" mode="generate-037">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">037</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:note/bf:Note/rdfs:label[text()='intervening source']">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="bf:note/bf:Note/rdfs:label[text()='current source']">
              <xsl:text>3</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 037 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/*[local-name()='StockNumber' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/StudyNumber']]/rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 037 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:variable name="v037-b">
        <xsl:choose>
          <xsl:when test="rdfs:label">
            <xsl:for-each select="rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 037 $b.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bf:source/bf:Source/rdfs:label">
            <xsl:for-each select="bf:source/bf:Source/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 037 $b.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v037-b != ''">
        <marc:subfield code="b">
          <xsl:value-of select="$v037-b"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:acquisitionTerms">
        <marc:subfield code="c">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label[text() != 'intervening source' and text() != 'current source']">
        <marc:subfield code="n">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
        <marc:subfield code="5">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:geographicCoverage[                       contains(@rdf:resource,'id.loc.gov/vocabulary/geographicAreas') or                       contains(bf:GeographicCoverage/@rdf:about,'id.loc.gov/vocabulary/geographicAreas') or                        bf:GeographicCoverage/madsrdf:code or                       bf:GeographicCoverage/bf:code or                       madsrdf:Geographic/madsrdf:code or                        bf:GeographicCoverage/rdf:value]" mode="generate-043">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vUri">
      <xsl:choose>
        <xsl:when test="@rdf:resource">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="*/@rdf:about">
          <xsl:value-of select="*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">043</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="*/bf:code">
          <xsl:for-each select="*/bf:code">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="*/@rdf:about">
              <xsl:variable name="v043-0">
                <xsl:value-of select="*/@rdf:about"/>
              </xsl:variable>
              <xsl:if test="$v043-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v043-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="*/madsrdf:code">
          <xsl:for-each select="*/madsrdf:code">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="*/@rdf:about">
              <xsl:variable name="v043-0">
                <xsl:value-of select="*/@rdf:about"/>
              </xsl:variable>
              <xsl:if test="$v043-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v043-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="starts-with($vUri,'http://id.loc.gov/vocabulary/geographicAreas/')">
          <xsl:variable name="v043-a">
            <xsl:call-template name="tPadRight">
              <xsl:with-param name="pInput" select="substring-after($vUri,'http://id.loc.gov/vocabulary/geographicAreas/')"/>
              <xsl:with-param name="pPadChar" select="'-'"/>
              <xsl:with-param name="pStringLength" select="7"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:if test="$v043-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v043-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:variable name="v043-0">
            <xsl:value-of select="$vUri"/>
          </xsl:variable>
          <xsl:if test="$v043-0 != ''">
            <marc:subfield code="0">
              <xsl:value-of select="$v043-0"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="bf:GeographicCoverage/bf:source/bf:Source/bf:code='ISO 3166'">
          <xsl:for-each select="bf:GeographicCoverage/rdf:value">
            <marc:subfield code="c">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="$vUri != ''">
              <xsl:variable name="v043-0">
                <xsl:value-of select="$vUri"/>
              </xsl:variable>
              <xsl:if test="$v043-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v043-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:GeographicCoverage/rdf:value">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="$vUri != ''">
              <xsl:variable name="v043-0">
                <xsl:value-of select="$vUri"/>
              </xsl:variable>
              <xsl:if test="$v043-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v043-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bf:GeographicCoverage/bf:source/bf:Source/bf:code">
            <marc:subfield code="2">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/*[bf:classificationPortion/text() and (local-name()='ClassificationLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationLcc') and not(bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399' or */rdf:about='http://id.loc.gov/authorities/names/no2004037399' or */rdfs:label='Library and Archives Canada'])]" mode="generate-050">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">050</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/uba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/uba']             ">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="             bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/nuba'] or              bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/nuba']             ">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="//bf:Item/bf:heldBy/*[@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc' or *[local-name()='label']='United States, Library of Congress' or *[local-name()='code']='DLC'] or                       //bf:Item/bf:heldBy/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc'">
              <xsl:text>0</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc' or                       bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc' or                       bf:assigner/*/*[local-name()='code']='DLC'">
              <xsl:text>0</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>4</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 050 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:identifier/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="//bf:Item/bf:classification/*[bf:classificationPortion/text() and (local-name()='ClassificationLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationLcc') and not(bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399' or */rdf:about='http://id.loc.gov/authorities/names/no2004037399' or */rdfs:label='Library and Archives Canada'])]" mode="generate-051">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">051</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 051 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="c">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 051 $c.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:geographicCoverage[contains(@rdf:resource,'id.loc.gov/authorities/classification/G') or                contains(bf:GeographicCoverage/@rdf:about,'id.loc.gov/authorities/classification/G')]" mode="generate-052">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vUri">
      <xsl:choose>
        <xsl:when test="@rdf:resource">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="*/@rdf:about">
          <xsl:value-of select="*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="v052Code">
      <xsl:call-template name="tUriCode">
        <xsl:with-param name="pUri" select="$vUri"/>
      </xsl:call-template>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">052</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v052-a">
        <xsl:choose>
          <xsl:when test="contains($v052Code,'.')">
            <xsl:value-of select="substring-after(substring-before($v052Code,'.'),'G')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="substring-after($v052Code,'G')"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v052-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v052-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="contains($v052Code,'.')">
          <xsl:variable name="v052-b">
            <xsl:value-of select="substring-after($v052Code,'.')"/>
          </xsl:variable>
          <xsl:if test="$v052-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v052-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/*[(local-name()='ClassificationLcc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationLcc') and bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399' or */@rdf:about='http://id.loc.gov/authorities/names/no2004037399' or */rdfs:label='Library and Archives Canada']]" mode="generate-055">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">055</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="             (               bf:assigner/*[@rdf:about='http://id.loc.gov/authorities/names/no2004037399'] or                bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399']             ) and (               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/uba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/uba']             )             ">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="             (               bf:assigner/*[@rdf:about='http://id.loc.gov/authorities/names/no2004037399'] or                bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399']             ) and (               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/nuba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/nuba']             )             ">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="             bf:assigner/*[@rdf:about='http://id.loc.gov/authorities/names/no2004037399'] or              bf:assigner[@rdf:resource='http://id.loc.gov/authorities/names/no2004037399']             ">
              <xsl:text>0</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 055 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 055 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about[not(contains(.,'example.org'))]">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/*[local-name()='ClassificationNlm' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationNlm']" mode="generate-060">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">060</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="             (               bf:assigner/*[@rdf:about='http://id.loc.gov/vocabulary/organizations/dnlm'] or                bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnlm']             ) and (               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/uba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/uba']             )             ">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="             (               bf:assigner/*[@rdf:about='http://id.loc.gov/vocabulary/organizations/dnlm'] or                bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnlm']             ) and (               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/nuba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/nuba']             )             ">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnlm' or */@rdf:about='http://id.loc.gov/vocabulary/organizations/dnlm']">
              <xsl:text>0</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>4</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 060 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about[not(contains(.,'example.org'))]">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/bf:ClassificationNal|bf:Work/bf:classification/bf:Classification[bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnal' or                     bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dnal']" mode="generate-070">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">070</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="             (               bf:assigner/*[@rdf:about='http://id.loc.gov/vocabulary/organizations/dnal'] or                bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnal']             ) and (               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/uba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/uba']             )             ">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="             (               bf:assigner/*[@rdf:about='http://id.loc.gov/vocabulary/organizations/dnal'] or                bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dnal']             ) and (               bf:status/bf:Status[@rdf:about='http://id.loc.gov/vocabulary/mstatus/nuba'] or                bf:status[@rdf:resource='http://id.loc.gov/vocabulary/mstatus/nuba']             )             ">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 070 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:subject/bf:Topic[bf:code[not(@rdf:datatype) or @rdf:datatype!='http://id.loc.gov/datatypes/codes/gac'] or madsrdf:code[not(@rdf:datatype) or @rdf:datatype!='http://id.loc.gov/datatypes/codes/gac']]" mode="generate-072">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">072</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/classSchemes/agricola' or                       */@rdf:about='http://id.loc.gov/vocabulary/classSchemes/agricola' or                       */*[local-name()='code'] = 'agricola']">
              <xsl:text>0</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>7</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="*[local-name()='code']">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:choose>
                <xsl:when test="contains(.,' ')">
                  <xsl:value-of select="substring-before(.,' ')"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="."/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 072 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="contains(*[local-name()='code'][1],' ')">
          <xsl:call-template name="tToken2Subfields">
            <xsl:with-param name="pString" select="substring-after(*[local-name()='code'][1],' ')"/>
            <xsl:with-param name="pSubfieldCode" select="'x'"/>
            <xsl:with-param name="pSeparator" select="' '"/>
          </xsl:call-template>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bf:source[not(@rdf:resource='http://id.loc.gov/vocabulary/classSchemes/agricola' or                        bf:Source/@rdf:about='http://id.loc.gov/vocabulary/classSchemes/agricola' or                        bf:Source/*[local-name()='code'] = 'agricola')]">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:choose>
                <xsl:when test="contains(@rdf:resource,'bisacsh') or                         contains(bf:Source/@rdf:about,'bisacsh')">
                  <xsl:text>bisacsh</xsl:text>
                </xsl:when>
                <xsl:when test="bf:Source/*[local-name()='code']">
                  <xsl:for-each select="bf:Source/*[local-name()='code']">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 072 $2.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:when test="@rdf:resource">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="bf:Source/@rdf:about">
                  <xsl:value-of select="bf:Source/@rdf:about"/>
                </xsl:when>
                <xsl:when test="bf:Source/rdfs:label">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="bf:Source/rdfs:label"/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>Unable to determine source</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 072 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dgpo' or bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dgpo']" mode="generate-074">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">074</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     translate(bf:status/bf:Status/rdfs:label,$upper,$lower)='canceled or invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 074 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/*[(local-name()='ClassificationUdc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationUdc') and bf:classificationPortion/text()]" mode="generate-080">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">080</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:edition = 'full'">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="bf:edition = 'abridged'">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 080 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="not(bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc' or */@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc'])">
          <xsl:for-each select="bf:assigner/bf:Agent/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="q">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 080 $q.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 080 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/*[(local-name()='ClassificationDdc' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ClassificationDdc') and bf:classificationPortion/text()]" mode="generate-082">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">082</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:edition = 'full'">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="bf:edition = 'abridged'">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>7</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:assigner/@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc' or                       bf:assigner/*/@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc' or                       //bf:Item/bf:heldBy[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc']">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="bf:assigner">
              <xsl:text>4</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>4</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 082 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="not(bf:assigner[@rdf:resource='http://id.loc.gov/vocabulary/organizations/dlc' or */@rdf:about='http://id.loc.gov/vocabulary/organizations/dlc'])">
          <xsl:for-each select="bf:assigner/bf:Agent/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="q">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 082 $q.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bf:source">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:choose>
                <xsl:when test="starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/classSchemes/ddc')">
                  <xsl:value-of select="substring-after(@rdf:resource,'http://id.loc.gov/vocabulary/classSchemes/ddc')"/>
                </xsl:when>
                <xsl:when test="starts-with(*/@rdf:about,'http://id.loc.gov/vocabulary/classSchemes/ddc')">
                  <xsl:value-of select="substring-after(*/@rdf:about,'http://id.loc.gov/vocabulary/classSchemes/ddc')"/>
                </xsl:when>
                <xsl:when test="rdfs:Resource/rdfs:label">
                  <xsl:value-of select="rdfs:Resource/rdfs:label"/>
                </xsl:when>
                <xsl:when test="bf:Source/rdfs:label">
                  <xsl:value-of select="bf:Source/rdfs:label"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="*/*[local-name()='code']"/>
                  </xsl:call-template>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 082 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/bf:Classification[not(                                                                       rdf:type or                                                                        bf:assigner//@rdf:*[contains(., 'dnal')] or                                                                        bf:source//@rdf:*[contains(., 'sudocs')] or                                                                        bf:source//@rdf:*[contains(., 'cacodoc')]                                                                 )]" mode="generate-084">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">084</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bf:classificationPortion">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:itemPortion">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 084 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:assigner">
        <marc:subfield code="q">
          <xsl:variable name="vUri">
            <xsl:choose>
              <xsl:when test="@rdf:resource">
                <xsl:value-of select="@rdf:resource"/>
              </xsl:when>
              <xsl:when test="*/@rdf:about">
                <xsl:value-of select="*/@rdf:about"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:variable name="vAssignerCode">
            <xsl:call-template name="tUriCode">
              <xsl:with-param name="pUri" select="$vUri"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vAssignerCode != ''">
              <xsl:value-of select="$vAssignerCode"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="*/rdfs:label"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="rdf:value/@rdf:resource">
              <xsl:value-of select="rdf:value/@rdf:resource"/>
            </xsl:when>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 084 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="//bf:Item/bf:shelfMark/bf:ShelfMark[not(rdf:type)]" mode="generate-084">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">084</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:assigner">
        <marc:subfield code="q">
          <xsl:choose>
            <xsl:when test="@rdf:resource">
              <xsl:call-template name="tUriCode">
                <xsl:with-param name="pUri" select="@rdf:resource"/>
              </xsl:call-template>
            </xsl:when>
            <xsl:when test="*/@rdf:about">
              <xsl:call-template name="tUriCode">
                <xsl:with-param name="pUri" select="*/@rdf:about"/>
              </xsl:call-template>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="*/rdfs:label"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 084 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:classification/bf:Classification[bf:source//@rdf:*[contains(., 'sudocs') or contains(., 'cacodoc')]]" mode="generate-086">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">086</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:source/@rdf:resource='http://id.loc.gov/vocabulary/classSchemes/sudocs' or bf:source/*/@rdf:about='http://id.loc.gov/vocabulary/classSchemes/sudocs'">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="bf:source/@rdf:resource='http://id.loc.gov/vocabulary/classSchemes/cacodoc' or bf:source/*/@rdf:about='http://id.loc.gov/vocabulary/classSchemes/cacodoc'">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     translate(bf:status/bf:Status/rdfs:label,$upper,$lower)='invalid'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 086 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="not(bf:source[@rdf:resource='http://id.loc.gov/vocabulary/classSchemes/sudocs' or */@rdf:about='http://id.loc.gov/vocabulary/classSchemes/sudocs' or @rdf:resource='http://id.loc.gov/vocabulary/classSchemes/cacdoc' or */@rdf:about='http://id.loc.gov/vocabulary/classSchemes/cacdoc'])">
          <xsl:for-each select="bf:source/bf:Source/bf:code">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="2">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 086 $2.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:identifiedBy/*[local-name()='ReportNumber' or rdf:type='http://id.loc.gov/ontologies/bibframe/ReportNumber']" mode="generate-088">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">088</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/cancinv' or                     translate(bf:status/bf:Status/rdfs:label,$upper,$lower)='invalid'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="z">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 088 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent[@rdf:resource]|       bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/bf:*[not(bflc:marcKey)] |       bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/madsrdf:*" mode="generate-vMainEntryTag">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="agentURI">
      <xsl:choose>
        <xsl:when test="contains(@rdf:resource,'id.loc.gov/authorities/names')">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:resource,'id.loc.gov/rwo/agents')">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'id.loc.gov/authorities/names')">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'id.loc.gov/rwo/agents')">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:resource,'d-nb.info/gnd/')">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'d-nb.info/gnd/')">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="tempAgent" select="self::node()/*[not(bflc:marcKey[starts-with(. , '4')])]"/>
    <xsl:variable name="vNameAuthPreNS">
      <xsl:call-template name="tGetRelResource">
        <xsl:with-param name="pRelUri" select="$agentURI"/>
        <xsl:with-param name="pContext" select="$tempAgent"/>
      </xsl:call-template>
    </xsl:variable>
    <xsl:variable name="vNameAuth" select="exsl:node-set($vNameAuthPreNS)"/>
    <xsl:variable name="vMainEntryTag">
      <xsl:choose>
        <xsl:when test="$vNameAuth//marc:datafield[@tag!='']">
          <xsl:choose>
            <xsl:when test="$vNameAuth//marc:datafield[@tag='100']">
              <xsl:text>100</xsl:text>
            </xsl:when>
            <xsl:when test="$vNameAuth//marc:datafield[@tag='110']">
              <xsl:text>110</xsl:text>
            </xsl:when>
            <xsl:when test="$vNameAuth//marc:datafield[@tag='111']">
              <xsl:text>111</xsl:text>
            </xsl:when>
            <xsl:when test="$vNameAuth//marc:datafield[@tag='151']">
              <xsl:text>110</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
        <xsl:when test="local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or                       local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                       local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
          <xsl:text>110</xsl:text>
        </xsl:when>
        <xsl:when test="local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or                       local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']">
          <xsl:text>111</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>100</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vAuthSubfields">
      <xsl:choose>
        <xsl:when test="$vMainEntryTag='100'">
          <xsl:text>abcdgjq</xsl:text>
        </xsl:when>
        <xsl:when test="$vMainEntryTag='110'">
          <xsl:text>abcdgn</xsl:text>
        </xsl:when>
        <xsl:when test="$vMainEntryTag='111'">
          <xsl:text>acdegnq</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="bf:source/@rdf:resource">
          <xsl:value-of select="bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vMainEntryTag"/>
      </xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="$vNameAuth//marc:datafield[@tag=$vMainEntryTag]">
              <xsl:value-of select="$vNameAuth//marc:datafield[@tag=$vMainEntryTag]/@ind1"/>
            </xsl:when>
            <xsl:when test="$vMainEntryTag='100'">
              <xsl:choose>
                <xsl:when test="contains(local-name(),'Family')">
                  <xsl:text>3</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>1</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:when>
            <xsl:when test="$vMainEntryTag='110'">
              <xsl:choose>
                <xsl:when test="local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:when test="$vNameAuth//marc:datafield[@tag='151']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>2</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="$vNameAuth//marc:datafield[@tag=$vMainEntryTag]">
          <xsl:for-each select="$vNameAuth//marc:datafield[@tag=$vMainEntryTag]/marc:subfield[contains($vAuthSubfields,@code)]">
            <marc:subfield>
              <xsl:attribute name="code">
                <xsl:value-of select="@code"/>
              </xsl:attribute>
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:variable name="vvMainEntryTag-a">
            <xsl:choose>
              <xsl:when test="$vMainEntryTag='100'">
                <xsl:choose>
                  <xsl:when test="madsrdf:elementList/madsrdf:FullNameElement/madsrdf:elementValue">
                    <xsl:for-each select="madsrdf:elementList/madsrdf:FullNameElement/madsrdf:elementValue[1]">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="madsrdf:authoritativeLabel">
                    <xsl:for-each select="madsrdf:authoritativeLabel">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:for-each select="rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:otherwise>
                <xsl:choose>
                  <xsl:when test="madsrdf:elementList">
                    <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="madsrdf:authoritativeLabel">
                    <xsl:for-each select="madsrdf:authoritativeLabel">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:for-each select="rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$vvMainEntryTag-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$vvMainEntryTag-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:choose>
            <xsl:when test="$vMainEntryTag='110'">
              <xsl:for-each select="madsrdf:elementList/*[position() &gt; 1]/madsrdf:elementValue">
                <marc:subfield code="b">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vMainEntryTag='100'">
              <xsl:for-each select="madsrdf:elementList/madsrdf:TermsOfAddressNameElement/madsrdf:elementValue">
                <marc:subfield code="c">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="$vMainEntryTag='111'">
              <xsl:for-each select="madsrdf:elementList/*[local-name()='GeographicElement' and position() &gt; 1]/madsrdf:elementValue">
                <marc:subfield code="c">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vMainEntryTag='100'">
              <xsl:for-each select="madsrdf:elementList/madsrdf:DateNameElement/madsrdf:elementValue">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="d">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $d.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vMainEntryTag='100'">
              <xsl:for-each select="madsrdf:fullerName/*/rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <marc:subfield code="q">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $q.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:when test="$vMainEntryTag='111'">
              <xsl:for-each select="madsrdf:elementList/*[local-name()='NameElement' and position() &gt; 1]/madsrdf:elementValue">
                <marc:subfield code="q">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
          </xsl:choose>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$vMainEntryTag='100' or $vMainEntryTag='110'">
          <xsl:for-each select="../../bf:role/*[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']]">
            <marc:subfield code="e">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="translate(., $upper, $lower)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $e.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="translate(., $upper, $lower)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $e.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="../bf:role/@rdf:resource">
            <marc:subfield code="e">
              <xsl:if test="contains(., 'id.loc.gov/vocabulary/relators/')">
                <xsl:value-of select="substring-after(., 'vocabulary/relators/')"/>
              </xsl:if>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$vMainEntryTag='111'">
          <xsl:for-each select="../../bf:role/*[rdfs:label[.!='Contributor'] or madsrdf:authoritativeLabel[.!='Contributor']]">
            <marc:subfield code="j">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $j.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $j.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="../../bf:role/*[madsrdf:code[.!='ctb'] or bf:code[.!='ctb']]|../bf:role/*[madsrdf:code[.!='ctb'] or bf:code[.!='ctb']]">
        <marc:subfield code="4">
          <xsl:choose>
            <xsl:when test="madsrdf:code">
              <xsl:for-each select="madsrdf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="                 ../../bf:role/*/@rdf:about[not(contains(., 'relators/ctb'))] |                  ../bf:role/*/@rdf:about[not(contains(., 'relators/ctb'))] |                  ../../bf:role/@rdf:resource[not(contains(., 'relators/ctb'))] |                  ../bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
        <marc:subfield code="4">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="$vSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label">
          <xsl:variable name="vvMainEntryTag-2">
            <xsl:choose>
              <xsl:when test="bf:source/bf:Source/bf:code">
                <xsl:value-of select="bf:source/bf:Source/bf:code"/>
              </xsl:when>
              <xsl:when test="$vSourceUri != ''">
                <xsl:choose>
                  <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vSourceUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vSourceUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$vvMainEntryTag-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$vvMainEntryTag-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="vvMainEntryTag-0">
        <xsl:choose>
          <xsl:when test="$agentURI != '' and contains($agentURI, '/authorities/')">
            <xsl:value-of select="$agentURI"/>
          </xsl:when>
          <xsl:when test="$agentURI != '' and contains($agentURI, 'id.loc.gov/rwo/agents/')">
            <xsl:value-of select="concat(substring-before($agentURI,'rwo/agents'), 'authorities/names/', substring-after($agentURI,'rwo/agents/'))"/>
          </xsl:when>
          <xsl:when test="@rdf:about[             not(contains(.,'example.org')) and              not(contains(.,'REPLACE')) and              not(contains(., '/agents/')) and             not(contains(., '/isni/')) and             not(contains(., '/gnd/'))             ]">
            <xsl:for-each select="@rdf:about[               not(contains(.,'example.org')) and                not(contains(.,'REPLACE')) and                not(contains(., '/agents/')) and               not(contains(., '/isni/')) and               not(contains(., '/gnd/'))               ]">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:value-of select="."/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $0.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$vvMainEntryTag-0 != ''">
        <marc:subfield code="0">
          <xsl:value-of select="$vvMainEntryTag-0"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:variable name="vvMainEntryTag-1">
        <xsl:choose>
          <xsl:when test="$agentURI != '' and (contains($agentURI, '/agents/') or contains($agentURI, '/gnd/'))">
            <xsl:value-of select="$agentURI"/>
          </xsl:when>
          <xsl:when test="@rdf:about[             contains(., '/agents/') or contains(., '/gnd/') or contains(., '/isni/')              ]">
            <xsl:for-each select="@rdf:about[               contains(., '/agents/') or contains(., '/gnd/') or contains(., '/isni/')               ]">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:value-of select="."/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vMainEntryTag $1.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$vvMainEntryTag-1 != ''">
        <marc:subfield code="1">
          <xsl:value-of select="$vvMainEntryTag-1"/>
        </marc:subfield>
      </xsl:if>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:title/*[local-name() = 'AbbreviatedTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AbbreviatedTitle']] |                     bf:Work/bf:title/*[local-name() = 'AbbreviatedTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/AbbreviatedTitle']]" mode="generate-210">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="bf:mainTitle/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">210</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>0</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:assigner/bf:Agent/bf:code = 'issnkey'">
              <xsl:text> </xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:mainTitle">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 210 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:qualifier">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 210 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:assigner/bf:Agent[not(bf:code='issnkey')]">
          <xsl:for-each select="bf:assigner/bf:Agent[not(bf:code='issnkey')]/bf:code">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:title/*[local-name() = 'KeyTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/KeyTitle']]" mode="generate-222">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="bf:mainTitle/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">222</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bflc:nonSortNum">
              <xsl:value-of select="bflc:nonSortNum"/>
            </xsl:when>
            <xsl:when test="bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:mainTitle))">
              <xsl:value-of select="string-length(bf:mainTitle) - string-length(bflc:titleSortKey)"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:mainTitle">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 222 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:qualifier">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 222 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:expressionOf/child::node()[         not(contains(@rdf:resource, 'hubs')) and not(contains(@rdf:about, 'hubs')) and          not(contains(@rdf:resource, 'REPLACE')) and not(contains(@rdf:about, 'REPLACE')) and          not(bflc:marcKey or marc:record) and          (local-name() = 'Hub' or local-name() = 'Work') and bf:title][../../bf:contribution/*[local-name()='PrimaryContribution'] or ../../bf:contribution/*/rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]" mode="generate-240">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="bf:mainTitle/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">240</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text>1</xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="bf:title/bf:Title/bflc:nonSortNum">
                  <xsl:value-of select="bf:title/bf:Title/bflc:nonSortNum"/>
                </xsl:when>
                <xsl:when test="bf:title/bf:Title/bflc:titleSortKey and (string-length(bf:title/bf:Title/bflc:titleSortKey) &lt; string-length(bf:title/bf:Title/bf:mainTitle))">
                  <xsl:value-of select="string-length(bf:title/bf:Title/bf:mainTitle) - string-length(bf:title/bf:Title/bflc:titleSortKey)"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>0</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:variable name="v240-a">
            <xsl:choose>
              <xsl:when test="bf:title/bf:Title/bf:mainTitle">
                <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 240 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v240-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v240-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:for-each select="bf:legalDate">
            <marc:subfield code="d">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:originDate">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="f">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 240 $f.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
            <marc:subfield code="m">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
            <marc:subfield code="n">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:title/bf:Title/bf:partName">
            <marc:subfield code="p">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
              <marc:subfield code="o">arranged</marc:subfield>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bf:musicKey">
            <marc:subfield code="r">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:version">
            <marc:subfield code="s">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:identifiedBy/bf:Identifier">
            <marc:subfield code="0">
              <xsl:variable name="vIdType">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vIdType != ''">
                  <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="rdf:value"/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:source/bf:Source/bf:code">
            <marc:subfield code="2">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (240).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:title/*[(local-name() = 'VariantTitle' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/VariantTitle']) and bf:variantType = 'translated']" mode="generate-242">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="langCode">
      <xsl:variable name="vxmllang">
        <xsl:value-of select="bf:mainTitle/@xml:lang"/>
      </xsl:variable>
      <xsl:value-of select="exsl:node-set($languages)/*[xmllang=$vxmllang]/iso6392"/>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="bf:mainTitle/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">242</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>1</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bflc:nonSortNum">
              <xsl:value-of select="bflc:nonSortNum"/>
            </xsl:when>
            <xsl:when test="bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:mainTitle))">
              <xsl:value-of select="string-length(bf:mainTitle) - string-length(bflc:titleSortKey)"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bf:mainTitle">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 242 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:subtitle">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 242 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:partNumber">
        <marc:subfield code="n">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:partName">
        <marc:subfield code="p">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="$langCode != ''">
          <xsl:variable name="v242-y">
            <xsl:value-of select="$langCode"/>
          </xsl:variable>
          <xsl:if test="$v242-y != ''">
            <marc:subfield code="y">
              <xsl:value-of select="$v242-y"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="bf:mainTitle/@xml:lang != ''">
          <xsl:variable name="v242-y">
            <xsl:value-of select="bf:mainTitle/@xml:lang "/>
          </xsl:variable>
          <xsl:if test="$v242-y != ''">
            <marc:subfield code="y">
              <xsl:value-of select="$v242-y"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:title/*[                       local-name()='CollectiveTitle' or                       rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/CollectiveTitle']                     ]" mode="generate-243">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <xsl:variable name="vXmlLang">
          <xsl:value-of select="bf:mainTitle/@xml:lang"/>
        </xsl:variable>
        <marc:datafield>
          <xsl:attribute name="tag">243</xsl:attribute>
          <xsl:if test="$vXmlLang != ''">
            <xsl:attribute name="xml:lang">
              <xsl:value-of select="$vXmlLang"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:attribute name="ind1">
            <xsl:text>1</xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="bflc:nonSortNum">
                  <xsl:value-of select="bflc:nonSortNum"/>
                </xsl:when>
                <xsl:when test="bflc:titleSortKey and (string-length(bflc:titleSortKey) &lt; string-length(bf:mainTitle))">
                  <xsl:value-of select="string-length(bf:mainTitle) - string-length(bflc:titleSortKey)"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>0</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:for-each select="bf:mainTitle">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 243 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (243).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]/bf:title/bf:Title[not(rdf:type)]|bf:Work[not(../bf:Instance/bf:title/bf:Title[not(rdf:type)])]/bf:title/bf:Title[not(rdf:type)]" mode="generate-245">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vLangTagLabel" select="bf:mainTitle[                     contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)) or                      string-length(@xml:lang)='2' or                      string-length(@xml:lang)='3'                   ][1]/@xml:lang"/>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <marc:datafield>
          <xsl:attribute name="tag">245</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="/rdf:RDF/bf:Work/bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]">
                  <xsl:text>1</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>0</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:variable name="vInd">
              <xsl:choose>
                <xsl:when test="bflc:nonSortNum[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:value-of select="bflc:nonSortNum[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]"/>
                </xsl:when>
                <xsl:when test="bflc:titleSortKey[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))] and                       (string-length(bflc:titleSortKey[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]) &lt; string-length(bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]))">
                  <xsl:value-of select="string-length(bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]) - string-length(bflc:titleSortKey[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))])"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="$vInd != ''">
                <xsl:value-of select="$vInd"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:text>0</xsl:text>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="count(bf:mainTitle)=2 and bf:mainTitle[@xml:lang] and bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
              <marc:subfield code="6">880-03</marc:subfield>
            </xsl:when>
          </xsl:choose>
          <xsl:variable name="v245-a">
            <xsl:choose>
              <xsl:when test="bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:for-each select="bf:mainTitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:value-of select="."/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="count(bf:mainTitle)=1 and bf:mainTitle[@xml:lang]">
                <xsl:for-each select="bf:mainTitle[@xml:lang]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:value-of select="."/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
            <xsl:choose>
              <xsl:when test="                 bf:partNumber[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))] and                 not(                   substring(                     bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))],                      string-length(bf:mainTitle[@xml:lang and not(contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower)))]),                   1) = '.'                 )               ">
                <xsl:text>.</xsl:text>
              </xsl:when>
              <xsl:when test="bf:partName[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text>.</xsl:text>
              </xsl:when>
              <xsl:when test="bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> :</xsl:text>
              </xsl:when>
              <xsl:when test="count(bf:subtitle)=1 and bf:subtitle[@xml:lang]">
                <xsl:text> :</xsl:text>
              </xsl:when>
              <xsl:when test="ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> /</xsl:text>
              </xsl:when>
              <xsl:when test="count(ancestor::bf:Instance/bf:responsibilityStatement)=1 and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]">
                <xsl:text> /</xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v245-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v245-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:variable name="v245-n">
            <xsl:variable name="nExists">
              <xsl:choose>
                <xsl:when test="bf:partNumber[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:value-of select="'1'"/>
                </xsl:when>
                <xsl:when test="count(bf:partNumber)=1 and bf:partNumber[@xml:lang]">
                  <xsl:value-of select="'1'"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="bf:partNumber[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:for-each select="bf:partNumber[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $n.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="count(bf:partNumber)=1 and bf:partNumber[@xml:lang]">
                <xsl:for-each select="bf:partNumber[@xml:lang]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $n.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
            <xsl:choose>
              <xsl:when test="$nExists='1' and bf:partName[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text>,</xsl:text>
              </xsl:when>
              <xsl:when test="$nExists='1' and bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> :</xsl:text>
              </xsl:when>
              <xsl:when test="$nExists='1' and count(bf:subtitle)=1 and bf:subtitle[@xml:lang]">
                <xsl:text> :</xsl:text>
              </xsl:when>
              <xsl:when test="$nExists='1' and ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> /</xsl:text>
              </xsl:when>
              <xsl:when test="$nExists='1' and count(ancestor::bf:Instance/bf:responsibilityStatement)=1 and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]">
                <xsl:text> /</xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v245-n != ''">
            <marc:subfield code="n">
              <xsl:value-of select="$v245-n"/>
            </marc:subfield>
          </xsl:if>
          <xsl:variable name="v245-p">
            <xsl:variable name="pExists">
              <xsl:choose>
                <xsl:when test="bf:partName[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:value-of select="'1'"/>
                </xsl:when>
                <xsl:when test="count(bf:partName)=1 and bf:partName[@xml:lang]">
                  <xsl:value-of select="'1'"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="bf:partName[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:for-each select="bf:partName[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $p.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="count(bf:partName)=1 and bf:partName[@xml:lang]">
                <xsl:for-each select="bf:partName[@xml:lang]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $p.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
            <xsl:choose>
              <xsl:when test="$pExists='1' and bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> :</xsl:text>
              </xsl:when>
              <xsl:when test="$pExists='1' and count(bf:subtitle)=1 and bf:subtitle[@xml:lang]">
                <xsl:text> :</xsl:text>
              </xsl:when>
              <xsl:when test="$pExists='1' and ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> /</xsl:text>
              </xsl:when>
              <xsl:when test="$pExists='1' and count(ancestor::bf:Instance/bf:responsibilityStatement)=1 and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]">
                <xsl:text> /</xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v245-p != ''">
            <marc:subfield code="p">
              <xsl:value-of select="$v245-p"/>
            </marc:subfield>
          </xsl:if>
          <xsl:variable name="v245-b">
            <xsl:variable name="bExists">
              <xsl:choose>
                <xsl:when test="bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:value-of select="'1'"/>
                </xsl:when>
                <xsl:when test="count(bf:subtitle)=1 and bf:subtitle[@xml:lang]">
                  <xsl:value-of select="'1'"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:for-each select="bf:subtitle[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:value-of select="."/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $b.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:when test="count(bf:subtitle)=1 and bf:subtitle[@xml:lang]">
                <xsl:for-each select="bf:subtitle[@xml:lang]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:value-of select="."/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $b.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
            </xsl:choose>
            <xsl:choose>
              <xsl:when test="$bExists='1' and ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:text> /</xsl:text>
              </xsl:when>
              <xsl:when test="$bExists='1' and count(ancestor::bf:Instance/bf:responsibilityStatement)=1 and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]">
                <xsl:text> /</xsl:text>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v245-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v245-b"/>
            </marc:subfield>
          </xsl:if>
          <xsl:variable name="v245-c">
            <xsl:choose>
              <xsl:when test="ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                <xsl:for-each select="ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:value-of select="."/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $c.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:variable name="vEndsWith">
                  <xsl:call-template name="tEndsWith">
                    <xsl:with-param name="pStr" select="ancestor::bf:Instance/bf:responsibilityStatement[not(@xml:lang) or contains(translate(@xml:lang,$upper,$lower),translate($pCatScript,$upper,$lower))]"/>
                    <xsl:with-param name="pEndChar" select="'.'"/>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:if test="$vEndsWith = '0'">
                  <xsl:text>.</xsl:text>
                </xsl:if>
              </xsl:when>
              <xsl:when test="count(ancestor::bf:Instance/bf:responsibilityStatement)=1 and ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]">
                <xsl:for-each select="ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:value-of select="."/>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 245 $c.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:variable name="vEndsWith">
                  <xsl:call-template name="tEndsWith">
                    <xsl:with-param name="pStr" select="ancestor::bf:Instance/bf:responsibilityStatement[@xml:lang]"/>
                    <xsl:with-param name="pEndChar" select="'.'"/>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:if test="$vEndsWith = '0'">
                  <xsl:text>.</xsl:text>
                </xsl:if>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v245-c != ''">
            <marc:subfield code="c">
              <xsl:value-of select="$v245-c"/>
            </marc:subfield>
          </xsl:if>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (245).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Work/bf:scale[not(bf:Scale)]" mode="generate-255">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">255</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:scale/bf:Scale/bf:note/bf:Note/rdfs:label" mode="generate-255">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">255</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:value-of select="."/>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:cartographicAttributes/bf:Cartographic[bf:projection or                     bf:coordinates or                     bf:ascensionAndDeclination or                     bf:equinox or                     bf:outerGRing or                     bf:exclusionGRing]" mode="generate-255">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">255</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bf:projection/bf:Projection/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 255 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:coordinates">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="c">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 255 $c.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:ascensionAndDeclination">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="d">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 255 $d.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:equinox">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="e">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 255 $e.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:outerGRing">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="f">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 255 $f.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:exclusionGRing">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="g">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 255 $g.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:originPlace/bf:Place" mode="generate-257">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">257</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source">
        <marc:subfield code="2">
          <xsl:variable name="vUri">
            <xsl:choose>
              <xsl:when test="@rdf:resource">
                <xsl:value-of select="@rdf:resource"/>
              </xsl:when>
              <xsl:when test="*/@rdf:about">
                <xsl:value-of select="*/@rdf:about"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:variable name="vSourceCode">
            <xsl:call-template name="tUriCode">
              <xsl:with-param name="pUri" select="$vUri"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSourceCode != ''">
              <xsl:value-of select="$vSourceCode"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="*/bf:code"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bflc:projectedProvisionDate" mode="generate-263">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <marc:datafield>
          <xsl:attribute name="tag">263</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <marc:subfield code="a">
            <xsl:value-of select="."/>
          </marc:subfield>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (263).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')]/bf:copyrightDate[. != '']" mode="generate-264">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="cDate">
      <xsl:choose>
        <xsl:when test="contains(., '©') or contains(., '℗')">
          <xsl:value-of select="."/>
        </xsl:when>
        <xsl:when test="../bf:media//@rdf:*[.='http://id.loc.gov/vocabulary/mediaTypes/s'] and                       (                         ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/se'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/st'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/sw'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/sq'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/sb'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/sd'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/sz'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/ss'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/sg'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/si'] or                          ../bf:carrier//@rdf:*[.='http://id.loc.gov/vocabulary/carriers/cr']                       )">
          <xsl:value-of select="concat('℗', text())"/>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="concat('©', text())"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:choose>
      <xsl:when test="position() = 1">
        <marc:datafield>
          <xsl:attribute name="tag">264</xsl:attribute>
          <xsl:attribute name="ind1">
            <xsl:text> </xsl:text>
          </xsl:attribute>
          <xsl:attribute name="ind2">
            <xsl:text>4</xsl:text>
          </xsl:attribute>
          <xsl:variable name="v264-c">
            <xsl:value-of select="$cDate"/>
          </xsl:variable>
          <xsl:if test="$v264-c != ''">
            <marc:subfield code="c">
              <xsl:value-of select="$v264-c"/>
            </marc:subfield>
          </xsl:if>
        </marc:datafield>
      </xsl:when>
      <xsl:otherwise>
        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target field (264).</xsl:message>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:extent/bf:Extent" mode="generate-300">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">300</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v300-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 300 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label[. != 'all']">
            <xsl:for-each select="bflc:appliesTo[1]/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 300 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v300-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v300-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="rdfs:label">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:variable name="v300-b">
        <xsl:choose>
          <xsl:when test="bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='physical details' or rdf:type//@rdf:*[1]='http://id.loc.gov/vocabulary/mnotetype/physical']/rdfs:label">
            <xsl:for-each select="bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='physical details' or rdf:type//@rdf:*[1]='http://id.loc.gov/vocabulary/mnotetype/physical']/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 300 $b.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bf:note/bf:Note/rdfs:label">
            <xsl:for-each select="bf:note/bf:Note/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 300 $b.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="../../bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='physical details' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/physical']/rdfs:label">
            <xsl:for-each select="../../bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='physical details' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/physical']/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 300 $b.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v300-b != ''">
        <marc:subfield code="b">
          <xsl:value-of select="$v300-b"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="../../bf:dimensions">
        <marc:subfield code="c">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="../../bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='accompanying material' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/accmat']/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="e">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 300 $e.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance[not(rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance'])]/bf:frequency/bf:Frequency[rdfs:label or bf:date]" mode="generate-vFreqTag">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vFreqTag">
      <xsl:choose>
        <xsl:when test="bf:status//@rdf:*[1] = 'http://id.loc.gov/vocabulary/mstatus/former'">
          <xsl:text>321</xsl:text>
        </xsl:when>
        <xsl:when test="translate(bf:note/bf:Note/rdfs:label,$upper,$lower)='former frequency'">
          <xsl:text>321</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>310</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vFreqTag"/>
      </xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vFreqTag $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:date">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vFreqTag $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vFreqTag $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance[not(rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance'])]/bf:issuance" mode="generate-334">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">334</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v334-a">
        <xsl:choose>
          <xsl:when test="bf:*/madsrdf:authoritativeLabel">
            <xsl:for-each select="bf:*/madsrdf:authoritativeLabel">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 334 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="bf:*/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 334 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v334-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v334-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="bf:*/*[local-name()='code']">
          <xsl:variable name="v334-b">
            <xsl:value-of select="bf:*/*[local-name()='code']"/>
          </xsl:variable>
          <xsl:if test="$v334-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v334-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="@rdf:resource or bf:*/@rdf:about">
          <xsl:variable name="v334-b">
            <xsl:choose>
              <xsl:when test="contains(@rdf:resource,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="@rdf:resource"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:when test="contains(bf:*/@rdf:about,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="bf:*/@rdf:about"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="bf:*/@rdf:about"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v334-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v334-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:resource">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:*/@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:*/bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:*/bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 334 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:content/*[local-name()='Content' or                                                  rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Content'] or                                                  local-name()='Authority' or                                                  rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]" mode="generate-336">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">336</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v336-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 336 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 336 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v336-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v336-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:variable name="v336-a">
        <xsl:choose>
          <xsl:when test="madsrdf:authoritativeLabel">
            <xsl:for-each select="madsrdf:authoritativeLabel">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 336 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 336 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v336-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v336-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="*[local-name()='code']">
          <xsl:variable name="v336-b">
            <xsl:value-of select="*[local-name()='code']"/>
          </xsl:variable>
          <xsl:if test="$v336-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v336-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="@rdf:about">
          <xsl:variable name="v336-b">
            <xsl:choose>
              <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="@rdf:about"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="@rdf:about"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v336-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v336-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="v336-2">
        <xsl:choose>
          <xsl:when test="contains(@rdf:about,'id.loc.gov/vocabulary/contentType')">
            <xsl:text>rdacontent</xsl:text>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="bf:source/bf:Source/bf:code">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 336 $2.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v336-2 != ''">
        <marc:subfield code="2">
          <xsl:value-of select="$v336-2"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:media/*[local-name()='Media' or                                                    rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Media'] or                                                    local-name()='Authority' or                                                    rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]" mode="generate-337">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">337</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v337-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 337 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 337 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v337-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v337-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:variable name="v337-a">
        <xsl:choose>
          <xsl:when test="madsrdf:authoritativeLabel">
            <xsl:for-each select="madsrdf:authoritativeLabel">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 337 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 337 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v337-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v337-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="*[local-name()='code']">
          <xsl:variable name="v337-b">
            <xsl:value-of select="*[local-name()='code']"/>
          </xsl:variable>
          <xsl:if test="$v337-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v337-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="@rdf:about">
          <xsl:variable name="v337-b">
            <xsl:choose>
              <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="@rdf:about"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="@rdf:about"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v337-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v337-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="v337-2">
        <xsl:choose>
          <xsl:when test="contains(@rdf:about,'id.loc.gov/vocabulary/mediaType')">
            <xsl:text>rdamedia</xsl:text>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="bf:source/bf:Source/bf:code">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 337 $2.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v337-2 != ''">
        <marc:subfield code="2">
          <xsl:value-of select="$v337-2"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:carrier/*[local-name()='Carrier' or                                                      rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Carrier'] or                                                      local-name()='Authority' or                                                      rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Authority']]" mode="generate-338">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">338</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v338-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 338 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 338 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v338-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v338-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:variable name="v338-a">
        <xsl:choose>
          <xsl:when test="madsrdf:authoritativeLabel">
            <xsl:for-each select="madsrdf:authoritativeLabel">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 338 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 338 $a.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v338-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v338-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="*[local-name()='code']">
          <xsl:variable name="v338-b">
            <xsl:value-of select="*[local-name()='code']"/>
          </xsl:variable>
          <xsl:if test="$v338-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v338-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="@rdf:about">
          <xsl:variable name="v338-b">
            <xsl:choose>
              <xsl:when test="contains(@rdf:about,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="@rdf:about"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="@rdf:about"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v338-b != ''">
            <marc:subfield code="b">
              <xsl:value-of select="$v338-b"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="v338-2">
        <xsl:choose>
          <xsl:when test="contains(@rdf:about,'id.loc.gov/vocabulary/carriers')">
            <xsl:text>rdacarrier</xsl:text>
          </xsl:when>
          <xsl:otherwise>
            <xsl:for-each select="bf:source/bf:Source/bf:code">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 338 $2.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v338-2 != ''">
        <marc:subfield code="2">
          <xsl:value-of select="$v338-2"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:baseMaterial/bf:BaseMaterial |                     bf:Instance/bf:appliedMaterial/bf:AppliedMaterial |                     bf:Instance/bf:productionMethod/bf:ProductionMethod |                     bf:Instance/bf:mount/bf:Mount |                     bf:Instance/bf:reductionRatio/bf:ReductionRatio |                     bf:Work/bf:colorContent/bf:ColorContent |                     bf:Instance/bf:generation/bf:Generation |                     bf:Instance/bf:layout/bf:Layout |                     bf:Instance/bf:bookFormat/bf:BookFormat |                     bf:Instance/bf:fontSize/bf:FontSize |                     bf:Instance/bf:polarity/bf:Polarity |                     bf:Instance/bf:binding/bf:Binding |                     bf:Work/bf:illustrativeContent/bf:Illustration" mode="generate-340">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">340</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v340-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 340 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 340 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v340-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v340-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="local-name()='BaseMaterial'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='AppliedMaterial'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='ProductionMethod'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="d">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Mount'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="e">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='ReductionRatio'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="q">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='ColorContent'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="g">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Generation'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="j">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Layout'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="k">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Binding'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="l">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='BookFormat'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="m">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='FontSize'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="n">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Polarity'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="o">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Illustration'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="p">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="local-name()='ReductionRatio'">
          <xsl:for-each select="rdf:value">
            <marc:subfield code="f">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 340 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:soundCharacteristic/bf:RecordingMethod |                     bf:Instance/bf:soundCharacteristic/bf:RecordingMedium |                     bf:Instance/bf:soundCharacteristic/bf:PlayingSpeed |                     bf:Instance/bf:soundCharacteristic/bf:GrooveCharacteristic |                     bf:Instance/bf:soundCharacteristic/bf:TrackConfig |                     bf:Instance/bf:soundCharacteristic/bf:TapeConfig |                     bf:Instance/bf:soundCharacteristic/bf:PlaybackChannels |                     bf:Instance/bf:soundCharacteristic/bf:PlaybackCharacteristic |                     bf:Instance/bf:soundCharacteristic/bf:CaptureStorage |                     bf:Instance/bf:soundCharacteristic/bflc:CaptureStorage |                     bf:Work/bf:soundContent/bf:SoundContent" mode="generate-344">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">344</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v344-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 344 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 344 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v344-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v344-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="local-name()='RecordingMethod'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='RecordingMedium'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='PlayingSpeed'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='GrooveCharacteristic'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="d">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='TrackConfig'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="e">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='TapeConfig'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="f">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='PlaybackChannels'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="g">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='PlaybackCharacteristic'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="h">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='SoundContent'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="i">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='CaptureStorage'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="j">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 344 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:projectionCharacteristic/bf:PresentationFormat |                     bf:Instance/bf:projectionCharacteristic/bf:ProjectionSpeed" mode="generate-345">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">345</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v345-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 345 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 345 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v345-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v345-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="local-name()='PresentationFormat'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='ProjectionSpeed'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 345 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:aspectRatio/bf:AspectRatio[rdfs:label|rdf:value]" mode="generate-345">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">345</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v345-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 345 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 345 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v345-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v345-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="rdf:value">
        <marc:subfield code="c">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="rdfs:label">
        <marc:subfield code="d">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 345 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:videoCharacteristic/bf:VideoFormat |                     bf:Instance/bf:videoCharacteristic/bf:BroadcastStandard" mode="generate-346">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">346</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v346-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 346 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 346 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v346-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v346-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="local-name()='VideoFormat'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='BroadcastStandard'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 346 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:digitalCharacteristic/bf:FileType |                     bf:Instance/bf:digitalCharacteristic/bf:EncodingFormat |                     bf:Instance/bf:digitalCharacteristic/bf:FileSize |                     bf:Instance/bf:digitalCharacteristic/bf:Resolution |                     bf:Instance/bf:digitalCharacteristic/bf:RegionalEncoding |                     bf:Instance/bf:digitalCharacteristic/bf:EncodedBitrate" mode="generate-347">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">347</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v347-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 347 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 347 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v347-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v347-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="local-name()='FileType'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='EncodingFormat'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='FileSize'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='Resolution'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="d">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='RegionalEncoding'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="e">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='EncodedBitrate'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="f">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 347 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:musicFormat/bf:MusicFormat | bf:Work/bf:notation/bf:MusicNotation |                     bf:Instance/bf:musicFormat/bf:MusicFormat | bf:Instance/bf:notation/bf:MusicNotation" mode="generate-348">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">348</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v348-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 348 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 348 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v348-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v348-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="../bf:MusicFormat/rdfs:label">
        <marc:subfield code="a">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="../bf:MusicNotation/rdfs:label">
        <marc:subfield code="c">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 348 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:collectionArrangement/bf:CollectionArrangement" mode="generate-351">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">351</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v351-3">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="ancestor::bf:Instance[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance']/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 351 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 351 $3.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v351-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v351-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:hierarchicalLevel">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 351 $c.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:collectionOrganization">
        <marc:subfield code="a">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:pattern">
        <marc:subfield code="b">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:digitalCharacteristic/bf:CartographicDataType |                     bf:Instance/bf:digitalCharacteristic/bf:CartographicObjectType" mode="generate-352">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">352</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="local-name()='CartographicDataType'">
          <xsl:for-each select="rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 352 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name()='CartographicObjectType'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:count">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:supplementaryContent/bf:SupplementaryContent[@rdf:about]" mode="generate-353">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">353</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <marc:subfield code="a">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:variable name="v353-b">
        <xsl:call-template name="tUriCode">
          <xsl:with-param name="pUri" select="@rdf:about"/>
        </xsl:call-template>
      </xsl:variable>
      <xsl:if test="$v353-b != ''">
        <marc:subfield code="b">
          <xsl:value-of select="$v353-b"/>
        </marc:subfield>
      </xsl:if>
      <xsl:variable name="v353-0">
        <xsl:choose>
          <xsl:when test="@rdf:about">
            <xsl:for-each select="@rdf:about">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:value-of select="."/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 353 $0.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v353-0 != ''">
        <marc:subfield code="0">
          <xsl:value-of select="$v353-0"/>
        </marc:subfield>
      </xsl:if>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:firstIssue" mode="generate-362">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">362</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>0</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v362-a">
        <xsl:variable name="vPosition" select="position()"/>
        <xsl:variable name="vLastIssue">
          <xsl:for-each select="../bf:lastIssue">
            <xsl:if test="position() = $vPosition">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </xsl:if>
          </xsl:for-each>
        </xsl:variable>
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="concat(.,'-',$vLastIssue)"/>
        </xsl:call-template>
      </xsl:variable>
      <xsl:if test="$v362-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v362-a"/>
        </marc:subfield>
      </xsl:if>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:originPlace/bf:Place" mode="generate-370">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">370</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="madsrdf:authoritiveLabel">
          <xsl:variable name="v370-g">
            <xsl:value-of select="madsrdf:authoritativeLabel"/>
          </xsl:variable>
          <xsl:if test="$v370-g != ''">
            <marc:subfield code="g">
              <xsl:value-of select="$v370-g"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="g">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vSource">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vSource != ''">
              <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 370 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:musicMedium/bf:MusicMedium[bflc:readMarc382]" mode="generate-382">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="v382data">
      <xsl:choose>
        <xsl:when test="starts-with(bflc:readMarc382, '$')">
          <xsl:value-of select="concat('382  ', bflc:readMarc382)"/>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="bflc:readMarc382"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">382</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:status/@rdf:resource='http://id.loc.gov/vocabulary/mstatus/part' or                       bf:status/bf:Status/@rdf:about='http://id.loc.gov/vocabulary/mstatus/part' or                       translate(bf:status/bf:Status/rdfs:label,$upper,$lower)='partial'">
              <xsl:text>1</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 382 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:call-template name="tReadMarc382">
        <xsl:with-param name="pString" select="substring($v382data, 6)"/>
      </xsl:call-template>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:musicKey" mode="generate-384">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">384</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bflc:creatorCharacteristic" mode="generate-386">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="*/bf:source/@rdf:resource">
          <xsl:value-of select="*/bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="*/bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="*/bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="bflc:CreatorCharacteristic/rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">386</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:CreatorCharacteristic/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 386 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bflc:CreatorCharacteristic/bflc:demographicGroup/bflc:DemographicGroup/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="m">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 386 $m.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bflc:CreatorCharacteristic/bflc:demographicGroup[@rdf:resource or */@rdf:about]">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="n">
              <xsl:variable name="vDGUri">
                <xsl:choose>
                  <xsl:when test="@rdf:resource">
                    <xsl:value-of select="@rdf:resource"/>
                  </xsl:when>
                  <xsl:when test="*/@rdf:about">
                    <xsl:value-of select="*/@rdf:about"/>
                  </xsl:when>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="contains($vDGUri,'id.loc.gov')">
                  <xsl:call-template name="tUriCode">
                    <xsl:with-param name="pUri" select="$vDGUri"/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="."/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 386 $n.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bflc:CreatorCharacteristic/rdfs:label">
        <marc:subfield code="a">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="*/bf:source/bf:Source/*[local-name()='code']">
          <xsl:variable name="v386-2">
            <xsl:value-of select="*/bf:source/bf:Source/*[local-name()='code'][1]"/>
          </xsl:variable>
          <xsl:if test="$v386-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$v386-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="$vSourceUri != ''">
          <xsl:variable name="v386-2">
            <xsl:choose>
              <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="$vSourceUri"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="$vSourceUri"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v386-2 != ''">
            <marc:subfield code="2">
              <xsl:value-of select="$v386-2"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:resource|bflc:CreatorCharacteristic/@rdf:about">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:note/bf:*[rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/refcitation']] |                     bf:Work/bf:relation/bf:Relation[bf:relationship//@rdf:*[1]='http://id.loc.gov/vocabulary/relationship/references']/bf:associatedResource/bf:Work |                     bf:Work/bf:relation/bf:Relation[bf:relationship//@rdf:*[1]='http://id.loc.gov/vocabulary/relationship/indexedin']/bf:associatedResource/bf:Work |                     bf:Work/bflc:indexedIn/bf:Work |                     bf:Work/bf:references/bf:Work" mode="generate-510">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="bf:title/*/bf:mainTitle/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">510</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/refcitation'] and bflc:citation">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/refcitation'] and bf:enumerationAndChronology">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="rdf:type[@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/refcitation'] and not(bflc:citation) and not(bf:enumerationAndChronology)">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[1]='http://id.loc.gov/vocabulary/relationship/references' and (bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='location' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/loc'])">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship//@rdf:*[1]='http://id.loc.gov/vocabulary/relationship/references'">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(..)='references' and bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='location' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/loc']">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(..)='references'">
              <xsl:text>3</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="ancestor::bf:Relation/bflc:appliesTo/bflc:AppliesTo/rdfs:label|bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 510 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:title/*/bf:mainTitle|rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 510 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='coverage' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/coverage']/rdfs:label |                        bf:enumerationAndChronology/bf:EnumerationAndChronology/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 510 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note[translate(bf:noteType,$upper,$lower)='location' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/loc']/rdfs:label | bflc:citation">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="c">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 510 $c.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="x">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 510 $x.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:electronicLocator/@rdf:resource">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="u">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 510 $u.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:capture/bf:Capture[not(bf:date[@rdf:datatype='http://id.loc.gov/datatypes/edtf']) and not(bf:place/@rdf:resource)]" mode="generate-518">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">518</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 518 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <marc:subfield code="o">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 518 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:date">
        <marc:subfield code="d">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:place/*/rdfs:label">
        <marc:subfield code="p">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:geographicCoverage/*[               not(                 bf:source/@rdf:resource='http://id.loc.gov/authorities/classification/G' or                  bf:source/bf:Source/@rdf:about='http://id.loc.gov/authorities/classification/G'               ) and not(@rdf:about) and rdfs:label]" mode="generate-522">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">522</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 522 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:preferredCitation |                      bf:Instance/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/citeas']/rdfs:label" mode="generate-524">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">524</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/suppl' and rdfs:label[. != '']]       " mode="generate-525">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">525</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 525 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:contentAccessibility/bf:ContentAccessibility/rdfs:label" mode="generate-532">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">532</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>8</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 532 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:systemRequirement/bf:SystemRequirement[not(contains(rdf:type/@rdf:resource,'bflc'))] |                     //bf:Item/bf:systemRequirement/bf:SystemRequirement[not(contains(rdf:type/@rdf:resource,'bflc'))]" mode="generate-538">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">538</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 538 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 538 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
        <marc:subfield code="u">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
        <marc:subfield code="5">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="//bf:Item/bf:immediateAcquisition/bf:ImmediateAcquisition[rdfs:label[. != '']]" mode="generate-541">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">541</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 541 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 541 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bflc:applicableInstitution/bf:Agent/bf:code">
        <marc:subfield code="5">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work[not(bf:note/bf:Note/rdf:type/@rdf:resource[.='http://id.loc.gov/vocabulary/mnotetype/lang'])]/bf:notation/bf:Notation[rdfs:label] |                      bf:Work[not(bf:note/bf:Note/rdf:type/@rdf:resource[.='http://id.loc.gov/vocabulary/mnotetype/lang'])]/bf:notation/bf:Script[rdfs:label]" mode="generate-546">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">546</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 546 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="rdfs:label">
        <marc:subfield code="b">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:title/bf:VariantTitle[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/vartitletype/for']/bf:note/bf:Note/rdfs:label" mode="generate-547">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">547</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:custodialHistory|//bf:Item/bf:custodialHistory" mode="generate-561">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">561</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
      <xsl:choose>
        <xsl:when test="local-name(parent::node()) = 'Item'">
          <xsl:variable name="v561-5">
            <xsl:value-of select="$pConversionAgency"/>
          </xsl:variable>
          <xsl:if test="$v561-5 != ''">
            <marc:subfield code="5">
              <xsl:value-of select="$v561-5"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="     //bf:Item/bf:note/*[bf:noteType='binding' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/binding'] |     bf:Instance/bf:note/*[bf:noteType='binding' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/binding'] " mode="generate-563">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">563</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 563 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="local-name(parent::node()/..) = 'Item'">
          <xsl:variable name="v563-5">
            <xsl:value-of select="$pConversionAgency"/>
          </xsl:variable>
          <xsl:if test="$v563-5 != ''">
            <marc:subfield code="5">
              <xsl:value-of select="$v563-5"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="bflc:applicableInstitution">
          <xsl:variable name="vAppOrg">
            <xsl:choose>
              <xsl:when test="bflc:applicableInstitution/@rdf:resource">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="bflc:applicableInstitution/@rdf:resource"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:when test="bflc:applicableInstitution/*/@rdf:about">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="bflc:applicableInstitution/*/@rdf:about"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:when test="bflc:applicableInstitution/*/*[local-name()='code']">
                <xsl:value-of select="bflc:applicableInstitution/*/*[local-name()='code']"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:variable name="v563-5">
            <xsl:value-of select="$vAppOrg"/>
          </xsl:variable>
          <xsl:if test="$v563-5 != ''">
            <marc:subfield code="5">
              <xsl:value-of select="$v563-5"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/relnote']/rdfs:label |       bf:Work/bf:relation/bf:Relation/bf:note/bf:Note[rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/relnote']/rdfs:label " mode="generate-580">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">580</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v580-a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </xsl:variable>
      <xsl:if test="$v580-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v580-a"/>
        </marc:subfield>
      </xsl:if>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       //bf:Item/bf:note/*[bf:noteType='action' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/action'] |       bf:Instance/bf:note/*[bf:noteType='action' or rdf:type/@rdf:resource='http://id.loc.gov/vocabulary/mnotetype/action'] " mode="generate-583">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">583</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 583 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:variable name="v583-a">
        <xsl:variable name="vLabel">
          <xsl:for-each select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]">
            <xsl:value-of select="concat(.,' ')"/>
          </xsl:for-each>
        </xsl:variable>
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="$vLabel"/>
        </xsl:call-template>
      </xsl:variable>
      <xsl:if test="$v583-a != ''">
        <marc:subfield code="a">
          <xsl:value-of select="$v583-a"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:date">
        <marc:subfield code="c">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:agent/*/rdfs:label">
        <marc:subfield code="k">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:status/*/rdfs:label">
        <marc:subfield code="l">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:electronicLocator/@rdf:resource|rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']">
        <marc:subfield code="u">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <marc:subfield code="z">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 583 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="local-name(parent::node()/..) = 'Item'">
          <xsl:variable name="v583-5">
            <xsl:value-of select="$pConversionAgency"/>
          </xsl:variable>
          <xsl:if test="$v583-5 != ''">
            <marc:subfield code="5">
              <xsl:value-of select="$v583-5"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="bflc:applicableInstitution">
          <xsl:variable name="vAppOrg">
            <xsl:choose>
              <xsl:when test="bflc:applicableInstitution/@rdf:resource">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="bflc:applicableInstitution/@rdf:resource"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:when test="bflc:applicableInstitution/*/@rdf:about">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="bflc:applicableInstitution/*/@rdf:about"/>
                </xsl:call-template>
              </xsl:when>
              <xsl:when test="bflc:applicableInstitution/*/*[local-name()='code']">
                <xsl:value-of select="bflc:applicableInstitution/*/*[local-name()='code']"/>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:variable name="v583-5">
            <xsl:value-of select="$vAppOrg"/>
          </xsl:variable>
          <xsl:if test="$v583-5 != ''">
            <marc:subfield code="5">
              <xsl:value-of select="$v583-5"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:awards" mode="generate-586">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="./@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">586</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>8</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <marc:subfield code="a">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="."/>
        </xsl:call-template>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:note/bf:Note[rdf:type/@rdf:resource = 'http://id.loc.gov/vocabulary/mnotetype/award']" mode="generate-586">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">586</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>8</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 586 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 586 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       bf:Work/bf:genreForm/*[bflc:marcKey or marc:record] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'd-nb.info/gnd/') and not(contains(@rdf:resource, '#'))] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'd-nb.info/gnd/') and not(contains(@rdf:about, '#'))] |       bf:Work/bf:genreForm[contains(@rdf:resource, 'id.worldcat.org/fast/')] |       bf:Work/bf:genreForm/*[contains(@rdf:about, 'id.worldcat.org/fast/')] |       //bf:Item/bf:genreForm[contains(@rdf:resource, 'id.loc.gov') and not(contains(@rdf:resource, '/vocabulary/')) and not(contains(@rdf:resource, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[contains(@rdf:about, 'id.loc.gov') and not(contains(@rdf:about, '/vocabulary/')) and not(contains(@rdf:about, 'REPLACE'))] |       //bf:Item/bf:genreForm/*[bflc:marcKey or marc:record]        " mode="generate-vGenreTag">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="relURI">
      <xsl:choose>
        <xsl:when test="contains(@rdf:resource,'id.loc') and not(contains(@rdf:resource, 'REPLACE'))">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'id.loc') and not(contains(@rdf:about, 'REPLACE'))">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:resource,'d-nb.info/gnd/') and not(contains(@rdf:resource, '#'))">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'d-nb.info/gnd/') and not(contains(@rdf:about, '#'))">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:resource,'id.worldcat.org/fast/')">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'id.worldcat.org/fast/')">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vRelResourcePreNS">
      <xsl:call-template name="tGetRelResource">
        <xsl:with-param name="pRelUri" select="$relURI"/>
        <xsl:with-param name="pContext" select="."/>
      </xsl:call-template>
    </xsl:variable>
    <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
    <xsl:variable name="vGenreTag">
      <xsl:choose>
        <xsl:when test="$vRelResource//marc:record">
          <xsl:choose>
            <xsl:when test="(self::bf:genreForm or ancestor::bf:genreForm) and contains($relURI, 'd-nb.info/gnd/')">
              <xsl:text>655</xsl:text>
            </xsl:when>
            <xsl:when test="$vRelResource//marc:datafield[@tag='155']">
              <xsl:text>655</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vValidSubfields">
      <xsl:choose>
        <xsl:when test="$vGenreTag='655'">
          <xsl:text>a</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vGenreTag"/>
      </xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="$vGenreTag = '630'">
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind2">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vGenreTag.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vGenreTag.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="contains($relURI, '/subjects/') or contains($relURI, '/names/')">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="contains($relURI, '/childrensSubjects/')">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="contains($relURI, '/mesh/')">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="contains($relURI, '/nalt/')">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:when test="contains($relURI, '/names/') or contains($relURI, '/genreForms/') or              contains($relURI, '/demographicTerms/') or contains($relURI, '/graphicMaterials/') or              contains($relURI, '/fast/') or             contains($relURI, 'd-nb.info/gnd/')">
              <xsl:text>7</xsl:text>
            </xsl:when>
            <xsl:when test="madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/subjects'] or              bf:source[@rdf:resource='http://id.loc.gov/authorities/subjects']">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects'] or              bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects']">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh']">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal']">
              <xsl:text>3</xsl:text>
            </xsl:when>
            <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash']">
              <xsl:text>5</xsl:text>
            </xsl:when>
            <xsl:when test="bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm']">
              <xsl:text>6</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>4</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
        <marc:subfield>
          <xsl:attribute name="code">
            <xsl:value-of select="@code"/>
          </xsl:attribute>
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains('vxyz',@code)]">
        <marc:subfield>
          <xsl:attribute name="code">
            <xsl:value-of select="@code"/>
          </xsl:attribute>
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:variable name="vvGenreTag-2">
        <xsl:choose>
          <xsl:when test="contains($relURI, '/genreForms/')">
            <xsl:text>lcgft</xsl:text>
          </xsl:when>
          <xsl:when test="contains($relURI, '/demogrpahicTerms/')">
            <xsl:text>lcdgt</xsl:text>
          </xsl:when>
          <xsl:when test="contains($relURI, '/graphicMaterials/')">
            <xsl:text>lctgm</xsl:text>
          </xsl:when>
          <xsl:when test="contains($relURI, '/fast/')">
            <xsl:text>fast</xsl:text>
          </xsl:when>
          <xsl:when test="contains($relURI, 'd-nb.info/gnd/')">
            <xsl:text>gnd</xsl:text>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$vvGenreTag-2 != ''">
        <marc:subfield code="2">
          <xsl:value-of select="$vvGenreTag-2"/>
        </marc:subfield>
      </xsl:if>
      <xsl:choose>
        <xsl:when test="$relURI != ''">
          <xsl:variable name="vvGenreTag-0">
            <xsl:value-of select="$relURI"/>
          </xsl:variable>
          <xsl:if test="$vvGenreTag-0 != ''">
            <marc:subfield code="0">
              <xsl:value-of select="$vvGenreTag-0"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="contains($relURI, 'id.worldcat.org/fast')">
          <xsl:variable name="vvGenreTag-0">
            <xsl:variable name="vFastID">
              <xsl:call-template name="tPadLeft">
                <xsl:with-param name="pInput" select="substring-after($relURI,'http://id.worldcat.org/fast/')"/>
                <xsl:with-param name="pPadChar" select="'0'"/>
                <xsl:with-param name="pStringLength" select="'8'"/>
              </xsl:call-template>
            </xsl:variable>
            <xsl:value-of select="concat('(OCoLC)fst', $vFastID)"/>
          </xsl:variable>
          <xsl:if test="$vvGenreTag-0 != ''">
            <marc:subfield code="0">
              <xsl:value-of select="$vvGenreTag-0"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ] |                      //bf:Item/bf:genreForm[                       not(@rdf:resource) and                        (                         not(contains(bf:*/@rdf:about, '/authorities/')) and                          (*/rdfs:label or */madsrdf:authoritativeLabel)                       ) and                       not(*/marc:record) and not(*/bflc:marcKey)                     ]" mode="generate-655">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="relURI">
      <xsl:choose>
        <xsl:when test="not(contains(.,'example.org')) and not(contains(bf:*/@rdf:about, 'REPLACE'))">
          <xsl:value-of select="bf:*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vInd2Val">
      <xsl:choose>
        <xsl:when test="*/bf:source/bf:Source/bf:code='lcsh' or             */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/subjects' or */@rdf:about='http://id.loc.gov/authorities/subjects'] or             */bf:source[@rdf:resource='http://id.loc.gov/authorities/subjects' or */@rdf:about='http://id.loc.gov/authorities/subjects'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcsh'">
          <xsl:text>0</xsl:text>
        </xsl:when>
        <xsl:when test="*/bf:source/bf:Source/bf:code='lcshac' or             */madsrdf:isMemberOfMADSScheme[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or             */bf:source[@rdf:resource='http://id.loc.gov/authorities/childrensSubjects' or */@rdf:about='http://id.loc.gov/authorities/childrensSubjects'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='lcshac'">
          <xsl:text>1</xsl:text>
        </xsl:when>
        <xsl:when test="*/bf:source/bf:Source/bf:code='mesh' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/mesh' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/mesh'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='mesh'">
          <xsl:text>2</xsl:text>
        </xsl:when>
        <xsl:when test="*/bf:source/bf:Source/bf:code='nal' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/nal' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/nal'] or             */madsrdf:componentList/*[1]/*/bf:source/bf:Source/bf:code='nal'">
          <xsl:text>3</xsl:text>
        </xsl:when>
        <xsl:when test="*/bf:source/bf:Source/bf:code='cash' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/cash' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/cash'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='cash'">
          <xsl:text>5</xsl:text>
        </xsl:when>
        <xsl:when test="*/bf:source/bf:Source/bf:code='rvm' or             */bf:source[@rdf:resource='http://id.loc.gov/vocabulary/subjectSchemes/rvm' or */@rdf:about='http://id.loc.gov/vocabulary/subjectSchemes/rvm'] or             */madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code='rvm'">
          <xsl:text>6</xsl:text>
        </xsl:when>
        <xsl:when test="contains($relURI, '/vocabulary/rbmscv/')">
          <xsl:text>7</xsl:text>
        </xsl:when>
        <xsl:when test="*/bf:source or */madsrdf:componentList/*[1]/bf:source">
          <xsl:text>7</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vSf2val">
      <xsl:choose>
        <xsl:when test="$vInd2Val = '7' and contains($relURI, '/vocabulary/rbmscv/')">
          <xsl:text>rbmscv</xsl:text>
        </xsl:when>
        <xsl:when test="$vInd2Val = '7'">
          <xsl:for-each select="*/bf:source|*/madsrdf:componentList/*[1]/bf:source">
            <xsl:variable name="vSourceUri">
              <xsl:choose>
                <xsl:when test="@rdf:resource">
                  <xsl:value-of select="@rdf:resource"/>
                </xsl:when>
                <xsl:when test="*/@rdf:about">
                  <xsl:value-of select="*/@rdf:about"/>
                </xsl:when>
              </xsl:choose>
            </xsl:variable>
            <xsl:choose>
              <xsl:when test="bf:Source/bf:code">
                <xsl:value-of select="bf:Source/bf:code"/>
              </xsl:when>
              <xsl:when test="$vSourceUri != ''">
                <xsl:choose>
                  <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vSourceUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vSourceUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="bf:Source/rdfs:label"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="*/rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">655</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="$vInd2Val != ''">
              <xsl:value-of select="$vInd2Val"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>4</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="*/madsrdf:componentList">
          <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="3">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:variable name="v655-a">
            <xsl:choose>
              <xsl:when test="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                <xsl:for-each select="*/madsrdf:componentList/*[1]/madsrdf:authoritativeLabel">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:otherwise>
                <xsl:for-each select="*/madsrdf:componentList/*[1]/rdfs:label">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v655-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v655-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:for-each select="*/madsrdf:componentList/*">
            <xsl:choose>
              <xsl:when test="position() &gt; 1">
                <xsl:choose>
                  <xsl:when test="local-name()='GenreForm' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#GenreForm']">
                    <xsl:variable name="v655-v">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $v.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $v.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v655-v != ''">
                      <marc:subfield code="v">
                        <xsl:value-of select="$v655-v"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='Temporal' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Temporal']">
                    <xsl:variable name="v655-y">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $y.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $y.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v655-y != ''">
                      <marc:subfield code="y">
                        <xsl:value-of select="$v655-y"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:when test="local-name()='Geographic' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Geographic']">
                    <xsl:variable name="v655-z">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $z.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $z.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v655-z != ''">
                      <marc:subfield code="z">
                        <xsl:value-of select="$v655-z"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:variable name="v655-x">
                      <xsl:choose>
                        <xsl:when test="madsrdf:authoritativeLabel">
                          <xsl:for-each select="madsrdf:authoritativeLabel">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $x.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:for-each select="rdfs:label">
                            <xsl:choose>
                              <xsl:when test="position() = 1">
                                <xsl:call-template name="tChopPunct">
                                  <xsl:with-param name="pString" select="."/>
                                </xsl:call-template>
                              </xsl:when>
                              <xsl:otherwise>
                                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $x.</xsl:message>
                              </xsl:otherwise>
                            </xsl:choose>
                          </xsl:for-each>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:variable>
                    <xsl:if test="$v655-x != ''">
                      <marc:subfield code="x">
                        <xsl:value-of select="$v655-x"/>
                      </marc:subfield>
                    </xsl:if>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="*/@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
            <marc:subfield code="0">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
            <marc:subfield code="0">
              <xsl:variable name="vIdType">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vIdType != ''">
                  <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="rdf:value"/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="*/madsrdf:authoritativeLabel or */rdfs:label">
          <xsl:for-each select="*/bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="3">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $3.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:variable name="v655-a">
            <xsl:choose>
              <xsl:when test="*/madsrdf:authoritativeLabel">
                <xsl:for-each select="*/madsrdf:authoritativeLabel[1]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:when>
              <xsl:otherwise>
                <xsl:for-each select="*/rdfs:label[1]">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $a.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$v655-a != ''">
            <marc:subfield code="a">
              <xsl:value-of select="$v655-a"/>
            </marc:subfield>
          </xsl:if>
          <xsl:choose>
            <xsl:when test="$relURI != ''">
              <xsl:variable name="v655-0">
                <xsl:value-of select="$relURI"/>
              </xsl:variable>
              <xsl:if test="$v655-0 != ''">
                <marc:subfield code="0">
                  <xsl:value-of select="$v655-0"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="*/bf:identifiedBy/bf:Identifier">
            <marc:subfield code="0">
              <xsl:variable name="vIdType">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vIdType != ''">
                  <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="rdf:value"/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="v655-2">
        <xsl:choose>
          <xsl:when test="$vSf2val != ''">
            <xsl:value-of select="$vSf2val"/>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v655-2 != ''">
        <marc:subfield code="2">
          <xsl:value-of select="$v655-2"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="*/bflc:applicableInstitution/*/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="5">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 655 $5.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent[contains(@rdf:resource, 'id.loc.gov/authorities/') or contains(@rdf:resource, 'id.loc.gov/rwo/')] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/bf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)] |       //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/madsrdf:*[(contains(@rdf:about, 'id.loc.gov/authorities/') or contains(@rdf:about, 'id.loc.gov/rwo/')) and not(bflc:marcKey)]       " mode="generate-vAddedEntryNameLookupTag">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="relURI">
      <xsl:choose>
        <xsl:when test="contains(@rdf:resource,'id.loc.gov')">
          <xsl:value-of select="@rdf:resource"/>
        </xsl:when>
        <xsl:when test="contains(@rdf:about,'id.loc.gov')">
          <xsl:value-of select="@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vRelResourcePreNS">
      <xsl:call-template name="tGetRelResource">
        <xsl:with-param name="pRelUri" select="$relURI"/>
        <xsl:with-param name="pContext" select="."/>
      </xsl:call-template>
    </xsl:variable>
    <xsl:variable name="vRelResource" select="exsl:node-set($vRelResourcePreNS)"/>
    <xsl:variable name="vAddedEntryNameLookupTag">
      <xsl:choose>
        <xsl:when test="$vRelResource//marc:datafield[@tag!='']">
          <xsl:choose>
            <xsl:when test="$vRelResource//marc:datafield[@tag='100']">
              <xsl:text>700</xsl:text>
            </xsl:when>
            <xsl:when test="$vRelResource//marc:datafield[@tag='110']">
              <xsl:text>710</xsl:text>
            </xsl:when>
            <xsl:when test="$vRelResource//marc:datafield[@tag='111']">
              <xsl:text>711</xsl:text>
            </xsl:when>
            <xsl:when test="$vRelResource//marc:datafield[@tag='151']">
              <xsl:text>710</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vValidSubfields">
      <xsl:choose>
        <xsl:when test="$vAddedEntryNameLookupTag='700'">
          <xsl:text>abcdgjq</xsl:text>
        </xsl:when>
        <xsl:when test="$vAddedEntryNameLookupTag='710'">
          <xsl:text>abcdgn</xsl:text>
        </xsl:when>
        <xsl:when test="$vAddedEntryNameLookupTag='711'">
          <xsl:text>acdegnq</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vAddedEntryNameLookupTag"/>
      </xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:for-each select="$vRelResource//marc:datafield[@tag='110']/@ind1">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <xsl:value-of select="."/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddedEntryNameLookupTag.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:value-of select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/@ind1"/>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="$vRelResource//marc:datafield[starts-with(@tag, '1')]">
          <xsl:for-each select="$vRelResource//marc:datafield[starts-with(@tag, '1')]/marc:subfield[contains($vValidSubfields,@code)]">
            <marc:subfield>
              <xsl:attribute name="code">
                <xsl:value-of select="@code"/>
              </xsl:attribute>
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="             ancestor::node()/bf:role/bf:Role/rdfs:label[.!='Contributor']|             ancestor::node()/bf:role/bf:Role/madsrdf:authoritativeLabel[.!='Contributor']">
        <marc:subfield code="e">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="           ancestor::node()/bf:role/bf:Role[not(rdfs:label) and not(madsrdf:authoritativeLabel)]/@rdf:about[not(contains(., 'relators/ctb'))] |            ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
        <xsl:variable name="vRelationURI">
          <xsl:choose>
            <xsl:when test="contains(.,'id.loc.gov/')">
              <xsl:value-of select="."/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vRelationLabel">
          <xsl:choose>
            <xsl:when test="$vRelationURI != ''">
              <xsl:call-template name="tGetLabel">
                <xsl:with-param name="pUri" select="$vRelationURI"/>
              </xsl:call-template>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:variable name="vvAddedEntryNameLookupTag-e"/>
        <xsl:if test="$vvAddedEntryNameLookupTag-e != ''">
          <marc:subfield code="e">
            <xsl:value-of select="$vvAddedEntryNameLookupTag-e"/>
          </marc:subfield>
        </xsl:if>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="ancestor::node()/bf:role/bf:Role/@rdf:about[not(contains(., 'relators/ctb'))] or ancestor::node()/bf:role/@rdf:resource[not(contains(., 'relators/ctb'))]">
          <xsl:for-each select="ancestor::node()/bf:role/bf:Role/@rdf:about | ancestor::node()/bf:role/@rdf:resource">
            <marc:subfield code="4">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="ancestor::node()/bf:role/bf:Role[bf:code[.!='ctb'] or madsrdf:code[.!='ctb']]">
          <xsl:for-each select="ancestor::node()/bf:role/bf:Role/*[local-name() = 'code']">
            <marc:subfield code="4">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/authorities/')">
          <xsl:variable name="vvAddedEntryNameLookupTag-0">
            <xsl:value-of select="$relURI"/>
          </xsl:variable>
          <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
            <marc:subfield code="0">
              <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="$relURI != '' and contains($relURI, 'id.loc.gov/rwo/agents/')">
          <xsl:variable name="vvAddedEntryNameLookupTag-0">
            <xsl:value-of select="concat(substring-before($relURI,'rwo/agents'), 'authorities/names/', substring-after($relURI,'rwo/agents/'))"/>
          </xsl:variable>
          <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
            <marc:subfield code="0">
              <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="not(contains($relURI,'example.org')) and not(contains($relURI,'REPLACE')) and not(contains($relURI,'rwo'))">
          <xsl:variable name="vvAddedEntryNameLookupTag-0">
            <xsl:value-of select="$relURI"/>
          </xsl:variable>
          <xsl:if test="$vvAddedEntryNameLookupTag-0 != ''">
            <marc:subfield code="0">
              <xsl:value-of select="$vvAddedEntryNameLookupTag-0"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$relURI != '' and (contains($relURI, '/agents/') or contains($relURI, '/gnd/'))">
          <xsl:variable name="vvAddedEntryNameLookupTag-1">
            <xsl:value-of select="$relURI"/>
          </xsl:variable>
          <xsl:if test="$vvAddedEntryNameLookupTag-1 != ''">
            <marc:subfield code="1">
              <xsl:value-of select="$vvAddedEntryNameLookupTag-1"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
        <xsl:when test="not(contains($relURI,'example.org')) and not(contains($relURI,'REPLACE')) and not(contains($relURI,'authorities'))">
          <xsl:variable name="vvAddedEntryNameLookupTag-1">
            <xsl:value-of select="$relURI"/>
          </xsl:variable>
          <xsl:if test="$vvAddedEntryNameLookupTag-1 != ''">
            <marc:subfield code="1">
              <xsl:value-of select="$vvAddedEntryNameLookupTag-1"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey) and not(bf:hasInstance)]/bf:contribution/*/bf:agent/* |                     bf:Work/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     bf:Instance/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:contribution/*[not(local-name()='PrimaryContribution') and not(rdf:type[contains(@rdf:resource, '/PrimaryContribution')])]/bf:agent/*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/* |                     //bf:Item/bf:hasPart/bf:*[(not(contains(@rdf:about, 'id.loc.gov')) or contains(@rdf:about, 'REPLACE')) and not(bflc:marcKey)]/bf:contribution/*/bf:agent/*" mode="generate-vAddEntryTag">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vNameAuthPreNS">
      <xsl:choose>
        <xsl:when test="bflc:marcKey">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pUri" select="@rdf:about"/>
            <xsl:with-param name="pContext" select="."/>
          </xsl:call-template>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vNameAuth" select="exsl:node-set($vNameAuthPreNS)"/>
    <xsl:variable name="vAddEntryTag">
      <xsl:choose>
        <xsl:when test="local-name()='Uncontrolled' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bflc/Uncontrolled']">
          <xsl:text>720</xsl:text>
        </xsl:when>
        <xsl:when test="local-name()='PersonalName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#PersonalName'] or                       local-name()='FamilyName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#FamilyName'] or                       local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person'] or                       local-name()='Family' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Family']">
          <xsl:text>700</xsl:text>
        </xsl:when>
        <xsl:when test="local-name()='CorporateName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CorporateName'] or                       local-name()='Organization' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Organization'] or                       local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
          <xsl:text>710</xsl:text>
        </xsl:when>
        <xsl:when test="local-name()='ConferenceName' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ConferenceName'] or                       local-name()='Meeting' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Meeting']">
          <xsl:text>711</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>720</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vNameAuthTag">
      <xsl:choose>
        <xsl:when test="$vAddEntryTag='710'">
          <xsl:text>110</xsl:text>
        </xsl:when>
        <xsl:when test="$vAddEntryTag='711'">
          <xsl:text>111</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>100</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vAuthSubfields">
      <xsl:choose>
        <xsl:when test="$vNameAuthTag='100'">
          <xsl:text>abcdgjq</xsl:text>
        </xsl:when>
        <xsl:when test="$vNameAuthTag='110'">
          <xsl:text>abcdgn</xsl:text>
        </xsl:when>
        <xsl:when test="$vNameAuthTag='111'">
          <xsl:text>acdegnq</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vSourceUri">
      <xsl:choose>
        <xsl:when test="bf:source/@rdf:resource">
          <xsl:value-of select="bf:source/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:source/bf:Source/@rdf:about">
          <xsl:value-of select="bf:source/bf:Source/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vWorkUri">
      <xsl:value-of select="../../../../@rdf:about"/>
    </xsl:variable>
    <xsl:variable name="vTitleResourcePreNS">
      <xsl:choose>
        <xsl:when test="../../../../bf:title/bf:Title/bflc:marcKey">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pUri" select="@rdf:about"/>
            <xsl:with-param name="pContext" select="../../../../bf:title/bf:Title"/>
          </xsl:call-template>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
    <xsl:variable name="vTitleTag">
      <xsl:choose>
        <xsl:when test="$vAddEntryTag='710'">
          <xsl:text>110</xsl:text>
        </xsl:when>
        <xsl:when test="$vAddEntryTag='711'">
          <xsl:text>111</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>100</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vTitleSubfields">
      <xsl:choose>
        <xsl:when test="$vTitleTag='100'">
          <xsl:text>fhklmnoprst</xsl:text>
        </xsl:when>
        <xsl:when test="$vTitleTag='110'">
          <xsl:text>fhklmnoprst</xsl:text>
        </xsl:when>
        <xsl:when test="$vTitleTag='111'">
          <xsl:text>fhklnpst</xsl:text>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vAddEntryTag"/>
      </xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]">
              <xsl:value-of select="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]/@ind1"/>
            </xsl:when>
            <xsl:when test="$vAddEntryTag='700'">
              <xsl:choose>
                <xsl:when test="contains(local-name(),'Family')">
                  <xsl:text>3</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text>1</xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:when>
            <xsl:when test="$vAddEntryTag='710'">
              <xsl:choose>
                <xsl:when test="local-name()='Jurisdiction' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Jurisdiction']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
              </xsl:choose>
            </xsl:when>
            <xsl:when test="$vAddEntryTag='720'">
              <xsl:choose>
                <xsl:when test="local-name()='Person' or rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Person']">
                  <xsl:text>1</xsl:text>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:text> </xsl:text>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>2</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="ancestor::bf:hasPart">
              <xsl:text>2</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="$vAddEntryTag='720'">
          <xsl:for-each select="rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
            <marc:subfield code="e">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="translate(., $upper, $lower)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="translate(., $upper, $lower)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
            <marc:subfield code="4">
              <xsl:choose>
                <xsl:when test="madsrdf:code">
                  <xsl:for-each select="madsrdf:code">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="bf:code">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
            <marc:subfield code="4">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label|../../../../bflc:appliesTo/bflc:AppliesTo/rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="3">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $3.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="../../../../../../bflc:relationship/bflc:Relationship[bf:relatedTo/@rdf:resource=$vWorkUri]/bflc:relation/bflc:Relation/rdfs:label">
            <marc:subfield code="i">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]">
              <xsl:for-each select="exsl:node-set($vNameAuth)//marc:datafield[@tag=$vNameAuthTag]/marc:subfield[contains($vAuthSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:variable name="vvAddEntryTag-a">
                <xsl:choose>
                  <xsl:when test="madsrdf:elementList">
                    <xsl:for-each select="madsrdf:elementList/*[1]/madsrdf:elementValue">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:when test="madsrdf:authoritativeLabel">
                    <xsl:for-each select="madsrdf:authoritativeLabel">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:for-each select="rdfs:label">
                      <xsl:choose>
                        <xsl:when test="position() = 1">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $a.</xsl:message>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:for-each>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$vvAddEntryTag-a != ''">
                <marc:subfield code="a">
                  <xsl:value-of select="$vvAddEntryTag-a"/>
                </marc:subfield>
              </xsl:if>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='710'">
                  <xsl:for-each select="madsrdf:elementList/*[position() &gt; 1]/madsrdf:elementValue">
                    <marc:subfield code="b">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='700'">
                  <xsl:for-each select="madsrdf:elementList/madsrdf:TermsOfAddressNameElement/madsrdf:elementValue">
                    <marc:subfield code="c">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='711'">
                  <xsl:for-each select="madsrdf:elementList/*[local-name()='GeographicElement' and position() &gt; 1]/madsrdf:elementValue">
                    <marc:subfield code="c">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='700'">
                  <xsl:for-each select="madsrdf:elementList/madsrdf:DateNameElement/madsrdf:elementValue">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="d">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $d.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='700'">
                  <xsl:for-each select="madsrdf:fullerName/*/rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <marc:subfield code="q">
                          <xsl:call-template name="tChopPunct">
                            <xsl:with-param name="pString" select="."/>
                          </xsl:call-template>
                        </marc:subfield>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $q.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
              <xsl:choose>
                <xsl:when test="$vAddEntryTag='711'">
                  <xsl:for-each select="madsrdf:elementList/*[local-name()='NameElement' and position() &gt; 1]/madsrdf:elementValue">
                    <marc:subfield code="q">
                      <xsl:call-template name="tChopPunct">
                        <xsl:with-param name="pString" select="."/>
                      </xsl:call-template>
                    </marc:subfield>
                  </xsl:for-each>
                </xsl:when>
              </xsl:choose>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:choose>
            <xsl:when test="$vAddEntryTag='711'">
              <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                <marc:subfield code="j">
                  <xsl:choose>
                    <xsl:when test="madsrdf:authoritativeLabel">
                      <xsl:for-each select="madsrdf:authoritativeLabel">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $j.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:call-template name="tChopPunct">
                              <xsl:with-param name="pString" select="."/>
                            </xsl:call-template>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $j.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="../../bf:role/*[rdfs:label or madsrdf:authoritativeLabel]">
                <marc:subfield code="e">
                  <xsl:choose>
                    <xsl:when test="madsrdf:authoritativeLabel">
                      <xsl:for-each select="madsrdf:authoritativeLabel">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="translate(., $upper, $lower)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:for-each select="rdfs:label">
                        <xsl:choose>
                          <xsl:when test="position() = 1">
                            <xsl:value-of select="translate(., $upper, $lower)"/>
                          </xsl:when>
                          <xsl:otherwise>
                            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $e.</xsl:message>
                          </xsl:otherwise>
                        </xsl:choose>
                      </xsl:for-each>
                    </xsl:otherwise>
                  </xsl:choose>
                </marc:subfield>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:for-each select="../../bf:role/*[madsrdf:code or bf:code]">
            <marc:subfield code="4">
              <xsl:choose>
                <xsl:when test="madsrdf:code">
                  <xsl:for-each select="madsrdf:code">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="bf:code">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $4.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="../../bf:role/bf:Role/@rdf:about|../../bf:role/@rdf:resource">
            <marc:subfield code="4">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and                                          not(contains(.,'REPLACE')) and                                          not(contains(., 'id.oclc.org/worldcat/entity/')) and                                         not(contains(., 'isni.org/isni/')) and                                         (contains(., 'viaf.org/') and contains(., '#'))]">
            <marc:subfield code="0">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:identifiedBy/bf:Identifier">
            <marc:subfield code="0">
              <xsl:variable name="vIdType">
                <xsl:call-template name="tChopPunct">
                  <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="$vIdType != ''">
                  <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:value-of select="rdf:value"/>
                </xsl:otherwise>
              </xsl:choose>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="@rdf:about[                             contains(., 'id.oclc.org/worldcat/entity/') or                              contains(., 'isni.org/isni/') or                             (contains(., 'viaf.org/') and not(contains(., '#')))]">
            <marc:subfield code="1">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="exsl:node-set($vTitleResource)//marc:datafield[@tag=$vTitleTag]">
              <xsl:for-each select="exsl:node-set($vTitleResource)//marc:datafield[@tag=$vTitleTag]/marc:subfield[contains($vTitleSubfields,@code)]">
                <marc:subfield>
                  <xsl:attribute name="code">
                    <xsl:value-of select="@code"/>
                  </xsl:attribute>
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="ancestor::bf:Hub">
                <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="t">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $t.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:legalDate">
                  <marc:subfield code="d">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="bf:originDate">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="f">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $f.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
                  <marc:subfield code="m">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partNumber">
                  <marc:subfield code="n">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:partName">
                  <marc:subfield code="p">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:for-each>
                <xsl:for-each select="bf:musicKey">
                  <xsl:choose>
                    <xsl:when test="position() = 1">
                      <marc:subfield code="r">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </marc:subfield>
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $r.</xsl:message>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:for-each>
                <xsl:for-each select="bf:version">
                  <marc:subfield code="s">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:for-each>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
          <xsl:for-each select="ancestor::bf:Hub">
            <xsl:for-each select="bf:identifier/*[local-name()=Issn or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <marc:subfield code="x">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </marc:subfield>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $x.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
            <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
              <marc:subfield code="0">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
            <xsl:for-each select="bf:identifiedBy/bf:Identifier">
              <marc:subfield code="0">
                <xsl:variable name="vIdType">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="$vIdType != ''">
                    <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="rdf:value"/>
                  </xsl:otherwise>
                </xsl:choose>
              </marc:subfield>
            </xsl:for-each>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="$vSourceUri != '' or bf:source/bf:Source/bf:code or bf:source/bf:Source/rdfs:label">
              <xsl:variable name="vvAddEntryTag-2">
                <xsl:choose>
                  <xsl:when test="bf:source/bf:Source/bf:code">
                    <xsl:value-of select="bf:source/bf:Source/bf:code"/>
                  </xsl:when>
                  <xsl:when test="$vSourceUri != ''">
                    <xsl:choose>
                      <xsl:when test="contains($vSourceUri,'id.loc.gov')">
                        <xsl:call-template name="tUriCode">
                          <xsl:with-param name="pUri" select="$vSourceUri"/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$vSourceUri"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="bf:source/bf:Source/rdfs:label"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:if test="$vvAddEntryTag-2 != ''">
                <marc:subfield code="2">
                  <xsl:value-of select="$vvAddEntryTag-2"/>
                </marc:subfield>
              </xsl:if>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="../../bflc:applicableInstitution/*/bf:code">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="5">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vAddEntryTag $5.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:relation/bf:Relation/bf:associatedResource/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:relatedTo/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     bf:Work/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)] |                     //bf:Item/bf:hasPart/bf:Hub[not(bf:contribution) and not(contains(@rdf:about, 'hubs')) and not(bflc:marcKey)]" mode="generate-730">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vTitleResourcePreNS">
      <xsl:choose>
        <xsl:when test="bf:title/bf:Title/bflc:marcKey">
          <xsl:call-template name="tGetRelResource">
            <xsl:with-param name="pUri" select="@rdf:about"/>
            <xsl:with-param name="pContext" select="bf:title/bf:Title"/>
          </xsl:call-template>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vTitleResource" select="exsl:node-set($vTitleResourcePreNS)"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">730</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:nonSortNum">
              <xsl:value-of select="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:nonSortNum"/>
            </xsl:when>
            <xsl:when test="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey and (string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey) &lt; string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:mainTitle))">
              <xsl:value-of select="string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bf:mainTitle) - string-length(bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))][1]/bflc:titleSortKey)"/>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>0</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name(parent::*)='hasPart'">
              <xsl:text>2</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:variable name="vNodeUri" select="@rdf:about"/>
      <xsl:for-each select="../../bflc:relationship/bflc:Relationship[bf:relatedTo/@rdf:resource=$vNodeUri or bf:relatedTo=$vNodeUri]/bflc:relation/bflc:Relation/rdfs:label">
        <marc:subfield code="i">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="$vTitleResource//marc:datafield[@tag='130']">
          <xsl:for-each select="$vTitleResource//marc:datafield[@tag='130']/marc:subfield[contains('adfghklmnoprst',@code)]">
            <marc:subfield>
              <xsl:attribute name="code">
                <xsl:value-of select="@code"/>
              </xsl:attribute>
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:otherwise>
          <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="a">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $a.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:legalDate">
            <marc:subfield code="d">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:originDate">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="f">
                  <xsl:value-of select="."/>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $f.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
          <xsl:for-each select="bf:musicMedium/bf:MusicMedium/rdfs:label">
            <marc:subfield code="m">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:title/bf:Title/bf:partNumber">
            <marc:subfield code="n">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:title/bf:Title/bf:partName">
            <marc:subfield code="p">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:choose>
            <xsl:when test="rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Arrangement'">
              <marc:subfield code="o">arranged</marc:subfield>
            </xsl:when>
          </xsl:choose>
          <xsl:for-each select="bf:musicKey">
            <marc:subfield code="r">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:version">
            <marc:subfield code="s">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
          <xsl:for-each select="bf:identifier/*[local-name()=Issn or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="x">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $x.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:otherwise>
      </xsl:choose>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <marc:subfield code="2">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:applicableInstitution/*/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="5">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 730 $5.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:place/*[local-name()='HierarchicalGeographic' or rdf:type/@rdf:resource='http://www.loc.gov/mads/rdf/v1#HierarchicalGeographic']" mode="generate-752">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">752</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="madsrdf:componentList/*">
        <xsl:choose>
          <xsl:when test="local-name()='Country' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Country']">
            <xsl:variable name="v752-a">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $a.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-a != ''">
              <marc:subfield code="a">
                <xsl:value-of select="$v752-a"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='State' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#State']">
            <xsl:variable name="v752-b">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $b.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $b.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-b != ''">
              <marc:subfield code="b">
                <xsl:value-of select="$v752-b"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='County' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#County']">
            <xsl:variable name="v752-c">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $c.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $c.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-c != ''">
              <marc:subfield code="c">
                <xsl:value-of select="$v752-c"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='City' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#City']">
            <xsl:variable name="v752-d">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $d.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $d.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-d != ''">
              <marc:subfield code="d">
                <xsl:value-of select="$v752-d"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='CitySection' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#CitySection']">
            <xsl:variable name="v752-f">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $f.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-f != ''">
              <marc:subfield code="f">
                <xsl:value-of select="$v752-f"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='Region' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#Region']">
            <xsl:variable name="v752-g">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $g.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $g.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-g != ''">
              <marc:subfield code="g">
                <xsl:value-of select="$v752-g"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='ExtraterrestrialArea' or rdf:type[@rdf:resource='http://www.loc.gov/mads/rdf/v1#ExtraterrestrialArea']">
            <xsl:variable name="v752-h">
              <xsl:choose>
                <xsl:when test="madsrdf:authoritativeLabel">
                  <xsl:for-each select="madsrdf:authoritativeLabel">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $h.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdfs:label">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:call-template name="tChopPunct">
                          <xsl:with-param name="pString" select="."/>
                        </xsl:call-template>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $h.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$v752-h != ''">
              <marc:subfield code="h">
                <xsl:value-of select="$v752-h"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[rdfs:label or madsrdf:authoritativeLabel]">
        <marc:subfield code="e">
          <xsl:choose>
            <xsl:when test="madsrdf:authoritativeLabel">
              <xsl:for-each select="madsrdf:authoritativeLabel">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $e.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $e.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[madsrdf:code or bf:code]">
        <marc:subfield code="4">
          <xsl:choose>
            <xsl:when test="madsrdf:code">
              <xsl:for-each select="madsrdf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*/@rdf:about|bflc:relationship/bflc:Relationship/bflc:relation/@rdf:resource">
        <marc:subfield code="4">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code|*/madsrdf:componentList/*[1]/bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 752 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance/bf:systemRequirement/*[       local-name() = 'MachineModel' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/MachineModel' or       local-name() = 'ProgrammingLanguage' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/ProgrammingLanguage' or       local-name() = 'OperatingSystem' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/OperatingSystem']" mode="generate-753">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">753</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="local-name() = 'MachineModel' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/MachineModel'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name() = 'ProgrammingLanguage' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/ProgrammingLanguage'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
        <xsl:when test="local-name() = 'OperatingSystem' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/OperatingSystem'">
          <xsl:for-each select="rdfs:label">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="@rdf:about[not(contains(.,'example.org')) and not(contains(.,'REPLACE'))]">
        <marc:subfield code="0">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/bf:Identifier">
        <marc:subfield code="0">
          <xsl:variable name="vIdType">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="bf:source/bf:Source/bf:code"/>
            </xsl:call-template>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="$vIdType != ''">
              <xsl:value-of select="concat('(',$vIdType,')',rdf:value)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="rdf:value"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:source/bf:Source/bf:code">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="2">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element 753 $2.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       bf:Work/bf:relation/bf:Relation[bf:relationship/@rdf:resource and bf:associatedResource/@rdf:resource] |       bf:Work/bf:relation/bf:Relation[bf:relationship/bf:Relationship/rdfs:label and bf:associatedResource/@rdf:resource] |       bf:Work/bflc:relationship/bflc:Relationship[bflc:relation/@rdf:resource and bf:relatedTo/@rdf:resource] |       bf:Work/bflc:relationship/bflc:Relationship[bflc:relation/bflc:Relation/rdfs:label and bf:relatedTo/@rdf:resource]" mode="generate-758">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">758</xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:for-each select="bf:relationship/@rdf:resource|bf:relationship/bf:Relationship/@rdf:about|bflc:relation/@rdf:resource|bflc:relation/bflc:Relation/@rdf:about">
        <marc:subfield code="4">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:relationship/bf:Relationship/rdfs:label|bflc:relation/bflc:Relation/rdfs:label">
        <marc:subfield code="i">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:associatedResource/@rdf:resource|bf:relatedTo/@rdf:resource">
        <marc:subfield code="1">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       bf:Work/@rdf:about |       bf:Instance[not(rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bflc/SecondaryInstance')][1]/@rdf:about" mode="generate-758">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <marc:datafield>
      <xsl:attribute name="tag">758</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:text> </xsl:text>
      </xsl:attribute>
      <xsl:variable name="v758-4">
        <xsl:choose>
          <xsl:when test="ancestor::bf:Work">
            <xsl:text>http://id.loc.gov/ontologies/bibframe/instanceOf</xsl:text>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v758-4 != ''">
        <marc:subfield code="4">
          <xsl:value-of select="$v758-4"/>
        </marc:subfield>
      </xsl:if>
      <marc:subfield code="1">
        <xsl:value-of select="."/>
      </marc:subfield>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'subseries') or contains(bf:Relationship/@rdf:about, 'subseries')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'series') or contains(bf:Relationship/@rdf:about, 'series')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translationof') or contains(bf:Relationship/@rdf:about, 'translationof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translatedas') or contains(bf:Relationship/@rdf:about, 'translatedas')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplementto') or contains(bf:Relationship/@rdf:about, 'supplementto')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplement') or contains(bf:Relationship/@rdf:about, 'supplement')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'partof') or contains(bf:Relationship/@rdf:about, 'partof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, '/part') or contains(bf:Relationship/@rdf:about, '/part')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otheredition') or contains(bf:Relationship/@rdf:about, 'otheredition')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'revisionof') or contains(bf:Relationship/@rdf:about, 'revisionof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otherphysicalformat') or contains(bf:Relationship/@rdf:about, 'otherphysicalformat')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'issuedwith') or contains(bf:Relationship/@rdf:about, 'issuedwith')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedinpart') or contains(bf:Relationship/@rdf:about, 'continuedinpart')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuationof') or contains(bf:Relationship/@rdf:about, 'continuationof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'precededby') or contains(bf:Relationship/@rdf:about, 'precededby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergerof') or contains(bf:Relationship/@rdf:about, 'mergerof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorbedby') or contains(bf:Relationship/@rdf:about, 'absorbedby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorptionof') or contains(bf:Relationship/@rdf:about, 'absorptionof')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'separatedby') or contains(bf:Relationship/@rdf:about, 'separatedby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedby') or contains(bf:Relationship/@rdf:about, 'continuedby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedinpartby') or contains(bf:Relationship/@rdf:about, 'continuedinpartby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'succeededby') or contains(bf:Relationship/@rdf:about, 'succeededby')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'splitinto') or contains(bf:Relationship/@rdf:about, 'splitinto')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergedtoform') or contains(bf:Relationship/@rdf:about, 'mergedtoform')]]/bf:mergedWith/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergedtoform') or contains(bf:Relationship/@rdf:about, 'mergedtoform')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'datasource') or contains(bf:Relationship/@rdf:about, 'datasource')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'relatedwork') or contains(bf:Relationship/@rdf:about, 'relatedwork')]]/bf:associatedResource/bf:*[bf:hasInstance] |              bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasSubseries') or contains(bf:Relationship/@rdf:about, 'hasSubseries')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translationOf') or contains(bf:Relationship/@rdf:about, 'translationOf')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'translation') or contains(bf:Relationship/@rdf:about, 'translation')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplementTo') or contains(bf:Relationship/@rdf:about, 'supplementTo')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'supplement') or contains(bf:Relationship/@rdf:about, 'supplement')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'partOf') or contains(bf:Relationship/@rdf:about, 'partOf')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'hasPart') or contains(bf:Relationship/@rdf:about, 'hasPart')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otherEdition') or contains(bf:Relationship/@rdf:about, 'otherEdition')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'otherPhysicalFormat') or contains(bf:Relationship/@rdf:about, 'otherPhysicalFormat')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'issuedWith') or contains(bf:Relationship/@rdf:about, 'issuedWith')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuesInPart') or contains(bf:Relationship/@rdf:about, 'continuesInPart')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'precededBy') or contains(bf:Relationship/@rdf:about, 'precededBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergerOf') or contains(bf:Relationship/@rdf:about, 'mergerOf')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorbedBy') or contains(bf:Relationship/@rdf:about, 'absorbedBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'absorbed') or contains(bf:Relationship/@rdf:about, 'absorbed')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'separatedBy') or contains(bf:Relationship/@rdf:about, 'separatedBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedBy') or contains(bf:Relationship/@rdf:about, 'continuedBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'continuedInPartBy') or contains(bf:Relationship/@rdf:about, 'continuedInPartBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'succeededBy') or contains(bf:Relationship/@rdf:about, 'succeededBy')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'splitInto') or contains(bf:Relationship/@rdf:about, 'splitInto')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'mergedToForm') or contains(bf:Relationship/@rdf:about, 'mergedToForm')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'dataSource') or contains(bf:Relationship/@rdf:about, 'dataSource')]]/bf:associatedResource/bf:*[bf:hasInstance] |       bf:Work/bf:relation/bf:Relation[bf:relationship[contains(@rdf:resource, 'relatedTo') or contains(bf:Relationship/@rdf:about, 'relatedTo')]]/bf:associatedResource/bf:*[bf:hasInstance]       " mode="generate-vLinkTagFromWork2">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vLinkTagFromWork2">
      <xsl:choose>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'subseries') or contains(bf:Relationship/@rdf:about, 'subseries')]">
          <xsl:text>762</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'series') or contains(bf:Relationship/@rdf:about, 'series')]">
          <xsl:text>760</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'translationof') or contains(bf:Relationship/@rdf:about, 'translationof')]">
          <xsl:text>765</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'translatedas') or contains(bf:Relationship/@rdf:about, 'translatedas')]">
          <xsl:text>767</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'supplementto') or contains(bf:Relationship/@rdf:about, 'supplementto')]">
          <xsl:text>772</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'supplement') or contains(bf:Relationship/@rdf:about, 'supplement')]">
          <xsl:text>770</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'partof') or contains(bf:Relationship/@rdf:about, 'partof')]">
          <xsl:text>773</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, '/part') or contains(bf:Relationship/@rdf:about, '/part')]">
          <xsl:text>774</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'otheredition') or contains(bf:Relationship/@rdf:about, 'otheredition')]">
          <xsl:text>775</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'revisionof') or contains(bf:Relationship/@rdf:about, 'revisionof')]">
          <xsl:text>775</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'otherphysicalformat') or contains(bf:Relationship/@rdf:about, 'otherphysicalformat')]">
          <xsl:text>776</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'issuedwith') or contains(bf:Relationship/@rdf:about, 'issuedwith')]">
          <xsl:text>777</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedinpart') or contains(bf:Relationship/@rdf:about, 'continuedinpart')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'precededby') or contains(bf:Relationship/@rdf:about, 'precededby')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'succeededby') or contains(bf:Relationship/@rdf:about, 'succeededby')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergerof') or contains(bf:Relationship/@rdf:about, 'mergerof')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorbedby') or contains(bf:Relationship/@rdf:about, 'absorbedby')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorptionof') or contains(bf:Relationship/@rdf:about, 'absorptionof')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'separatedfrom') or contains(bf:Relationship/@rdf:about, 'separatedfrom')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedby') or contains(bf:Relationship/@rdf:about, 'continuedby')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedinpartby') or contains(bf:Relationship/@rdf:about, 'continuedinpartby')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'splitinto') or contains(bf:Relationship/@rdf:about, 'splitinto')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergedtoform') or contains(bf:Relationship/@rdf:about, 'mergedtoform')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'datasource') or contains(bf:Relationship/@rdf:about, 'datasource')]">
          <xsl:text>786</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'hasSeries') or contains(bf:Relationship/@rdf:about, 'hasSeries')]">
          <xsl:text>760</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'hasSubseries') or contains(bf:Relationship/@rdf:about, 'hasSubseries')]">
          <xsl:text>762</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'translationOf') or contains(bf:Relationship/@rdf:about, 'translationOf')]">
          <xsl:text>765</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'translation') or contains(bf:Relationship/@rdf:about, 'translation')]">
          <xsl:text>767</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'supplementTo') or contains(bf:Relationship/@rdf:about, 'supplementTo')]">
          <xsl:text>772</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'supplement') or contains(bf:Relationship/@rdf:about, 'supplement')]">
          <xsl:text>770</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'partOf') or contains(bf:Relationship/@rdf:about, 'partOf')]">
          <xsl:text>773</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'hasPart') or contains(bf:Relationship/@rdf:about, 'hasPart')]">
          <xsl:text>774</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'otherEdition') or contains(bf:Relationship/@rdf:about, 'otherEdition')]">
          <xsl:text>775</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'otherPhysicalFormat') or contains(bf:Relationship/@rdf:about, 'otherPhysicalFormat')]">
          <xsl:text>776</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'issuedWith') or contains(bf:Relationship/@rdf:about, 'issuedWith')]">
          <xsl:text>777</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuesInPart') or contains(bf:Relationship/@rdf:about, 'continuesInPart')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuationof') or contains(bf:Relationship/@rdf:about, 'continuationof')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'precededBy') or contains(bf:Relationship/@rdf:about, 'precededBy')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'succeededBy') or contains(bf:Relationship/@rdf:about, 'succeededBy')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergerOf') or contains(bf:Relationship/@rdf:about, 'mergerOf')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorbedBy') or contains(bf:Relationship/@rdf:about, 'absorbedBy')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorbed') or contains(bf:Relationship/@rdf:about, 'absorbed')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'separatedFrom') or contains(bf:Relationship/@rdf:about, 'separatedFrom')]">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedBy') or contains(bf:Relationship/@rdf:about, 'continuedBy')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedInPartBy') or contains(bf:Relationship/@rdf:about, 'continuedInPartBy')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'splitInto') or contains(bf:Relationship/@rdf:about, 'splitInto')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergedToForm') or contains(bf:Relationship/@rdf:about, 'mergedToForm')]">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'dataSource') or contains(bf:Relationship/@rdf:about, 'dataSource')]">
          <xsl:text>786</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>787</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vLanguageUri">
      <xsl:choose>
        <xsl:when test="bf:language/@rdf:resource">
          <xsl:value-of select="bf:language/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:language/*/@rdf:about">
          <xsl:value-of select="bf:language/*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vPlaceUri">
      <xsl:choose>
        <xsl:when test="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/@rdf:resource">
          <xsl:value-of select="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*/@rdf:about">
          <xsl:value-of select="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vRelStrs">
      <xsl:value-of select="'         http://id.loc.gov/vocabulary/relationship/subseries          http://id.loc.gov/vocabulary/relationship/series          http://id.loc.gov/vocabulary/relationship/translationof          http://id.loc.gov/vocabulary/relationship/translatedas          http://id.loc.gov/vocabulary/relationship/supplementto          http://id.loc.gov/vocabulary/relationship/supplement          http://id.loc.gov/vocabulary/relationship/partof          http://id.loc.gov/vocabulary/relationship/part          http://id.loc.gov/vocabulary/relationship/otheredition          http://id.loc.gov/vocabulary/relationship/otherphysicalformat          http://id.loc.gov/vocabulary/relationship/issuedwith          http://id.loc.gov/vocabulary/relationship/continuedinpart          http://id.loc.gov/vocabulary/relationship/continuationof          http://id.loc.gov/vocabulary/relationship/continues          http://id.loc.gov/vocabulary/relationship/precededby          http://id.loc.gov/vocabulary/relationship/mergerof          http://id.loc.gov/vocabulary/relationship/absorbedby          http://id.loc.gov/vocabulary/relationship/absorptionof          http://id.loc.gov/vocabulary/relationship/separatedby          http://id.loc.gov/vocabulary/relationship/continuedby          http://id.loc.gov/vocabulary/relationship/continuedinpartby          http://id.loc.gov/vocabulary/relationship/succeededby          http://id.loc.gov/vocabulary/relationship/splitinto          http://id.loc.gov/vocabulary/relationship/mergedtoform          http://id.loc.gov/vocabulary/relationship/datasource          http://id.loc.gov/vocabulary/relationship/relatedwork         '"/>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vLinkTagFromWork2"/>
      </xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="$vLinkTagFromWork2 = '780' or $vLinkTagFromWork2 = '785'">
              <xsl:text>0</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text>1</xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="$vLinkTagFromWork2 != '780' and $vLinkTagFromWork2 != '785'">
              <xsl:value-of select="' '"/>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedinpart') or contains(bf:Relationship/@rdf:about, 'continuedinpart')]">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuationof') or contains(bf:Relationship/@rdf:about, 'continuationof')]">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'precededby') or contains(bf:Relationship/@rdf:about, 'precededby')]">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'succeededby') or contains(bf:Relationship/@rdf:about, 'succeededby')]">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergerof') or contains(bf:Relationship/@rdf:about, 'mergerof')]">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorbedby') or contains(bf:Relationship/@rdf:about, 'absorbedby')]">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorptionof') or contains(bf:Relationship/@rdf:about, 'absorptionof')]">
              <xsl:text>5</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'separatedfrom') or contains(bf:Relationship/@rdf:about, 'separatedfrom')]">
              <xsl:text>7</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedby') or contains(bf:Relationship/@rdf:about, 'continuedby')]">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedinpartby') or contains(bf:Relationship/@rdf:about, 'continuedinpartby')]">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'splitinto') or contains(bf:Relationship/@rdf:about, 'splitinto')]">
              <xsl:text>6</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergedtoform') or contains(bf:Relationship/@rdf:about, 'mergedtoform')]">
              <xsl:text>7</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuesInPart') or contains(bf:Relationship/@rdf:about, 'continuesInPart')]">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continues') or contains(bf:Relationship/@rdf:about, 'continues')]">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'precededBy') or contains(bf:Relationship/@rdf:about, 'precededBy')]">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'succeededBy') or contains(bf:Relationship/@rdf:about, 'succeededBy')]">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergerOf') or contains(bf:Relationship/@rdf:about, 'mergerOf')]">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorbedBy') or contains(bf:Relationship/@rdf:about, 'absorbedBy')]">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'absorbed') or contains(bf:Relationship/@rdf:about, 'absorbed')]">
              <xsl:text>5</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'separatedFrom') or contains(bf:Relationship/@rdf:about, 'separatedFrom')]">
              <xsl:text>7</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedBy') or contains(bf:Relationship/@rdf:about, 'continuedBy')]">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'continuedInPartBy') or contains(bf:Relationship/@rdf:about, 'continuedInPartBy')]">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'splitInto') or contains(bf:Relationship/@rdf:about, 'splitInto')]">
              <xsl:text>6</xsl:text>
            </xsl:when>
            <xsl:when test="ancestor::bf:Relation/bf:relationship[contains(@rdf:resource, 'mergedToForm') or contains(bf:Relationship/@rdf:about, 'mergedToForm')]">
              <xsl:text>7</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="ancestor::bf:Relation/bf:relationship[                             (                                  @rdf:resource and                                  not(contains($vRelStrs, @rdf:resource)) and                                  not(contains(@rdf:resource, 'ontologies/bibframe'))                             ) or                             (                                  bf:Relationship/@rdf:about and                                  not(contains($vRelStrs, bf:Relationship/@rdf:about)) and                                 not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))                             )                          ]/bf:Relationship[rdfs:label or madsrdf:authoritativeLabel]">
        <marc:subfield code="i">
          <xsl:choose>
            <xsl:when test="madsrdf:authoritativeLabel">
              <xsl:for-each select="madsrdf:authoritativeLabel">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $i.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $i.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="ancestor::bf:Relation/bf:relationship[                       (                          @rdf:resource and                          not(contains($vRelStrs, @rdf:resource)) and                          not(contains(@rdf:resource, 'ontologies/bibframe'))                       ) or                       (                          bf:Relationship/@rdf:about and                          not(contains($vRelStrs, bf:Relationship/@rdf:about)) and                         not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))                       )                     ]/bf:Relationship[madsrdf:code or bf:code]">
        <marc:subfield code="4">
          <xsl:choose>
            <xsl:when test="madsrdf:code">
              <xsl:for-each select="madsrdf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="ancestor::bf:Relation/bf:relationship[                     (                        @rdf:resource and                        not(contains($vRelStrs, @rdf:resource)) and                       not(contains(@rdf:resource, 'ontologies/bibframe'))                     ) or                     (                        bf:Relationship/@rdf:about and                        not(contains($vRelStrs, bf:Relationship/@rdf:about)) and                       not(contains(bf:Relationship/@rdf:about, 'ontologies/bibframe'))                     )                   ]//@rdf:*[1]">
        <marc:subfield code="4">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/*/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:title/bf:Title/bf:mainTitle != bf:hasInstance/bf:Instance/bf:title/bf:Title/bf:mainTitle">
          <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="s">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $s.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="vvLinkTagFromWork2-t">
        <xsl:choose>
          <xsl:when test="bf:hasInstance/bf:Instance/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="bf:hasInstance/bf:Instance/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $t.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $t.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$vvLinkTagFromWork2-t != ''">
        <marc:subfield code="t">
          <xsl:value-of select="$vvLinkTagFromWork2-t"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:part">
        <marc:subfield code="g">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:editionStatement">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:title/bf:Title/bf:qualifier">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $c.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:publicationStatement|bf:hasInstance/bf:Instance/bflc:publicationStatement|bf:hasInstance/bf:Instance/bf:provisionActivityStatement">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="d">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $d.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="$vPlaceUri != '' or bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*[local-name()='code']">
          <xsl:variable name="vvLinkTagFromWork2-f">
            <xsl:choose>
              <xsl:when test="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*[local-name()='code']">
                <xsl:value-of select="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*[local-name()='code']"/>
              </xsl:when>
              <xsl:when test="$vPlaceUri != ''">
                <xsl:choose>
                  <xsl:when test="contains($vPlaceUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vPlaceUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vPlaceUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$vvLinkTagFromWork2-f != ''">
            <marc:subfield code="f">
              <xsl:value-of select="$vvLinkTagFromWork2-f"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:seriesStatement">
        <marc:subfield code="k">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label|bf:hasInstance/bf:Instance/bf:note/bf:Note/rdfs:label">
        <marc:subfield code="n">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:title/*[local-name()='AbbreviatedTitle' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/AbbreviatedTitle']/mainTitle">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="p">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $p.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="x">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $x.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:identifiedBy/*">
        <xsl:choose>
          <xsl:when test="local-name()='ReportNumber' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ReportNumber'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="r">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='Strn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Strn'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="u">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn'">
            <xsl:variable name="vvLinkTagFromWork2-w">
              <xsl:value-of select="concat('(DLC)',rdf:value)"/>
            </xsl:variable>
            <xsl:if test="$vvLinkTagFromWork2-w != ''">
              <marc:subfield code="w">
                <xsl:value-of select="$vvLinkTagFromWork2-w"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='Coden' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Coden'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="y">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='Isbn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="z">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:variable name="vvLinkTagFromWork2-w">
              <xsl:choose>
                <xsl:when test="bf:assigner/bf:Agent/bf:code">
                  <xsl:variable name="vSource">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:assigner/bf:Agent/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork2 $w.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$vvLinkTagFromWork2-w != ''">
              <marc:subfield code="w">
                <xsl:value-of select="$vvLinkTagFromWork2-w"/>
              </marc:subfield>
            </xsl:if>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:hasSeries/bf:Work[bf:hasInstance] |                     bf:Work/bf:hasSubseries/bf:Work[bf:hasInstance] |                     bf:Work/bf:translationOf/bf:Work[bf:hasInstance] |                     bf:Work/bf:translation/bf:Work[bf:hasInstance] |                     bf:Work/bf:supplement/bf:Work[bf:hasInstance] |                     bf:Work/bf:supplementTo/bf:Work[bf:hasInstance] |                     bf:Work/bf:partOf/bf:Work[bf:hasInstance] |                     bf:Work/bf:hasPart/bf:Work[bf:hasInstance] |                     bf:Work/bf:otherEdition/bf:Work[bf:hasInstance] |                     bf:Work/bf:otherPhysicalFormat/bf:Work[bf:hasInstance] |                     bf:Work/bf:issuedWith/bf:Work[bf:hasInstance] |                     bf:Work/bf:continues/bf:Work[bf:hasInstance] |                     bf:Work/bf:continuesInPart/bf:Work[bf:hasInstance] |                     bf:Work/bf:precededBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:mergerOf/bf:Work[bf:hasInstance] |                     bf:Work/bf:absorbed/bf:Work[bf:hasInstance] |                     bf:Work/bf:separatedBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:continuedBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:continuedInPartBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:succeededBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:absorbedBy/bf:Work[bf:hasInstance] |                     bf:Work/bf:splitInto/bf:Work[bf:hasInstance] |                     bf:Work/bf:mergedToForm/bf:Work[bf:hasInstance] |                     bf:Work/bf:dataSource/bf:Work[bf:hasInstance] |                     bf:Work/bf:relatedTo/bf:Work[bf:hasInstance]" mode="generate-vLinkTagFromWork">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="vLinkTagFromWork">
      <xsl:choose>
        <xsl:when test="local-name(..)='hasSeries'">
          <xsl:text>760</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='hasSubseries'">
          <xsl:text>762</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='translationOf'">
          <xsl:text>765</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='translation'">
          <xsl:text>767</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='supplement'">
          <xsl:text>770</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='supplementTo'">
          <xsl:text>772</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='partOf'">
          <xsl:text>773</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='hasPart'">
          <xsl:text>774</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='otherEdition'">
          <xsl:text>775</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='otherPhysicalFormat'">
          <xsl:text>776</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='issuedWith'">
          <xsl:text>777</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='continues'">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='continuesInPart'">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='precededBy'">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='mergerOf'">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='absorbed'">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='separatedFrom'">
          <xsl:text>780</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='continuedBy'">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='continuedInPartBy'">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='succeededBy'">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='absorbedBy'">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='splitInto'">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='mergedToForm'">
          <xsl:text>785</xsl:text>
        </xsl:when>
        <xsl:when test="local-name(..)='dataSource'">
          <xsl:text>786</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:text>787</xsl:text>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vLanguageUri">
      <xsl:choose>
        <xsl:when test="bf:language/@rdf:resource">
          <xsl:value-of select="bf:language/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:language/*/@rdf:about">
          <xsl:value-of select="bf:language/*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vPlaceUri">
      <xsl:choose>
        <xsl:when test="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/@rdf:resource">
          <xsl:value-of select="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/@rdf:resource"/>
        </xsl:when>
        <xsl:when test="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*/@rdf:about">
          <xsl:value-of select="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*/@rdf:about"/>
        </xsl:when>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vXmlLang">
      <xsl:value-of select="rdfs:label/@xml:lang"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">
        <xsl:value-of select="$vLinkTagFromWork"/>
      </xsl:attribute>
      <xsl:if test="$vXmlLang != ''">
        <xsl:attribute name="xml:lang">
          <xsl:value-of select="$vXmlLang"/>
        </xsl:attribute>
      </xsl:if>
      <xsl:attribute name="ind1">
        <xsl:text>0</xsl:text>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name(parent::*)='continues'">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='continuesInPart'">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='precededBy'">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='mergerOf'">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='absorbed'">
              <xsl:text>5</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='separatedFrom'">
              <xsl:text>7</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='continuedBy'">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='continuedInPartBy'">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='succeededBy'">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='absorbedBy'">
              <xsl:text>4</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='splitInto'">
              <xsl:text>5</xsl:text>
            </xsl:when>
            <xsl:when test="local-name(parent::*)='mergedToForm'">
              <xsl:text>7</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:for-each select="bflc:appliesTo/bflc:AppliesTo/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="3">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $3.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:contribution/*[local-name()='PrimaryContribution' or rdf:type[contains(@rdf:resource, '/PrimaryContribution')]]/bf:agent/*/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="a">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $a.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:editionStatement">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="b">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $b.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:title/bf:Title/bf:qualifier">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="c">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $c.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:provisionActivityStatement">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="d">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $d.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="$vLanguageUri != '' or bf:language/*[local-name()='code']">
          <xsl:variable name="vvLinkTagFromWork-e">
            <xsl:choose>
              <xsl:when test="bf:language/*[local-name()='code']">
                <xsl:value-of select="bf:language/*[local-name()='code']"/>
              </xsl:when>
              <xsl:when test="$vLanguageUri != ''">
                <xsl:choose>
                  <xsl:when test="contains($vLanguageUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vLanguageUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vLanguageUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$vvLinkTagFromWork-e != ''">
            <marc:subfield code="e">
              <xsl:value-of select="$vvLinkTagFromWork-e"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:choose>
        <xsl:when test="$vPlaceUri != '' or bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*[local-name()='code']">
          <xsl:variable name="vvLinkTagFromWork-f">
            <xsl:choose>
              <xsl:when test="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*[local-name()='code']">
                <xsl:value-of select="bf:hasInstance/bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place/*[local-name()='code']"/>
              </xsl:when>
              <xsl:when test="$vPlaceUri != ''">
                <xsl:choose>
                  <xsl:when test="contains($vPlaceUri,'id.loc.gov')">
                    <xsl:call-template name="tUriCode">
                      <xsl:with-param name="pUri" select="$vPlaceUri"/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$vPlaceUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:when>
            </xsl:choose>
          </xsl:variable>
          <xsl:if test="$vvLinkTagFromWork-f != ''">
            <marc:subfield code="f">
              <xsl:value-of select="$vvLinkTagFromWork-f"/>
            </marc:subfield>
          </xsl:if>
        </xsl:when>
      </xsl:choose>
      <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[rdfs:label or madsrdf:authoritativeLabel]">
        <marc:subfield code="i">
          <xsl:choose>
            <xsl:when test="madsrdf:authoritativeLabel">
              <xsl:for-each select="madsrdf:authoritativeLabel">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $i.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="."/>
                    </xsl:call-template>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $i.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*[madsrdf:code or bf:code]">
        <marc:subfield code="4">
          <xsl:choose>
            <xsl:when test="madsrdf:code">
              <xsl:for-each select="madsrdf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:when>
            <xsl:otherwise>
              <xsl:for-each select="bf:code">
                <xsl:choose>
                  <xsl:when test="position() = 1">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $4.</xsl:message>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bflc:relationship/bflc:Relationship/bflc:relation/*/@rdf:about|bflc:relationship/bflc:Relationship/bflc:relation/@rdf:resource">
        <marc:subfield code="4">
          <xsl:value-of select="."/>
        </marc:subfield>
      </xsl:for-each>
      <xsl:choose>
        <xsl:when test="bf:title/bf:Title/bf:mainTitle != bf:hasInstance/bf:Instance/bf:title/bf:Title/bf:mainTitle">
          <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
            <xsl:choose>
              <xsl:when test="position() = 1">
                <marc:subfield code="s">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </marc:subfield>
              </xsl:when>
              <xsl:otherwise>
                <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $s.</xsl:message>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="vvLinkTagFromWork-t">
        <xsl:choose>
          <xsl:when test="bf:hasInstance/bf:Instance/bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="bf:hasInstance/bf:Instance/bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $t.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="bf:title/bf:Title/bf:mainTitle">
            <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
              <xsl:choose>
                <xsl:when test="position() = 1">
                  <xsl:call-template name="tChopPunct">
                    <xsl:with-param name="pString" select="."/>
                  </xsl:call-template>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $t.</xsl:message>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:for-each>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$vvLinkTagFromWork-t != ''">
        <marc:subfield code="t">
          <xsl:value-of select="$vvLinkTagFromWork-t"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:part">
        <marc:subfield code="g">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:extent/bf:Extent/rdfs:label">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="h">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $h.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:seriesStatement">
        <marc:subfield code="k">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label|bf:hasInstance/bf:Instance/bf:note/bf:Note/rdfs:label">
        <marc:subfield code="n">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
      <xsl:for-each select="bf:title/*[local-name()='AbbreviatedTitle' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/AbbreviatedTitle']/mainTitle">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="p">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $p.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value">
        <xsl:choose>
          <xsl:when test="position() = 1">
            <marc:subfield code="x">
              <xsl:call-template name="tChopPunct">
                <xsl:with-param name="pString" select="."/>
              </xsl:call-template>
            </marc:subfield>
          </xsl:when>
          <xsl:otherwise>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $x.</xsl:message>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
      <xsl:for-each select="bf:hasInstance/bf:Instance/bf:identifiedBy/*">
        <xsl:choose>
          <xsl:when test="local-name()='Local' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="o">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='ReportNumber' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ReportNumber'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="r">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='Strn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Strn'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="u">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='Lccn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Lccn'">
            <xsl:variable name="vvLinkTagFromWork-w">
              <xsl:value-of select="concat('(DLC)',rdf:value)"/>
            </xsl:variable>
            <xsl:if test="$vvLinkTagFromWork-w != ''">
              <marc:subfield code="w">
                <xsl:value-of select="$vvLinkTagFromWork-w"/>
              </marc:subfield>
            </xsl:if>
          </xsl:when>
          <xsl:when test="local-name()='Coden' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Coden'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="y">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:when test="local-name()='Isbn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn'">
            <xsl:for-each select="rdf:value">
              <marc:subfield code="z">
                <xsl:value-of select="."/>
              </marc:subfield>
            </xsl:for-each>
          </xsl:when>
          <xsl:otherwise>
            <xsl:variable name="vvLinkTagFromWork-w">
              <xsl:choose>
                <xsl:when test="bf:assigner/bf:Agent/bf:code">
                  <xsl:variable name="vSource">
                    <xsl:call-template name="tChopPunct">
                      <xsl:with-param name="pString" select="bf:assigner/bf:Agent/bf:code"/>
                    </xsl:call-template>
                  </xsl:variable>
                  <xsl:value-of select="concat('(',$vSource,')',rdf:value)"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:for-each select="rdf:value">
                    <xsl:choose>
                      <xsl:when test="position() = 1">
                        <xsl:value-of select="."/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed node <xsl:value-of select="name()"/>. Non-repeatable target element vLinkTagFromWork $w.</xsl:message>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:variable>
            <xsl:if test="$vvLinkTagFromWork-w != ''">
              <marc:subfield code="w">
                <xsl:value-of select="$vvLinkTagFromWork-w"/>
              </marc:subfield>
            </xsl:if>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Instance[                       (bf:media/@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/c' or bf:media/*/@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/c') and                        bf:electronicLocator                       ]" mode="generate-856">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="v856Uri">
      <xsl:value-of select="bf:electronicLocator/@rdf:resource"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">856</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="starts-with($v856Uri,'mailto')">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'ftp')">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'telnet') or starts-with($v856Uri,'ssh')">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'http')">
              <xsl:text>4</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name()='SupplementaryContent'">
              <xsl:text>2</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:choose>
        <xsl:when test="not(contains(bf:title/bf:Title/bf:mainTitle, 'resource]'))">
          <xsl:for-each select="bf:title/bf:Title/bf:mainTitle">
            <marc:subfield code="3">
              <xsl:value-of select="."/>
            </marc:subfield>
          </xsl:for-each>
        </xsl:when>
      </xsl:choose>
      <xsl:variable name="v856-u">
        <xsl:value-of select="$v856Uri"/>
      </xsl:variable>
      <xsl:if test="$v856-u != ''">
        <marc:subfield code="u">
          <xsl:value-of select="$v856-u"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <marc:subfield code="z">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:tableOfContents/bf:TableOfContents[not(rdfs:label) and rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']] |                     bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']] |                     //bf:Item/bf:electronicLocator/*[rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']]" mode="generate-856">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="v856Uri">
      <xsl:value-of select="rdf:value[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">856</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="starts-with($v856Uri,'mailto')">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'ftp')">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'telnet') or starts-with($v856Uri,'ssh')">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'http')">
              <xsl:text>4</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name()='SupplementaryContent'">
              <xsl:text>2</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:variable name="v856-u">
        <xsl:value-of select="$v856Uri"/>
      </xsl:variable>
      <xsl:if test="$v856-u != ''">
        <marc:subfield code="u">
          <xsl:value-of select="$v856-u"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <marc:subfield code="z">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="bf:Work/bf:tableOfContents[@rdf:resource] |                     bf:Instance/bf:supplementaryContent/bf:SupplementaryContent[bf:electronicLocator/@rdf:resource] |                     //bf:Item/bf:electronicLocator[@rdf:resource]" mode="generate-856">
    <xsl:param name="vRecordId"/>
    <xsl:param name="vAdminMetadata"/>
    <xsl:variable name="v856Uri">
      <xsl:value-of select="@rdf:resource|bf:electronicLocator/@rdf:resource"/>
    </xsl:variable>
    <marc:datafield>
      <xsl:attribute name="tag">856</xsl:attribute>
      <xsl:attribute name="ind1">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="starts-with($v856Uri,'mailto')">
              <xsl:text>0</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'ftp')">
              <xsl:text>1</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'telnet') or starts-with($v856Uri,'ssh')">
              <xsl:text>2</xsl:text>
            </xsl:when>
            <xsl:when test="starts-with($v856Uri,'http')">
              <xsl:text>4</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:attribute name="ind2">
        <xsl:variable name="vInd">
          <xsl:choose>
            <xsl:when test="local-name()='SupplementaryContent'">
              <xsl:text>2</xsl:text>
            </xsl:when>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vInd != ''">
            <xsl:value-of select="$vInd"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:text> </xsl:text>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>
      <xsl:variable name="v856-3">
        <xsl:choose>
          <xsl:when test="local-name()='tableOfContents'">
            <xsl:text>Table of contents</xsl:text>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:if test="$v856-3 != ''">
        <marc:subfield code="3">
          <xsl:value-of select="$v856-3"/>
        </marc:subfield>
      </xsl:if>
      <xsl:variable name="v856-u">
        <xsl:value-of select="$v856Uri"/>
      </xsl:variable>
      <xsl:if test="$v856-u != ''">
        <marc:subfield code="u">
          <xsl:value-of select="$v856-u"/>
        </marc:subfield>
      </xsl:if>
      <xsl:for-each select="bf:note/bf:Note/rdfs:label">
        <marc:subfield code="z">
          <xsl:call-template name="tChopPunct">
            <xsl:with-param name="pString" select="."/>
          </xsl:call-template>
        </marc:subfield>
      </xsl:for-each>
    </marc:datafield>
  </xsl:template>
  <xsl:template match="text()"/>
  <xsl:template name="tChopPunct">
    <xsl:param name="pString"/>
    <xsl:variable name="vNormString" select="normalize-space($pString)"/>
    <xsl:variable name="vPunct" select="':;,/=–—'"/>
    <xsl:variable name="vEndEnclose" select="')]}&quot;'"/>
    <xsl:variable name="vLength" select="string-length($vNormString)"/>
    <xsl:choose>
      <xsl:when test="$vLength=0"/>
      <xsl:when test="not($vNormString)"/>
      <xsl:when test="substring($vNormString,1,1) = '('">
        <xsl:variable name="vCloseIndex">
          <xsl:call-template name="tLastIndex">
            <xsl:with-param name="pString" select="$vNormString"/>
            <xsl:with-param name="pSearch" select="')'"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vCloseIndex &gt; 2">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="concat(substring($vNormString,2,$vCloseIndex - 2),substring($vNormString,$vCloseIndex+1))"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:otherwise>
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="substring($vNormString,2)"/>
            </xsl:call-template>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:when test="substring($vNormString,1,1) = '['">
        <xsl:variable name="vCloseIndex">
          <xsl:call-template name="tLastIndex">
            <xsl:with-param name="pString" select="$vNormString"/>
            <xsl:with-param name="pSearch" select="']'"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vCloseIndex &gt; 2">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="concat(substring($vNormString,2,$vCloseIndex - 2),substring($vNormString,$vCloseIndex+1))"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:otherwise>
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="substring($vNormString,2)"/>
            </xsl:call-template>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:when test="substring($vNormString,1,1) = '{'">
        <xsl:variable name="vCloseIndex">
          <xsl:call-template name="tLastIndex">
            <xsl:with-param name="pString" select="$vNormString"/>
            <xsl:with-param name="pSearch" select="'}'"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vCloseIndex &gt; 2">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="concat(substring($vNormString,2,$vCloseIndex - 2),substring($vNormString,$vCloseIndex+1))"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:otherwise>
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="substring($vNormString,2)"/>
            </xsl:call-template>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:when test="substring($vNormString,1,1) = '&quot;'">
        <xsl:variable name="vCloseIndex">
          <xsl:call-template name="tLastIndex">
            <xsl:with-param name="pString" select="$vNormString"/>
            <xsl:with-param name="pSearch" select="'&quot;'"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vCloseIndex &gt; 2">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="concat(substring($vNormString,2,$vCloseIndex - 2),substring($vNormString,$vCloseIndex+1))"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:otherwise>
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="substring($vNormString,2)"/>
            </xsl:call-template>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:when test="substring($vNormString,$vLength,1) = '.'">
        <xsl:choose>
          <xsl:when test="contains(concat($vPunct,$vEndEnclose),substring($vNormString,$vLength - 1,1))">
            <xsl:call-template name="tChopPunct">
              <xsl:with-param name="pString" select="substring($vNormString,1,$vLength - 1)"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="$vNormString"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:when test="contains($vPunct, substring($vNormString,$vLength,1))">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="substring($vNormString,1,$vLength - 1)"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:when test="substring($vNormString,$vLength,1)=')' and not(contains($vNormString,'('))">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="substring($vNormString,1,$vLength - 1)"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:when test="substring($vNormString,$vLength,1)=']' and not(contains($vNormString,'['))">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="substring($vNormString,1,$vLength - 1)"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:when test="substring($vNormString,$vLength,1)='}' and not(contains($vNormString,'{'))">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="substring($vNormString,1,$vLength - 1)"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:when test="substring($vNormString,$vLength,1)='&quot;' and not(contains($vNormString,'&quot;'))">
        <xsl:call-template name="tChopPunct">
          <xsl:with-param name="pString" select="substring($vNormString,1,$vLength - 1)"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise>
        <xsl:value-of select="$vNormString"/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tLastIndex">
    <xsl:param name="pString"/>
    <xsl:param name="pSearch"/>
    <xsl:choose>
      <xsl:when test="$pSearch != '' and contains($pString,$pSearch)">
        <xsl:variable name="vRevSearch">
          <xsl:call-template name="tReverseString">
            <xsl:with-param name="pString" select="$pSearch"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vRevString">
          <xsl:call-template name="tReverseString">
            <xsl:with-param name="pString" select="$pString"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:value-of select="string-length($pString) - string-length(substring-before($vRevString,$vRevSearch))"/>
      </xsl:when>
      <xsl:otherwise>0</xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tReverseString">
    <xsl:param name="pString"/>
    <xsl:variable name="vLength" select="string-length($pString)"/>
    <xsl:choose>
      <xsl:when test="$vLength &lt; 2">
        <xsl:value-of select="$pString"/>
      </xsl:when>
      <xsl:when test="$vLength = 2">
        <xsl:value-of select="concat(substring($pString,2,1),substring($pString,1,1))"/>
      </xsl:when>
      <xsl:otherwise>
        <xsl:variable name="vMid" select="floor($vLength div 2)"/>
        <xsl:variable name="vHalf1">
          <xsl:call-template name="tReverseString">
            <xsl:with-param name="pString" select="substring($pString,1,$vMid)"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:variable name="vHalf2">
          <xsl:call-template name="tReverseString">
            <xsl:with-param name="pString" select="substring($pString,$vMid+1)"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:value-of select="concat($vHalf2,$vHalf1)"/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tPadRight">
    <xsl:param name="pInput"/>
    <xsl:param name="pPadChar" select="' '"/>
    <xsl:param name="pStringLength"/>
    <xsl:choose>
      <xsl:when test="string-length($pInput) &gt;= $pStringLength">
        <xsl:value-of select="$pInput"/>
      </xsl:when>
      <xsl:otherwise>
        <xsl:call-template name="tPadRight">
          <xsl:with-param name="pInput" select="concat($pInput,$pPadChar)"/>
          <xsl:with-param name="pPadChar" select="$pPadChar"/>
          <xsl:with-param name="pStringLength" select="$pStringLength"/>
        </xsl:call-template>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tPadLeft">
    <xsl:param name="pInput"/>
    <xsl:param name="pPadChar" select="' '"/>
    <xsl:param name="pStringLength" select="string-length($pInput)"/>
    <xsl:choose>
      <xsl:when test="string-length($pInput) &gt;= $pStringLength">
        <xsl:value-of select="$pInput"/>
      </xsl:when>
      <xsl:otherwise>
        <xsl:call-template name="tPadLeft">
          <xsl:with-param name="pInput" select="concat($pPadChar,$pInput)"/>
          <xsl:with-param name="pPadChar" select="$pPadChar"/>
          <xsl:with-param name="pStringLength" select="$pStringLength"/>
        </xsl:call-template>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tStringJoin">
    <xsl:param name="pSeq"/>
    <xsl:param name="pJoinChar" select="', '"/>
    <xsl:for-each select="$pSeq">
      <xsl:value-of select="."/>
      <xsl:if test="position() != last()">
        <xsl:value-of select="$pJoinChar"/>
      </xsl:if>
    </xsl:for-each>
  </xsl:template>
  <xsl:template name="tEndsWith">
    <xsl:param name="pStr"/>
    <xsl:param name="pEndChar"/>
    <xsl:choose>
      <xsl:when test="substring($pStr, string-length($pStr)) = $pEndChar">1</xsl:when>
      <xsl:otherwise>0</xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="EDTF-Date1">
    <xsl:param name="pEDTFDate"/>
    <xsl:choose>
      <xsl:when test="contains($pEDTFDate,'/')">
        <xsl:value-of select="substring-before($pEDTFDate,'/')"/>
      </xsl:when>
      <xsl:otherwise>
        <xsl:value-of select="$pEDTFDate"/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="EDTF-Date2">
    <xsl:param name="pEDTFDate"/>
    <xsl:value-of select="substring-after($pEDTFDate,'/')"/>
  </xsl:template>
  <xsl:template name="EDTF-DatePart">
    <xsl:param name="pEDTFDate"/>
    <xsl:choose>
      <xsl:when test="contains($pEDTFDate,'T')">
        <xsl:value-of select="substring-before($pEDTFDate,'T')"/>
      </xsl:when>
      <xsl:otherwise>
        <xsl:value-of select="$pEDTFDate"/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="EDTF-TimePart">
    <xsl:param name="pEDTFDate"/>
    <xsl:choose>
      <xsl:when test="contains(substring-after($pEDTFDate,'T'),'+')">
        <xsl:value-of select="substring-before(substring-after($pEDTFDate,'T'),'+')"/>
      </xsl:when>
      <xsl:when test="contains(substring-after($pEDTFDate,'T'),'-')">
        <xsl:value-of select="substring-before(substring-after($pEDTFDate,'T'),'-')"/>
      </xsl:when>
      <xsl:when test="contains(substring-after($pEDTFDate,'T'),'Z')">
        <xsl:value-of select="substring-before(substring-after($pEDTFDate,'T'),'Z')"/>
      </xsl:when>
      <xsl:otherwise>
        <xsl:value-of select="substring-after($pEDTFDate,'T')"/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="EDTF-TimeDiff">
    <xsl:param name="pEDTFDate"/>
    <xsl:choose>
      <xsl:when test="contains(substring-after($pEDTFDate,'T'),'+')">
        <xsl:value-of select="concat('+',substring-after(substring-after($pEDTFDate,'T'),'+'))"/>
      </xsl:when>
      <xsl:when test="contains(substring-after($pEDTFDate,'T'),'-')">
        <xsl:value-of select="concat('-',substring-after(substring-after($pEDTFDate,'T'),'-'))"/>
      </xsl:when>
      <xsl:when test="contains(substring-after($pEDTFDate,'T'),'Z')">+00:00</xsl:when>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="EDTF-to-033">
    <xsl:param name="pEDTFDate"/>
    <xsl:variable name="vEDTFDate" select="translate(translate(translate($pEDTFDate,'?',''),'~',''),'%','')"/>
    <xsl:variable name="vDatePart">
      <xsl:call-template name="EDTF-DatePart">
        <xsl:with-param name="pEDTFDate" select="$vEDTFDate"/>
      </xsl:call-template>
    </xsl:variable>
    <xsl:variable name="vTimePart">
      <xsl:call-template name="EDTF-TimePart">
        <xsl:with-param name="pEDTFDate" select="$vEDTFDate"/>
      </xsl:call-template>
    </xsl:variable>
    <xsl:variable name="vTimeDiffPart">
      <xsl:call-template name="EDTF-TimeDiff">
        <xsl:with-param name="pEDTFDate" select="$vEDTFDate"/>
      </xsl:call-template>
    </xsl:variable>
    <xsl:variable name="vYear">
      <xsl:variable name="vYear033">
        <xsl:choose>
          <xsl:when test="contains($vDatePart,'-')">
            <xsl:value-of select="translate(substring-before($vDatePart,'-'),'X','-')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="translate($vDatePart,'X','-')"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:choose>
        <xsl:when test="starts-with($vYear033,'Y') or starts-with($vYear033,'-') or (string-length($vYear033) != 4)">
          <xsl:text>----</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$vYear033"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vMonth">
      <xsl:variable name="vMonth033">
        <xsl:choose>
          <xsl:when test="substring-after(substring-after($vDatePart,'-'),'-') != ''">
            <xsl:value-of select="translate(substring-before(substring-after($vDatePart,'-'),'-'),'X','-')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="translate(substring-after($vDatePart,'-'),'X','-')"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:choose>
        <xsl:when test="(string-length($vMonth033) != 2) or ($vMonth033 &gt; 12)">
          <xsl:text>--</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$vMonth033"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vDay">
      <xsl:variable name="vDay033" select="translate(substring-after(substring-after($vDatePart,'-'),'-'),'X','-')"/>
      <xsl:choose>
        <xsl:when test="(string-length($vDay033) != 2) or ($vDay033 &gt; 31)">
          <xsl:text>--</xsl:text>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$vDay033"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:variable name="vTime">
      <xsl:if test="$vTimePart != ''">
        <xsl:variable name="vTime033" select="translate(translate($vTimePart,'X','-'),':','')"/>
        <xsl:choose>
          <xsl:when test="string-length($vTime033) = 6">
            <xsl:value-of select="$vTime033"/>
          </xsl:when>
          <xsl:otherwise>------</xsl:otherwise>
        </xsl:choose>
      </xsl:if>
    </xsl:variable>
    <xsl:variable name="vTimeDiff">
      <xsl:if test="($vTimePart != '') and ($vTimeDiffPart != '')">
        <xsl:variable name="vTimeDiff033" select="translate(translate($vTimeDiffPart,'X','-'),':','')"/>
        <xsl:choose>
          <xsl:when test="string-length($vTimeDiff033) = 5">
            <xsl:value-of select="$vTimeDiff033"/>
          </xsl:when>
          <xsl:when test="string-length($vTimeDiff033) = 3">
            <xsl:value-of select="concat($vTimeDiff033,'00')"/>
          </xsl:when>
        </xsl:choose>
      </xsl:if>
    </xsl:variable>
    <xsl:value-of select="concat($vYear,$vMonth,$vDay,$vTime,$vTimeDiff)"/>
  </xsl:template>
  <xsl:template name="tScriptCode">
    <xsl:param name="pXmlLang"/>
    <xsl:if test="string-length($pXmlLang) &gt;= 4">
      <xsl:choose>
        <xsl:when test="string-length($pXmlLang)=4 and translate(substring($pXmlLang,1,1),0123456789,'') != ''">
          <xsl:value-of select="$pXmlLang"/>
        </xsl:when>
        <xsl:when test="string-length(substring-before($pXmlLang,'-'))=4 and translate(substring($pXmlLang,1,1),0123456789,'') != ''">
          <xsl:value-of select="substring-before($pXmlLang,'-')"/>
        </xsl:when>
        <xsl:otherwise>
          <xsl:call-template name="tScriptCode">
            <xsl:with-param name="pXmlLang" select="substring-after($pXmlLang,'-')"/>
          </xsl:call-template>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:if>
  </xsl:template>
  <xsl:template name="tUriCode">
    <xsl:param name="pUri"/>
    <xsl:choose>
      <xsl:when test="contains($pUri,'://')">
        <xsl:if test="contains(substring-after($pUri,'://'),'/')">
          <xsl:call-template name="tUriCode">
            <xsl:with-param name="pUri" select="substring-after($pUri,'://')"/>
          </xsl:call-template>
        </xsl:if>
      </xsl:when>
      <xsl:when test="contains($pUri,'/')">
        <xsl:call-template name="tUriCode">
          <xsl:with-param name="pUri" select="substring-after($pUri,'/')"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise>
        <xsl:choose>
          <xsl:when test="contains($pUri,'?')">
            <xsl:value-of select="substring-before($pUri,'?')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="$pUri"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tToken2Subfields">
    <xsl:param name="pString"/>
    <xsl:param name="pSeparator" select="' '"/>
    <xsl:param name="pSubfieldCode"/>
    <xsl:choose>
      <xsl:when test="contains($pString,$pSeparator)">
        <marc:subfield>
          <xsl:attribute name="code">
            <xsl:value-of select="$pSubfieldCode"/>
          </xsl:attribute>
          <xsl:value-of select="substring-before($pString,$pSeparator)"/>
        </marc:subfield>
        <xsl:call-template name="tToken2Subfields">
          <xsl:with-param name="pString" select="substring-after($pString,$pSeparator)"/>
          <xsl:with-param name="pSeparator" select="$pSeparator"/>
          <xsl:with-param name="pSubfieldCode" select="$pSubfieldCode"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise>
        <marc:subfield>
          <xsl:attribute name="code">
            <xsl:value-of select="$pSubfieldCode"/>
          </xsl:attribute>
          <xsl:value-of select="$pString"/>
        </marc:subfield>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tGetRelResource">
    <xsl:param name="pRelUri"/>
    <xsl:param name="pContext"/>
    <xsl:choose>
      <xsl:when test="$pContext/marc:record">
        <xsl:copy-of select="$pContext/marc:record"/>
      </xsl:when>
      <xsl:when test="$pContext/bflc:marcKey">
        <xsl:call-template name="tGetMiniMARCFromKey">
          <xsl:with-param name="pFieldStr" select="$pContext/bflc:marcKey"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise>
        <xsl:variable name="vRelResourcePreNS">
          <xsl:call-template name="tGetMARCAuth">
            <xsl:with-param name="pUri" select="$pRelUri"/>
          </xsl:call-template>
        </xsl:variable>
        <xsl:copy-of select="$vRelResourcePreNS"/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tGetMiniMARCFromKey">
    <xsl:param name="pFieldStr"/>
    <xsl:variable name="tTag">
      <xsl:choose>
        <xsl:when test="substring($pFieldStr, 1, 3) = '880'">
          <xsl:value-of select="substring( substring-after($pFieldStr, '$6'), 1, 3)"/>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="substring($pFieldStr, 1, 3)"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <marc:record>
      <marc:datafield>
        <xsl:attribute name="tag">
          <xsl:choose>
            <xsl:when test="substring($tTag, 2, 2) = '00'">100</xsl:when>
            <xsl:when test="substring($tTag, 2, 2) = '10'">110</xsl:when>
            <xsl:when test="substring($tTag, 2, 2) = '11'">111</xsl:when>
            <xsl:when test="substring($tTag, 2, 2) = '30'">130</xsl:when>
            <xsl:when test="substring($tTag, 2, 2) = '50'">150</xsl:when>
            <xsl:when test="substring($tTag, 2, 2) = '51'">151</xsl:when>
            <xsl:when test="substring($tTag, 2, 2) = '55'">155</xsl:when>
            <xsl:when test="substring($tTag, 1, 3) = '440'">130</xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="substring($tTag, 1, 3)"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:attribute>
        <xsl:attribute name="ind1">
          <xsl:choose>
            <xsl:when test="$tTag = 630 or $tTag = 730">
              <xsl:value-of select="substring($pFieldStr, 5, 1)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="substring($pFieldStr, 4, 1)"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:attribute>
        <xsl:attribute name="ind2">
          <xsl:choose>
            <xsl:when test="$tTag = 630 or $tTag = 730">
              <xsl:value-of select="substring($pFieldStr, 4, 1)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="substring($pFieldStr, 5, 1)"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:attribute>
        <xsl:call-template name="tParseMarcKey">
          <xsl:with-param name="pString" select="substring($pFieldStr, 6)"/>
        </xsl:call-template>
      </marc:datafield>
    </marc:record>
  </xsl:template>
  <xsl:template name="tGetMARCAuth">
    <xsl:param name="pUri"/>
    <xsl:param name="pForceSRULookup" select="false()"/>
    <xsl:variable name="vUrl">
      <xsl:choose>
        <xsl:when test="(                                contains($pUri,'id.loc.gov/authorities/') or                                contains($pUri,'id.loc.gov/rwo/agents') or                                contains($pUri,'id.loc.gov/resources/hubs') or                                contains($pUri,'id.worldcat.org/fast/') or                                contains($pUri,'d-nb.info/gnd/')                             )                             and not('.marcxml.xml' = substring($pUri, string-length($pUri) - 11))">
          <xsl:choose>
            <xsl:when test="($xslProcessor='libxslt' or $pSRULookup='true' or $pForceSRULookup=true())">
              <xsl:variable name="vUriLccn">
                <xsl:call-template name="tUriCode">
                  <xsl:with-param name="pUri" select="$pUri"/>
                </xsl:call-template>
              </xsl:variable>
              <xsl:variable name="vLccnSearch">
                <xsl:variable name="vLccnNum">
                  <xsl:value-of select="translate($vUriLccn,translate($vUriLccn,'0123456789',''),'')"/>
                </xsl:variable>
                <xsl:variable name="vPrefix">
                  <xsl:value-of select="translate(substring($vUriLccn,1,3),'0123456789 ','')"/>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vLccnNum)=10">
                    <xsl:choose>
                      <xsl:when test="string-length($vPrefix) &lt; 2">
                        <xsl:value-of select="concat($vPrefix,'%20',$vLccnNum)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$vUriLccn"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:choose>
                      <xsl:when test="string-length($vPrefix) &lt; 3">
                        <xsl:value-of select="concat($vPrefix,'%20',$vLccnNum)"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$vUriLccn"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:choose>
                <xsl:when test="contains($pUri,'names') or contains($pUri,'agents')">
                  <xsl:value-of select="concat('http://lx2.loc.gov:210/NAF?query=bath.lccn%3d',$vLccnSearch,'&amp;recordSchema=marcxml&amp;maximumRecords=1')"/>
                </xsl:when>
                <xsl:when test="contains($pUri,'ubjects') or contains($pUri,'genreForm')">
                  <xsl:value-of select="concat('http://lx2.loc.gov:210/SAF?query=bath.lccn%3d',$vLccnSearch,'&amp;recordSchema=marcxml&amp;maximumRecords=1')"/>
                </xsl:when>
                <xsl:otherwise>
                  <xsl:message>Desire to look up <xsl:value-of select="$pUri"/> but using xsltproc. No lookup occurred.</xsl:message>
                  <xsl:value-of select="$pUri"/>
                </xsl:otherwise>
              </xsl:choose>
            </xsl:when>
            <xsl:when test="contains($pUri, 'id.worldcat.org/fast/')">
              <xsl:variable name="vPath">
                <xsl:value-of select="substring-after($pUri,'://id.worldcat.org')"/>
              </xsl:variable>
              <xsl:value-of select="concat('https://id.worldcat.org',$vPath,'.mrc.xml')"/>
            </xsl:when>
            <xsl:when test="contains($pUri, 'd-nb.info/gnd/')">
              <xsl:variable name="vPath">
                <xsl:value-of select="substring-after($pUri,'://d-nb.info')"/>
              </xsl:variable>
              <xsl:value-of select="concat('https://d-nb.info',$vPath,'/about/marcxml')"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:variable name="vLookupURI">
                <xsl:choose>
                  <xsl:when test="contains($pUri, 'id.loc.gov/rwo/agents')">
                    <xsl:value-of select="concat(substring-before($pUri,'rwo/agents'), 'authorities/names/', substring-after($pUri,'rwo/agents/'))"/>
                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="$pUri"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>
              <xsl:variable name="vPath">
                <xsl:value-of select="substring-after($vLookupURI,'://id.loc.gov')"/>
              </xsl:variable>
              <xsl:value-of select="concat('https://id.loc.gov',$vPath,'.marcxml.xml')"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:when>
        <xsl:otherwise>
          <xsl:value-of select="$pUri"/>
        </xsl:otherwise>
      </xsl:choose>
    </xsl:variable>
    <xsl:choose>
      <xsl:when test="$vUrl != '' and not($xslProcessor='libxslt' and contains($vUrl, 'resources/hubs'))">
        <xsl:variable name="vDoc">
          <xsl:choose>
            <xsl:when test="function-available('xdmp:document-get')">
              <xsl:copy-of select="xdmp:document-get($vUrl)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:copy-of select="document($vUrl)"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <xsl:choose>
          <xsl:when test="$vDoc">
            <xsl:copy-of select="$vDoc"/>
          </xsl:when>
          <xsl:otherwise>
            <marc:collection/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:when>
      <xsl:otherwise>
        <marc:collection/>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tGetLabel">
    <xsl:param name="pUri"/>
    <xsl:if test="$xslProcessor != 'libxslt'">
      <xsl:variable name="vUrl">
        <xsl:choose>
          <xsl:when test="(                contains($pUri,'id.loc.gov/entities/') or                contains($pUri,'id.loc.gov/vocabulary/')               )               and not('.madsrdf_raw.rdf' = substring($pUri, string-length($pUri) - 16))">
            <xsl:variable name="vPath">
              <xsl:value-of select="substring-after($pUri,'://id.loc.gov')"/>
            </xsl:variable>
            <xsl:value-of select="concat('https://id.loc.gov',$vPath,'.madsrdf_raw.rdf')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="$pUri"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:variable name="vDoc">
        <xsl:choose>
          <xsl:when test="function-available('xdmp:document-get')">
            <xsl:copy-of select="xdmp:document-get($vUrl)"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:copy-of select="document($vUrl)"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>
      <xsl:choose>
        <xsl:when test="$vDoc">
          <xsl:value-of select="$vDoc/rdf:RDF/madsrdf:*/madsrdf:authoritativeLabel[1]"/>
        </xsl:when>
      </xsl:choose>
    </xsl:if>
  </xsl:template>
  <xsl:template name="tParseMarcKey">
    <xsl:param name="pString"/>
    <xsl:param name="pSeparator" select="'$'"/>
    <xsl:choose>
      <xsl:when test="starts-with($pString,$pSeparator)">
        <marc:subfield>
          <xsl:attribute name="code">
            <xsl:value-of select="substring(substring-after($pString,$pSeparator),1,1)"/>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="substring(substring-after($pString,$pSeparator),1,1) = '6' and                                    contains(substring-after($pString,$pSeparator),$pSeparator) and                                    substring-before(substring(substring-after($pString,$pSeparator),2),'/$1$') != ''                                   ">
              <xsl:value-of select="concat(substring-before(substring(substring-after($pString,$pSeparator),2),'/$1'),'/$1')"/>
            </xsl:when>
            <xsl:when test="contains(substring-after($pString,$pSeparator),$pSeparator)">
              <xsl:value-of select="substring-before(substring(substring-after($pString,$pSeparator),2),$pSeparator)"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="substring(substring-after($pString,$pSeparator),2)"/>
            </xsl:otherwise>
          </xsl:choose>
        </marc:subfield>
        <xsl:choose>
          <xsl:when test="substring(substring-after($pString,$pSeparator),1,1) = '6' and                                substring-before(substring(substring-after($pString,$pSeparator),2),'/$1$') != '' and                               contains(substring-after($pString,$pSeparator),$pSeparator)">
            <xsl:call-template name="tParseMarcKey">
              <xsl:with-param name="pString" select="concat($pSeparator,substring-after(substring-after($pString,$pSeparator),'/$1$'))"/>
              <xsl:with-param name="pSeparator" select="$pSeparator"/>
            </xsl:call-template>
          </xsl:when>
          <xsl:when test="contains(substring-after($pString,$pSeparator),$pSeparator)">
            <xsl:call-template name="tParseMarcKey">
              <xsl:with-param name="pString" select="concat($pSeparator,substring-after(substring-after($pString,$pSeparator),$pSeparator))"/>
              <xsl:with-param name="pSeparator" select="$pSeparator"/>
            </xsl:call-template>
          </xsl:when>
        </xsl:choose>
      </xsl:when>
    </xsl:choose>
  </xsl:template>
  <xsl:template name="tReadMarc382">
    <xsl:param name="pString"/>
    <xsl:param name="pSeparator" select="'$'"/>
    <xsl:choose>
      <xsl:when test="starts-with($pString,$pSeparator)">
        <xsl:if test="substring(substring-after($pString,$pSeparator),1,1) != '3'">
          <marc:subfield>
            <xsl:attribute name="code">
              <xsl:value-of select="substring(substring-after($pString,$pSeparator),1,1)"/>
            </xsl:attribute>
            <xsl:choose>
              <xsl:when test="contains(substring-after($pString,$pSeparator),$pSeparator)">
                <xsl:value-of select="substring-before(substring(substring-after($pString,$pSeparator),2),$pSeparator)"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="substring(substring-after($pString,$pSeparator),2)"/>
              </xsl:otherwise>
            </xsl:choose>
          </marc:subfield>
        </xsl:if>
        <xsl:choose>
          <xsl:when test="contains(substring-after($pString,$pSeparator),$pSeparator)">
            <xsl:call-template name="tReadMarc382">
              <xsl:with-param name="pString" select="concat($pSeparator,substring-after(substring-after($pString,$pSeparator),$pSeparator))"/>
              <xsl:with-param name="pSeparator" select="$pSeparator"/>
            </xsl:call-template>
          </xsl:when>
        </xsl:choose>
      </xsl:when>
    </xsl:choose>
  </xsl:template>
</xsl:stylesheet>
